import{b as ge,d as pe,j as e}from"./query-vendor-B--u1oZD.js";import{g as d}from"./react-vendor-XXJdR_Id.js";import{c as B,b as he}from"./index-C1kkCffi.js";import{d as be,e as fe,c as ye,u as je,a as ve,b as ke}from"./useAttendances-BtemQHXu.js";import{u as we}from"./useLecturerAssignments-BNW1KFc6.js";import{c as Ne,i as Se,Y as Ae}from"./ui-vendor-DIF6S0il.js";const y=(a,k="")=>a?typeof a=="string"?a:"String"in a&&typeof a.String=="string"?a.String:"Time"in a&&typeof a.Time=="string"?a.Time:B(a,k):k,De=({selectedMeeting:a,onClose:k})=>{const F=ge(),{data:H,isLoading:se}=be(a?.classId),{data:R,isLoading:ae}=fe(a?.meetingId),{data:w,refetch:U}=ye(a?.classId),N=d.useMemo(()=>H??[],[H]),z=d.useMemo(()=>R??[],[R]),{data:M=[]}=we({id_kelas:a?.classId?String(a.classId):void 0}),q=d.useMemo(()=>{const t=new Set;return M.forEach(s=>{const n=B(s.id_dosen);n&&t.add(n)}),Array.from(t)},[M]),Q=pe({queries:q.map(t=>({queryKey:["lecturer",t],queryFn:()=>he.getLecturerByID(t),enabled:!!t}))}),E=d.useMemo(()=>{const t={};return Q.forEach(s=>{const n=s.data;n?.id&&n?.nama_dosen&&(t[n.id]=n.nama_dosen)}),t},[Q]),l=d.useMemo(()=>{if(!a||!w||w.length===0)return null;const t=w.find(L=>L.id===a.meetingId);if(!t)return null;let s="",n="",c="",i="",r="",f="";s=y(t.tgl_pertemuan,""),n=y(t.jam_pertemuan,""),c=y(t.topik,""),i=y(t.id_dosen,""),r=y(t.realisasi_topik,""),f=y(t.catatan_pertemuan,"");let v=!1;t.absensi_aktif!==null&&t.absensi_aktif!==void 0&&(typeof t.absensi_aktif=="boolean"?v=t.absensi_aktif:typeof t.absensi_aktif=="object"&&"Bool"in t.absensi_aktif&&(v=t.absensi_aktif.Valid?t.absensi_aktif.Bool:!1));let _;if(s&&n){const L=s.includes("T")?s.split("T")[0]:s.split(" ")[0]||s,xe=n.length===5?`${n}:00`:n.split(".")[0]||n,ue=`${L}T${xe}`;_=new Date(ue)}return{meetingDateTime:_,topic:c,lecturerId:i,absensiAktif:v,realisasiTopik:r,catatanPertemuan:f}},[a,w]),u=je(),g=ve(),h=ke(),[x,o]=d.useState({}),[ne,S]=d.useState(!1),[P,K]=d.useState(!1),[ie,A]=d.useState(!1),[b,O]=d.useState(""),[m,W]=d.useState(""),[I,V]=d.useState(""),[X,Y]=d.useState(""),[p,D]=d.useState(!1),[C,G]=d.useState(""),[T,J]=d.useState(""),j=d.useMemo(()=>{if(!N||N.length===0)return[];const t=new Map(z.map(s=>[s.nim,{status:B(s.status_kehadiran,""),id:s.id}]));return N.map(s=>{const n=t.get(s.nim);return{...s,status:n?.status||"Belum Absen",attendanceId:n?.id}})},[N,z]),Z=async(t,s,n)=>{if(!a)return;const c=new Date().toISOString();try{n?await g.mutateAsync({id:n,data:{status_kehadiran:s,waktu_masuk:c}}):await u.mutateAsync({id_pertemuan:a.meetingId,nim:t,status_kehadiran:s,waktu_masuk:c})}catch(i){console.error("Failed to update attendance:",i),alert(`Failed to update attendance: ${i instanceof Error?i.message:"Unknown error"}`)}},re=async()=>{if(!a||Object.keys(x).length===0)return;K(!0);const t=[],s=new Date().toISOString();for(const n of Object.keys(x)){const c=x[n],i=j.find(r=>r.nim===n);if(i)try{i.attendanceId?await g.mutateAsync({id:i.attendanceId,data:{status_kehadiran:c,waktu_masuk:s}}):await u.mutateAsync({id_pertemuan:a.meetingId,nim:n,status_kehadiran:c,waktu_masuk:s})}catch(r){console.error(`Failed to update attendance for ${n}:`,r),t.push(`${i.nama} (${n})`)}}K(!1),t.length>0?alert(`Failed to update attendance for: ${t.join(", ")}`):(o({}),S(!1))},le=()=>{const t={};j.forEach(s=>{t[s.nim]=s.status==="Belum Absen"?"Hadir":s.status||"Hadir"}),o(t),S(!0)},de=()=>{o({}),S(!1)},ce=async()=>{if(!(!a||!b||!m))try{const t=m.length===5?`${m}:00`:m;await h.mutateAsync({id:a.meetingId,data:{tgl_pertemuan:b,jam_pertemuan:t,topik:I||void 0,id_dosen:X||void 0,absensi_aktif:p,realisasi_topik:C||void 0,catatan_pertemuan:T||void 0}}),await U(),await F.invalidateQueries({queryKey:["lecturer-meeting-recap"]}),A(!1),alert("Meeting schedule updated successfully!")}catch(t){console.error("Failed to update meeting:",t),alert(`Failed to update meeting: ${t instanceof Error?t.message:"Unknown error"}`)}};d.useEffect(()=>{const t=l?.meetingDateTime||a?.meetingDateTime,s=l?.topic||a?.topic||"",n=l?.lecturerId||"",c=l?.absensiAktif||!1,i=l?.realisasiTopik||"",r=l?.catatanPertemuan||"";if(t){const f=new Date(t),v=f.toISOString().split("T")[0],_=`${String(f.getHours()).padStart(2,"0")}:${String(f.getMinutes()).padStart(2,"0")}`;O(v),W(_),V(s),Y(n),D(c),G(i),J(r)}},[l?.meetingDateTime,l?.topic,l?.lecturerId,l?.absensiAktif,l?.realisasiTopik,l?.catatanPertemuan,a?.meetingDateTime,a?.topic]);const oe=()=>{A(!0)},me=()=>{o({}),S(!1),A(!1),k()},$=l?.meetingDateTime||a?.meetingDateTime,ee=d.useMemo(()=>$?new Date($).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric"}):a?.dateLabel,[$,a?.dateLabel]),te=l?.topic||a?.topic;return a?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-2 sm:p-4 bg-black/30",children:e.jsxs("div",{className:"w-full h-full max-h-screen sm:max-h-[90vh] max-w-6xl bg-white rounded-lg shadow-lg flex flex-col overflow-hidden",children:[e.jsx("div",{className:"px-3 sm:px-4 py-2 border-b border-gray-200 flex items-center justify-end flex-shrink-0",children:e.jsx("button",{onClick:me,className:"px-3 py-1.5 text-sm rounded hover:bg-gray-100 cursor-pointer","aria-label":"Close",children:"Close"})}),e.jsxs("div",{className:"flex-1 flex overflow-hidden min-h-0",children:[e.jsxs("div",{className:"w-full sm:w-1/3 border-r border-gray-200 overflow-y-auto p-3 sm:p-4",children:[e.jsxs("div",{className:"mb-4 pb-3 border-b border-gray-200",children:[e.jsx("div",{className:"text-xs sm:text-sm text-gray-500 truncate",children:a.subtitle}),e.jsx("h3",{className:"text-sm sm:text-base font-semibold text-gray-900 line-clamp-2",children:a.title}),ee&&e.jsx("div",{className:"text-xs text-gray-500 mt-0.5",children:ee})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"Course Week"}),e.jsx("div",{className:"text-sm text-gray-900 font-mono",children:a.subtitle})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"Course Code - Name"}),e.jsx("div",{className:"text-sm text-gray-900",children:a.title})]}),ie?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Date"}),e.jsx("input",{type:"date",value:b,onChange:t=>O(t.target.value),className:"input-field w-full text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Time"}),e.jsx("input",{type:"time",value:m,onChange:t=>W(t.target.value),className:"input-field w-full text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Topic"}),e.jsx("textarea",{value:I,onChange:t=>V(t.target.value),className:"input-field w-full text-sm",rows:3,placeholder:"Enter meeting topic or description...",maxLength:500}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[I.length,"/500 characters"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Realized Topic"}),e.jsx("textarea",{value:C,onChange:t=>G(t.target.value),className:"input-field w-full text-sm",rows:3,placeholder:"Enter actual/realized topic delivered...",maxLength:500}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[C.length,"/500 characters"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Meeting Notes"}),e.jsx("textarea",{value:T,onChange:t=>J(t.target.value),className:"input-field w-full text-sm",rows:3,placeholder:"Enter any notes or observations from this meeting...",maxLength:500}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[T.length,"/500 characters"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Lecturer"}),e.jsxs("select",{value:X,onChange:t=>Y(t.target.value),className:"input-field w-full text-sm",children:[e.jsx("option",{value:"",children:"- No Lecturer -"}),q.map(t=>e.jsx("option",{value:t,children:E[t]||t},t))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"flex items-center gap-2 text-xs font-medium text-gray-700",children:[e.jsx("input",{type:"checkbox",checked:p,onChange:t=>D(t.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{children:"Enable Attendance"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1 ml-6",children:"When enabled, students can check-in for attendance"})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx("button",{onClick:ce,disabled:h.isPending||!b||!m,className:"px-3 py-1.5 text-sm font-medium rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer flex-1",children:h.isPending?"Saving...":"Save Changes"}),e.jsx("button",{onClick:()=>A(!1),disabled:h.isPending,className:"px-3 py-1.5 text-sm font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50 cursor-pointer",children:"Cancel"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"Date"}),e.jsx("div",{className:"text-sm text-gray-900",children:b?new Date(`${b}T00:00`).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric"}):"-"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"Time"}),e.jsxs("div",{className:"text-sm text-gray-900 font-mono flex items-center",children:[e.jsx(Ne,{className:"h-3 w-3 mr-2"}),m||"-"]})]}),te&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"Topic"}),e.jsx("div",{className:"text-sm text-gray-900 break-words",children:te})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"Realized Topic"}),e.jsx("div",{className:"text-sm text-gray-900 break-words",children:C||"-"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"Meeting Notes"}),e.jsx("div",{className:"text-sm text-gray-900 break-words",children:T||"-"})]}),l?.lecturerId&&E[l.lecturerId]&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"Lecturer"}),e.jsxs("div",{className:"text-sm text-gray-900 flex items-center",children:[e.jsx(Se,{className:"h-3 w-3 mr-2 flex-shrink-0"}),E[l.lecturerId]]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"Attendance Status"}),e.jsxs("div",{className:`text-sm flex items-center gap-2 ${l?.absensiAktif?"text-green-600":"text-gray-600"}`,children:[e.jsx("div",{className:`h-2 w-2 rounded-full ${l?.absensiAktif?"bg-green-600":"bg-gray-400"}`}),l?.absensiAktif?"Enabled":"Disabled"]})]}),e.jsxs("button",{onClick:oe,className:"w-full px-3 py-2 text-sm font-medium rounded bg-blue-600 text-white hover:bg-blue-700 cursor-pointer flex items-center justify-center gap-2 mt-2",title:"Edit meeting schedule",children:[e.jsx(Ae,{className:"h-4 w-4"}),e.jsx("span",{children:"Edit Meeting"})]})]})]})]}),e.jsxs("div",{className:"w-full sm:w-2/3 overflow-hidden flex flex-col min-h-0",children:[e.jsx("div",{className:"px-3 sm:px-4 py-3 border-b border-gray-200 flex-shrink-0",children:e.jsx("h2",{className:"text-base sm:text-lg font-semibold text-gray-900",children:"Attendance"})}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden min-h-0",children:se||ae?e.jsx("div",{className:"text-center text-gray-500 py-6",children:"Loading students and attendances..."}):j.length===0?e.jsx("div",{className:"text-center text-gray-500 py-6",children:"No students found for this class."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-3 sm:mb-4 flex gap-1 sm:gap-2 justify-between flex-wrap",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("button",{onClick:async()=>{if(a)try{await h.mutateAsync({id:a.meetingId,data:{tgl_pertemuan:b,jam_pertemuan:m.length===5?`${m}:00`:m,absensi_aktif:!p}}),D(!p),await U(),await F.invalidateQueries({queryKey:["lecturer-meeting-recap"]})}catch(t){console.error("Failed to toggle attendance:",t),alert(`Failed to toggle attendance: ${t instanceof Error?t.message:"Unknown error"}`)}},disabled:h.isPending,className:`px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm font-medium rounded flex items-center gap-1 whitespace-nowrap cursor-pointer transition-colors ${p?"bg-green-600 text-white hover:bg-green-700":"bg-gray-200 text-gray-700 hover:bg-gray-300"} disabled:opacity-50 disabled:cursor-not-allowed`,title:p?"Disable attendance":"Enable attendance",children:[e.jsx("div",{className:`h-2 w-2 rounded-full ${p?"bg-white":"bg-gray-500"}`}),h.isPending?"Toggling...":p?"Attendance On":"Attendance Off"]})}),e.jsx("div",{className:"flex gap-1 sm:gap-2",children:ne?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:re,disabled:P||Object.keys(x).length===0,className:"px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm font-medium rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer whitespace-nowrap",children:P?"Saving...":`Save (${Object.keys(x).length})`}),e.jsx("button",{onClick:de,disabled:P,className:"px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50 cursor-pointer whitespace-nowrap",children:"Cancel"})]}):e.jsx("button",{onClick:le,className:"px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm font-medium rounded bg-primary-600 text-white hover:bg-primary-700 cursor-pointer whitespace-nowrap",children:"Edit All"})})]}),e.jsxs("div",{className:"space-y-2 sm:overflow-x-auto sm:border sm:border-gray-200 sm:rounded-lg",children:[e.jsx("div",{className:"sm:hidden space-y-2",children:j.map(t=>{const s=t.status,n=x[t.nim]!==void 0,c=n?x[t.nim]:s;return e.jsxs("div",{className:"border border-gray-200 rounded-lg p-2 bg-white",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs font-semibold text-gray-900 break-words",children:t.nama}),e.jsx("p",{className:"text-xs text-gray-500 font-mono",children:t.nim})]}),!n&&e.jsx("span",{className:`flex-shrink-0 px-2 py-0.5 rounded text-xs font-medium inline-block ${s==="Hadir"?"bg-green-100 text-green-700":s==="Izin"||s==="Sakit"?"bg-yellow-100 text-yellow-700":s==="Terlambat"?"bg-blue-100 text-blue-700":s==="Pengganti"?"bg-purple-100 text-purple-700":s==="Belum Absen"?"bg-gray-100 text-gray-700":"bg-red-100 text-red-700"}`,children:s||"Belum Absen"})]}),n?e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"grid grid-cols-3 gap-0.5",children:["Hadir","Izin","Sakit","Alfa","Terlambat","Pengganti"].map(i=>e.jsx("button",{onClick:()=>o(r=>({...r,[t.nim]:i})),className:`px-1.5 py-1 text-xs font-medium rounded transition-colors cursor-pointer ${c===i?"bg-primary-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:i},i))}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:async()=>{await Z(t.nim,c,t.attendanceId),o(i=>{const r={...i};return delete r[t.nim],r})},disabled:u.isPending||g.isPending,className:"flex-1 px-2 py-1 text-xs font-medium rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 cursor-pointer",children:u.isPending||g.isPending?"Saving...":"Save"}),e.jsx("button",{onClick:()=>o(i=>{const r={...i};return delete r[t.nim],r}),disabled:u.isPending||g.isPending,className:"px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50 cursor-pointer",children:"X"})]})]}):e.jsx("button",{onClick:()=>o(i=>({...i,[t.nim]:s==="Belum Absen"?"Hadir":s||"Hadir"})),className:"w-full px-2 py-1 text-xs font-medium rounded bg-primary-600 text-white hover:bg-primary-700 cursor-pointer",children:"Edit"})]},t.nim)})}),e.jsx("table",{className:"hidden sm:table w-full text-xs sm:text-sm",children:e.jsx("tbody",{children:j.map(t=>{const s=t.status,n=x[t.nim]!==void 0,c=n?x[t.nim]:s;return e.jsxs("tr",{className:"border-b border-gray-100 hover:bg-gray-50",children:[e.jsx("td",{className:"px-2 sm:px-3 py-2 font-mono text-gray-900 whitespace-nowrap text-xs",children:t.nim}),e.jsx("td",{className:"px-2 sm:px-3 py-2 text-gray-900",children:t.nama}),e.jsx("td",{className:"px-2 sm:px-3 py-2",children:n?e.jsx("div",{className:"flex gap-1 flex-wrap",children:["Hadir","Izin","Sakit","Alfa","Terlambat","Pengganti"].map(i=>e.jsx("button",{onClick:()=>o(r=>({...r,[t.nim]:i})),className:`px-2 py-0.5 text-xs font-medium rounded transition-colors cursor-pointer ${c===i?"bg-primary-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:i},i))}):e.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-medium inline-block ${s==="Hadir"?"bg-green-100 text-green-700":s==="Izin"||s==="Sakit"?"bg-yellow-100 text-yellow-700":s==="Terlambat"?"bg-blue-100 text-blue-700":s==="Pengganti"?"bg-purple-100 text-purple-700":s==="Belum Absen"?"bg-gray-100 text-gray-700":"bg-red-100 text-red-700"}`,children:s||"Belum Absen"})}),e.jsx("td",{className:"px-2 sm:px-3 py-2 whitespace-nowrap",children:n?e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:async()=>{await Z(t.nim,c,t.attendanceId),o(i=>{const r={...i};return delete r[t.nim],r})},disabled:u.isPending||g.isPending,className:"px-2 py-1 text-xs font-medium rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 cursor-pointer",children:u.isPending||g.isPending?"Saving...":"Save"}),e.jsx("button",{onClick:()=>o(i=>{const r={...i};return delete r[t.nim],r}),disabled:u.isPending||g.isPending,className:"px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50 cursor-pointer",children:"Cancel"})]}):e.jsx("button",{onClick:()=>o(i=>({...i,[t.nim]:s==="Belum Absen"?"Hadir":s||"Hadir"})),className:"px-2 py-1 text-xs font-medium rounded bg-primary-600 text-white hover:bg-primary-700 cursor-pointer",children:"Edit"})})]},t.nim)})})})]})]})})]})]})]})}):null};export{De as A};
//# sourceMappingURL=AttendanceModal-B2J1rK3l.js.map
