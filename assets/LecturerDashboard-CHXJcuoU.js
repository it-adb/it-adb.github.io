import{b as Y,u as V,j as e}from"./query-vendor-B--u1oZD.js";import{u as X,r as m,g as Z}from"./react-vendor-XXJdR_Id.js";import{u as z,a as G,l as J,f as L,g as _,e as $}from"./index-BYG0ekbM.js";import{d as ee}from"./useClasses-BnXaOsS0.js";import{A as te}from"./AttendanceModal-CWoH1YFV.js";import{C as se}from"./Card-DDjmpwhs.js";import{s as b,u as M,i as f,f as ae,Y as re,c as ne}from"./ui-vendor-CkH0jJa3.js";import"./useAttendances-sywbn539.js";import"./useLecturerAssignments-BSprSVq5.js";const ce=l=>{const d=L(l);if(!d)return null;const c=d.getDay();return{1:"Monday",2:"Tuesday",3:"Wednesday",4:"Thursday",5:"Friday"}[c]||null},de=l=>{const d=_(l);if(!d)return"00:00";const c=d.match(/^(\d{1,2}):(\d{2})(?::\d{2})?$/);if(c){const o=c[1].padStart(2,"0"),p=c[2];return`${o}:${p}`}const u=d.split("T")[1];if(u){const o=u.split(".")[0].split("Z")[0],[p="00",N="00"]=o.split(":");return`${p.padStart(2,"0")}:${N.padStart(2,"0")}`}try{const o=new Date(d);if(!isNaN(o.getTime()))return o.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1})}catch{}return"00:00"},le=()=>{const l=new Date,d=l.getDay(),c=d===0?0:d,u=new Date(l);u.setDate(l.getDate()-c),u.setHours(0,0,0,0);const o=new Date(u);return o.setDate(u.getDate()+6),o.setHours(23,59,59,999),{start:u,end:o}},be=()=>{const{user:l,currentSemester:d}=z(),{t:c}=G(),u=X(),o=Y(),[p,N]=m.useState([]),[R,y]=m.useState(null),[I,A]=m.useState(null),[S,k]=m.useState({});m.useEffect(()=>{},[]),m.useEffect(()=>{const t=!!(l?.employeeId&&d);J.debug("LecturerDashboard - meetingRecapQuery enabled state:",t)},[l?.employeeId,d]);const{start:E,end:W}=Z.useMemo(()=>le(),[]),P=E.toISOString().split("T")[0],U=W.toISOString().split("T")[0],{data:j,isLoading:B}=ee(l?.employeeId||"",{semester:d,start_day:P,end_day:U}),F=!!(l?.employeeId!=null&&d),{data:h,isLoading:K}=V({queryKey:["lecturer-meeting-recap",l?.employeeId,d],queryFn:async()=>{if(!l?.employeeId||!d)return null;try{return await $.getLecturerMeetingRecap(l.employeeId,{semester:d})}catch(t){throw t}},enabled:F}),x=m.useMemo(()=>h?.classes?h.classes.map(t=>{const a=(Array.isArray(t.meetings)?t.meetings:[]).map(s=>{let r=Number(s.pertemuan_ke??s.pertemuanKe??s.pertemuan??0);Number.isNaN(r)&&(r=0);const n=s.recorded_attendances??s.recordedAttendances??s.total_attendances??s.total_attendances_count??0,i=Number(n)||0,g=s.attendance_complete??s.attendanceComplete,v=g===!0||g==="true"||g===1||g==="1"||(t.total_students?i>=Number(t.total_students):i>0),D=!!s.id_dosen;return{id:s.id,weekNumber:r,date:s.tgl_pertemuan?new Date(s.tgl_pertemuan):null,topic:s.topik??s.topic??void 0,studentAttendanceComplete:!!v,lecturerAssigned:D,totalStudents:Number(t.total_students??0),recordedAttendances:i,absensiAktif:!!(s.absensi_aktif??s.absensiAktif)}}).sort((s,r)=>{if((s.weekNumber??0)!==(r.weekNumber??0))return(s.weekNumber??0)-(r.weekNumber??0);const n=s.date?s.date.getTime():0,i=r.date?r.date.getTime():0;return n-i});return{classId:t.class_id,courseCode:t.kode_mk,courseName:t.course_name,className:t.class_name,sksTatapMuka:t.sks_tatap_muka,sksPraktek:t.sks_praktek,sksPrakLapangan:t.sks_prak_lapangan,sksSimulasi:t.sks_simulasi,meetings:a}}):[],[h]);m.useEffect(()=>{h&&console.debug("LecturerDashboard - raw meetingRecapData:",h),x&&x.length&&(console.debug("LecturerDashboard - mapped meetingRecaps:",x),x.forEach(t=>{console.debug(`LecturerDashboard - class ${t.classId} meetings:`,t.meetings.map(a=>({id:a.id,weekNumber:a.weekNumber,date:a.date,absensiAktif:a.absensiAktif,recorded:a.recordedAttendances,lecturerAssigned:a.lecturerAssigned,id_dosen:a.id_dosen})))}))},[h,x]),m.useEffect(()=>{const t=[];(Array.isArray(j)?j:[]).forEach(s=>{s&&Array.isArray(s.meeting_schedules)&&s.meeting_schedules.forEach(r=>{if(!r)return;const n=ce(r.tgl_pertemuan);if(!n)return;const i=de(r.jam_pertemuan),g=L(r.tgl_pertemuan);if(!g)return;const w=(s.sks_tatap_muka||0)+(s.sks_praktek||0)+(s.sks_prak_lapangan||0)+(s.sks_simulasi||0),v=w*60,[D,T]=i.split(":").map(Number),C=D*60+T+v,q=Math.floor(C/60)%24,H=C%60,O=`${String(q).padStart(2,"0")}:${String(H).padStart(2,"0")}`;t.push({id:`${s.kelas_id}-${r.id}`,day:n,startTime:i,endTime:O,courseCode:s.kode_mk,courseName:s.nama_mk,className:s.nama_kelas,credits:w,room:_(r.media_pembelajaran,"TBA"),topic:_(r.topik,""),weekNumber:r.pertemuan_ke,classId:s.kelas_id,actualDate:g,meetingId:r.id})})});const a=t.filter(s=>s.actualDate).map(s=>{const r=s.actualDate.getDay();return{...s,weekDay:{0:"Sunday",1:"Monday",2:"Tuesday",3:"Wednesday",4:"Thursday",5:"Friday",6:"Saturday"}[r]||"Monday"}}).sort((s,r)=>!s.actualDate||!r.actualDate?0:s.actualDate.getTime()-r.actualDate.getTime());N(a)},[j]);const Q=async(t,a,s)=>{t.stopPropagation(),A(a),k(r=>({...r,[a]:!s}));try{await $.updateMeeting(a,{absensi_aktif:!s}),await o.invalidateQueries({queryKey:["lecturer-meeting-recap",l?.employeeId,d]}),await o.invalidateQueries({queryKey:["class-meetings"]}),k(r=>{const n={...r};return delete n[a],n})}catch(r){console.error("Failed to toggle attendance:",r),k(n=>{const i={...n};return delete i[a],i})}finally{A(null)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Lecturer Dashboard"}),e.jsx("div",{className:"text-sm text-gray-500",children:"Academic Year 2024/2025"})]}),e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:c("lecturer.meetings")}),K?e.jsx("div",{className:"text-center py-8 text-gray-500",children:c("common.loading")}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("h3",{className:"text-xs font-semibold text-gray-700 mb-2",children:c("student.legend")}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(b,{className:"h-4 w-4 text-green-600 flex-shrink-0"}),e.jsx("span",{className:"text-gray-600",children:c("student.attendanceRecapComplete")})]},"student-complete"),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(b,{className:"h-4 w-4 text-orange-500 flex-shrink-0"}),e.jsx("span",{className:"text-gray-600",children:c("student.attendanceRecapPartial")})]},"student-partial"),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(M,{className:"h-4 w-4 text-gray-300 flex-shrink-0"}),e.jsx("span",{className:"text-gray-600",children:c("student.attendanceRecapIncomplete")})]},"student-incomplete"),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(f,{className:"h-4 w-4 text-blue-600 flex-shrink-0"}),e.jsx("span",{className:"text-gray-600",children:c("lecturer.lecturerAssigned")})]},"lecturer-assigned"),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(f,{className:"h-4 w-4 text-gray-300 flex-shrink-0"}),e.jsx("span",{className:"text-gray-600",children:c("lecturer.lecturerUnassigned")})]},"lecturer-unassigned"),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"h-2 w-2 rounded-full bg-green-600 flex-shrink-0"}),e.jsx("span",{className:"text-gray-600",children:c("lecturer.attendanceActive")})]},"attendance-active"),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"h-2 w-2 rounded-full bg-gray-400 flex-shrink-0"}),e.jsx("span",{className:"text-gray-600",children:c("lecturer.attendanceInactive")})]},"attendance-inactive")]})]}),x.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No classes found for this semester"}):e.jsx("div",{className:"space-y-3",children:x.map(t=>e.jsxs(se,{className:"p-0 overflow-hidden",children:[e.jsx("div",{className:"bg-gradient-to-r from-primary-50 to-secondary-50 px-3 py-2 border-b border-gray-200",children:e.jsxs("div",{className:"flex justify-between items-center gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("h4",{className:"font-semibold text-sm text-gray-900 truncate",children:[t.courseCode," - ",t.courseName]}),e.jsx("p",{className:"text-xs text-gray-600",children:t.className})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:[t.meetings.length," meeting",t.meetings.length!==1?"s":""]}),e.jsxs("button",{type:"button",onClick:()=>{u(`/class-summary/${t.classId}?courseCode=${encodeURIComponent(t.courseCode)}&courseName=${encodeURIComponent(t.courseName)}&className=${encodeURIComponent(t.className)}&sksTatapMuka=${t.sksTatapMuka}&sksPraktek=${t.sksPraktek}&sksPrakLapangan=${t.sksPrakLapangan}&sksSimulasi=${t.sksSimulasi}&from=lecturer/dashboard`)},className:"px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors flex items-center gap-1 text-xs whitespace-nowrap",title:"View attendance matrix",children:[e.jsx(ae,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"Summary"})]})]})]})}),e.jsx("div",{className:"p-3",children:e.jsx("div",{className:"flex gap-1 flex-wrap",children:t.meetings.map(a=>{const s=a.date?a.date.toLocaleDateString("en-US",{month:"short",day:"numeric"}):"",r=S[a.id]!==void 0?S[a.id]:a.absensiAktif;return e.jsxs("div",{role:"button",tabIndex:0,onClick:()=>{const n=a.date?new Date(a.date):void 0;console.log("LecturerDashboard Debug - Setting selectedMeeting with classId:",t.classId),y({meetingId:a.id,classId:t.classId,title:`${t.courseCode} • ${t.courseName}`,subtitle:`Week ${a.weekNumber}`,dateLabel:s,meetingDateTime:n,topic:a.topic||void 0})},onKeyDown:n=>{if(n.key==="Enter"||n.key===" "){n.preventDefault();const i=a.date?new Date(a.date):void 0;console.log("LecturerDashboard Debug - Setting selectedMeeting with classId:",t.classId),y({meetingId:a.id,classId:t.classId,title:`${t.courseCode} • ${t.courseName}`,subtitle:`Week ${a.weekNumber}`,dateLabel:s,meetingDateTime:i,topic:a.topic||void 0})}},className:"flex flex-col items-center gap-1 p-2 rounded border border-gray-200 hover:bg-gray-50 transition-colors cursor-pointer min-w-[80px] relative group focus:outline-none focus:ring-2 focus:ring-primary-200",title:`Week ${a.weekNumber} - ${s}${a.topic?` - ${a.topic}`:""}
Student Attendance: ${a.recordedAttendances}/${a.totalStudents}
Lecturer Attendance: ${a.lecturerAssigned?"Complete":"Incomplete"}
Attendance: ${a.absensiAktif?"Active":"Inactive"}`,children:[e.jsx("div",{className:"text-xs font-semibold text-gray-600",children:a.weekNumber}),e.jsxs("div",{className:"flex gap-1 items-center justify-center h-6",children:[a.studentAttendanceComplete?e.jsx(b,{className:"h-4 w-4 text-green-600"}):a.recordedAttendances>0?e.jsx(b,{className:"h-4 w-4 text-orange-500"}):e.jsx(M,{className:"h-4 w-4 text-gray-300"}),a.lecturerAssigned?e.jsx(f,{className:"h-4 w-4 text-blue-600"}):e.jsx(f,{className:"h-4 w-4 text-gray-300"})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center leading-tight",children:s||"-"}),e.jsx("div",{className:"flex items-center justify-center gap-1",children:e.jsx("div",{className:`h-2 w-2 rounded-full ${r?"bg-green-600":"bg-gray-400"}`})}),e.jsx("button",{type:"button",onClick:n=>Q(n,a.id,r),disabled:I===a.id,"aria-label":r?"Deactivate attendance":"Activate attendance",onMouseEnter:n=>{n.currentTarget.style.opacity="1"},onMouseLeave:n=>{n.currentTarget.style.opacity="0.25"},className:"absolute bottom-1 right-1 p-1.5 rounded bg-white border border-gray-200 hover:bg-gray-50 disabled:opacity-50 transition-opacity shadow-sm cursor-pointer",style:{opacity:.25},title:r?"Deactivate Attendance":"Activate Attendance",children:I===a.id?e.jsx(re,{className:"h-3.5 w-3.5 text-gray-600 animate-spin"}):e.jsx("div",{className:`h-3.5 w-3.5 rounded-full border-2 ${r?"bg-green-600 border-green-600":"border-gray-300"}`})})]},a.id)})})})]},t.classId))})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:c("lecturerDashboard.thisWeekSchedule")}),B?e.jsx("div",{className:"text-center py-8 text-gray-500",children:c("lecturerDashboard.loadingSchedule")}):p.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:c("lecturerDashboard.noClasses")}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:p.map(t=>{const a=t.actualDate?new Date(t.actualDate):null;if(a&&t.startTime){const[s,r]=t.startTime.split(":").map(Number);a.setHours(s,r,0,0)}return e.jsxs("button",{type:"button",onClick:()=>y({meetingId:t.meetingId,classId:t.classId,title:`${t.courseCode} • ${t.courseName}`,subtitle:`Week ${t.weekNumber}`,dateLabel:t.actualDate?.toLocaleDateString("id-ID",{weekday:"short",day:"numeric",month:"short"}),meetingDateTime:a||void 0,topic:t.topic||void 0}),className:"text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors flex flex-col cursor-pointer",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"inline-block px-2.5 py-0.5 bg-primary-100 text-primary-700 text-xs font-semibold rounded",children:t.weekDay}),t.actualDate&&e.jsx("span",{className:"text-xs text-gray-500 px-2 py-0.5 bg-gray-100 rounded",children:t.actualDate.toLocaleDateString("id-ID",{day:"numeric",month:"short"})})]}),e.jsxs("span",{className:"text-xs text-gray-500",children:[c("lecturerDashboard.week")," ",t.weekNumber]})]}),e.jsx("div",{className:"text-xs font-semibold text-primary-600 mb-1",children:t.courseCode}),e.jsx("h3",{className:"text-xs font-medium text-gray-900 line-clamp-2 mb-1",children:t.courseName})]}),e.jsx("div",{className:"flex flex-col gap-1 text-xs text-gray-600 border-t border-gray-100 pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(ne,{className:"h-3 w-3 flex-shrink-0"}),e.jsxs("span",{children:[t.startTime," - ",t.endTime]})]})})]},t.id)})})]}),e.jsx(te,{selectedMeeting:R,onClose:()=>y(null)})]})};export{be as default};
//# sourceMappingURL=LecturerDashboard-CHXJcuoU.js.map
