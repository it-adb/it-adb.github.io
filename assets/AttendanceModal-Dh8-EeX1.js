import{d as de,j as e}from"./query-vendor-B--u1oZD.js";import{g as l}from"./react-vendor-XXJdR_Id.js";import{c as P,b as le}from"./index-U_9acvuP.js";import{g as T}from"./status-sB_rSvKV.js";import{d as oe,f as ce,c as me,e as xe,u as ue,a as ge,b as pe}from"./useLecturerAssignments-DiRZGo_n.js";import{g as V,i as he,W as be}from"./ui-vendor-C-UqR_Df.js";const A=(n,y="")=>n?typeof n=="string"?n:"String"in n&&typeof n.String=="string"?n.String:"Time"in n&&typeof n.Time=="string"?n.Time:P(n,y):y,Se=({selectedMeeting:n,onClose:y})=>{const{data:_,isLoading:X}=oe(n?.classId),{data:L,isLoading:Y}=ce(n?.meetingId),{data:f,refetch:G}=me(n?.classId),j=l.useMemo(()=>_??[],[_]),$=l.useMemo(()=>L??[],[L]),{data:M=[]}=xe({id_kelas:n?.classId?String(n.classId):void 0}),B=l.useMemo(()=>{const t=new Set;return M.forEach(s=>{const a=P(s.id_dosen);a&&t.add(a)}),Array.from(t)},[M]),H=de({queries:B.map(t=>({queryKey:["lecturer",t],queryFn:()=>le.getLecturerByID(t),enabled:!!t}))}),D=l.useMemo(()=>{const t={};return H.forEach(s=>{const a=s.data;a?.id&&a?.nama_dosen&&(t[a.id]=a.nama_dosen)}),t},[H]),o=l.useMemo(()=>{if(!n||!f||f.length===0)return null;const t=f.find(E=>E.id===n.meetingId);if(!t)return null;let s="",a="",d="",i="";s=A(t.tgl_pertemuan,""),a=A(t.jam_pertemuan,""),d=A(t.topik,""),i=A(t.id_dosen,""),console.log("ðŸ“… Meeting data from API:",{tglPertemuan:s,jamPertemuan:a,topik:d,idDosen:i,rawData:t.tgl_pertemuan});let r;if(s&&a){const E=s.includes("T")?s.split("T")[0]:s.split(" ")[0]||s,re=a.length===5?`${a}:00`:a.split(".")[0]||a,K=`${E}T${re}`;r=new Date(K),console.log("ðŸ“… Parsed meeting datetime:",K,"â†’",r)}else console.warn("âš ï¸ Missing date or time:",{tglPertemuan:s,jamPertemuan:a});return{meetingDateTime:r,topic:d,lecturerId:i}},[n,f]),x=ue(),u=ge(),w=pe(),[m,c]=l.useState({}),[J,N]=l.useState(!1),[C,F]=l.useState(!1),[v,S]=l.useState(!1),[h,U]=l.useState(""),[p,z]=l.useState(""),[k,R]=l.useState(""),[I,q]=l.useState(""),b=l.useMemo(()=>{if(!j||j.length===0)return[];const t=new Map($.map(s=>[s.nim,{status:P(s.status_kehadiran,""),id:s.id}]));return j.map(s=>{const a=t.get(s.nim);return{...s,status:a?.status||"Belum Absen",attendanceId:a?.id}})},[j,$]),Z=l.useMemo(()=>{const t=o?.meetingDateTime||n?.meetingDateTime;if(!t)return!1;const s=new Date,a=new Date(t),d=new Date(a.getTime()-300*1e3);return s>=d},[o?.meetingDateTime,n?.meetingDateTime]),O=async(t,s,a)=>{if(!n)return;const d=new Date().toISOString();try{a?await u.mutateAsync({id:a,data:{status_kehadiran:s,waktu_masuk:d}}):await x.mutateAsync({id_pertemuan:n.meetingId,nim:t,status_kehadiran:s,waktu_masuk:d})}catch(i){console.error("Failed to update attendance:",i),alert(`Failed to update attendance: ${i instanceof Error?i.message:"Unknown error"}`)}},ee=async()=>{if(!n||Object.keys(m).length===0)return;F(!0);const t=[],s=new Date().toISOString();for(const a of Object.keys(m)){const d=m[a],i=b.find(r=>r.nim===a);if(i)try{i.attendanceId?await u.mutateAsync({id:i.attendanceId,data:{status_kehadiran:d,waktu_masuk:s}}):await x.mutateAsync({id_pertemuan:n.meetingId,nim:a,status_kehadiran:d,waktu_masuk:s})}catch(r){console.error(`Failed to update attendance for ${a}:`,r),t.push(`${i.nama} (${a})`)}}F(!1),t.length>0?alert(`Failed to update attendance for: ${t.join(", ")}`):(c({}),N(!1))},te=()=>{const t={};b.forEach(s=>{t[s.nim]=s.status==="Belum Absen"?"Hadir":s.status||"Hadir"}),c(t),N(!0)},se=()=>{c({}),N(!1)},ae=async()=>{if(!(!n||!h||!p))try{const t=p.length===5?`${p}:00`:p;console.log("ðŸ’¾ Saving meeting update:",{id:n.meetingId,tgl_pertemuan:h,jam_pertemuan:t,topik:k||void 0,id_dosen:I||void 0}),await w.mutateAsync({id:n.meetingId,data:{tgl_pertemuan:h,jam_pertemuan:t,topik:k||void 0,id_dosen:I||void 0}}),console.log("âœ… Meeting saved, refetching data..."),await G(),console.log("âœ… Data refetched"),S(!1),alert("Meeting schedule updated successfully!")}catch(t){console.error("Failed to update meeting:",t),alert(`Failed to update meeting: ${t instanceof Error?t.message:"Unknown error"}`)}};l.useEffect(()=>{const t=o?.meetingDateTime||n?.meetingDateTime,s=o?.topic||n?.topic||"",a=o?.lecturerId||"";if(t){const d=new Date(t),i=d.toISOString().split("T")[0],r=`${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;U(i),z(r),R(s),q(a)}},[o?.meetingDateTime,o?.topic,o?.lecturerId,n?.meetingDateTime,n?.topic]);const ne=()=>{S(!0)},ie=()=>{c({}),N(!1),S(!1),y()},g=o?.meetingDateTime||n?.meetingDateTime,Q=l.useMemo(()=>g?new Date(g).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric"}):n?.dateLabel,[g,n?.dateLabel]),W=o?.topic||n?.topic;return n?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-2 sm:p-4 bg-black/30",children:e.jsxs("div",{className:"w-full h-full max-h-screen sm:max-h-[90vh] max-w-sm sm:max-w-2xl lg:max-w-4xl bg-white rounded-lg shadow-lg flex flex-col",children:[e.jsxs("div",{className:"px-3 sm:px-4 py-3 border-b border-gray-200 flex items-center justify-between flex-shrink-0",children:[e.jsxs("div",{className:"flex-1 min-w-0 pr-2",children:[e.jsx("div",{className:"text-xs sm:text-sm text-gray-500 truncate",children:n.subtitle}),e.jsx("h3",{className:"text-sm sm:text-base font-semibold text-gray-900 line-clamp-2",children:n.title}),Q&&e.jsx("div",{className:"text-xs text-gray-500 mt-0.5",children:Q}),g&&e.jsxs("div",{className:"text-xs text-gray-600 mt-0.5 font-medium",children:[e.jsx(V,{className:"inline h-3 w-3 mr-1"}),new Date(g).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1})]}),W&&!v&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1 italic",children:["Topic: ",W]}),o?.lecturerId&&D[o.lecturerId]&&!v&&e.jsxs("div",{className:"text-xs text-gray-600 mt-0.5 flex items-center",children:[e.jsx(he,{className:"inline h-3 w-3 mr-1"}),D[o.lecturerId]]})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2 flex-shrink-0",children:[!v&&e.jsxs("button",{onClick:ne,className:"px-2 py-1 text-xs font-medium rounded bg-blue-600 text-white hover:bg-blue-700 cursor-pointer flex items-center gap-1 whitespace-nowrap",title:"Edit meeting schedule",children:[e.jsx(be,{className:"h-3 w-3"}),e.jsx("span",{className:"hidden sm:inline",children:"Edit Schedule"}),e.jsx("span",{className:"sm:hidden",children:"Edit"})]}),e.jsx("button",{onClick:ie,className:"px-2 py-1 text-sm rounded hover:bg-gray-100 cursor-pointer","aria-label":"Close",children:"Close"})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-3 sm:p-4",children:[v&&e.jsxs("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Edit Meeting Schedule"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Date"}),e.jsx("input",{type:"date",value:h,onChange:t=>U(t.target.value),className:"input-field w-full text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Time"}),e.jsx("input",{type:"time",value:p,onChange:t=>z(t.target.value),className:"input-field w-full text-sm"})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Topic/Description (Optional)"}),e.jsx("textarea",{value:k,onChange:t=>R(t.target.value),className:"input-field w-full text-sm",rows:3,placeholder:"Enter meeting topic or description...",maxLength:500}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[k.length,"/500 characters"]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Lecturer (Optional)"}),e.jsxs("select",{value:I,onChange:t=>q(t.target.value),className:"input-field w-full text-sm",children:[e.jsx("option",{value:"",children:"- No Lecturer -"}),B.map(t=>e.jsx("option",{value:t,children:D[t]||t},t))]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:ae,disabled:w.isPending||!h||!p,className:"px-3 py-1.5 text-sm font-medium rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer",children:w.isPending?"Saving...":"Save Changes"}),e.jsx("button",{onClick:()=>S(!1),disabled:w.isPending,className:"px-3 py-1.5 text-sm font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50 cursor-pointer",children:"Cancel"})]})]}),Z?X||Y?e.jsx("div",{className:"text-center text-gray-500 py-6",children:"Loading students and attendances..."}):b.length===0?e.jsx("div",{className:"text-center text-gray-500 py-6",children:"No students found for this class."}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-3 sm:mb-4 flex gap-1 sm:gap-2 justify-end flex-wrap",children:J?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:ee,disabled:C||Object.keys(m).length===0,className:"px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm font-medium rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer whitespace-nowrap",children:C?"Saving...":`Save (${Object.keys(m).length})`}),e.jsx("button",{onClick:se,disabled:C,className:"px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50 cursor-pointer whitespace-nowrap",children:"Cancel"})]}):e.jsx("button",{onClick:te,className:"px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm font-medium rounded bg-primary-600 text-white hover:bg-primary-700 cursor-pointer whitespace-nowrap",children:"Edit All"})}),e.jsxs("div",{className:"space-y-2 sm:overflow-x-auto sm:border sm:border-gray-200 sm:rounded-lg",children:[e.jsx("div",{className:"sm:hidden space-y-2",children:b.map(t=>{const s=t.status,a=m[t.nim]!==void 0,d=a?m[t.nim]:s;return e.jsxs("div",{className:"border border-gray-200 rounded-lg p-2 bg-white",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs font-semibold text-gray-900 break-words",children:t.nama}),e.jsx("p",{className:"text-xs text-gray-500 font-mono",children:t.nim})]}),!a&&e.jsx("span",{className:`flex-shrink-0 px-2 py-0.5 rounded text-xs font-medium inline-block ${s==="Hadir"?"bg-green-100 text-green-700":s==="Izin"||s==="Sakit"?"bg-yellow-100 text-yellow-700":s==="Terlambat"?"bg-blue-100 text-blue-700":s==="Pengganti"?"bg-purple-100 text-purple-700":s==="Belum Absen"?"bg-gray-100 text-gray-700":"bg-red-100 text-red-700"}`,children:T(s)||"Belum Absen"})]}),a?e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"grid grid-cols-3 gap-0.5",children:["Hadir","Izin","Sakit","Alfa","Terlambat","Pengganti"].map(i=>e.jsx("button",{onClick:()=>c(r=>({...r,[t.nim]:i})),className:`px-1.5 py-1 text-xs font-medium rounded transition-colors cursor-pointer ${d===i?"bg-primary-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:T(i)},i))}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:async()=>{await O(t.nim,d,t.attendanceId),c(i=>{const r={...i};return delete r[t.nim],r})},disabled:x.isPending||u.isPending,className:"flex-1 px-2 py-1 text-xs font-medium rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 cursor-pointer",children:x.isPending||u.isPending?"Saving...":"Save"}),e.jsx("button",{onClick:()=>c(i=>{const r={...i};return delete r[t.nim],r}),disabled:x.isPending||u.isPending,className:"px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50 cursor-pointer",children:"X"})]})]}):e.jsx("button",{onClick:()=>c(i=>({...i,[t.nim]:s==="Belum Absen"?"Hadir":s||"Hadir"})),className:"w-full px-2 py-1 text-xs font-medium rounded bg-primary-600 text-white hover:bg-primary-700 cursor-pointer",children:"Edit"})]},t.nim)})}),e.jsxs("table",{className:"hidden sm:table w-full text-xs sm:text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 border-b border-gray-200",children:[e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-semibold text-gray-700 whitespace-nowrap",children:"NIM"}),e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-semibold text-gray-700",children:"Name"}),e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Status"}),e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Action"})]})}),e.jsx("tbody",{children:b.map(t=>{const s=t.status,a=m[t.nim]!==void 0,d=a?m[t.nim]:s;return e.jsxs("tr",{className:"border-b border-gray-100 hover:bg-gray-50",children:[e.jsx("td",{className:"px-2 sm:px-3 py-2 font-mono text-gray-900 whitespace-nowrap text-xs",children:t.nim}),e.jsx("td",{className:"px-2 sm:px-3 py-2 text-gray-900",children:t.nama}),e.jsx("td",{className:"px-2 sm:px-3 py-2",children:a?e.jsx("div",{className:"flex gap-1 flex-wrap",children:["Hadir","Izin","Sakit","Alfa","Terlambat","Pengganti"].map(i=>e.jsx("button",{onClick:()=>c(r=>({...r,[t.nim]:i})),className:`px-2 py-0.5 text-xs font-medium rounded transition-colors cursor-pointer ${d===i?"bg-primary-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:T(i)},i))}):e.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-medium inline-block ${s==="Hadir"?"bg-green-100 text-green-700":s==="Izin"||s==="Sakit"?"bg-yellow-100 text-yellow-700":s==="Terlambat"?"bg-blue-100 text-blue-700":s==="Pengganti"?"bg-purple-100 text-purple-700":s==="Belum Absen"?"bg-gray-100 text-gray-700":"bg-red-100 text-red-700"}`,children:T(s)||"Belum Absen"})}),e.jsx("td",{className:"px-2 sm:px-3 py-2 whitespace-nowrap",children:a?e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:async()=>{await O(t.nim,d,t.attendanceId),c(i=>{const r={...i};return delete r[t.nim],r})},disabled:x.isPending||u.isPending,className:"px-2 py-1 text-xs font-medium rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 cursor-pointer",children:x.isPending||u.isPending?"Saving...":"Save"}),e.jsx("button",{onClick:()=>c(i=>{const r={...i};return delete r[t.nim],r}),disabled:x.isPending||u.isPending,className:"px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50 cursor-pointer",children:"Cancel"})]}):e.jsx("button",{onClick:()=>c(i=>({...i,[t.nim]:s==="Belum Absen"?"Hadir":s||"Hadir"})),className:"px-2 py-1 text-xs font-medium rounded bg-primary-600 text-white hover:bg-primary-700 cursor-pointer",children:"Edit"})})]},t.nim)})})]})]})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(V,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Attendance Not Available Yet"}),e.jsx("p",{className:"text-gray-600",children:"Attendance editing will be available 5 minutes before the class starts."}),g&&e.jsxs("p",{className:"text-sm text-gray-500 mt-2",children:["Class starts at: ",new Date(g).toLocaleString("en-US",{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})]})]})]})]})}):null};export{Se as A};
//# sourceMappingURL=AttendanceModal-Dh8-EeX1.js.map
