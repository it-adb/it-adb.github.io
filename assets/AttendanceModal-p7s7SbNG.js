import{d as oe,j as e}from"./query-vendor-B--u1oZD.js";import{g as o}from"./react-vendor-XXJdR_Id.js";import{c as P,b as ce}from"./index-BFadXLuC.js";import{d as me,e as xe,c as ue,u as ge,a as pe,b as he}from"./useAttendances-BRO_9oj9.js";import{u as be}from"./useLecturerAssignments-DTgRc4eP.js";import{g as Y,i as fe,W as ye}from"./ui-vendor-Bvty7Z9l.js";const T=(n,j="")=>n?typeof n=="string"?n:"String"in n&&typeof n.String=="string"?n.String:"Time"in n&&typeof n.Time=="string"?n.Time:P(n,j):j,Ae=({selectedMeeting:n,onClose:j})=>{const{data:L,isLoading:G}=me(n?.classId),{data:$,isLoading:J}=xe(n?.meetingId),{data:w,refetch:Z}=ue(n?.classId),N=o.useMemo(()=>L??[],[L]),B=o.useMemo(()=>$??[],[$]),{data:M=[]}=be({id_kelas:n?.classId?String(n.classId):void 0}),H=o.useMemo(()=>{const t=new Set;return M.forEach(s=>{const a=P(s.id_dosen);a&&t.add(a)}),Array.from(t)},[M]),F=oe({queries:H.map(t=>({queryKey:["lecturer",t],queryFn:()=>ce.getLecturerByID(t),enabled:!!t}))}),D=o.useMemo(()=>{const t={};return F.forEach(s=>{const a=s.data;a?.id&&a?.nama_dosen&&(t[a.id]=a.nama_dosen)}),t},[F]),l=o.useMemo(()=>{if(!n||!w||w.length===0)return null;const t=w.find(E=>E.id===n.meetingId);if(!t)return null;let s="",a="",d="",i="";s=T(t.tgl_pertemuan,""),a=T(t.jam_pertemuan,""),d=T(t.topik,""),i=T(t.id_dosen,"");let r=!1;t.absensi_aktif!==null&&t.absensi_aktif!==void 0&&(typeof t.absensi_aktif=="boolean"?r=t.absensi_aktif:typeof t.absensi_aktif=="object"&&"Bool"in t.absensi_aktif&&(r=t.absensi_aktif.Valid?t.absensi_aktif.Bool:!1)),console.log("ðŸ“… Meeting data from API:",{tglPertemuan:s,jamPertemuan:a,topik:d,idDosen:i,absensiAktif:r,rawData:t.tgl_pertemuan});let y;if(s&&a){const E=s.includes("T")?s.split("T")[0]:s.split(" ")[0]||s,le=a.length===5?`${a}:00`:a.split(".")[0]||a,X=`${E}T${le}`;y=new Date(X),console.log("ðŸ“… Parsed meeting datetime:",X,"â†’",y)}else console.warn("âš ï¸ Missing date or time:",{tglPertemuan:s,jamPertemuan:a});return{meetingDateTime:y,topic:d,lecturerId:i,absensiAktif:r}},[n,w]),x=ge(),u=pe(),k=he(),[m,c]=o.useState({}),[ee,v]=o.useState(!1),[_,U]=o.useState(!1),[h,S]=o.useState(!1),[b,z]=o.useState(""),[p,R]=o.useState(""),[A,q]=o.useState(""),[C,W]=o.useState(""),[I,O]=o.useState(!1),f=o.useMemo(()=>{if(!N||N.length===0)return[];const t=new Map(B.map(s=>[s.nim,{status:P(s.status_kehadiran,""),id:s.id}]));return N.map(s=>{const a=t.get(s.nim);return{...s,status:a?.status||"Belum Absen",attendanceId:a?.id}})},[N,B]),te=o.useMemo(()=>{const t=l?.meetingDateTime||n?.meetingDateTime;if(!t)return!1;const s=new Date,a=new Date(t),d=new Date(a.getTime()-300*1e3);return s>=d},[l?.meetingDateTime,n?.meetingDateTime]),Q=async(t,s,a)=>{if(!n)return;const d=new Date().toISOString();try{a?await u.mutateAsync({id:a,data:{status_kehadiran:s,waktu_masuk:d}}):await x.mutateAsync({id_pertemuan:n.meetingId,nim:t,status_kehadiran:s,waktu_masuk:d})}catch(i){console.error("Failed to update attendance:",i),alert(`Failed to update attendance: ${i instanceof Error?i.message:"Unknown error"}`)}},se=async()=>{if(!n||Object.keys(m).length===0)return;U(!0);const t=[],s=new Date().toISOString();for(const a of Object.keys(m)){const d=m[a],i=f.find(r=>r.nim===a);if(i)try{i.attendanceId?await u.mutateAsync({id:i.attendanceId,data:{status_kehadiran:d,waktu_masuk:s}}):await x.mutateAsync({id_pertemuan:n.meetingId,nim:a,status_kehadiran:d,waktu_masuk:s})}catch(r){console.error(`Failed to update attendance for ${a}:`,r),t.push(`${i.nama} (${a})`)}}U(!1),t.length>0?alert(`Failed to update attendance for: ${t.join(", ")}`):(c({}),v(!1))},ae=()=>{const t={};f.forEach(s=>{t[s.nim]=s.status==="Belum Absen"?"Hadir":s.status||"Hadir"}),c(t),v(!0)},ne=()=>{c({}),v(!1)},ie=async()=>{if(!(!n||!b||!p))try{const t=p.length===5?`${p}:00`:p;console.log("ðŸ’¾ Saving meeting update:",{id:n.meetingId,tgl_pertemuan:b,jam_pertemuan:t,topik:A||void 0,id_dosen:C||void 0,absensi_aktif:I}),await k.mutateAsync({id:n.meetingId,data:{tgl_pertemuan:b,jam_pertemuan:t,topik:A||void 0,id_dosen:C||void 0,absensi_aktif:I}}),console.log("âœ… Meeting saved, refetching data..."),await Z(),console.log("âœ… Data refetched"),S(!1),alert("Meeting schedule updated successfully!")}catch(t){console.error("Failed to update meeting:",t),alert(`Failed to update meeting: ${t instanceof Error?t.message:"Unknown error"}`)}};o.useEffect(()=>{const t=l?.meetingDateTime||n?.meetingDateTime,s=l?.topic||n?.topic||"",a=l?.lecturerId||"",d=l?.absensiAktif||!1;if(t){const i=new Date(t),r=i.toISOString().split("T")[0],y=`${String(i.getHours()).padStart(2,"0")}:${String(i.getMinutes()).padStart(2,"0")}`;z(r),R(y),q(s),W(a),O(d)}},[l?.meetingDateTime,l?.topic,l?.lecturerId,l?.absensiAktif,n?.meetingDateTime,n?.topic]);const re=()=>{S(!0)},de=()=>{c({}),v(!1),S(!1),j()},g=l?.meetingDateTime||n?.meetingDateTime,V=o.useMemo(()=>g?new Date(g).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric"}):n?.dateLabel,[g,n?.dateLabel]),K=l?.topic||n?.topic;return n?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-2 sm:p-4 bg-black/30",children:e.jsxs("div",{className:"w-full h-full max-h-screen sm:max-h-[90vh] max-w-sm sm:max-w-2xl lg:max-w-4xl bg-white rounded-lg shadow-lg flex flex-col",children:[e.jsxs("div",{className:"px-3 sm:px-4 py-3 border-b border-gray-200 flex items-center justify-between flex-shrink-0",children:[e.jsxs("div",{className:"flex-1 min-w-0 pr-2",children:[e.jsx("div",{className:"text-xs sm:text-sm text-gray-500 truncate",children:n.subtitle}),e.jsx("h3",{className:"text-sm sm:text-base font-semibold text-gray-900 line-clamp-2",children:n.title}),V&&e.jsx("div",{className:"text-xs text-gray-500 mt-0.5",children:V}),g&&e.jsxs("div",{className:"text-xs text-gray-600 mt-0.5 font-medium",children:[e.jsx(Y,{className:"inline h-3 w-3 mr-1"}),new Date(g).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1})]}),K&&!h&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1 italic",children:["Topic: ",K]}),l?.lecturerId&&D[l.lecturerId]&&!h&&e.jsxs("div",{className:"text-xs text-gray-600 mt-0.5 flex items-center",children:[e.jsx(fe,{className:"inline h-3 w-3 mr-1"}),D[l.lecturerId]]}),!h&&e.jsxs("div",{className:`text-xs mt-1 flex items-center gap-1 ${l?.absensiAktif?"text-green-600":"text-gray-500"}`,children:[e.jsx("div",{className:`h-2 w-2 rounded-full ${l?.absensiAktif?"bg-green-600":"bg-gray-400"}`}),e.jsxs("span",{children:["Attendance ",l?.absensiAktif?"Enabled":"Disabled"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2 flex-shrink-0",children:[!h&&e.jsxs("button",{onClick:re,className:"px-2 py-1 text-xs font-medium rounded bg-blue-600 text-white hover:bg-blue-700 cursor-pointer flex items-center gap-1 whitespace-nowrap",title:"Edit meeting schedule",children:[e.jsx(ye,{className:"h-3 w-3"}),e.jsx("span",{className:"hidden sm:inline",children:"Edit Schedule"}),e.jsx("span",{className:"sm:hidden",children:"Edit"})]}),e.jsx("button",{onClick:de,className:"px-2 py-1 text-sm rounded hover:bg-gray-100 cursor-pointer","aria-label":"Close",children:"Close"})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-3 sm:p-4",children:[h&&e.jsxs("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Edit Meeting Schedule"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Date"}),e.jsx("input",{type:"date",value:b,onChange:t=>z(t.target.value),className:"input-field w-full text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Time"}),e.jsx("input",{type:"time",value:p,onChange:t=>R(t.target.value),className:"input-field w-full text-sm"})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Topic"}),e.jsx("textarea",{value:A,onChange:t=>q(t.target.value),className:"input-field w-full text-sm",rows:3,placeholder:"Enter meeting topic or description...",maxLength:500}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[A.length,"/500 characters"]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Lecturer (Optional)"}),e.jsxs("select",{value:C,onChange:t=>W(t.target.value),className:"input-field w-full text-sm",children:[e.jsx("option",{value:"",children:"- No Lecturer -"}),H.map(t=>e.jsx("option",{value:t,children:D[t]||t},t))]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{className:"flex items-center gap-2 text-xs font-medium text-gray-700",children:[e.jsx("input",{type:"checkbox",checked:I,onChange:t=>O(t.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{children:"Enable Attendance for this Meeting"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1 ml-6",children:"When enabled, students can check-in for attendance"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:ie,disabled:k.isPending||!b||!p,className:"px-3 py-1.5 text-sm font-medium rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer",children:k.isPending?"Saving...":"Save Changes"}),e.jsx("button",{onClick:()=>S(!1),disabled:k.isPending,className:"px-3 py-1.5 text-sm font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50 cursor-pointer",children:"Cancel"})]})]}),te?G||J?e.jsx("div",{className:"text-center text-gray-500 py-6",children:"Loading students and attendances..."}):f.length===0?e.jsx("div",{className:"text-center text-gray-500 py-6",children:"No students found for this class."}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-3 sm:mb-4 flex gap-1 sm:gap-2 justify-end flex-wrap",children:ee?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:se,disabled:_||Object.keys(m).length===0,className:"px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm font-medium rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer whitespace-nowrap",children:_?"Saving...":`Save (${Object.keys(m).length})`}),e.jsx("button",{onClick:ne,disabled:_,className:"px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50 cursor-pointer whitespace-nowrap",children:"Cancel"})]}):e.jsx("button",{onClick:ae,className:"px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm font-medium rounded bg-primary-600 text-white hover:bg-primary-700 cursor-pointer whitespace-nowrap",children:"Edit All"})}),e.jsxs("div",{className:"space-y-2 sm:overflow-x-auto sm:border sm:border-gray-200 sm:rounded-lg",children:[e.jsx("div",{className:"sm:hidden space-y-2",children:f.map(t=>{const s=t.status,a=m[t.nim]!==void 0,d=a?m[t.nim]:s;return e.jsxs("div",{className:"border border-gray-200 rounded-lg p-2 bg-white",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs font-semibold text-gray-900 break-words",children:t.nama}),e.jsx("p",{className:"text-xs text-gray-500 font-mono",children:t.nim})]}),!a&&e.jsx("span",{className:`flex-shrink-0 px-2 py-0.5 rounded text-xs font-medium inline-block ${s==="Hadir"?"bg-green-100 text-green-700":s==="Izin"||s==="Sakit"?"bg-yellow-100 text-yellow-700":s==="Terlambat"?"bg-blue-100 text-blue-700":s==="Pengganti"?"bg-purple-100 text-purple-700":s==="Belum Absen"?"bg-gray-100 text-gray-700":"bg-red-100 text-red-700"}`,children:s||"Belum Absen"})]}),a?e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"grid grid-cols-3 gap-0.5",children:["Hadir","Izin","Sakit","Alfa","Terlambat","Pengganti"].map(i=>e.jsx("button",{onClick:()=>c(r=>({...r,[t.nim]:i})),className:`px-1.5 py-1 text-xs font-medium rounded transition-colors cursor-pointer ${d===i?"bg-primary-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:i},i))}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:async()=>{await Q(t.nim,d,t.attendanceId),c(i=>{const r={...i};return delete r[t.nim],r})},disabled:x.isPending||u.isPending,className:"flex-1 px-2 py-1 text-xs font-medium rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 cursor-pointer",children:x.isPending||u.isPending?"Saving...":"Save"}),e.jsx("button",{onClick:()=>c(i=>{const r={...i};return delete r[t.nim],r}),disabled:x.isPending||u.isPending,className:"px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50 cursor-pointer",children:"X"})]})]}):e.jsx("button",{onClick:()=>c(i=>({...i,[t.nim]:s==="Belum Absen"?"Hadir":s||"Hadir"})),className:"w-full px-2 py-1 text-xs font-medium rounded bg-primary-600 text-white hover:bg-primary-700 cursor-pointer",children:"Edit"})]},t.nim)})}),e.jsxs("table",{className:"hidden sm:table w-full text-xs sm:text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 border-b border-gray-200",children:[e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-semibold text-gray-700 whitespace-nowrap",children:"NIM"}),e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-semibold text-gray-700",children:"Name"}),e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Status"}),e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Action"})]})}),e.jsx("tbody",{children:f.map(t=>{const s=t.status,a=m[t.nim]!==void 0,d=a?m[t.nim]:s;return e.jsxs("tr",{className:"border-b border-gray-100 hover:bg-gray-50",children:[e.jsx("td",{className:"px-2 sm:px-3 py-2 font-mono text-gray-900 whitespace-nowrap text-xs",children:t.nim}),e.jsx("td",{className:"px-2 sm:px-3 py-2 text-gray-900",children:t.nama}),e.jsx("td",{className:"px-2 sm:px-3 py-2",children:a?e.jsx("div",{className:"flex gap-1 flex-wrap",children:["Hadir","Izin","Sakit","Alfa","Terlambat","Pengganti"].map(i=>e.jsx("button",{onClick:()=>c(r=>({...r,[t.nim]:i})),className:`px-2 py-0.5 text-xs font-medium rounded transition-colors cursor-pointer ${d===i?"bg-primary-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:i},i))}):e.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-medium inline-block ${s==="Hadir"?"bg-green-100 text-green-700":s==="Izin"||s==="Sakit"?"bg-yellow-100 text-yellow-700":s==="Terlambat"?"bg-blue-100 text-blue-700":s==="Pengganti"?"bg-purple-100 text-purple-700":s==="Belum Absen"?"bg-gray-100 text-gray-700":"bg-red-100 text-red-700"}`,children:s||"Belum Absen"})}),e.jsx("td",{className:"px-2 sm:px-3 py-2 whitespace-nowrap",children:a?e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:async()=>{await Q(t.nim,d,t.attendanceId),c(i=>{const r={...i};return delete r[t.nim],r})},disabled:x.isPending||u.isPending,className:"px-2 py-1 text-xs font-medium rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 cursor-pointer",children:x.isPending||u.isPending?"Saving...":"Save"}),e.jsx("button",{onClick:()=>c(i=>{const r={...i};return delete r[t.nim],r}),disabled:x.isPending||u.isPending,className:"px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50 cursor-pointer",children:"Cancel"})]}):e.jsx("button",{onClick:()=>c(i=>({...i,[t.nim]:s==="Belum Absen"?"Hadir":s||"Hadir"})),className:"px-2 py-1 text-xs font-medium rounded bg-primary-600 text-white hover:bg-primary-700 cursor-pointer",children:"Edit"})})]},t.nim)})})]})]})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Y,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Attendance Not Available Yet"}),e.jsx("p",{className:"text-gray-600",children:"Attendance editing will be available 5 minutes before the class starts."}),g&&e.jsxs("p",{className:"text-sm text-gray-500 mt-2",children:["Class starts at: ",new Date(g).toLocaleString("en-US",{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})]})]})]})]})}):null};export{Ae as A};
//# sourceMappingURL=AttendanceModal-p7s7SbNG.js.map
