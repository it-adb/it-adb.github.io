{"version":3,"mappings":";qZAIO,SAASA,GAAuBC,EAAuC,CAC5E,OAAOC,GAAiC,CACtC,SAAU,CAAC,uBAAwBD,CAAM,EACzC,QAAS,IAAME,EAAW,uBAAuBF,CAAM,EACxD,CACH,CCLO,SAASG,GAAUH,EAA0B,CAClD,OAAOC,GAA+B,CACpC,SAAU,CAAC,SAAUD,GAAQ,QAAU,KAAMA,GAAQ,UAAY,IAAI,EACrE,QAAS,IAAME,EAAW,UAAUF,CAAM,EAC1C,QAAS,GAAQA,IAAWA,EAAO,SAAW,QAAaA,EAAO,WAAa,QAAU,CAC1F,CACH,CAEO,SAASI,GAAeC,EAA0C,CACvE,MAAMC,EAAKC,GAAA,EACX,OAAOC,GAAY,CACjB,WAAaC,GAA6BP,EAAW,YAAYO,CAAI,EACrE,UAAW,SAAY,CAGnBH,EAAG,kBAAkB,CAAE,SAAU,CAAC,QAAQ,EAAG,CAEjD,EACD,CACH,CAEO,SAASI,GAAeL,EAA0C,CACvE,MAAMC,EAAKC,GAAA,EACX,OAAOC,GAAY,CACjB,WAAY,CAAC,CAAE,GAAAG,EAAI,KAAAF,KAAqDP,EAAW,YAAYS,EAAIF,CAAI,EACvG,UAAW,MAAOG,EAAWC,IAAc,CAGvC,GAAI,CACF,MAAMC,EAAe,MAAMZ,EAAW,SAASW,EAAU,EAAE,EAG3DP,EAAG,eACD,CAAE,SAAU,CAAC,QAAQ,EAAG,MAAO,IAC9BS,GACMA,GACEA,EAAI,IAAIC,GACbA,EAAM,KAAOH,EAAU,GAAKC,EAAeE,CAAA,CAE/C,CAEJ,OAASC,EAAO,CAEd,QAAQ,MAAM,+CAAgDA,CAAK,EACnEX,EAAG,kBAAkB,CAAE,SAAU,CAAC,QAAQ,EAAG,CAC/C,CAEJ,EACD,CACH,CCnBA,MAAMY,GAAsB,CAAC,GAAI,QAAS,OAAQ,QAAS,OAAQ,YAAa,WAAW,EAGrFC,GAA8C,CAClD,EAAK,QACL,EAAK,OACL,EAAK,QACL,EAAK,OACL,EAAK,YACL,EAAK,WACP,EAGMC,EAAwB,CAC5B,uBAAwB,GACxB,aAAc,GACd,KAAM,EACN,MAAO,EACP,IAAK,GACL,IAAK,EACP,EAEMC,GAAe,CACnB,qBACA,eACA,aACA,cACA,YACA,WACF,EAGMC,EAAqBC,GAAgC,CACzD,GAAIA,GAAQ,KAA2B,OAAO,KAC9C,GAAI,OAAOA,GAAQ,SAAU,OAAOA,EACpC,GAAI,OAAOA,GAAQ,UAAYA,IAAQ,MAAQ,YAAaA,GAAO,UAAWA,EAAK,CACjF,MAAMC,EAAUD,EAChB,OAAOC,EAAQ,MAAQA,EAAQ,QAAU,IAC3C,CACA,OAAO,IACT,EAGMC,GAAsBC,GAAoB,CAC9C,MAAMC,EAAeL,EAAkBI,GAAW,kBAAkB,EAC9DE,EAASN,EAAkBI,GAAW,YAAY,EAClDG,EAAOP,EAAkBI,GAAW,UAAU,EAC9CI,EAAQR,EAAkBI,GAAW,WAAW,EAChDK,EAAMT,EAAkBI,GAAW,SAAS,EAC5CM,EAAMV,EAAkBI,GAAW,SAAS,EAElD,MAAO,CACL,CAAE,IAAK,yBAA0B,OAAQC,GAAgBP,EAAsB,wBAC/E,CAAE,IAAK,eAAgB,OAAQQ,GAAUR,EAAsB,cAC/D,CAAE,IAAK,OAAQ,OAAQS,GAAQT,EAAsB,MACrD,CAAE,IAAK,QAAS,OAAQU,GAASV,EAAsB,OACvD,CAAE,IAAK,MAAO,OAAQW,GAAOX,EAAsB,KACnD,CAAE,IAAK,MAAO,OAAQY,GAAOZ,EAAsB,IAAI,CAE3D,EAGMa,GAA8C,CAClD,yBACA,eACA,OACA,QACA,MACA,MACA,cACA,cACA,cACF,EAgBMC,EAAiBX,GAChBA,EACD,OAAOA,GAAQ,SAAiBA,EAC7BA,EAAI,MAAQA,EAAI,OAAS,GAFf,GAMbY,GAAkBZ,GAAyD,CAC/E,GAAI,CAACA,EAAK,MAAO,GACjB,IAAIa,EAAM,GAMV,GALI,OAAOb,GAAQ,SACjBa,EAAMb,EACGA,EAAI,QACba,EAAMb,EAAI,MAER,CAACa,EAAK,MAAO,GACjB,MAAMC,EAAI,IAAI,KAAKD,CAAG,EACtB,OAAO,MAAMC,EAAE,SAAS,EAAI,GAAKA,EAAE,cAAc,MAAM,EAAG,EAAE,CAC9D,EAGMC,GAAmBf,GAAyE,CAChG,GAAI,CAACA,EAAK,MAAO,GACjB,IAAIa,EAAM,GAQV,GAPI,OAAOb,GAAQ,SACjBa,EAAMb,EACG,WAAYA,GAAOA,EAAI,MAChCa,EAAMb,EAAI,OACD,SAAUA,GAAOA,EAAI,QAC9Ba,EAAMb,EAAI,MAER,CAACa,EAAK,MAAO,GACjB,MAAMG,EAAQH,EAAI,MAAM,GAAG,EAC3B,OAAOG,EAAM,QAAU,EAAI,GAAGA,EAAM,CAAC,EAAE,SAAS,EAAG,GAAG,CAAC,IAAIA,EAAM,CAAC,EAAE,SAAS,EAAG,GAAG,CAAC,GAAKH,CAC3F,EAGMI,EAAkBjB,GAAgC,CACtD,GAAIA,GAAQ,KAA2B,OAAO,KAC9C,GAAI,OAAOA,GAAQ,SAAU,OAAOA,EACpC,GAAI,OAAOA,GAAQ,UAAYA,IAAQ,KAAM,CAC3C,GAAI,YAAaA,GAAQA,EAAuB,aAAeA,EAAuB,QACtF,GAAI,UAAWA,GAAQA,EAAqB,aAAeA,EAAqB,KAClF,CACA,OAAO,IACT,EAGMkB,GAAoBlB,GAAmD,CAC3E,GAAIA,GAAQ,KAA2B,OAAO,KAC9C,GAAI,OAAOA,GAAQ,UAAY,OAAOA,GAAQ,UAAY,OAAOA,GAAQ,UAAW,OAAOA,EAC3F,GAAI,OAAOA,GAAQ,UAAYA,IAAQ,KAAM,CAC3C,GAAI,YAAaA,GAAQA,EAAuB,aAAeA,EAAuB,QACtF,GAAI,UAAWA,EAAK,OAAQA,EAAqB,MACjD,GAAI,WAAYA,GAAQA,EAAsB,aAAeA,EAAsB,MACrF,CACA,OAAO,IACT,EAGMmB,GAAmBC,GAAgC,CACvD,MAAMpB,EACJoB,GAAS,QACTA,GAAS,QACTA,GAAS,OACTA,GAAS,KAAK,IACdA,GAAS,KAAK,KAAK,GACrB,OAA4BpB,GAAQ,KAAO,OAAOA,CAAG,EAAI,IAC3D,EAGMqB,GAAmBrB,GACTL,GAAoB,KAAM2B,GAAMA,EAAE,gBAAkBtB,EAAI,aAAa,GACnEA,EAIZuB,GAAwBC,GACxBA,GAAe,KAAyC,CAAE,MAAO,GAAI,OAAQ,GAC7EA,GAAc,GAAW,CAAE,MAAO,IAAK,OAAQ,GAC/CA,GAAc,GAAW,CAAE,MAAO,KAAM,OAAQ,KAChDA,GAAc,GAAW,CAAE,MAAO,IAAK,OAAQ,GAC/CA,GAAc,GAAW,CAAE,MAAO,KAAM,OAAQ,KAChDA,GAAc,GAAW,CAAE,MAAO,IAAK,OAAQ,GAC/CA,GAAc,GAAW,CAAE,MAAO,KAAM,OAAQ,KAChDA,GAAc,GAAW,CAAE,MAAO,IAAK,OAAQ,GAC5C,CAAE,MAAO,IAAK,OAAQ,GAIzBC,GAAwB,CAC5BC,EACAC,IACkB,CAClB,IAAIC,EAAc,EACdC,EAAa,EACbC,EAAc,GAalB,OAXwBH,GAAmBzB,GAAA,GAC3B,QAAQ,CAAC,CAAE,IAAA6B,EAAK,OAAAC,MAAa,CAC3C,MAAMC,GAAWP,EAAWK,CAAwB,EAC9CG,GAAQjB,EAAegB,EAAQ,EACjCC,KAAU,OACZL,GAAcK,GAAQF,GACtBJ,GAAeI,GACfF,EAAc,GAElB,CAAC,EAEG,CAACA,GAAeF,IAAgB,EAAU,KACvC,YAAYC,EAAaD,GAAa,QAAQ,CAAC,CAAC,CACzD,EAGMO,GAAcC,GAA4C,CAC9D,IAAIC,EAAa,GACjB,GAAI,OAAOD,GAAc,UAAYA,IAAc,KAAM,CACvD,GAAI,CAACA,EAAU,MAAO,MAAO,IAC7BC,EAAaD,EAAU,IACzB,MACEC,EAAaD,EAEf,GAAI,CAACC,EAAY,MAAO,IACxB,MAAMC,EAAO,IAAI,KAAKD,CAAU,EAC1BE,EAAYD,EAAK,mBAAmB,QAAS,CAAE,QAAS,QAAS,EACjEE,EAAgBF,EAAK,mBAAmB,QAAS,CAAE,IAAK,UAAW,MAAO,QAAS,KAAM,UAAW,EAC1G,MAAO,GAAGC,CAAS,KAAKC,CAAa,EACvC,EAGMC,GAAqBL,GAA4C,CACrE,IAAIC,EAAa,GACjB,GAAI,OAAOD,GAAc,UAAYA,IAAc,KAAM,CACvD,GAAI,CAACA,EAAU,MAAO,MAAO,IAC7BC,EAAaD,EAAU,IACzB,MACEC,EAAaD,EAEf,GAAI,CAACC,EAAY,MAAO,IACxB,MAAMC,EAAO,IAAI,KAAKD,CAAU,EAC1BE,EAAYD,EAAK,mBAAmB,QAAS,CAAE,QAAS,QAAS,EACjEI,EAAMJ,EAAK,mBAAmB,QAAS,CAAE,IAAK,UAAW,EACzDK,EAAQL,EAAK,mBAAmB,QAAS,CAAE,MAAO,QAAS,EACjE,MAAO,GAAGC,CAAS;AAAA,EAAKG,CAAG,IAAIC,CAAK,EACtC,EAGMC,GAAcC,GACN9B,GAAgB8B,CAAS,GACvB,IAIVC,GAAmB,CAACrD,EAAoBsD,EAA6BC,IACrEvD,EAAM,IAAMA,EAAM,GAAK,EAClB,MAAMA,EAAM,EAAE,GAEnBA,EAAM,OAED,OADO,OAAOA,EAAM,QAAW,SAAYA,EAAM,OAAwB,MAAQA,EAAM,MAC3E,GAEjBsD,EACK,OAAOA,CAAY,GAErB,OAAOC,CAAU,GAOpBC,GAAyB,IAAM,CAInC,KAAM,CAAE,QAAAC,CAAA,EAAYC,GAAA,EACd,CAACC,CAAY,EAAIC,GAAA,EACjBC,EAAWC,GAAA,EACXC,EAAaC,SAAuB,IAAI,EACxCC,EAAc1E,GAAA,EACd2E,EAAyBF,SAAO,EAAK,EAKrC,CAACG,EAAiBC,EAAkB,EAAIC,WAAS,EAAK,EACtD,CAACC,GAAkBC,EAAmB,EAAIF,WAAS,EAAK,EAExD,CAACG,EAAqBC,EAAsB,EAAIJ,WAAS,EAAK,EAC9D,CAACK,EAAkBC,EAAmB,EAAIN,WAAS,EAAK,EACxD,CAACO,EAAiBC,EAAkB,EAAIR,WAAS,EAAK,EACtD,CAACS,GAAaC,EAAc,EAAIV,WAAS,EAAK,EAK9C,CAACW,EAAcC,EAAe,EAAIZ,WAAiC,EAAE,EACrE,CAACa,GAAaC,EAAc,EAAId,WAAiC,EAAE,EACnE,CAACe,GAAaC,EAAc,EAAIhB,WAAiC,EAAE,EACnE,CAACiB,GAAiBC,EAAkB,EAAIlB,WAAiC,EAAE,EAK3E,CAACmB,GAAaC,EAAc,EAAIpB,WAAkC,EAAE,EACpE,CAACqB,GAA2BC,EAA4B,EAAItB,WAAiC,EAAE,EAC/F,CAACuB,GAAeC,EAAgB,EAAIxB,WAAsB,IAAI,GAAK,EACnE,CAACyB,GAAsBC,EAAuB,EAAI1B,WAAiC,EAAE,EACrF,CAAC2B,GAAyBC,EAA0B,EAAI5B,WAA6C,EAAE,EACvG,CAAC6B,GAAYC,EAAa,EAAI9B,WAAwB,IAAI,EAC1D,CAAC+B,EAAuBC,CAAwB,EAAIhC,WAAwB,IAAI,EAKhF,CAACiC,EAAcC,CAAe,EAAIlC,WAA+C,EAAE,EACnF,CAACmC,GAAgBC,EAAiB,EAAIpC,WAAsB,IAAI,GAAK,EACrE,CAACqC,GAAoBC,EAAqB,EAAItC,WAAsB,IAAI,GAAK,EAG7E,CAACuC,EAAcC,EAAe,EAAIxC,WAOrC,EAAE,EACC,CAACyC,GAAgBC,EAAiB,EAAI1C,WAAS,EAAK,EACpD,CAAC2C,GAAYC,CAAa,EAAI5C,WAAwB,IAAI,EAC1D,CAAC6C,GAAkBC,EAAmB,EAAI9C,WAAS,EAAK,EAKxD+C,GAAYzD,EAAa,IAAI,WAAW,GAAK,GAC7C0D,GAAa1D,EAAa,IAAI,YAAY,GAAK,GAC/C2D,GAAa3D,EAAa,IAAI,YAAY,GAAK,GAC/C4D,GAAW5D,EAAa,IAAI,MAAM,GAAK,YAGvC6D,GAAe,SAAS7D,EAAa,IAAI,cAAc,GAAK,IAAK,EAAE,EACnE8D,GAAa,SAAS9D,EAAa,IAAI,YAAY,GAAK,IAAK,EAAE,EAC/D+D,GAAkB,SAAS/D,EAAa,IAAI,iBAAiB,GAAK,IAAK,EAAE,EACzEgE,GAAc,SAAShE,EAAa,IAAI,aAAa,GAAK,IAAK,EAAE,EAKjEiE,EAAa,OAAOnE,CAAO,EAE3B,CACJ,KAAMoE,EAAW,GACjB,UAAWC,GACX,MAAOC,EAAA,EACLC,GAAiBJ,CAAU,EAEzB,CACJ,KAAMK,EAAW,GACjB,UAAWC,GACX,MAAOC,EAAA,EACLC,GAAiBR,CAAU,EAEzB,CAAE,KAAMS,EAAe,GAAI,UAAWC,EAAA,EAAkBnJ,GAAU,CACtE,SAAUyI,CAAA,CACX,EAEK,CAAE,KAAMW,GAAsB,GAAI,UAAWC,EAAA,EAAqBzJ,GAAuB,CAC7F,SAAU,OAAO0E,CAAO,EACzB,EAEK,CAAE,KAAM/C,EAAW,UAAW+H,EAAA,EAAqBxJ,GAAS,CAChE,SAAU,CAAC,QAASwE,CAAO,EAC3B,QAAS,IAAMvE,EAAW,aAAa0I,CAAU,EACjD,QAAS,CAAC,CAACnE,CAAA,CACZ,EAKKiF,EAAeC,UAAQ,IAAM,CAEjC,MAAMhI,EAAeiG,EAAa,oBAAsBtG,EAAkBI,GAAW,kBAAkB,EACjGE,EAASgG,EAAa,cAAgBtG,EAAkBI,GAAW,YAAY,EAC/EG,EAAO+F,EAAa,YAActG,EAAkBI,GAAW,UAAU,EACzEI,EAAQ8F,EAAa,aAAetG,EAAkBI,GAAW,WAAW,EAC5EK,EAAM6F,EAAa,WAAatG,EAAkBI,GAAW,SAAS,EACtEM,EAAM4F,EAAa,WAAatG,EAAkBI,GAAW,SAAS,EAE5E,MAAO,CACL,uBAAwBC,GAAgBP,EAAsB,uBAC9D,aAAcQ,GAAUR,EAAsB,aAC9C,KAAMS,GAAQT,EAAsB,KACpC,MAAOU,GAASV,EAAsB,MACtC,IAAKW,GAAOX,EAAsB,IAClC,IAAKY,GAAOZ,EAAsB,IAEtC,EAAG,CAACM,EAAWkG,CAAY,CAAC,EAEtB1E,GAAkByG,UAAQ,IAAM,CAEpC,MAAMC,EAAqB,CACzB,mBAAoBhC,EAAa,oBAAsBtG,EAAkBI,GAAW,kBAAkB,EACtG,aAAckG,EAAa,cAAgBtG,EAAkBI,GAAW,YAAY,EACpF,WAAYkG,EAAa,YAActG,EAAkBI,GAAW,UAAU,EAC9E,YAAakG,EAAa,aAAetG,EAAkBI,GAAW,WAAW,EACjF,UAAWkG,EAAa,WAAatG,EAAkBI,GAAW,SAAS,EAC3E,UAAWkG,EAAa,WAAatG,EAAkBI,GAAW,SAAS,GAE7E,OAAOD,GAAmBmI,CAAkB,CAC9C,EAAG,CAAClI,EAAWkG,CAAY,CAAC,EAEtBiC,GAAuBF,UAC3B,KAAO,CACL,mBAAoBrI,EAAkBI,GAAW,kBAAkB,GAAKN,EAAsB,uBAC9F,aAAcE,EAAkBI,GAAW,YAAY,GAAKN,EAAsB,aAClF,WAAYE,EAAkBI,GAAW,UAAU,GAAKN,EAAsB,KAC9E,YAAaE,EAAkBI,GAAW,WAAW,GAAKN,EAAsB,MAChF,UAAWE,EAAkBI,GAAW,SAAS,GAAKN,EAAsB,IAC5E,UAAWE,EAAkBI,GAAW,SAAS,GAAKN,EAAsB,MAE9E,CAACM,CAAS,GAGNoI,GAAkBH,UACtB,IACEtI,GAAa,KAAM0I,GAAU,CAC3B,MAAMC,EAASpC,EAAamC,CAAK,EACjC,OAAIC,IAAW,OAAkB,GAC1BA,IAAWH,GAAqBE,CAAK,CAC9C,CAAC,EACH,CAACnC,EAAciC,EAAoB,GAM/BI,GAAcN,UAAQ,IAAM,CAChC,MAAMO,MAAY,IAClB,OAAAX,GAAoB,QAASY,GAAe,CAC1C,MAAMxJ,EAAKuB,EAAciI,EAAW,QAAkC,EAClExJ,GAAIuJ,EAAM,IAAIvJ,CAAE,CACtB,CAAC,EACM,MAAM,KAAKuJ,CAAK,CACzB,EAAG,CAACX,EAAmB,CAAC,EAElBa,GAAuBC,GAAW,CACtC,QAASJ,GAAY,IAAKtJ,IAAQ,CAChC,SAAU,CAAC,WAAYA,CAAE,EACzB,QAAS,IAAMT,EAAW,gBAAgBS,CAAE,EAC5C,QAAS,CAAC,CAACA,CAAA,EACX,EACH,EAEK2J,EAAiBX,UAAQ,IAAM,CACnC,MAAMY,EAAiC,GACvC,OAAAH,GAAqB,QAASI,GAAM,CAClC,MAAMC,EAAWD,EAAE,KACfC,GAAU,IAAMA,GAAU,aAC5BF,EAAOE,EAAS,EAAE,EAAIA,EAAS,WAEnC,CAAC,EACMF,CACT,EAAG,CAACH,EAAoB,CAAC,EAKnBM,GAAWlC,GAAeC,GAAaC,GAAkBC,GAEzDgC,GAAgBhB,UAAQ,IACrBJ,GACJ,IAAKY,GAAe,CACnB,MAAMS,EAAa1I,EAAciI,EAAW,QAAkC,EAC9E,OAAOS,EAAaN,EAAeM,CAAU,GAAKA,EAAa,IACjE,CAAC,EACA,OAAO,OAAO,EAChB,CAACrB,GAAqBe,CAAc,CAAC,EAElCO,EAAalB,UAAQ,IAAMd,EAAS,IAAKiC,GAAMA,EAAE,EAAE,EAAG,CAACjC,CAAQ,CAAC,EAEhE,CAAE,KAAMkC,EAAgB,GAAI,UAAWC,EAAA,EAAuB/K,GAAS,CAC3E,SAAU,CAAC,oBAAqBwE,EAASoG,CAAU,EACnD,QAAS,SAAY,CACnB,MAAMI,EAA0C,GAChD,aAAM,QAAQ,IACZJ,EAAW,IAAI,MAAOK,GAAc,CAClC,MAAMC,EAAU,MAAMjL,EAAW,sBAAsBgL,CAAS,EAChED,EAAIC,CAAS,EAAIC,CACnB,CAAC,GAEIF,CACT,EACA,QAASJ,EAAW,OAAS,EAC9B,EAKKO,GAAwBC,GAAA,EACxBC,GAA2BC,GAAA,EAC3BC,GAA2BC,GAAA,EAC3BC,GAAsBhL,GAAA,EACtBiL,GAAsBvL,GAAA,EAKtBwL,GAA0BxB,GAAqB,KAAMI,GAAMA,EAAE,SAAS,EACtEqB,GACJ/C,IACAI,IACA8B,IACAxB,IACAF,IACAG,IACAmC,GACI3K,GAAQ8H,IAAiBI,GAGzB2C,GAAatG,GAAuBE,GAAoBE,EAOxDmG,EAAuBpJ,GAA0C,CAErE,IAAIqJ,EAAQ3C,EAAa,KAAM4C,GAAWA,EAAE,MAAQtJ,EAAQ,GAAG,EAU/D,GATIqJ,IAGJA,EAAQ3C,EAAa,KAClB4C,GACCA,EAAE,SAAS,MAAQtJ,EAAQ,KAC3BsJ,EAAE,KAAK,SAAS,MAAQtJ,EAAQ,KAChCsJ,EAAE,KAAK,MAAQtJ,EAAQ,KAEvBqJ,GAAO,OAAOA,EAGlB,MAAM1H,EAAe5B,GAAgBC,CAAO,EAa5C,OAZI2B,IAAiB,OACnB0H,EAAQ3C,EAAa,KAAM4C,GAAM,CAC/B,MAAMC,EAAI1J,EAAeyJ,EAAE,MAAM,EACjC,OAAOC,IAAM,MAAQA,IAAM5H,CAC7B,CAAC,EACG0H,KAINA,EAAQ3C,EAAa,KAAM4C,GACzB,OAAO,OAAOA,CAAC,EAAE,KAAME,GAAM,OAAOA,GAAM,UAAYA,IAAMxJ,EAAQ,GAAG,GAErEqJ,GAAcA,EAGX,CACL,GAAI,EACJ,OAAQ,KACR,uBAAwB,KACxB,aAAc,KACd,KAAM,KACN,MAAO,KACP,IAAK,KACL,IAAK,KACL,YAAa,KACb,YAAa,KACb,aAAc,KAElB,EAEMI,GAAiB,CAAClB,EAAmBmB,EAAsBC,EAAqBC,EAAqBC,IAA4B,CACrIvG,GAAiBwG,IAAU,CAAE,GAAGA,EAAM,CAACvB,CAAS,EAAGmB,GAAgB,IAAK,EACxElG,GAAgBsG,IAAU,CAAE,GAAGA,EAAM,CAACvB,CAAS,EAAGoB,GAAe,IAAK,EACtEjG,GAAgBoG,IAAU,CAAE,GAAGA,EAAM,CAACvB,CAAS,EAAGqB,GAAe,IAAK,EACtEhG,GAAoBkG,IAAU,CAAE,GAAGA,EAAM,CAACvB,CAAS,EAAGsB,GAAmB,IAAK,CAChF,EAEME,GAAmBxB,GAAsB,CAC7CjF,GAAiBwG,GAAS,CACxB,MAAME,EAAO,CAAE,GAAGF,CAAA,EAClB,cAAOE,EAAKzB,CAAS,EACdyB,CACT,CAAC,EACDxG,GAAgBsG,GAAS,CACvB,MAAME,EAAO,CAAE,GAAGF,CAAA,EAClB,cAAOE,EAAKzB,CAAS,EACdyB,CACT,CAAC,EACDtG,GAAgBoG,GAAS,CACvB,MAAME,EAAO,CAAE,GAAGF,CAAA,EAClB,cAAOE,EAAKzB,CAAS,EACdyB,CACT,CAAC,EACDpG,GAAoBkG,GAAS,CAC3B,MAAME,EAAO,CAAE,GAAGF,CAAA,EAClB,cAAOE,EAAKzB,CAAS,EACdyB,CACT,CAAC,CACH,EAEMC,GAAY,MAAO1B,GAAsB,CAC7C,MAAM2B,EAAW7G,EAAakF,CAAS,GAAK,GACtC4B,EAAa5G,GAAYgF,CAAS,GAAK,GACvC6B,EAAa3G,GAAY8E,CAAS,GAAK,GACvC8B,EAAc1G,GAAgB4E,CAAS,GAAK,GAI5C+B,EAAaH,EAAa,GAAGA,CAAU,iBAAmB,OAC1DI,EAAqBH,EAAa,GAAGA,CAAU,MAAQ,OAE7D,QAAQ,IAAI,8BAA+B7B,EAAW,cAAe2B,CAAQ,EAC7E,QAAQ,IAAI,wBAAyBC,EAAY,SAAUG,CAAU,EACrE,QAAQ,IAAI,sBAAuBD,CAAW,EAE9C,GAAI,CACF,MAAM5B,GAAsB,YAAY,CACtC,GAAIF,EACJ,KAAM,CACJ,MAAO2B,GAAY,OACnB,cAAeI,EACf,cAAeC,EACf,SAAUF,GAAe,OAC3B,CACD,EAED,QAAQ,IAAI,wCAAwC,EAGpD/H,EAAY,aACV,CAAC,iBAAkB2D,CAAU,EAC5B6D,GACMA,GACEA,EAAK,IAAK3B,GACfA,EAAE,KAAOI,EACL,CACE,GAAGJ,EACH,MAAO+B,EACP,cAAeI,GAAcnC,EAAE,cAC/B,cAAeoC,GAAsBpC,EAAE,cACvC,SAAUkC,GAAelC,EAAE,UAE7BA,CAAA,CAER,EAGF4B,GAAgBxB,CAAS,CAC3B,OAASiC,EAAG,CACV,MAAMA,aAAa,MAAQA,EAAE,QAAU,wBAAwB,CACjE,CACF,EAQMC,EAAiBzD,UAAQ,IAAM,CACnC,MAAM0D,EAAgB9L,GAAyD,CAC7E,GAAI,CAACA,EAAK,OAAO,OAAO,kBACxB,GAAI,OAAOA,GAAQ,SAAU,CAC3B,MAAM+L,EAAI,KAAK,MAAM/L,CAAG,EACxB,OAAO,MAAM+L,CAAC,EAAI,OAAO,kBAAoBA,CAC/C,CACA,GAAI,UAAW/L,EAAK,CAClB,GAAI,CAACA,EAAI,MAAO,OAAO,OAAO,kBAC9B,MAAM+L,EAAI,KAAK,MAAM/L,EAAI,IAAI,EAC7B,OAAO,MAAM+L,CAAC,EAAI,OAAO,kBAAoBA,CAC/C,CACA,OAAO,OAAO,iBAChB,EAEA,MAAO,CAAC,GAAGzE,CAAQ,EAAE,KAAK,CAAC0E,EAAGC,IAAM,CAClC,MAAMC,EAAOJ,EAAaE,EAAE,aAAa,EAAIF,EAAaG,EAAE,aAAa,EACzE,OAAOC,IAAS,EAAIA,EAAOF,EAAE,aAAeC,EAAE,YAChD,CAAC,CACH,EAAG,CAAC3E,CAAQ,CAAC,EAIP6E,GAAmB/D,UAAQ,IAAM,CACrC,MAAMY,EAAiD,GAEvD,cAAO,OAAOQ,CAAa,EAAE,QAASI,GAAY,CAChDA,EAAQ,QAASwC,GAAW,CACrBpD,EAAOoD,EAAO,GAAG,IACpBpD,EAAOoD,EAAO,GAAG,EAAI,IAEvB,MAAMC,EAAS1L,EAAcyL,EAAO,gBAA0C,EAC9EpD,EAAOoD,EAAO,GAAG,EAAEA,EAAO,YAAY,EAAIC,CAC5C,CAAC,CACH,CAAC,EAEMrD,CACT,EAAG,CAACQ,CAAa,CAAC,EAMZ8C,GAAiBD,GAAmB,CACxC,OAAQA,GAAQ,cAAY,CAC1B,IAAK,QACL,IAAK,UACH,OAAOE,MAACC,GAAA,CAAY,UAAU,yBAAyB,EACzD,IAAK,OACL,IAAK,UACH,OAAOD,MAACE,GAAA,CAAM,UAAU,wBAAwB,EAClD,IAAK,QACL,IAAK,OACH,OAAOF,MAACG,GAAA,CAAY,UAAU,0BAA0B,EAC1D,IAAK,YACL,IAAK,OACH,OAAOH,MAACI,GAAA,CAAW,UAAU,0BAA0B,EACzD,IAAK,YACL,IAAK,aACH,OAAOJ,MAACC,GAAA,CAAY,UAAU,0BAA0B,EAC1D,IAAK,OACL,IAAK,OACL,IAAK,SACH,OAAOD,MAACK,GAAA,CAAQ,UAAU,uBAAuB,EACnD,QACE,OAAOL,MAACM,GAAA,CAAM,UAAU,wBAAwB,EAEtD,EAEMC,GAAkBT,GAAmB,CACzC,OAAQA,GAAQ,cAAY,CAC1B,IAAK,QACL,IAAK,UACH,MAAO,6BACT,IAAK,OACL,IAAK,UACH,MAAO,2BACT,IAAK,QACL,IAAK,OACH,MAAO,+BACT,IAAK,YACL,IAAK,OACH,MAAO,+BACT,IAAK,YACL,IAAK,aACH,MAAO,+BACT,IAAK,OACL,IAAK,OACL,IAAK,SACH,MAAO,yBACT,QACE,MAAO,2BAEb,EAOAU,YAAU,IAAM,CAEd,GAAIpJ,EAAuB,QAAS,CAClC,QAAQ,IAAI,2DAA2D,EACvE,MACF,CAEA,QAAQ,IAAI,oDAAqDM,CAAmB,EAEpF,MAAM+I,EAA+B,GACrC,OAAO,OAAOxD,CAAa,EAAE,QAASI,GAAY,CAChDA,EAAQ,QAASqD,GAAM,CACrB,MAAMZ,EAAS1L,EAAcsM,EAAE,gBAA0C,EACzED,EAAK,GAAGC,EAAE,GAAG,IAAIA,EAAE,YAAY,EAAE,EAAI5L,GAAgBgL,CAAM,CAC7D,CAAC,CACH,CAAC,EACDjH,GAA6B4H,CAAI,EAC5B/I,IACH,QAAQ,IAAI,+CAA+C,EAC3DyB,GAA2B8D,CAAa,EAE5C,EAAG,CAACA,EAAevF,CAAmB,CAAC,EAGvC8I,YAAU,IAAM,CACd,GAAI,CAAC9I,EAAqB,OAE1B,MAAMiJ,EAAWtB,GAAqB,CAChChM,GAAoBgM,EAAE,GAAG,GAC3BA,EAAE,iBACF9F,EAAyBlG,GAAoBgM,EAAE,GAAG,CAAC,GAC1CA,EAAE,MAAQ,UACnB9F,EAAyB,IAAI,CAEjC,EAEA,cAAO,iBAAiB,UAAWoH,CAAO,EACnC,IAAM,OAAO,oBAAoB,UAAWA,CAAO,CAC5D,EAAG,CAACjJ,CAAmB,CAAC,EAMxB,MAAMkJ,GAAiB,IAAM,CAC3B,MAAM/B,MAAW,IACjB,OAAO,QAAQ7F,EAAoB,EAAE,QAAQ,CAAC,CAACxD,EAAK/B,CAAG,IAAM,CAC3D,MAAMoN,EAAWjI,GAA0BpD,CAAG,GAAK,GAC/CV,GAAgB+L,CAAQ,IAAM/L,GAAgBrB,CAAG,GACnDoL,EAAK,IAAIrJ,CAAG,CAEhB,CAAC,EACDuD,GAAiB8F,CAAI,CACvB,EAGMiC,GAAoBjF,UAAQ,IAAM,CAEtC,GAAI/C,GAAc,KAAO,EAAG,MAAO,GAGnC,UAAWiI,KAAWhG,EAAU,CAC9B,MAAMlI,EAAKkO,EAAQ,GAGbC,EAAc9I,EAAarF,CAAE,GAAK,GAClC0L,EAAenK,EAAc2M,EAAQ,KAA+B,EAC1E,GAAIC,IAAgBzC,EAAc,MAAO,GAGzC,MAAM0C,EAAa7I,GAAYvF,CAAE,GAAK,GAChCqO,EAAiB7M,GAAe0M,EAAQ,aAAa,EAC3D,GAAIE,IAAeC,EAAgB,MAAO,GAG1C,MAAMC,EAAa7I,GAAYzF,CAAE,GAAK,GAChC4L,EAAcjK,GAAgBuM,EAAQ,aAAuC,EACnF,GAAII,IAAe1C,EAAa,MAAO,GAGvC,MAAM2C,EAAiB5I,GAAgB3F,CAAE,GAAK,GACxC6L,EAAkBtK,EAAc2M,EAAQ,QAAkC,EAChF,GAAIK,IAAmB1C,EAAiB,MAAO,EACjD,CAGA,SAAW,CAAC2C,EAAUnF,CAAM,IAAK,OAAO,QAAQ1C,CAAY,EAAG,CAC7D,IAAIqH,EAA+B,KAEnC,GAAIQ,EAAS,WAAW,KAAK,EAAG,CAC9B,MAAMxO,EAAK,OAAOwO,EAAS,MAAM,GAAG,EAAE,CAAC,CAAC,EACxCR,EAAWtF,EAAa,KAAM4C,GAAMA,EAAE,KAAOtL,CAAE,GAAK,IACtD,SAAWwO,EAAS,WAAW,MAAM,EAAG,CACtC,MAAMC,EAAQ,OAAOD,EAAS,MAAM,GAAG,EAAE,CAAC,CAAC,EAC3CR,EACEtF,EAAa,KAAM4C,GAAM,CACvB,MAAMC,EAAI1J,EAAeyJ,EAAE,MAAM,EACjC,OAAOC,IAAM,MAAQA,IAAMkD,CAC7B,CAAC,GAAK,IACV,SAAWD,EAAS,WAAW,MAAM,EAAG,CACtC,MAAME,EAAMF,EAAS,MAAM,GAAG,EAAE,CAAC,EACjCR,EACEtF,EAAa,KACV4C,GAAWA,EAAE,MAAQoD,GAAOpD,EAAE,SAAS,MAAQoD,CAAA,GAC7C,IACT,CAEA,GAAI,CAACV,EAAU,CACb,GAAI,OAAO,OAAO3E,CAAM,EAAE,KAAMmC,GAAMA,GAAM,MAA2BA,IAAM,EAAE,EAC7E,MAAO,GAET,QACF,CAEA,UAAWpC,KAAS9H,GAAsB,CACxC,MAAMqN,EAAO7M,GAAkBuH,EAAeD,CAAK,CAAC,EAC9CwF,EAAO9M,GAAkBkM,EAAiB5E,CAAK,CAAC,EACtD,GAAIuF,IAASC,EAAM,MAAO,EAC5B,CACF,CAGA,MAAI,EAAAzF,EAGN,EAAG,CAAClD,GAAeU,EAActB,EAAcE,GAAaE,GAAaE,GAAiBuC,EAAUQ,EAAcS,EAAe,CAAC,EAM5H0F,GAAmB,CAAClM,EAAamM,IAAsB,CAC3D,KAAM,CAACJ,EAAKK,CAAY,EAAIpM,EAAI,MAAM,GAAG,EACnC4H,EAAY,OAAOwE,CAAY,EAC/BC,EAAW,CAAC,oBAAqBlL,EAASoG,CAAU,EAE1D5F,EAAY,aAAa0K,EAAW5O,GAA8B,CAChE,MAAM6O,EAAQ,CAAE,GAAI7O,GAAO,EAAC,EACtB8O,EAAM,CAAC,GAAID,EAAM1E,CAAS,GAAK,EAAG,EAClC4E,EAAcD,EAAI,UAAWrB,GAAMA,EAAE,MAAQa,CAAG,EAEtD,OAAIS,GAAe,EACjBD,EAAIC,CAAW,EAAI,CAAE,GAAGD,EAAIC,CAAW,EAAG,iBAAkBL,CAAA,EAE5DI,EAAI,KAAK,CACP,GAAI,CAAC,KAAK,MACV,aAAc3E,EACd,IAAAmE,EACA,iBAAkBI,CAAA,CACC,EAGvBG,EAAM1E,CAAS,EAAI2E,EACZD,CACT,CAAC,EAED7I,GAAyB0F,IAAU,CAAE,GAAGA,EAAM,CAACnJ,CAAG,EAAGmM,CAAA,EAAY,EACjEf,GAAA,CACF,EAEMqB,GAA0B,MAAOC,EAAW,KAAU,CAC1D,GAAI,CAACxK,EAAqB,OAE1B,MAAMyK,EAAU,OAAO,QAAQnJ,EAAoB,EACnD,GAAI,CAACmJ,EAAQ,OAAQ,CACdD,GAAUvK,GAAuB,EAAK,EAC3C,MACF,CAEAgB,GAAgBgG,GAAS,CACvB,MAAME,EAAO,CAAE,GAAGF,CAAA,EAClB,OAAAwD,EAAQ,QAAQ,CAAC,CAAC3M,CAAG,IAAOqJ,EAAKrJ,CAAG,EAAI,EAAK,EACtCqJ,CACT,CAAC,EAED,GAAI,CACF,MAAM,QAAQ,IACZsD,EAAQ,IAAI,MAAO,CAAC3M,EAAKsK,CAAM,IAAM,CACnC,KAAM,CAACyB,EAAKK,CAAY,EAAIpM,EAAI,MAAM,GAAG,EACnC4H,EAAY,OAAOwE,CAAY,EAC/BQ,EAAWnF,EAAcG,CAAS,GAAG,KAAMsD,GAAMA,EAAE,MAAQa,CAAG,EAEhEa,GAAYA,EAAS,GAAK,EAE5B,MAAM1E,GAAyB,YAAY,CACzC,GAAI0E,EAAS,GACb,KAAM,CAAE,iBAAkBtC,GAAU,OAAU,CAC/C,EAGD,MAAMtC,GAAyB,YAAY,CACzC,aAAcJ,EACd,IAAAmE,EACA,iBAAkBzB,GAAU,OAC7B,CAEL,CAAC,GAIH,MAAM3C,EAA0C,GAChD,MAAM,QAAQ,IACZJ,EAAW,IAAI,MAAOK,GAAc,CAClC,MAAMC,EAAU,MAAMjL,EAAW,sBAAsBgL,CAAS,EAChED,EAAIC,CAAS,EAAIC,CACnB,CAAC,GAIHlG,EAAY,aAAa,CAAC,oBAAqBR,EAASoG,CAAU,EAAGI,CAAG,EAIxEhE,GAA2BgE,CAAG,EAG9B/F,EAAuB,QAAU,GAE5B8K,GACHvK,GAAuB,EAAK,EAE9BsB,GAAwB,EAAE,EAC1BF,GAAiB,IAAI,GAAK,EAC1BM,GAAc,IAAI,CACpB,OAASgG,EAAG,CACV,MAAMA,aAAa,MAAQA,EAAE,QAAU,0BAA0B,CACnE,SACE1G,GAAe,EAAE,CACnB,CACF,EAQM0J,GAA0B,IAAM,CACpClJ,GAA2B8D,CAAa,EACxChE,GAAwB,EAAE,EAC1BF,GAAiB,IAAI,GAAK,EAC1BM,GAAc,IAAI,EAClBE,EAAyB,IAAI,EAC7B5B,GAAuB,EAAI,CAC7B,EAEM2K,GAAyB,IAAM,CACnC,MAAMT,EAAW,CAAC,oBAAqBlL,EAASoG,CAAU,EAGtD3F,EAAuB,QACzBA,EAAuB,QAAU,GAEjCD,EAAY,aAAa0K,EAAU3I,EAAuB,EAG5DD,GAAwB,EAAE,EAC1BF,GAAiB,IAAI,GAAK,EAC1BM,GAAc,IAAI,EAClBE,EAAyB,IAAI,EAC7B5B,GAAuB,EAAK,CAC9B,EAEM4K,GAAuB,IAAM,CACjC,QAAQ,IAAI,yCAAyC,EAErD,MAAMC,EAAiC,GACjCC,EAAgC,GAChCC,EAAgC,GAChCC,EAAoC,GAC1C5H,EAAS,QAASgG,GAAY,CAC5ByB,EAAOzB,EAAQ,EAAE,EAAI3M,EAAc2M,EAAQ,KAA+B,EAC1E0B,EAAM1B,EAAQ,EAAE,EAAI1M,GAAe0M,EAAQ,aAAa,EACxD2B,EAAM3B,EAAQ,EAAE,EAAIvM,GAAgBuM,EAAQ,aAAuC,EACnF4B,EAAU5B,EAAQ,EAAE,EAAI3M,EAAc2M,EAAQ,QAAkC,CAClF,CAAC,EACD5I,GAAgBqK,CAAM,EACtBnK,GAAeoK,CAAK,EACpBlK,GAAemK,CAAK,EACpBjK,GAAmBkK,CAAS,EAC5B9K,GAAoB,EAAI,CAC1B,EAEM+K,GAAsB,IAAM,CAChC,QAAQ,IAAI,yDAAyD,EACrEzK,GAAgB,EAAE,EAClBE,GAAe,EAAE,EACjBE,GAAe,EAAE,EACjBE,GAAmB,EAAE,EACrBZ,GAAoB,EAAK,CAC3B,EAEMgL,GAAsB,IAAM,CAChC,QAAQ,IAAI,uCAAuC,EACnD,MAAMC,EAAiD,GACvD3H,EAAS,QAAStG,GAAY,CAC5B,MAAM3B,EAAQ+K,EAAoBpJ,CAAO,GAAM,GACzC2B,EAAe5B,GAAgBC,CAAO,EACtCwM,EAAW9K,GAAiBrD,EAAOsD,EAAc3B,EAAQ,GAAG,EAClEiO,EAASzB,CAAQ,EAAInO,CACvB,CAAC,EACD,QAAQ,IAAI,8BAA+B4P,CAAQ,EACnDrJ,EAAgBqJ,CAAQ,EACxB/K,GAAmB,EAAI,CACzB,EAEMgL,GAAqB,IAAM,CAC/B,QAAQ,IAAI,uDAAuD,EACnEtJ,EAAgB,EAAE,EAClBI,GAAsB,IAAI,GAAK,EAC/BE,GAAgB,EAAE,EAClBI,EAAc,IAAI,EAClBE,GAAoB,EAAK,EACzBtC,GAAmB,EAAK,CAC1B,EAEMiL,GAAmB,IAAM,CAC7BV,GAAA,EACAM,GAAA,EACAG,GAAA,CACF,EAMME,GAAY,MAAO5B,EAAkBnO,EAAoB2B,IAAkB,CAC/E,QAAQ,IAAI,oCAAqCwM,EAAU,YAAanO,GAAO,EAAE,EACjF,MAAMgQ,EAAQhQ,GAAO,IAAMA,EAAM,GAAK,EAAIA,EAAM,GAAK,KACjDgQ,GAAOvJ,GAAmBgF,GAAS,IAAI,IAAI,CAAC,GAAGA,EAAMuE,CAAK,CAAC,CAAC,EAEhE,GAAI,CACF,MAAMC,EAAc3J,EAAa6H,CAAQ,EACzC,GAAI,CAAC8B,EAAa,CAChB,QAAQ,IAAI,6CAA8C9B,CAAQ,EAClE,MACF,CAkBA,GAAI,CAfgD,CAClD,yBACA,eACA,OACA,QACA,MACA,OAGsC,KAAMpF,GAAU,CACtD,MAAMmH,EAAgB1O,EAAexB,EAAM+I,CAAK,CAAC,EAC3CoH,EAAc3O,EAAeyO,EAAYlH,CAAK,CAAC,EACrD,OAAOmH,IAAkBC,CAC3B,CAAC,EAEgB,CACf,QAAQ,IAAI,gDAAgD,EAE5DxJ,GAAuB8E,GAAS,IAAI,IAAI,CAAC,GAAGA,EAAM0C,CAAQ,CAAC,CAAC,EACxD6B,GAAOvJ,GAAmBgF,GAAS,IAAI,IAAI,CAAC,GAAGA,CAAI,EAAE,OAAQ9L,GAAOA,IAAOqQ,CAAK,CAAC,CAAC,EACtF,MACF,CAIA,MAAMI,EAAoBpO,GAAsBiO,EAAa/N,EAAe,EACtEH,EAAaqO,IAAsB,KAAOA,EAAoB5O,EAAeyO,EAAY,WAAW,EAG1G,IAAII,EACAC,EAEJ,GAAIvO,IAAe,KAAM,CACvB,KAAM,CAAE,MAAAwO,EAAO,OAAAC,GAAW1O,GAAqBC,CAAU,EACzDsO,EAAaE,EACbD,EAAcE,EACd,QAAQ,IAAI,wCAAyCzO,EAAY,UAAWsO,EAAY,SAAUC,CAAW,CAC/G,CAEA,MAAMG,EAAa,CACjB,uBAAwBjP,EAAeyO,EAAY,sBAAsB,GAAK,OAC9E,aAAczO,EAAeyO,EAAY,YAAY,GAAK,OAC1D,KAAMzO,EAAeyO,EAAY,IAAI,GAAK,OAC1C,MAAOzO,EAAeyO,EAAY,KAAK,GAAK,OAC5C,IAAKzO,EAAeyO,EAAY,GAAG,GAAK,OACxC,IAAKzO,EAAeyO,EAAY,GAAG,GAAK,OACxC,YAAalO,GAAc,OAC3B,YAAasO,EACb,aAAcC,CAAA,EAGhB,GAAItQ,EAAM,IAAMA,EAAM,GAAK,EACzB,QAAQ,IAAI,+CAAgDA,EAAM,EAAE,EACpE,MAAM0K,GAAoB,YAAY,CAAE,GAAI1K,EAAM,GAAI,KAAMyQ,EAAY,UAC/DzQ,EAAM,OAAQ,CACvB,MAAMoO,EAAQ5M,EAAexB,EAAM,MAAM,EACzC,QAAQ,IAAI,6CAA8CoO,CAAK,EAC/D,MAAMzD,GAAoB,YAAY,CAAE,OAAQyD,EAAiB,GAAGqC,EAAmB,CACzF,KAAO,CAGL,MAAMrC,EADe1M,GAAgBC,CAAO,GACdH,EAAeyO,GAAa,MAAM,EAChE,GAAI7B,EACF,QAAQ,IAAI,0DAA2DA,CAAK,EAC5E,MAAMzD,GAAoB,YAAY,CAAE,OAAQ,OAAOyD,CAAK,EAAG,GAAGqC,EAAmB,MAErF,eAAQ,IAAI,8CAA8C,EACpD,IAAI,MAAM,mCAAmC,CAEvD,CAEA,QAAQ,IAAI,qCAAqC,EAEjDlK,EAAiBkF,GAAS,CACxB,MAAME,EAAO,CAAE,GAAGF,CAAA,EAClB,cAAOE,EAAKwC,CAAQ,EACbxC,CACT,CAAC,EAEDhF,GAAuB8E,GAAS,IAAI,IAAI,CAAC,GAAGA,EAAM0C,CAAQ,CAAC,CAAC,CAC9D,OAAShC,EAAG,CACV,QAAQ,IAAI,iCAAkCA,CAAC,EAC/C,MAAMA,aAAa,MAAQA,EAAE,QAAU,sBAAsB,CAC/D,SACM6D,GACFvJ,GAAmBgF,GAAS,IAAI,IAAI,CAAC,GAAGA,CAAI,EAAE,OAAQ9L,GAAOA,IAAOqQ,CAAK,CAAC,CAAC,CAE/E,CACF,EAGMU,GAAoB,CAAC3H,EAAetG,IAAkB,CAC1D,MAAMkO,EAAWlO,IAAU,GAAK,OAAY,WAAWA,CAAK,EAC5DoE,GAAiB4E,IAAU,CACzB,GAAGA,EACH,CAAC1C,CAAK,EAAG4H,CAAA,EACT,EACF1J,EAAc,IAAI,CACpB,EAEM2J,GAAe,IAAM,CACzB/J,GAAgB,EAAE,EAClBI,EAAc,IAAI,EAClBE,GAAoB,EAAI,CAC1B,EAGM0J,GAAa,SAAY,CAC7B,GAAI,CACF9J,GAAkB,EAAI,EACtBE,EAAc,IAAI,EAGlB,MAAM6J,EAAY,CAChB,mBAAoBlK,EAAa,oBAAsB8B,EAAa,uBACpE,aAAc9B,EAAa,cAAgB8B,EAAa,aACxD,WAAY9B,EAAa,YAAc8B,EAAa,KACpD,YAAa9B,EAAa,aAAe8B,EAAa,MACtD,UAAW9B,EAAa,WAAa8B,EAAa,IAClD,UAAW9B,EAAa,WAAa8B,EAAa,KAI9CqI,EACJD,EAAU,mBACVA,EAAU,aACVA,EAAU,WACVA,EAAU,YACVA,EAAU,UACVA,EAAU,UAEZ,OAAI,KAAK,IAAIC,EAAQ,GAAG,EAAI,KAC1B9J,EAAc,sCAAsC8J,EAAM,QAAQ,CAAC,CAAC,GAAG,EAChE,KAIT,MAAM7R,EAAW,YAAY0I,EAAYkJ,CAAS,EAGlD,MAAM7M,EAAY,kBAAkB,CAAE,SAAU,CAAC,QAASR,CAAO,EAAG,EAGpEoD,GAAgB,EAAE,EAClBM,GAAoB,EAAI,EACxB,QAAQ,IAAI,4CAA4C,EACjD,GACT,OAASlH,EAAO,CACd,eAAQ,MAAM,0CAA2CA,CAAK,EAC9DgH,EAAchH,aAAiB,MAAQA,EAAM,QAAU,8BAA8B,EAC9E,EACT,SACE8G,GAAkB,EAAK,CACzB,CACF,EAEMiK,GAAmB,SAAY,CACnC,QAAQ,IAAI,4CAA4C,EACxD,QAAQ,IAAI,iCAAkCxM,CAAmB,EACjE,QAAQ,IAAI,8BAA+BE,CAAgB,EAC3D,QAAQ,IAAI,6BAA8BE,CAAe,EAEzDG,GAAe,EAAI,EACnB,GAAI,CAEF,MAAMkM,EAAsBvM,EACxB,OAAO,KAAKM,CAAY,EAAE,IAAKkM,GAAU,OAAOA,CAAK,CAAC,EAAE,OAAQvR,GAAO,CAAC,OAAO,MAAMA,CAAE,CAAC,EAAE,IAAKA,GAAOiM,GAAUjM,CAAE,CAAC,EACnH,GAGJ,IAAIwR,EAAa,GACjB,GAAIvM,GAAmBkE,KACrB,QAAQ,IAAI,mCAAmC,EAC/CqI,EAAa,MAAMN,GAAA,EACf,CAACM,GACH,MAAM,IAAI,MAAM,8BAA8B,EAKlD,MAAMC,EAAoBxM,EACtB,OAAO,QAAQ0B,CAAY,EAAE,IAAI,CAAC,CAAC6H,CAAQ,IAAM,CACnD,IAAIkD,EAGJ,GAAIlD,EAAS,WAAW,MAAM,EAAG,CAC/B,MAAME,EAAMF,EAAS,UAAU,CAAC,EAChCkD,EAAgBpJ,EAAS,KAAMpG,GAAMA,EAAE,MAAQwM,CAAG,CACpD,SAAWF,EAAS,WAAW,MAAM,EAAG,CACtC,MAAMC,EAAQ,OAAOD,EAAS,UAAU,CAAC,CAAC,EAC1CkD,EAAgBpJ,EAAS,KAAMpG,GAAMH,GAAgBG,CAAC,IAAMuM,CAAK,CACnE,SAAWD,EAAS,WAAW,KAAK,EAAG,CACrC,MAAMmD,EAAU,OAAOnD,EAAS,UAAU,CAAC,CAAC,EAE5CkD,EAAgBpJ,EAAS,KAAMpG,GACfkJ,EAAoBlJ,CAAC,GACrB,KAAOyP,CACtB,CACH,CAEA,MAAMC,EAAgBF,EAClBtG,EAAoBsG,CAAa,EAChC/K,EAAa6H,CAAQ,EAC1B,OAAO4B,GAAU5B,EAAUoD,EAAeF,CAAa,CACvD,CAAC,EACC,GAEJ,QAAQ,IAAI,+BAAgCJ,EAAoB,MAAM,EACtE,QAAQ,IAAI,6BAA8BG,EAAkB,MAAM,EAGlE,MAAMI,EAAoBhN,EAAsBuK,GAAwB,EAAI,EAAI,QAAQ,UAExF,MAAM,QAAQ,IAAI,CAChB,QAAQ,IAAIkC,CAAmB,EAC/B,QAAQ,IAAIG,CAAiB,EAC7BI,CAAA,CACD,EAED,QAAQ,IAAI,sDAAsD,EAElEC,GAAA,CACF,OAASC,EAAK,CACZ,MAAMA,aAAe,MAAQA,EAAI,QAAU,wBAAwB,CACrE,SACE3M,GAAe,EAAK,CACtB,CACF,EAEM4M,GAAmB,CAACxD,EAAkBpF,EAA0BtG,IAAe,CACnF8D,EAAiBkF,GAAS,CACxB,MAAM3L,EAAe,CACnB,GAAG2L,EAAK0C,CAAQ,EAChB,CAACpF,CAAK,EAAGtG,IAAU,GAAK,KAAOA,CAAA,EAMjC,GAFyBP,GAAgB,KAAM0P,GAASA,EAAK,MAAQ7I,CAAK,EAEpD,CAEpB,MAAMqH,EAAoBpO,GAAsBlC,EAAcoC,EAAe,EAE7E,GAAIkO,IAAsB,KAAM,CAE9B,KAAM,CAAE,MAAAG,EAAO,OAAAC,GAAW1O,GAAqBsO,CAAiB,EAGhEtQ,EAAa,YAAcsQ,EAC3BtQ,EAAa,YAAcyQ,EAC3BzQ,EAAa,aAAe0Q,CAC9B,MAEE1Q,EAAa,YAAc,KAC3BA,EAAa,YAAc,KAC3BA,EAAa,aAAe,IAEhC,CAEA,MAAO,CACL,GAAG2L,EACH,CAAC0C,CAAQ,EAAGrO,CAAA,CAEhB,CAAC,CACH,EAMM+R,GAAa,IAAM,CACvBhO,EAAS,EAAE,CACb,EAEM4N,GAAe,IAAM,CACzB3B,GAAA,CACF,EAIMgC,GAAoB,SAAY,CACpC,GAAK/N,EAAW,QAChB,EAAC,OAAO,OAAO,kBAAqBgO,GAAmBA,EAAA,IAAO,IAAM,CAClE3N,GAAmB,EAAI,CACzB,CAAC,EACD,MAAM,IAAI,QAASoJ,GAAM,WAAWA,EAAG,CAAC,CAAC,EACzC,GAAI,CACF,KAAM,CAAC,CAAE,QAASwE,GAAe,CAAE,QAASC,EAAO,EAAI,MAAM,QAAQ,IAAI,CAAAC,GAAA,IACvE,OAAO,mCAAiB,MAAAA,GAAA,IACxB,OAAO,4BAAO,OAAAC,KAAA,6BACf,EAEKC,EAAS,MAAMJ,EAAYjO,EAAW,QAAS,CACnD,MAAO,IACP,QAAS,GACT,QAAS,GACT,gBAAiB,UAClB,EACKsO,EAAW,IACXC,EAAa,IACbC,EAAaH,EAAO,OAASC,EAAYD,EAAO,MACtD,IAAII,EAAaD,EACjB,MAAME,EAAM,IAAIR,EAAM,IAAK,KAAM,IAAI,EACrC,IAAIS,EAAW,EACf,MAAMC,EAAUP,EAAO,UAAU,aAAc,GAAI,EAGnD,IAFAK,EAAI,SAASE,EAAS,OAAQ,EAAGD,EAAUL,EAAUE,CAAS,EAC9DC,GAAcF,EACPE,EAAa,GAClBE,EAAWF,EAAaD,EACxBE,EAAI,UACJA,EAAI,SAASE,EAAS,OAAQ,EAAGD,EAAUL,EAAUE,CAAS,EAC9DC,GAAcF,EAEhB,MAAMM,EAAW,iBAAiBxL,EAAS,IAAIC,GAAW,QAAQ,OAAQ,GAAG,CAAC,IAAI,IAAI,OAAO,cAAc,MAAM,GAAG,EAAE,CAAC,CAAC,OACxHoL,EAAI,KAAKG,CAAQ,CACnB,OAAS3S,EAAO,CACd,QAAQ,MAAM,wBAAyBA,CAAK,EAC5C,MAAM,2CAA2C,CACnD,SACEmE,GAAmB,EAAK,CAC1B,EACF,EAEMyO,GAAqB,SAAY,CACrCtO,GAAoB,EAAI,EACxB,GAAI,CACF,MAAMuO,EAAO,MAAAZ,GAAA,IAAM,OAAO,oBAAM,MAC1Ba,EAAWD,EAAK,MAAM,WAGtBE,EAAgB,CACpB,CAAC,sBAAsB,EACvB,GACA,CAAC,cAAe1L,EAAU,EAC1B,CAAC,cAAeD,EAAU,EAC1B,CAAC,QAASD,EAAS,EACnB,CAAC,YAAasC,EAAQ,EACtB,CAAC,YAAaC,GAAc,KAAK,IAAI,CAAC,EACtC,CAAC,iBAAkB1B,EAAS,MAAM,EAClC,CAAC,iBAAkBJ,EAAS,MAAM,EAClC,CAAC,iBAAkB,IAAI,OAAO,mBAAmB,OAAO,CAAC,GAErDoL,EAAiBH,EAAK,MAAM,aAAaE,CAAa,EAC5DC,EAAe,OAAO,EAAI,CAAC,CAAE,IAAK,IAAM,CAAE,IAAK,GAAI,EACnDH,EAAK,MAAM,kBAAkBC,EAAUE,EAAgB,mBAAmB,EAI1E,MAAMC,EAAiB,CADG,CAAC,MAAO,OAAQ,GAAG9G,EAAe,IAAItC,GAAK,IAAIA,EAAE,YAAY,EAAE,CAAC,CACjD,EAEzC7B,EAAS,QAAStG,GAAY,CAC5B,MAAMwR,EAAoBzG,GAAiB/K,EAAQ,GAAG,GAAK,GACrDyR,EAAM,CAACzR,EAAQ,IAAKA,EAAQ,IAAI,EAEtCyK,EAAe,QAASyB,GAAY,CAClC,MAAMjB,EAASuG,EAAkBtF,EAAQ,EAAE,GAAK,GAChDuF,EAAI,KAAKxG,GAAU,GAAG,CACxB,CAAC,EAEDsG,EAAe,KAAKE,CAAG,CACzB,CAAC,EAED,MAAMC,EAAkBP,EAAK,MAAM,aAAaI,CAAc,EAC9DG,EAAgB,OAAO,EAAI,CACzB,CAAE,IAAK,IACP,CAAE,IAAK,IACP,GAAGjH,EAAe,IAAI,KAAO,CAAE,IAAK,IAAK,GAE3C0G,EAAK,MAAM,kBAAkBC,EAAUM,EAAiB,qBAAqB,EAG7E,MAAMC,EAAqB,CACzB,CAAC,UAAW,OAAQ,OAAQ,YAAa,OAAO,EAChD,GAAGlH,EAAe,IAAKyB,GAAY,CACjC,MAAM0F,EAAe1F,EAAQ,gBAC3B,OAAOA,EAAQ,eAAkB,UAChC,OAAOA,EAAQ,eAAkB,UAAY,UAAWA,EAAQ,eAAiBA,EAAQ,cAAc,OAG1G,IAAI2F,EAAQ,GACR3F,EAAQ,QACN,OAAOA,EAAQ,OAAU,SAC3B2F,EAAQ3F,EAAQ,MACP,WAAYA,EAAQ,OAASA,EAAQ,MAAM,QACpD2F,EAAQ3F,EAAQ,MAAM,SAI1B,MAAMjE,EAAa1I,EAAc2M,EAAQ,QAAkC,EACrE4F,EAAe7J,GAAcN,EAAeM,CAAU,EAAIN,EAAeM,CAAU,EAAI,IAE7F,MAAO,CACL,IAAIiE,EAAQ,YAAY,GACxB0F,EAAe7Q,GAAWmL,EAAQ,aAAa,EAAI,IACnD1K,GAAW0K,EAAQ,aAAoB,EACvC4F,EACAD,GAAS,IAEb,CAAC,GAGGE,EAAeZ,EAAK,MAAM,aAAaQ,CAAkB,EAC/DI,EAAa,OAAO,EAAI,CAAC,CAAE,IAAK,IAAM,CAAE,IAAK,IAAM,CAAE,IAAK,IAAM,CAAE,IAAK,IAAM,CAAE,IAAK,GAAI,EACxFZ,EAAK,MAAM,kBAAkBC,EAAUW,EAAc,iBAAiB,EAQtE,MAAMC,EAAoC,CALpB,CACpB,MAAO,OAAQ,gBAAiB,UAAW,OAC3C,aAAc,UAAW,QAAS,gBAClC,eAAgB,cAEsC,EAExD1L,EAAS,QAAStG,GAAY,CAC5B,MAAM3B,EAAQ+K,EAAoBpJ,CAAO,GAAM,CAC7C,uBAAwB,KACxB,aAAc,KACd,KAAM,KACN,MAAO,KACP,IAAK,KACL,IAAK,KACL,YAAa,KACb,YAAa,KACb,aAAc,MAGViS,EAAYtR,GAAgC,CAChD,MAAM/B,EAAMP,EAAMsC,CAAG,EACrB,OAAI/B,GAAQ,KAAkC,GAC1C,OAAOA,GAAQ,UAAY,YAAaA,EAAYA,EAAI,MAAQA,EAAI,QAAU,GAC9E,OAAOA,GAAQ,UAAY,WAAYA,EAAYA,EAAI,MAAQA,EAAI,OAAS,GAC5E,OAAOA,GAAQ,UAAY,UAAWA,EAAYA,EAAI,MAAQA,EAAI,MAAQ,GACvEA,CACT,EAEAoT,EAAW,KAAK,CACdhS,EAAQ,IACRA,EAAQ,MACP,IAAM,CAAE,MAAMwJ,EAAIyI,EAAS,wBAAwB,EAAG,OAAOzI,IAAM,GAAKA,EAAI,GAAK,MACjF,IAAM,CAAE,MAAMA,EAAIyI,EAAS,cAAc,EAAG,OAAOzI,IAAM,GAAKA,EAAI,GAAK,MACvE,IAAM,CAAE,MAAMA,EAAIyI,EAAS,MAAM,EAAG,OAAOzI,IAAM,GAAKA,EAAI,GAAK,MAC/D,IAAM,CAAE,MAAMA,EAAIyI,EAAS,OAAO,EAAG,OAAOzI,IAAM,GAAKA,EAAI,GAAK,MAChE,IAAM,CAAE,MAAMA,EAAIyI,EAAS,KAAK,EAAG,OAAOzI,IAAM,GAAKA,EAAI,GAAK,MAC9D,IAAM,CAAE,MAAMA,EAAIyI,EAAS,KAAK,EAAG,OAAOzI,IAAM,GAAKA,EAAI,GAAK,MAC9D,IAAM,CAAE,MAAMA,EAAIyI,EAAS,aAAa,EAAG,OAAOzI,IAAM,GAAKA,EAAI,GAAK,MACtE,IAAM,CAAE,MAAMA,EAAIyI,EAAS,aAAa,EAAG,OAAOzI,IAAM,GAAKA,EAAI,GAAK,MACtE,IAAM,CAAE,MAAMA,EAAIyI,EAAS,cAAc,EAAG,OAAOzI,IAAM,GAAKA,EAAI,GAAK,IAAG,CAC5E,CACH,CAAC,EAGDwI,EAAW,KAAK,CACd,oBACA,GACA,GAAGjL,EAAa,sBAAsB,IACtC,GAAGA,EAAa,YAAY,IAC5B,GAAGA,EAAa,IAAI,IACpB,GAAGA,EAAa,KAAK,IACrB,GAAGA,EAAa,GAAG,IACnB,GAAGA,EAAa,GAAG,IACnB,cACA,GACA,GACD,EAED,MAAMmL,EAAcf,EAAK,MAAM,aAAaa,CAAU,EACtDE,EAAY,OAAO,EAAI,CACrB,CAAE,IAAK,IACP,CAAE,IAAK,IACP,CAAE,IAAK,IACP,CAAE,IAAK,IACP,CAAE,IAAK,GACP,CAAE,IAAK,IACP,CAAE,IAAK,IACP,CAAE,IAAK,GACP,CAAE,IAAK,IACP,CAAE,IAAK,IACP,CAAE,IAAK,GAAG,EAEZf,EAAK,MAAM,kBAAkBC,EAAUc,EAAa,iBAAiB,EAGrE,MAAMjB,EAAW,iBAAiBxL,EAAS,IAAIC,GAAW,QAAQ,OAAQ,GAAG,CAAC,IAAI,IAAI,OAAO,cAAc,MAAM,GAAG,EAAE,CAAC,CAAC,QAGxHyL,EAAK,UAAUC,EAAUH,CAAQ,CACnC,OAAS3S,EAAO,CACd,QAAQ,MAAM,yBAA0BA,CAAK,EAC7C,MAAM,4CAA4C,CACpD,SACEsE,GAAoB,EAAK,CAC3B,CACF,EAEA,OACEuP,OAAC,OAAI,UAAU,gBAEb,UAAAA,OAAC,OAAI,UAAU,oDACb,UAAAhH,MAAC,UACC,QAAS,IAAMjJ,EAAS,IAAI0D,EAAQ,EAAE,EACtC,UAAU,0DAEV,SAAAuF,MAACiH,GAAA,CAAK,UAAU,UAAU,IAE5BjH,MAACkH,GAAA,CAAa,UAAU,UAAU,EAClClH,MAAC,UACC,QAAS+E,GACT,UAAU,wCAET,SAAAtK,KAAa,0BAA4B,iBACzCA,KAAa,yBAA2B,mBAAqB,cAEhEuF,MAACkH,GAAA,CAAa,UAAU,UAAU,EAClClH,MAAC,QAAK,UAAU,4BAA4B,yBAAa,GAC3D,EAGEgH,OAAC,OAAI,UAAU,yBACf,UAAAA,OAAC,OAAI,UAAU,0BACb,UAAAhH,MAAC,UACC,QAAS,IAAOtI,EAAsB4K,GAAA,EAA2BD,GAAA,EACjE,UAAW,6FAA6F3K,EAAsB,yBAA2B,EAAE,GAE1J,WAAsB,0BAA4B,oBAGrDsI,MAAC,UACC,QAAS,IAAOpI,EAAmBgL,GAAA,EAAwBL,GAAA,EAC3D,UAAW,6FAA6F3K,EAAmB,yBAA2B,EAAE,GAEvJ,WAAmB,uBAAyB,kBAG/CoI,MAAC,UACC,QAAS,IAAOlI,EAAkBiL,GAAA,EAAuBF,GAAA,EACzD,UAAW,6FAA6F/K,EAAkB,yBAA2B,EAAE,GAEtJ,WAAkB,sBAAwB,gBAG5CkG,IACCgJ,OAAAG,WAAA,CACE,UAAAnH,MAAC,UAAO,QAASkE,GAAkB,UAAU,cAAc,SAAUlM,IAAe,CAAC8I,GAAmB,yBAAa,EACrHd,MAAC,UAAO,QAAS,IAAMgD,KAAoB,UAAU,gBAAgB,kBAAM,GAC7E,GAEJ,EACCtL,GACCsP,OAAC,OAAI,UAAU,0FACb,UAAAA,OAAC,OACC,UAAAhH,MAAC,QAAK,UAAU,4BAA4B,yBAAa,EACzDA,MAAC,KAAE,UAAU,qBAAqB,+HAAmH,GACvJ,EACAgH,OAAC,OAAI,UAAU,uBACb,UAAAhH,MAAC,UACC,QAAS,IAAMzG,EAAyB,OAAO,EAC/C,UAAW,wDACTD,IAA0B,QACtB,0BACA,gEACN,GACA,MAAM,UACP,uBAGD0G,MAAC,UACC,QAAS,IAAMzG,EAAyB,MAAM,EAC9C,UAAW,wDACTD,IAA0B,OACtB,yBACA,gEACN,GACA,MAAM,UACP,sBAGD0G,MAAC,UACC,QAAS,IAAMzG,EAAyB,OAAO,EAC/C,UAAW,wDACTD,IAA0B,QACtB,2BACA,gEACN,GACA,MAAM,UACP,uBAGD0G,MAAC,UACC,QAAS,IAAMzG,EAAyB,MAAM,EAC9C,UAAW,wDACTD,IAA0B,OACtB,wBACA,gEACN,GACA,MAAM,UACP,sBAGD0G,MAAC,UACC,QAAS,IAAMzG,EAAyB,WAAW,EACnD,UAAW,wDACTD,IAA0B,YACtB,2BACA,gEACN,GACA,MAAM,UACP,2BAGD0G,MAAC,UACC,QAAS,IAAMzG,EAAyB,WAAW,EACnD,UAAW,wDACTD,IAA0B,YACtB,2BACA,gEACN,GACA,MAAM,UACP,uBAGD0G,MAAC,UACC,QAAS,IAAMzG,EAAyB,IAAI,EAC5C,UAAW,wDACTD,IAA0B,KACtB,yBACA,gEACN,GACA,MAAM,YACP,wBAED,EACF,EACA0N,OAAC,OAAI,UAAU,oEACb,UAAAhH,MAAC,QAAK,UAAU,cAAc,qBAAS,EACvCA,MAAC,QAAK,UAAU,gBACb,SAAA1G,IAA0B,KAAO,OAAUA,IAA0B,GAAK,SAAWA,CAAA,CACxF,GACF,GACF,EAEF0G,MAAC,UACC,QAASgF,GACT,SAAU3N,GAAmB0G,GAC7B,UAAU,0IAET,WACCiJ,OAAAG,WAAA,CACE,UAAAnH,MAACoH,GAAA,CAAQ,UAAU,uBAAuB,EAC1CpH,MAAC,QAAK,6BAAiB,GACzB,EAEAgH,OAAAG,WAAA,CACE,UAAAnH,MAACqH,GAAA,CAAS,UAAU,UAAU,EAC9BrH,MAAC,QAAK,+BAAmB,GAC3B,IAIJA,MAAC,UACC,QAAS+F,GACT,SAAUvO,IAAoBuG,GAC9B,UAAU,0IAET,YACCiJ,OAAAG,WAAA,CACE,UAAAnH,MAACoH,GAAA,CAAQ,UAAU,uBAAuB,EAC1CpH,MAAC,QAAK,8BAAkB,GAC1B,EAEAgH,OAAAG,WAAA,CACE,UAAAnH,MAACsH,GAAA,CAAgB,UAAU,UAAU,EACrCtH,MAAC,QAAK,gCAAoB,GAC5B,GAEJ,EACF,EAGAgH,OAAC,OAAI,IAAK/P,EAAY,UAAU,uDAE9B,UAAA+I,MAAC,OAAI,UAAU,iBACb,SAAAgH,OAAC,OACC,UAAAhH,MAAC,MAAG,UAAU,mCAAmC,yBAAa,EAC9DgH,OAAC,KAAE,UAAU,+BACV,UAAAxM,IAAcwF,MAAC,QAAK,UAAU,cAAe,SAAAxF,GAAW,EACxDA,IAAc,MACdD,GAAW,YAAUD,GACrBsC,GAAW,GAAK,KAAKA,EAAQ,SAChC,EACCC,GAAc,OAAS,GACtBmD,MAAC,KAAE,UAAU,6BACV,SAAAnD,GAAc,KAAK,IAAI,EAC1B,GAEJ,EACF,QAGC,OACA,SAAAkB,GACCiJ,OAAC,OAAI,UAAU,8FACb,UAAAhH,MAACoH,GAAA,CAAQ,UAAU,qCAAqC,EACxDpH,MAAC,QAAK,UAAU,qBAAqB,sCAA0B,GACjE,EACE7M,GACF6T,OAAC,OAAI,UAAU,sFACb,UAAAhH,MAACG,GAAA,CAAY,UAAU,wBAAwB,SAC9C,OACC,UAAAH,MAAC,KAAE,UAAU,cAAc,yCAA6B,EACxDA,MAAC,KAAE,UAAU,uBACV,uBAAiB,MAAQ7M,GAAM,QAAU,gBAC5C,GACF,GACF,EACE4H,EAAS,SAAW,EACtBiM,OAAC,OAAI,UAAU,uFACb,UAAAhH,MAACG,GAAA,CAAY,UAAU,uCAAuC,EAC9DH,MAAC,KAAE,gDAAoC,GACzC,EACE7E,EAAS,SAAW,EACtB6L,OAAC,OAAI,UAAU,uFACb,UAAAhH,MAACG,GAAA,CAAY,UAAU,uCAAuC,EAC9DH,MAAC,KAAE,8CAAkC,GACvC,EAEAgH,OAAAG,WAAA,CAEE,UAAAH,OAAC,OAAI,UAAU,YACb,UAAAhH,MAAC,MAAG,UAAU,2CAA2C,+BAAmB,EAC5EA,MAAC,OAAI,UAAU,oDACb,SAAAA,MAAC,OAAI,UAAU,kBACb,SAAAgH,OAAC,OAAI,UAAU,aAEb,UAAAhH,MAAC,OAAI,UAAU,mCACb,SAAAgH,OAAC,SAAM,UAAU,kBACf,UAAAhH,MAAC,SACC,SAAAgH,OAAC,MAAG,UAAU,aACZ,UAAAhH,MAAC,MAAG,UAAU,sHACZ,SAAAA,MAAC,OAAI,UAAU,mCAAmC,eAAG,EACvD,EACAA,MAAC,MAAG,UAAU,sHACZ,eAAC,OAAI,UAAU,mCAAmC,gBAAI,EACxD,GACF,EACF,EACAA,MAAC,SACE,SAAA7E,EAAS,IAAKtG,GACbmS,OAAC,MAAqB,UAAU,uBAC9B,UAAAhH,MAAC,MAAG,UAAU,2FACX,SAAAnL,EAAQ,IACX,EACAmL,MAAC,MAAG,UAAU,wFACX,WAAQ,KACX,IANOnL,EAAQ,GAOjB,CACD,EACH,GACF,EACF,QAGC,OAAI,UAAU,SACb,SAAAmS,OAAC,SAAM,UAAU,kBACf,UAAAhH,MAAC,SACC,eAAC,MAAG,UAAU,aACX,SAAAV,EAAe,IAAKyB,GAAY,CAE/B,MAAM0F,EAAe1F,EAAQ,gBAC3B,OAAOA,EAAQ,eAAkB,UAChC,OAAOA,EAAQ,eAAkB,UAAY,UAAWA,EAAQ,eAAiBA,EAAQ,cAAc,OAG1G,OACEf,MAAC,MAEC,UAAU,6GAEV,SAAAgH,OAAC,OAAI,UAAU,mEACb,UAAAA,OAAC,QAAK,UAAU,wBAAwB,cAAEjG,EAAQ,cAAa,EAC9D0F,SACE,QAAK,UAAU,2DACb,SAAAvQ,GAAkB6K,EAAQ,aAAa,EAC1C,GAEJ,GAVKA,EAAQ,GAanB,CAAC,EACH,EACF,EACAf,MAAC,SACE,SAAA7E,EAAS,IAAKtG,GAAY,CACzB,MAAMwR,EAAoBzG,GAAiB/K,EAAQ,GAAG,GAAK,GAE3D,aACG,MAAqB,UAAU,uBAC7B,SAAAyK,EAAe,IAAKyB,GAAY,CAC/B,MAAMjB,EAAS9G,GAAqB,GAAGnE,EAAQ,GAAG,IAAIkM,EAAQ,EAAE,EAAE,GAAKsF,EAAkBtF,EAAQ,EAAE,GAAK,GAClGwG,EAAU,GAAG1S,EAAQ,GAAG,IAAIkM,EAAQ,EAAE,GACtCyG,EAAa1O,GAAc,IAAIyO,CAAO,EACtCE,EAAW/O,GAAY6O,CAAO,EACpC,OACEvH,MAAC,MAEC,UAAW,6DAA6DO,GAAeT,CAAM,CAAC,IAAIpI,EAAsB,iBAAmB,EAAE,IAAI8P,EAAa,eAAiB,EAAE,IAAIpO,KAAemO,EAAU,qCAAuC,EAAE,GACvP,QAAS,IAAM,CACR7P,IACD4B,IAA0B,KAC5BoI,GAAiB6F,EAASjO,CAAqB,EAE/CD,GAAckO,CAAO,EAEzB,EAEC,SAAA7P,GAAuB0B,KAAemO,EACrCP,OAAC,UACC,UAAS,GACT,MAAOlH,EACP,SAAWT,GAAMqC,GAAiB6F,EAASlI,EAAE,OAAO,KAAK,EACzD,OAAQ,IAAMhG,GAAc,IAAI,EAChC,UAAU,yEAEV,UAAA2G,MAAC,UAAO,MAAM,GAAG,EAChB5M,GAAoB,MAAM,CAAC,EAAE,IAAI2B,GAAKiL,MAAC,UAAe,MAAOjL,EAAI,SAAAA,CAAA,EAAdA,CAAgB,CAAS,KAE7E0S,EACFzH,MAACoH,GAAA,CAAQ,UAAU,6CAA6C,EAEhErH,GAAcD,CAAM,GAzBjBiB,EAAQ,GA6BnB,CAAC,GArCMlM,EAAQ,GAsCjB,CAEJ,CAAC,EACH,GACF,EACF,GACF,EACF,EACF,GACF,QAGC,OAAI,UAAU,YACb,SAAAmS,OAAC,OAAI,UAAU,4CACb,UAAAhH,MAAC,QAAK,UAAU,4BAA4B,mBAAO,EACnDgH,OAAC,OAAI,UAAU,0BACb,UAAAhH,MAACC,GAAA,CAAY,UAAU,yBAAyB,EAChDD,MAAC,QAAK,UAAU,gBAAgB,mBAAO,GACzC,EACAgH,OAAC,OAAI,UAAU,0BACb,UAAAhH,MAACI,GAAA,CAAW,UAAU,0BAA0B,EAChDJ,MAAC,QAAK,UAAU,gBAAgB,gBAAI,GACtC,EACAgH,OAAC,OAAI,UAAU,0BACb,UAAAhH,MAACE,GAAA,CAAM,UAAU,wBAAwB,EACzCF,MAAC,QAAK,UAAU,gBAAgB,mBAAO,GACzC,EACAgH,OAAC,OAAI,UAAU,0BACb,UAAAhH,MAACG,GAAA,CAAY,UAAU,0BAA0B,EACjDH,MAAC,QAAK,UAAU,gBAAgB,gBAAI,GACtC,EACAgH,OAAC,OAAI,UAAU,0BACb,UAAAhH,MAACK,GAAA,CAAQ,UAAU,uBAAuB,EAC1CL,MAAC,QAAK,UAAU,gBAAgB,kBAAM,GACxC,EACAgH,OAAC,OAAI,UAAU,0BACb,UAAAhH,MAACC,GAAA,CAAY,UAAU,0BAA0B,EACjDD,MAAC,QAAK,UAAU,gBAAgB,iBAAK,GACvC,EACAgH,OAAC,OAAI,UAAU,0BACb,UAAAhH,MAACM,GAAA,CAAM,UAAU,wBAAwB,EACzCN,MAAC,QAAK,UAAU,gBAAgB,mBAAO,GACzC,GACF,EACF,EAGAgH,OAAC,OAAI,UAAU,YACb,UAAAhH,MAAC,MAAG,UAAU,2CAA2C,gCAAoB,QAC5E,OAAI,UAAU,oDACb,SAAAgH,OAAC,SAAM,UAAU,iCACf,UAAAhH,MAAC,SACC,SAAAgH,OAAC,MAAG,UAAU,aACZ,UAAAhH,MAAC,MAAG,UAAU,gFAAgF,mBAE9F,EACAA,MAAC,MAAG,UAAU,gFAAgF,gBAAI,EAClGA,MAAC,MAAG,UAAU,gFAAgF,gBAAI,EAClGA,MAAC,MAAG,UAAU,gFAAgF,qBAAS,EACvGA,MAAC,MAAG,UAAU,2EAA2E,iBAEzF,GACF,EACF,EACAA,MAAC,SACE,SAAAV,EAAe,IAAKyB,GAAY,CAC/B,MAAM0F,EAAe1F,EAAQ,gBAC3B,OAAOA,EAAQ,eAAkB,UAChC,OAAOA,EAAQ,eAAkB,UAAY,UAAWA,EAAQ,eAAiBA,EAAQ,cAAc,OAE1G,IAAIxC,EAAe,GACnB,OAAIwC,EAAQ,QACN,OAAOA,EAAQ,OAAU,WAAyBA,EAAQ,MACrD,WAAYA,EAAQ,OAASA,EAAQ,MAAM,QAAOxC,EAAewC,EAAQ,MAAM,SAIxFiG,OAAC,MAAoB,UAAU,mBAC7B,UAAAA,OAAC,MAAG,UAAU,+DAA+D,cACzEjG,EAAQ,cACZ,EACAf,MAAC,MAAG,UAAU,mDACX,WAAae,EAAQ,EAAE,IAAM,OAC5Bf,MAAC,SACC,KAAK,OACL,MAAO5H,GAAY2I,EAAQ,EAAE,IAAM,IAAM,CACvC,GAAI,CAAC0F,EAAc,MAAO,GAC1B,IAAIiB,EAAU,GAGd,GAFI,OAAO3G,EAAQ,eAAkB,WAAoBA,EAAQ,cACxD,OAAOA,EAAQ,eAAkB,UAAYA,EAAQ,cAAc,QAAO2G,EAAU3G,EAAQ,cAAc,MAC/G,CAAC2G,EAAS,MAAO,GACrB,MAAMnT,EAAI,IAAI,KAAKmT,CAAO,EAC1B,OAAO,MAAMnT,EAAE,SAAS,EAAI,GAAKA,EAAE,cAAc,MAAM,EAAE,EAAE,CAC7D,KACA,SAAW8K,GAAMhH,GAAgBsP,IAAO,CAAE,GAAGA,EAAG,CAAC5G,EAAQ,EAAE,EAAG1B,EAAE,OAAO,OAAQ,EAC/E,UAAU,wBAGZoH,EAAe7Q,GAAWmL,EAAQ,aAAa,EAAI,IAEvD,EACAf,MAAC,MAAG,UAAU,mDACX,WAAae,EAAQ,EAAE,IAAM,OAC5Bf,MAAC,SACC,KAAK,OACL,MAAO1H,GAAYyI,EAAQ,EAAE,IAAM,IAAM,CACvC,MAAMzM,EAAM,OAAOyM,EAAQ,eAAkB,SACzCA,EAAQ,cACPA,EAAQ,eAAiB,WAAaA,EAAQ,eAA0BA,EAAQ,cAAsB,MACpGA,EAAQ,cAAsB,OAC/B,GACN,GAAI,CAACzM,EAAK,MAAO,GAEjB,MAAMG,EAAQH,EAAI,MAAM,GAAG,EAC3B,OAAOG,EAAM,QAAU,EAAI,GAAGA,EAAM,CAAC,EAAE,SAAS,EAAE,GAAG,CAAC,IAAIA,EAAM,CAAC,EAAE,SAAS,EAAE,GAAG,CAAC,GAAKH,CACzF,KACA,SAAW+K,GAAM9G,GAAgBoP,IAAO,CAAE,GAAGA,EAAG,CAAC5G,EAAQ,EAAE,EAAG1B,EAAE,OAAO,OAAQ,EAC/E,UAAU,wBAGZhJ,GAAW0K,EAAQ,aAAoB,EAE3C,EACAf,MAAC,MAAG,UAAU,mDACX,WAAae,EAAQ,EAAE,IAAM,OAC5BiG,OAAC,UACC,MAAOxO,GAAgBuI,EAAQ,EAAE,GAAK,GACtC,SAAW1B,GAAM5G,GAAoBkP,IAAO,CAAE,GAAGA,EAAG,CAAC5G,EAAQ,EAAE,EAAG1B,EAAE,OAAO,OAAQ,EACnF,UAAU,6BAEV,UAAAW,MAAC,UAAO,MAAM,GAAG,2BAAe,EAC/B7D,GAAY,IAAKW,GAChBkD,MAAC,UAAwB,MAAOlD,EAC7B,SAAAN,EAAeM,CAAU,GAAKA,CAAA,EADpBA,CAEb,CACD,MAGF,IAAM,CACL,MAAMA,EAAa1I,EAAc2M,EAAQ,QAAkC,EAC3E,OAAOjE,GAAcN,EAAeM,CAAU,EAAIN,EAAeM,CAAU,EAAI,GACjF,IAAG,CAEP,EACAkD,MAAC,MAAG,UAAU,mDACX,SAAApI,EACCM,EAAa6I,EAAQ,EAAE,IAAM,OAC3BiG,OAAC,OAAI,UAAU,0BACb,UAAAhH,MAAC,SACC,MAAO9H,EAAa6I,EAAQ,EAAE,EAC9B,SAAW1B,GAAMlH,GAAiBwP,IAAO,CAAE,GAAGA,EAAG,CAAC5G,EAAQ,EAAE,EAAG1B,EAAE,OAAO,OAAQ,EAChF,UAAU,6BACV,YAAY,4BAEdW,MAAC,UACC,QAAS,IAAMlB,GAAUiC,EAAQ,EAAE,EACnC,SAAUzD,GAAsB,UAChC,UAAU,2FACX,kBAGD0C,MAAC,UACC,QAAS,IAAMpB,GAAgBmC,EAAQ,EAAE,EACzC,SAAUzD,GAAsB,UAChC,UAAU,wEACX,mBAED,EACF,EAEA0J,OAAC,OAAI,UAAU,0CACb,UAAAhH,MAAC,QAAK,UAAU,yBAA0B,SAAAzB,GAAgB,IAAI,EAC9DyB,MAAC,UACC,QAAS,IAAM,CACb,IAAI4H,EAAe,GACnB,GAAInB,EAAc,CAChB,IAAIiB,EAAU,GAGd,GAFI,OAAO3G,EAAQ,eAAkB,WAAoBA,EAAQ,cACxD,OAAOA,EAAQ,eAAkB,UAAYA,EAAQ,cAAc,QAAO2G,EAAU3G,EAAQ,cAAc,MAC/G2G,EAAS,CACX,MAAMnT,EAAI,IAAI,KAAKmT,CAAO,EACrB,MAAMnT,EAAE,SAAS,IAAGqT,EAAerT,EAAE,cAAc,MAAM,EAAE,EAAE,EACpE,CACF,CACA,IAAIsT,EAAe,GACnB,MAAMC,EAAU,OAAO/G,EAAQ,eAAkB,SAC7CA,EAAQ,cACPA,EAAQ,eAAiB,WAAaA,EAAQ,eAA0BA,EAAQ,cAAsB,MACpGA,EAAQ,cAAsB,OAC/B,GACN,GAAI+G,EAAS,CACX,MAAMrT,EAAQqT,EAAQ,MAAM,GAAG,EAC3BrT,EAAM,QAAU,MAAkB,GAAGA,EAAM,CAAC,EAAE,SAAS,EAAE,GAAG,CAAC,IAAIA,EAAM,CAAC,EAAE,SAAS,EAAE,GAAG,CAAC,GAC/F,CACA,MAAMsT,EAAmB3T,EAAc2M,EAAQ,QAAkC,EACjFzC,GAAeyC,EAAQ,GAAIxC,EAAcqJ,EAAcC,EAAcE,CAAgB,CACvF,EACA,UAAU,2EACX,iBAED,EACF,EAGF/H,MAAC,QAAM,SAAAzB,GAAgB,IAAI,EAE/B,IAjIOwC,EAAQ,EAkIjB,CAEJ,CAAC,EACH,GACF,EACF,GACF,EAGAiG,OAAC,OAAI,UAAU,iBACb,UAAAhH,MAAC,OAAI,UAAU,yCACb,SAAAA,MAAC,MAAG,UAAU,sCAAsC,2BAAe,EAErE,EACAA,MAAC,OAAI,UAAU,oDACb,SAAAA,MAAC,OAAI,UAAU,kBACb,SAAAgH,OAAC,SAAM,UAAU,iCACf,UAAAhH,MAAC,SACC,SAAAgH,OAAC,MAAG,UAAU,aACZ,UAAAhH,MAAC,MAAG,UAAU,yFAAyF,eAEvG,EACAA,MAAC,MAAG,UAAU,yFAAyF,gBAEvG,EACAA,MAAC,MAAG,UAAU,2FAA2F,yBAEzG,EACAA,MAAC,MAAG,UAAU,2FAA2F,mBAEzG,EACAA,MAAC,MAAG,UAAU,2FAA2F,gBAEzG,EACAA,MAAC,MAAG,UAAU,2FAA2F,sBAEzG,EACAA,MAAC,MAAG,UAAU,2FAA2F,mBAEzG,EACAA,MAAC,MAAG,UAAU,2FAA2F,iBAEzG,QACC,MAAG,UAAU,2FACZ,SAAAgH,OAAC,OAAI,UAAU,6BACb,UAAAhH,MAAC,QAAK,mBAAO,EACbA,MAAC,QAAK,UAAU,oCAAoC,kBAAM,GAC5D,EACF,QACC,MAAG,UAAU,2FACZ,SAAAgH,OAAC,OAAI,UAAU,6BACb,UAAAhH,MAAC,QAAK,kBAAM,EACZA,MAAC,QAAK,UAAU,oCAAoC,kBAAM,GAC5D,EACF,EACAA,MAAC,MAAG,UAAW,mFAAmFlI,EAAkB,WAAa,EAAE,GACjI,SAAAkP,OAAC,OAAI,UAAU,6BACb,UAAAhH,MAAC,QAAK,iBAAK,EACXA,MAAC,QAAK,UAAU,oCAAoC,kBAAM,GAC5D,EACF,EACClI,GACCkI,MAAC,MAAG,UAAU,kFAAkF,kBAEhG,GAEJ,EACF,SACC,SACE,UAAA7E,EAAS,IAAKtG,GAAY,CACzB,MAAM3B,EAAQ+K,EAAoBpJ,CAAO,GAAM,CAC7C,GAAI,EACJ,OAAQ,KACR,uBAAwB,KACxB,aAAc,KACd,KAAM,KACN,MAAO,KACP,IAAK,KACL,IAAK,KACL,YAAa,KACb,YAAa,KACb,aAAc,MAGV2B,EAAgB3B,EAAgB,QAAWA,EAAgB,QAAWA,EAAgB,OAAUA,EAAgB,KAAK,IAAOA,EAAgB,KAAK,KAAK,GACtJwM,EAAWnO,EAAM,IAAMA,EAAM,GAAK,EACpC,MAAMA,EAAM,EAAE,GACbA,EAAM,OAAS,OAAO,OAAOA,EAAM,QAAW,SAAYA,EAAM,OAAe,MAAQA,EAAM,MAAM,GAAMsD,EAAe,OAAOA,CAAY,GAAK,OAAO3B,EAAQ,GAAG,GACjKmT,EAAcpO,GAAmB,IAAIyH,CAAQ,EAC7C4G,EAAYnQ,GAAmB,CAACkQ,EAChCP,EAAWvU,EAAM,GAAKwG,GAAe,IAAIxG,EAAM,EAAE,EAAI,GACrDgJ,EAAS1C,EAAa6H,CAAQ,GAAKnO,EAGnC4T,EAAYtR,GAAgC,CAChD,MAAM/B,EAAMyI,EAAO1G,CAAG,EACtB,OAAI/B,GAAQ,KAAkC,GAC1C,OAAOA,GAAQ,UAAY,YAAaA,EAAYA,EAAI,MAAQA,EAAI,QAAU,GAC9E,OAAOA,GAAQ,UAAY,WAAYA,EAAYA,EAAI,MAAQA,EAAI,OAAS,GAC5E,OAAOA,GAAQ,UAAY,UAAWA,EAAYA,EAAI,MAAQA,EAAI,MAAQ,GACvEA,CACT,EAGMyU,EAAkBpB,EAAS,aAAa,EACxCqB,EAAiBD,IAAoB,GAAKA,EAAmBpQ,GAAmBoE,EAAShH,GAAsBgH,EAAQ9G,EAAe,EAAI,KAC1I,CAAE,MAAOgT,EAAW,OAAQC,CAAA,EAAeF,IAAmB,MAAQA,IAAmB,GAAKnT,GAAqBmT,CAAc,EAAI,CAAE,MAAO,GAAI,OAAQ,GAC1JG,EAAkBxB,EAAS,aAAa,EACxCyB,EAAeD,IAAoB,GAAKA,EAAkBF,EAC1DI,EAAmB1B,EAAS,cAAc,EAC1C2B,EAAgBD,IAAqB,GAAKA,EAAmBH,EAEnE,OACErB,OAAC,MAAqB,UAAU,mBAC9B,UAAAhH,MAAC,MAAG,UAAU,6EACX,SAAAnL,EAAQ,IACX,EACAmL,MAAC,MAAG,UAAU,iEACX,WAAQ,KACX,EAEAA,MAAC,MAAG,UAAU,+DACX,SAAAiI,EACCjI,MAAC,SACC,KAAK,SACL,KAAK,MACL,MAAO8G,EAAS,wBAAwB,EACxC,SAAWzH,GAAMwF,GAAiBxD,EAAU,yBAA0BhC,EAAE,OAAO,MAAQ,WAAWA,EAAE,OAAO,KAAK,EAAI,IAAI,EACxH,UAAU,oJAGZW,MAAC,QAAK,UAAU,gBAAkB,cAAM,CAAE,MAAM3B,EAAIyI,EAAS,wBAAwB,EAAG,OAAOzI,IAAM,GAAKA,EAAI,GAAK,KAAK,EAE5H,EAEA2B,MAAC,MAAG,UAAU,+DACX,SAAAiI,EACCjI,MAAC,SACC,KAAK,SACL,KAAK,MACL,MAAO8G,EAAS,cAAc,EAC1B,SAAWzH,GAAMwF,GAAiBxD,EAAU,eAAgBhC,EAAE,OAAO,MAAQ,WAAWA,EAAE,OAAO,KAAK,EAAI,IAAI,EAClH,UAAU,oJAGZW,MAAC,QAAK,UAAU,gBAAkB,cAAM,CAAE,MAAM3B,EAAIyI,EAAS,cAAc,EAAG,OAAOzI,IAAM,GAAKA,EAAI,GAAK,KAAK,EAElH,EAEA2B,MAAC,MAAG,UAAU,+DACX,SAAAiI,EACCjI,MAAC,SACC,KAAK,SACL,KAAK,MACL,MAAO8G,EAAS,MAAM,EACtB,SAAWzH,GAAMwF,GAAiBxD,EAAU,OAAQhC,EAAE,OAAO,MAAQ,WAAWA,EAAE,OAAO,KAAK,EAAI,IAAI,EACtG,UAAU,oJAGZW,MAAC,QAAK,UAAU,gBAAkB,cAAM,CAAE,MAAM3B,EAAIyI,EAAS,MAAM,EAAG,OAAOzI,IAAM,GAAKA,EAAI,GAAK,KAAK,EAE1G,EAEA2B,MAAC,MAAG,UAAU,+DACX,SAAAiI,EACCjI,MAAC,SACC,KAAK,SACL,KAAK,MACL,MAAO8G,EAAS,OAAO,EACvB,SAAWzH,GAAMwF,GAAiBxD,EAAU,QAAShC,EAAE,OAAO,MAAQ,WAAWA,EAAE,OAAO,KAAK,EAAI,IAAI,EACvG,UAAU,oJAGZW,MAAC,QAAK,UAAU,gBAAkB,cAAM,CAAE,MAAM3B,EAAIyI,EAAS,OAAO,EAAG,OAAOzI,IAAM,GAAKA,EAAI,GAAK,KAAK,EAE3G,EAEA2B,MAAC,MAAG,UAAU,+DACX,SAAAiI,EACCjI,MAAC,SACC,KAAK,SACL,KAAK,MACL,MAAO8G,EAAS,KAAK,EACrB,SAAWzH,GAAMwF,GAAiBxD,EAAU,MAAOhC,EAAE,OAAO,MAAQ,WAAWA,EAAE,OAAO,KAAK,EAAI,IAAI,EACrG,UAAU,oJAGZW,MAAC,QAAK,UAAU,gBAAkB,cAAM,CAAE,MAAM3B,EAAIyI,EAAS,KAAK,EAAG,OAAOzI,IAAM,GAAKA,EAAI,GAAK,KAAK,EAEzG,EAEA2B,MAAC,MAAG,UAAU,+DACX,SAAAiI,EACCjI,MAAC,SACC,KAAK,SACL,KAAK,MACL,MAAO8G,EAAS,KAAK,EACrB,SAAWzH,GAAMwF,GAAiBxD,EAAU,MAAOhC,EAAE,OAAO,MAAQ,WAAWA,EAAE,OAAO,KAAK,EAAI,IAAI,EACrG,UAAU,oJAGZW,MAAC,QAAK,UAAU,gBAAkB,cAAM,CAAE,MAAM3B,EAAIyI,EAAS,KAAK,EAAG,OAAOzI,IAAM,GAAKA,EAAI,GAAK,KAAK,EAEzG,EAEA2B,MAAC,MAAG,UAAU,2FACZ,SAAAgH,OAAC,OAAI,UAAW,qBAAqBiB,EAAY,2BAA6B,EAAE,GAC9E,UAAAjI,MAAC,QAAM,SAAAmI,IAAmB,MAAQA,IAAmB,GAAKA,EAAiB,IAAI,EAC9EF,GAAaE,IAAmB,MAAQA,IAAmB,IAC1DnI,MAAC,QAAK,UAAU,6BAA6B,aAAC,GAElD,EACF,EAEAA,MAAC,MAAG,UAAU,uFACZ,SAAAgH,OAAC,OAAI,UAAW,qBAAqBiB,EAAY,aAAe,EAAE,GAChE,UAAAjI,MAAC,QAAM,YAAgB,IAAI,EAC1BiI,GAAaM,GACZvI,MAAC,QAAK,UAAU,eAAe,aAAC,GAEpC,EACF,EAEAA,MAAC,MAAG,UAAW,mFAAmFlI,EAAkB,WAAa,EAAE,GACjI,SAAAkP,OAAC,OAAI,UAAW,qBAAqBiB,EAAY,2BAA6B,EAAE,GAC9E,UAAAjI,MAAC,QAAM,YAAiB,IAAI,EAC3BiI,GAAaQ,GACZzI,MAAC,QAAK,UAAU,6BAA6B,aAAC,GAElD,EACF,EAEClI,GACCkI,MAAC,MAAG,UAAU,iDACX,SAAAgI,EACChI,MAAC,UACC,QAAS,IAAM,CAEbnG,GAAuB8E,GAAS,CAC9B,MAAME,GAAO,IAAI,IAAIF,CAAI,EACzB,OAAAE,GAAK,OAAOwC,CAAQ,EACbxC,EACT,CAAC,EAED,MAAM6J,EAAezK,EAAoBpJ,CAAO,EAC5C6T,GACFjP,EAAgBkF,IAAS,CACvB,GAAGA,EACH,CAAC0C,CAAQ,EAAGqH,CAAA,EACZ,CAEN,EACA,UAAU,qEACX,kBAID1B,OAAC,OAAI,UAAU,4BACb,UAAAhH,MAAC,UACC,QAAS,IAAMiD,GAAU5B,EAAUnO,EAAO2B,CAAO,EACjD,SAAU4S,EACV,UAAU,2FAET,WAAW,YAAc,SAE5BzH,MAAC,UACC,QAAS,IAAM,CAEb,MAAMyE,EAAgBxG,EAAoBpJ,CAAO,EAE/C4E,EADEgL,EACc9F,IAAS,CACvB,GAAGA,EACH,CAAC0C,CAAQ,EAAGoD,CAAA,GAGE9F,GAAQ,CACtB,MAAME,GAAO,CAAE,GAAGF,CAAA,EAClB,cAAOE,GAAKwC,CAAQ,EACbxC,EACT,CANE,EASJhF,GAAuB8E,GAAS,IAAI,IAAI,CAAC,GAAGA,EAAM0C,CAAQ,CAAC,CAAC,CAC9D,EACA,SAAUoG,EACV,UAAU,4FACX,mBAED,EACF,EAEJ,IAlLK5S,EAAQ,GAoLjB,CAEJ,CAAC,EAEDmS,OAAC,MAAG,UAAU,uBACZ,UAAAA,OAAC,MAAG,QAAS,EAAG,UAAU,4DAA4D,8BAEnFlP,GACCkI,MAAC,OAAI,UAAU,yCAAyC,gCAExD,GAEJ,EACAA,MAAC,MAAG,UAAU,6EACX,SAAAlI,EACCkI,MAAC,SACC,KAAK,OACL,MAAOpE,EAAa,uBACpB,SAAWyD,GAAMuE,GAAkB,qBAAsBvE,EAAE,OAAO,KAAK,EACvE,UAAU,uHAGZ,GAAGzD,EAAa,sBAAsB,IAE1C,EACAoE,MAAC,MAAG,UAAU,6EACX,SAAAlI,EACCkI,MAAC,SACC,KAAK,OACL,MAAOpE,EAAa,aACpB,SAAWyD,GAAMuE,GAAkB,eAAgBvE,EAAE,OAAO,KAAK,EACjE,UAAU,uHAGZ,GAAGzD,EAAa,YAAY,IAEhC,EACAoE,MAAC,MAAG,UAAU,6EACX,SAAAlI,EACCkI,MAAC,SACC,KAAK,OACL,MAAOpE,EAAa,KACpB,SAAWyD,GAAMuE,GAAkB,aAAcvE,EAAE,OAAO,KAAK,EAC/D,UAAU,uHAGZ,GAAGzD,EAAa,IAAI,IAExB,EACAoE,MAAC,MAAG,UAAU,6EACX,SAAAlI,EACCkI,MAAC,SACC,KAAK,OACL,MAAOpE,EAAa,MACpB,SAAWyD,GAAMuE,GAAkB,cAAevE,EAAE,OAAO,KAAK,EAChE,UAAU,uHAGZ,GAAGzD,EAAa,KAAK,IAEzB,EACAoE,MAAC,MAAG,UAAU,6EACX,SAAAlI,EACCkI,MAAC,SACC,KAAK,OACL,MAAOpE,EAAa,IACpB,SAAWyD,GAAMuE,GAAkB,YAAavE,EAAE,OAAO,KAAK,EAC9D,UAAU,uHAGZ,GAAGzD,EAAa,GAAG,IAEvB,EACAoE,MAAC,MAAG,UAAU,6EACX,SAAAlI,EACCkI,MAAC,SACC,KAAK,OACL,MAAOpE,EAAa,IACpB,SAAWyD,GAAMuE,GAAkB,YAAavE,EAAE,OAAO,KAAK,EAC9D,UAAU,uHAGZ,GAAGzD,EAAa,GAAG,IAEvB,EACAoL,OAAC,MAAG,QAAS,EAAG,UAAU,sFACxB,UAAAA,OAAC,OAAI,UAAU,gBAAgB,qBAE3BpL,EAAa,uBACbA,EAAa,aACbA,EAAa,KACbA,EAAa,MACbA,EAAa,IACbA,EAAa,KACb,QAAQ,CAAC,EAAE,KACf,EACC1B,IACC8F,MAAC,OAAI,UAAU,4BACZ,SAAA9F,EAAA,CACH,GAEJ,EAEA8F,MAAC,MAAG,UAAW,kDAAkDlI,EAAkB,GAAK,QAAQ,GAC7F,SAAAA,GACCkI,MAAAmH,WAAA,CACG,SAAA/M,GACC4F,MAAC,UACC,QAAS,IAAM,CACb3F,GAAoB,EAAK,CAC3B,EACA,UAAU,qEACX,kBAID2M,OAAC,OAAI,UAAU,4BACb,UAAAhH,MAAC,UACC,QAAS,IAAM+D,GAAA,EACf,SAAU/J,GACV,UAAU,2FAET,YAAiB,YAAc,SAElCgG,MAAC,UACC,QAAS8D,GACT,SAAU9J,GACV,UAAU,4FACX,mBAED,EACF,EAEJ,EAEJ,GACF,GACF,GACF,EACF,EACF,GACF,GACF,EAEF,GACF,GACF,CAEJ","names":["useLecturerAssignments","params","useQuery","apiService","useGrades","useCreateGrade","options","qc","useQueryClient","useMutation","data","useUpdateGrade","id","_response","variables","updatedGrade","old","grade","error","ATTENDANCE_STATUSES","KEYBOARD_STATUS_MAP","DEFAULT_GRADE_WEIGHTS","BOBOT_FIELDS","extractBobotValue","val","sqlNull","getGradeComponents","classData","partisipatif","proyek","kuis","tugas","uts","uas","GRADE_COMPARE_FIELDS","extractString","extractDateISO","raw","d","extractTimeHHMM","parts","extractNumeric","extractPrimitive","getStudentKrsId","student","normalizeStatus","s","calculateLetterGrade","nilaiAngka","calculateNumericGrade","components","gradeComponents","totalWeight","totalValue","hasAnyValue","key","weight","rawValue","value","formatDate","dateValue","dateString","date","dayOfWeek","formattedDate","formatDateCompact","day","month","formatTime","timeValue","generateGradeKey","studentKrsId","studentNim","ClassSummary","classId","useParams","searchParams","useSearchParams","navigate","useNavigate","contentRef","useRef","queryClient","justSavedAttendanceRef","isGeneratingPDF","setIsGeneratingPDF","useState","isGeneratingXLSX","setIsGeneratingXLSX","isAttendanceEditing","setIsAttendanceEditing","isMeetingEditing","setIsMeetingEditing","isGradesEditing","setIsGradesEditing","isSavingAll","setIsSavingAll","editedTopics","setEditedTopics","editedDates","setEditedDates","editedTimes","setEditedTimes","editedLecturers","setEditedLecturers","savingCells","setSavingCells","initialAttendanceSnapshot","setInitialAttendanceSnapshot","modifiedCells","setModifiedCells","pendingStatusChanges","setPendingStatusChanges","originalAttendanceCache","setOriginalAttendanceCache","activeCell","setActiveCell","currentShortcutStatus","setCurrentShortcutStatus","editedGrades","setEditedGrades","savingGradeIds","setSavingGradeIds","completedGradeKeys","setCompletedGradeKeys","editedBobots","setEditedBobots","isSavingBobots","setIsSavingBobots","bobotError","setBobotError","isBobotCompleted","setIsBobotCompleted","className","courseName","courseCode","fromPage","sksTatapMuka","sksPraktek","sksPrakLapangan","sksSimulasi","classIdNum","meetings","loadingMeetings","meetingsError","useClassMeetings","students","loadingStudents","studentsError","useClassStudents","gradeRecords","loadingGrades","lecturerAssignments","loadingLecturers","loadingClassData","gradeWeights","useMemo","effectiveClassData","originalBobotWeights","hasEditedBobots","field","edited","lecturerIds","idSet","assignment","lecturerQueryResults","useQueries","lecturerLookup","lookup","q","lecturer","totalSks","lecturerNames","lecturerId","meetingIds","m","attendanceMap","loadingAttendances","map","meetingId","records","updateMeetingMutation","useUpdateMeeting","createAttendanceMutation","useCreateAttendance","updateAttendanceMutation","useUpdateAttendance","updateGradeMutation","createGradeMutation","loadingLecturersDetails","loading","anyEditing","findGradeForStudent","found","g","k","v","startEditTopic","currentTopik","currentDate","currentTime","currentLecturer","prev","cancelEditTopic","next","saveTopic","newTopic","newDateRaw","newTimeRaw","newLecturer","newDateISO","newTimeWithSeconds","e","sortedMeetings","getTimeValue","t","a","b","diff","attendanceLookup","record","status","getStatusIcon","jsx","CheckCircle","Clock","AlertCircle","ClockAlert","XCircle","Minus","getStatusColor","useEffect","snap","r","handler","recalcModified","original","hasUnsavedChanges","meeting","editedTopik","editedDate","currentDateISO","editedTime","editedLecturer","gradeKey","krsId","nim","eVal","oVal","updateSingleCell","newStatus","meetingIdStr","queryKey","clone","arr","existingIdx","commitAttendanceChanges","skipExit","changes","existing","enterAttendanceEditMode","exitAttendanceEditMode","enterMeetingEditMode","topics","dates","times","lecturers","exitMeetingEditMode","enterGradesEditMode","gradeMap","exitGradesEditMode","exitAllEditModes","saveGrade","idNum","editedGrade","originalValue","editedValue","calculatedNumeric","nilaiHuruf","nilaiIndeks","huruf","indeks","updateData","handleBobotChange","numValue","cancelBobots","saveBobots","bobotData","total","saveAllAndFinish","meetingSavePromises","idStr","bobotSaved","gradeSavePromises","targetStudent","gradeId","originalGrade","attendancePromise","exitEditMode","err","updateGradeField","comp","handleBack","handleGeneratePDF","fn","html2canvas","jsPDF","__vitePreload","n","canvas","imgWidth","pageHeight","imgHeight","heightLeft","pdf","position","imgData","filename","handleGenerateXLSX","XLSX","workbook","classDescData","classDescSheet","attendanceData","studentAttendance","row","attendanceSheet","meetingSummaryData","hasValidDate","topik","lecturerName","meetingSheet","gradesData","getValue","gradesSheet","jsxs","Home","ChevronRight","Fragment","Loader2","Download","FileSpreadsheet","cellKey","isModified","isSaving","rawDate","p","dateForInput","timeForInput","rawTime","lecturerForInput","isCompleted","isEditing","nilaiAngkaValue","displayNumeric","calcHuruf","calcIndeks","nilaiHurufValue","displayHuruf","nilaiIndeksValue","displayIndeks","currentGrade"],"ignoreList":[],"sources":["../../src/hooks/useLecturerAssignments.ts","../../src/hooks/useGrades.ts","../../src/pages/shared/ClassSummary.tsx"],"sourcesContent":["import { useQuery } from '@tanstack/react-query';\r\nimport { apiService } from '../services/api';\r\nimport type { DosenPengajar, GetLecturerAssignmentsParams } from '../types';\r\n\r\nexport function useLecturerAssignments(params?: GetLecturerAssignmentsParams) {\r\n  return useQuery<DosenPengajar[], Error>({\r\n    queryKey: ['lecturer-assignments', params],\r\n    queryFn: () => apiService.getLecturerAssignments(params),\r\n  });\r\n}\r\n","import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\r\nimport { apiService } from '../services/api';\r\nimport type { GetGradesParams, GradeRecord, CreateGradeRequest, UpdateGradeRequest } from '../types';\r\n\r\nexport function useGrades(params?: GetGradesParams) {\r\n  return useQuery<GradeRecord[], Error>({\r\n    queryKey: ['grades', params?.krs_id ?? null, params?.kelas_id ?? null],\r\n    queryFn: () => apiService.getGrades(params),\r\n    enabled: Boolean(params && (params.krs_id !== undefined || params.kelas_id !== undefined)),\r\n  });\r\n}\r\n\r\nexport function useCreateGrade(options?: { skipInvalidation?: boolean }) {\r\n  const qc = useQueryClient();\r\n  return useMutation({\r\n    mutationFn: (data: CreateGradeRequest) => apiService.createGrade(data),\r\n    onSuccess: async () => {\r\n      if (!options?.skipInvalidation) {\r\n        // For create, we need to invalidate since we don't have the new ID yet\r\n        qc.invalidateQueries({ queryKey: ['grades'] });\r\n      }\r\n    },\r\n  });\r\n}\r\n\r\nexport function useUpdateGrade(options?: { skipInvalidation?: boolean }) {\r\n  const qc = useQueryClient();\r\n  return useMutation({\r\n    mutationFn: ({ id, data }: { id: number; data: UpdateGradeRequest }) => apiService.updateGrade(id, data),\r\n    onSuccess: async (_response, variables) => {\r\n      if (!options?.skipInvalidation) {\r\n        // Fetch the updated grade and update cache instead of invalidating all\r\n        try {\r\n          const updatedGrade = await apiService.getGrade(variables.id);\r\n\r\n          // Update all matching grade queries\r\n          qc.setQueriesData<GradeRecord[]>(\r\n            { queryKey: ['grades'], exact: false },\r\n            (old) => {\r\n              if (!old) return old;\r\n              return old.map(grade =>\r\n                grade.id === variables.id ? updatedGrade : grade\r\n              );\r\n            }\r\n          );\r\n        } catch (error) {\r\n          // Fallback to invalidation if fetch fails\r\n          console.error('Failed to fetch updated grade, invalidating:', error);\r\n          qc.invalidateQueries({ queryKey: ['grades'] });\r\n        }\r\n      }\r\n    },\r\n  });\r\n}\r\n\r\nexport function useDeleteGrade() {\r\n  const qc = useQueryClient();\r\n  return useMutation({\r\n    mutationFn: (id: number) => apiService.deleteGrade(id),\r\n    onSuccess: () => {\r\n      qc.invalidateQueries({ queryKey: ['grades'] });\r\n    },\r\n  });\r\n}\r\n","import React, { useMemo, useRef, useState, useEffect } from 'react';\r\nimport { useParams, useNavigate, useSearchParams } from 'react-router-dom';\r\nimport { useQuery, useQueries, useQueryClient } from '@tanstack/react-query';\r\nimport {\r\n  Loader2,\r\n  AlertCircle,\r\n  CheckCircle,\r\n  XCircle,\r\n  Clock,\r\n  Minus,\r\n  ClockAlert,\r\n  ChevronRight,\r\n  Home,\r\n  Download,\r\n  FileSpreadsheet,\r\n} from 'lucide-react';\r\n\r\nimport {\r\n  useClassMeetings,\r\n  useClassStudents,\r\n  useUpdateMeeting,\r\n  useCreateAttendance,\r\n  useUpdateAttendance,\r\n} from '../../hooks/useAttendances';\r\nimport { useLecturerAssignments } from '../../hooks/useLecturerAssignments';\r\nimport { useGrades, useUpdateGrade, useCreateGrade } from '../../hooks/useGrades';\r\nimport { apiService } from '../../services/api';\r\nimport type { AttendanceRecord, GradeRecord, MeetingSchedule } from '../../types';\r\n\r\n// ============================================================================\r\n// Constants\r\n// ============================================================================\r\n\r\n/** Canonical attendance status values */\r\nconst ATTENDANCE_STATUSES = ['', 'Hadir', 'Izin', 'Sakit', 'Alfa', 'Terlambat', 'Pengganti'] as const;\r\n\r\n/** Keyboard shortcuts mapping for attendance status brush */\r\nconst KEYBOARD_STATUS_MAP: Record<string, string> = {\r\n  '1': 'Hadir',\r\n  '2': 'Izin',\r\n  '3': 'Sakit',\r\n  '4': 'Alfa',\r\n  '5': 'Terlambat',\r\n  '6': 'Pengganti',\r\n};\r\n\r\n/** Default grade component weights (percentage) - used as fallback */\r\nconst DEFAULT_GRADE_WEIGHTS = {\r\n  aktivitas_partisipatif: 15,\r\n  hasil_proyek: 35,\r\n  quiz: 5,\r\n  tugas: 5,\r\n  uts: 15,\r\n  uas: 25,\r\n} as const;\r\n\r\nconst BOBOT_FIELDS = [\r\n  'bobot_partisipatif',\r\n  'bobot_proyek',\r\n  'bobot_kuis',\r\n  'bobot_tugas',\r\n  'bobot_uts',\r\n  'bobot_uas',\r\n] as const;\r\n\r\n/** Helper to extract numeric value from SqlNullFloat64 or number */\r\nconst extractBobotValue = (val: unknown): number | null => {\r\n  if (val === null || val === undefined) return null;\r\n  if (typeof val === 'number') return val;\r\n  if (typeof val === 'object' && val !== null && 'Float64' in val && 'Valid' in val) {\r\n    const sqlNull = val as { Float64: number; Valid: boolean };\r\n    return sqlNull.Valid ? sqlNull.Float64 : null;\r\n  }\r\n  return null;\r\n};\r\n\r\n/** Get grade components with dynamic weights from class data */\r\nconst getGradeComponents = (classData?: any) => {\r\n  const partisipatif = extractBobotValue(classData?.bobot_partisipatif);\r\n  const proyek = extractBobotValue(classData?.bobot_proyek);\r\n  const kuis = extractBobotValue(classData?.bobot_kuis);\r\n  const tugas = extractBobotValue(classData?.bobot_tugas);\r\n  const uts = extractBobotValue(classData?.bobot_uts);\r\n  const uas = extractBobotValue(classData?.bobot_uas);\r\n\r\n  return [\r\n    { key: 'aktivitas_partisipatif', weight: partisipatif ?? DEFAULT_GRADE_WEIGHTS.aktivitas_partisipatif },\r\n    { key: 'hasil_proyek', weight: proyek ?? DEFAULT_GRADE_WEIGHTS.hasil_proyek },\r\n    { key: 'quiz', weight: kuis ?? DEFAULT_GRADE_WEIGHTS.quiz },\r\n    { key: 'tugas', weight: tugas ?? DEFAULT_GRADE_WEIGHTS.tugas },\r\n    { key: 'uts', weight: uts ?? DEFAULT_GRADE_WEIGHTS.uts },\r\n    { key: 'uas', weight: uas ?? DEFAULT_GRADE_WEIGHTS.uas },\r\n  ] as const;\r\n};\r\n\r\n/** Fields to compare when checking for grade changes */\r\nconst GRADE_COMPARE_FIELDS: (keyof GradeRecord)[] = [\r\n  'aktivitas_partisipatif',\r\n  'hasil_proyek',\r\n  'quiz',\r\n  'tugas',\r\n  'uts',\r\n  'uas',\r\n  'nilai_angka',\r\n  'nilai_huruf',\r\n  'nilai_indeks',\r\n];\r\n\r\n// ============================================================================\r\n// Type Helpers\r\n// ============================================================================\r\n\r\ntype SqlNullString = { String: string; Valid: boolean };\r\ntype SqlNullTime = { Time: string; Valid: boolean };\r\ntype SqlNullFloat64 = { Float64: number; Valid: boolean };\r\ntype SqlNullInt32 = { Int32: number; Valid: boolean };\r\n\r\n// ============================================================================\r\n// Utility Functions\r\n// ============================================================================\r\n\r\n/** Extract string from SqlNullString or plain string */\r\nconst extractString = (val: string | SqlNullString | undefined | null): string => {\r\n  if (!val) return '';\r\n  if (typeof val === 'string') return val;\r\n  return val.Valid ? val.String : '';\r\n};\r\n\r\n/** Extract date string from SqlNullTime or plain string, returns ISO date YYYY-MM-DD */\r\nconst extractDateISO = (val: string | SqlNullTime | undefined | null): string => {\r\n  if (!val) return '';\r\n  let raw = '';\r\n  if (typeof val === 'string') {\r\n    raw = val;\r\n  } else if (val.Valid) {\r\n    raw = val.Time;\r\n  }\r\n  if (!raw) return '';\r\n  const d = new Date(raw);\r\n  return isNaN(d.getTime()) ? '' : d.toISOString().slice(0, 10);\r\n};\r\n\r\n/** Extract time string, returns HH:MM format */\r\nconst extractTimeHHMM = (val: string | SqlNullString | SqlNullTime | undefined | null): string => {\r\n  if (!val) return '';\r\n  let raw = '';\r\n  if (typeof val === 'string') {\r\n    raw = val;\r\n  } else if ('String' in val && val.Valid) {\r\n    raw = val.String;\r\n  } else if ('Time' in val && val.Valid) {\r\n    raw = val.Time;\r\n  }\r\n  if (!raw) return '';\r\n  const parts = raw.split(':');\r\n  return parts.length >= 2 ? `${parts[0].padStart(2, '0')}:${parts[1].padStart(2, '0')}` : raw;\r\n};\r\n\r\n/** Extract numeric value from various SQL null types (properly checks Valid property) */\r\nconst extractNumeric = (val: unknown): number | null => {\r\n  if (val === null || val === undefined) return null;\r\n  if (typeof val === 'number') return val;\r\n  if (typeof val === 'object' && val !== null) {\r\n    if ('Float64' in val && (val as SqlNullFloat64).Valid) return (val as SqlNullFloat64).Float64;\r\n    if ('Int32' in val && (val as SqlNullInt32).Valid) return (val as SqlNullInt32).Int32;\r\n  }\r\n  return null;\r\n};\r\n\r\n/** Extract primitive value from SQL null types */\r\nconst extractPrimitive = (val: unknown): string | number | boolean | null => {\r\n  if (val === null || val === undefined) return null;\r\n  if (typeof val === 'number' || typeof val === 'string' || typeof val === 'boolean') return val;\r\n  if (typeof val === 'object' && val !== null) {\r\n    if ('Float64' in val && (val as SqlNullFloat64).Valid) return (val as SqlNullFloat64).Float64;\r\n    if ('Int32' in val) return (val as SqlNullInt32).Int32;\r\n    if ('String' in val && (val as SqlNullString).Valid) return (val as SqlNullString).String;\r\n  }\r\n  return null;\r\n};\r\n\r\n/** Get KRS ID from student object (handles multiple field name variants) */\r\nconst getStudentKrsId = (student: any): number | null => {\r\n  const val =\r\n    student?.id_krs ??\r\n    student?.krs_id ??\r\n    student?.krsId ??\r\n    student?.krs?.id ??\r\n    student?.krs?.KRS?.id;\r\n  return val !== undefined && val !== null ? Number(val) : null;\r\n};\r\n\r\n/** Normalize attendance status to canonical form */\r\nconst normalizeStatus = (val: string): string => {\r\n  const found = ATTENDANCE_STATUSES.find((s) => s.toLowerCase() === val.toLowerCase());\r\n  return found ?? val;\r\n};\r\n\r\n/** Calculate letter grade and index from numeric value */\r\nconst calculateLetterGrade = (nilaiAngka: number | null): { huruf: string; indeks: number } => {\r\n  if (nilaiAngka === null || nilaiAngka === undefined) return { huruf: '', indeks: 0 };\r\n  if (nilaiAngka >= 80) return { huruf: 'A', indeks: 4.0 };\r\n  if (nilaiAngka >= 75) return { huruf: 'AB', indeks: 3.5 };\r\n  if (nilaiAngka >= 70) return { huruf: 'B', indeks: 3.0 };\r\n  if (nilaiAngka >= 65) return { huruf: 'BC', indeks: 2.5 };\r\n  if (nilaiAngka >= 60) return { huruf: 'C', indeks: 2.0 };\r\n  if (nilaiAngka >= 55) return { huruf: 'CD', indeks: 1.5 };\r\n  if (nilaiAngka >= 40) return { huruf: 'D', indeks: 1.0 };\r\n  return { huruf: 'E', indeks: 0.0 };\r\n};\r\n\r\n/** Calculate numeric grade from components based on weights (handles SqlNullFloat64) */\r\nconst calculateNumericGrade = (\r\n  components: Partial<GradeRecord>,\r\n  gradeComponents?: ReturnType<typeof getGradeComponents>\r\n): number | null => {\r\n  let totalWeight = 0;\r\n  let totalValue = 0;\r\n  let hasAnyValue = false;\r\n\r\n  const componentsToUse = gradeComponents ?? getGradeComponents();\r\n  componentsToUse.forEach(({ key, weight }) => {\r\n    const rawValue = components[key as keyof GradeRecord];\r\n    const value = extractNumeric(rawValue);\r\n    if (value !== null) {\r\n      totalValue += value * weight;\r\n      totalWeight += weight;\r\n      hasAnyValue = true;\r\n    }\r\n  });\r\n\r\n  if (!hasAnyValue || totalWeight === 0) return null;\r\n  return parseFloat((totalValue / totalWeight).toFixed(2));\r\n};\r\n\r\n/** Format date for display with day of week */\r\nconst formatDate = (dateValue: string | SqlNullTime): string => {\r\n  let dateString = '';\r\n  if (typeof dateValue === 'object' && dateValue !== null) {\r\n    if (!dateValue.Valid) return '-';\r\n    dateString = dateValue.Time;\r\n  } else {\r\n    dateString = dateValue;\r\n  }\r\n  if (!dateString) return '-';\r\n  const date = new Date(dateString);\r\n  const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'short' });\r\n  const formattedDate = date.toLocaleDateString('en-US', { day: '2-digit', month: 'short', year: 'numeric' });\r\n  return `${dayOfWeek}, ${formattedDate}`;\r\n};\r\n\r\n/** Format date for compact display (for table headers) */\r\nconst formatDateCompact = (dateValue: string | SqlNullTime): string => {\r\n  let dateString = '';\r\n  if (typeof dateValue === 'object' && dateValue !== null) {\r\n    if (!dateValue.Valid) return '-';\r\n    dateString = dateValue.Time;\r\n  } else {\r\n    dateString = dateValue;\r\n  }\r\n  if (!dateString) return '-';\r\n  const date = new Date(dateString);\r\n  const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'short' });\r\n  const day = date.toLocaleDateString('en-US', { day: '2-digit' });\r\n  const month = date.toLocaleDateString('en-US', { month: 'short' });\r\n  return `${dayOfWeek}\\n${day} ${month}`;\r\n};\r\n\r\n/** Format time for display */\r\nconst formatTime = (timeValue: string | SqlNullString | SqlNullTime | null | undefined): string => {\r\n  const raw = extractTimeHHMM(timeValue);\r\n  return raw || '-';\r\n};\r\n\r\n/** Generate a unique grade key for a student */\r\nconst generateGradeKey = (grade: GradeRecord, studentKrsId: number | null, studentNim: string): string => {\r\n  if (grade.id && grade.id > 0) {\r\n    return `id:${grade.id}`;\r\n  }\r\n  if (grade.krs_id) {\r\n    const krsId = typeof grade.krs_id === 'object' ? (grade.krs_id as SqlNullInt32).Int32 : grade.krs_id;\r\n    return `krs:${krsId}`;\r\n  }\r\n  if (studentKrsId) {\r\n    return `krs:${studentKrsId}`;\r\n  }\r\n  return `nim:${studentNim}`;\r\n};\r\n\r\n// ============================================================================\r\n// Component\r\n// ============================================================================\r\n\r\nconst ClassSummary: React.FC = () => {\r\n  // ---------------------------------------------------------------------------\r\n  // Router & Refs\r\n  // ---------------------------------------------------------------------------\r\n  const { classId } = useParams<{ classId: string }>();\r\n  const [searchParams] = useSearchParams();\r\n  const navigate = useNavigate();\r\n  const contentRef = useRef<HTMLDivElement>(null);\r\n  const queryClient = useQueryClient();\r\n  const justSavedAttendanceRef = useRef(false);\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // UI State\r\n  // ---------------------------------------------------------------------------\r\n  const [isGeneratingPDF, setIsGeneratingPDF] = useState(false);\r\n  const [isGeneratingXLSX, setIsGeneratingXLSX] = useState(false);\r\n  // Edit modes: separate for attendance, meetings, and grades\r\n  const [isAttendanceEditing, setIsAttendanceEditing] = useState(false);\r\n  const [isMeetingEditing, setIsMeetingEditing] = useState(false);\r\n  const [isGradesEditing, setIsGradesEditing] = useState(false);\r\n  const [isSavingAll, setIsSavingAll] = useState(false);\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // Meeting Edit State\r\n  // ---------------------------------------------------------------------------\r\n  const [editedTopics, setEditedTopics] = useState<Record<number, string>>({});\r\n  const [editedDates, setEditedDates] = useState<Record<number, string>>({});\r\n  const [editedTimes, setEditedTimes] = useState<Record<number, string>>({});\r\n  const [editedLecturers, setEditedLecturers] = useState<Record<number, string>>({});\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // Attendance Edit State\r\n  // ---------------------------------------------------------------------------\r\n  const [savingCells, setSavingCells] = useState<Record<string, boolean>>({});\r\n  const [initialAttendanceSnapshot, setInitialAttendanceSnapshot] = useState<Record<string, string>>({});\r\n  const [modifiedCells, setModifiedCells] = useState<Set<string>>(new Set());\r\n  const [pendingStatusChanges, setPendingStatusChanges] = useState<Record<string, string>>({});\r\n  const [originalAttendanceCache, setOriginalAttendanceCache] = useState<Record<number, AttendanceRecord[]>>({});\r\n  const [activeCell, setActiveCell] = useState<string | null>(null);\r\n  const [currentShortcutStatus, setCurrentShortcutStatus] = useState<string | null>(null);\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // Grade Edit State\r\n  // ---------------------------------------------------------------------------\r\n  const [editedGrades, setEditedGrades] = useState<Record<string, Partial<GradeRecord>>>({});\r\n  const [savingGradeIds, setSavingGradeIds] = useState<Set<number>>(new Set());\r\n  const [completedGradeKeys, setCompletedGradeKeys] = useState<Set<string>>(new Set()); // Track saved/cancelled rows\r\n\r\n  // Bobot (grade weights) edit state\r\n  const [editedBobots, setEditedBobots] = useState<{\r\n    bobot_partisipatif?: number;\r\n    bobot_proyek?: number;\r\n    bobot_kuis?: number;\r\n    bobot_tugas?: number;\r\n    bobot_uts?: number;\r\n    bobot_uas?: number;\r\n  }>({});\r\n  const [isSavingBobots, setIsSavingBobots] = useState(false);\r\n  const [bobotError, setBobotError] = useState<string | null>(null);\r\n  const [isBobotCompleted, setIsBobotCompleted] = useState(false);\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // URL Parameters\r\n  // ---------------------------------------------------------------------------\r\n  const className = searchParams.get('className') || '';\r\n  const courseName = searchParams.get('courseName') || '';\r\n  const courseCode = searchParams.get('courseCode') || '';\r\n  const fromPage = searchParams.get('from') || 'dashboard';\r\n  \r\n  // Get SKS values from URL params\r\n  const sksTatapMuka = parseInt(searchParams.get('sksTatapMuka') || '0', 10);\r\n  const sksPraktek = parseInt(searchParams.get('sksPraktek') || '0', 10);\r\n  const sksPrakLapangan = parseInt(searchParams.get('sksPrakLapangan') || '0', 10);\r\n  const sksSimulasi = parseInt(searchParams.get('sksSimulasi') || '0', 10);\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // Data Fetching\r\n  // ---------------------------------------------------------------------------\r\n  const classIdNum = Number(classId);\r\n\r\n  const {\r\n    data: meetings = [],\r\n    isLoading: loadingMeetings,\r\n    error: meetingsError,\r\n  } = useClassMeetings(classIdNum);\r\n\r\n  const {\r\n    data: students = [],\r\n    isLoading: loadingStudents,\r\n    error: studentsError,\r\n  } = useClassStudents(classIdNum);\r\n\r\n  const { data: gradeRecords = [], isLoading: loadingGrades } = useGrades({\r\n    kelas_id: classIdNum,\r\n  });\r\n\r\n  const { data: lecturerAssignments = [], isLoading: loadingLecturers } = useLecturerAssignments({\r\n    id_kelas: String(classId),\r\n  });\r\n\r\n  const { data: classData, isLoading: loadingClassData } = useQuery({\r\n    queryKey: ['class', classId],\r\n    queryFn: () => apiService.getClassById(classIdNum),\r\n    enabled: !!classId,\r\n  });\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // Grade Components with Dynamic Weights\r\n  // ---------------------------------------------------------------------------\r\n  const gradeWeights = useMemo(() => {\r\n    // Use edited values if in edit mode, otherwise use class data\r\n    const partisipatif = editedBobots.bobot_partisipatif ?? extractBobotValue(classData?.bobot_partisipatif);\r\n    const proyek = editedBobots.bobot_proyek ?? extractBobotValue(classData?.bobot_proyek);\r\n    const kuis = editedBobots.bobot_kuis ?? extractBobotValue(classData?.bobot_kuis);\r\n    const tugas = editedBobots.bobot_tugas ?? extractBobotValue(classData?.bobot_tugas);\r\n    const uts = editedBobots.bobot_uts ?? extractBobotValue(classData?.bobot_uts);\r\n    const uas = editedBobots.bobot_uas ?? extractBobotValue(classData?.bobot_uas);\r\n\r\n    return {\r\n      aktivitas_partisipatif: partisipatif ?? DEFAULT_GRADE_WEIGHTS.aktivitas_partisipatif,\r\n      hasil_proyek: proyek ?? DEFAULT_GRADE_WEIGHTS.hasil_proyek,\r\n      quiz: kuis ?? DEFAULT_GRADE_WEIGHTS.quiz,\r\n      tugas: tugas ?? DEFAULT_GRADE_WEIGHTS.tugas,\r\n      uts: uts ?? DEFAULT_GRADE_WEIGHTS.uts,\r\n      uas: uas ?? DEFAULT_GRADE_WEIGHTS.uas,\r\n    };\r\n  }, [classData, editedBobots]);\r\n\r\n  const gradeComponents = useMemo(() => {\r\n    // Use edited bobot values to create dynamic grade components\r\n    const effectiveClassData = {\r\n      bobot_partisipatif: editedBobots.bobot_partisipatif ?? extractBobotValue(classData?.bobot_partisipatif),\r\n      bobot_proyek: editedBobots.bobot_proyek ?? extractBobotValue(classData?.bobot_proyek),\r\n      bobot_kuis: editedBobots.bobot_kuis ?? extractBobotValue(classData?.bobot_kuis),\r\n      bobot_tugas: editedBobots.bobot_tugas ?? extractBobotValue(classData?.bobot_tugas),\r\n      bobot_uts: editedBobots.bobot_uts ?? extractBobotValue(classData?.bobot_uts),\r\n      bobot_uas: editedBobots.bobot_uas ?? extractBobotValue(classData?.bobot_uas),\r\n    };\r\n    return getGradeComponents(effectiveClassData);\r\n  }, [classData, editedBobots]);\r\n\r\n  const originalBobotWeights = useMemo(\r\n    () => ({\r\n      bobot_partisipatif: extractBobotValue(classData?.bobot_partisipatif) ?? DEFAULT_GRADE_WEIGHTS.aktivitas_partisipatif,\r\n      bobot_proyek: extractBobotValue(classData?.bobot_proyek) ?? DEFAULT_GRADE_WEIGHTS.hasil_proyek,\r\n      bobot_kuis: extractBobotValue(classData?.bobot_kuis) ?? DEFAULT_GRADE_WEIGHTS.quiz,\r\n      bobot_tugas: extractBobotValue(classData?.bobot_tugas) ?? DEFAULT_GRADE_WEIGHTS.tugas,\r\n      bobot_uts: extractBobotValue(classData?.bobot_uts) ?? DEFAULT_GRADE_WEIGHTS.uts,\r\n      bobot_uas: extractBobotValue(classData?.bobot_uas) ?? DEFAULT_GRADE_WEIGHTS.uas,\r\n    }),\r\n    [classData]\r\n  );\r\n\r\n  const hasEditedBobots = useMemo(\r\n    () =>\r\n      BOBOT_FIELDS.some((field) => {\r\n        const edited = editedBobots[field];\r\n        if (edited === undefined) return false;\r\n        return edited !== originalBobotWeights[field];\r\n      }),\r\n    [editedBobots, originalBobotWeights]\r\n  );\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // Lecturer Lookup\r\n  // ---------------------------------------------------------------------------\r\n  const lecturerIds = useMemo(() => {\r\n    const idSet = new Set<string>();\r\n    lecturerAssignments.forEach((assignment) => {\r\n      const id = extractString(assignment.id_dosen as string | SqlNullString);\r\n      if (id) idSet.add(id);\r\n    });\r\n    return Array.from(idSet);\r\n  }, [lecturerAssignments]);\r\n\r\n  const lecturerQueryResults = useQueries({\r\n    queries: lecturerIds.map((id) => ({\r\n      queryKey: ['lecturer', id],\r\n      queryFn: () => apiService.getLecturerByID(id),\r\n      enabled: !!id,\r\n    })),\r\n  });\r\n\r\n  const lecturerLookup = useMemo(() => {\r\n    const lookup: Record<string, string> = {};\r\n    lecturerQueryResults.forEach((q) => {\r\n      const lecturer = q.data as { id: string; nama_dosen: string } | undefined;\r\n      if (lecturer?.id && lecturer?.nama_dosen) {\r\n        lookup[lecturer.id] = lecturer.nama_dosen;\r\n      }\r\n    });\r\n    return lookup;\r\n  }, [lecturerQueryResults]);\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // Derived Data\r\n  // ---------------------------------------------------------------------------\r\n  const totalSks = sksTatapMuka + sksPraktek + sksPrakLapangan + sksSimulasi;\r\n\r\n  const lecturerNames = useMemo(() => {\r\n    return lecturerAssignments\r\n      .map((assignment) => {\r\n        const lecturerId = extractString(assignment.id_dosen as string | SqlNullString);\r\n        return lecturerId ? lecturerLookup[lecturerId] || lecturerId : null;\r\n      })\r\n      .filter(Boolean) as string[];\r\n  }, [lecturerAssignments, lecturerLookup]);\r\n\r\n  const meetingIds = useMemo(() => meetings.map((m) => m.id), [meetings]);\r\n  \r\n  const { data: attendanceMap = {}, isLoading: loadingAttendances } = useQuery({\r\n    queryKey: ['class-attendances', classId, meetingIds],\r\n    queryFn: async () => {\r\n      const map: Record<number, AttendanceRecord[]> = {};\r\n      await Promise.all(\r\n        meetingIds.map(async (meetingId) => {\r\n          const records = await apiService.getMeetingAttendances(meetingId);\r\n          map[meetingId] = records;\r\n        })\r\n      );\r\n      return map;\r\n    },\r\n    enabled: meetingIds.length > 0,\r\n  });\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // Mutations\r\n  // ---------------------------------------------------------------------------\r\n  const updateMeetingMutation = useUpdateMeeting();\r\n  const createAttendanceMutation = useCreateAttendance();\r\n  const updateAttendanceMutation = useUpdateAttendance();\r\n  const updateGradeMutation = useUpdateGrade();\r\n  const createGradeMutation = useCreateGrade();\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // Loading & Error States\r\n  // ---------------------------------------------------------------------------\r\n  const loadingLecturersDetails = lecturerQueryResults.some((q) => q.isLoading);\r\n  const loading =\r\n    loadingMeetings ||\r\n    loadingStudents ||\r\n    loadingAttendances ||\r\n    loadingLecturers ||\r\n    loadingGrades ||\r\n    loadingClassData ||\r\n    loadingLecturersDetails;\r\n  const error = meetingsError || studentsError;\r\n\r\n  // Whether any section is currently being edited\r\n  const anyEditing = isAttendanceEditing || isMeetingEditing || isGradesEditing;\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // Helper Functions\r\n  // ---------------------------------------------------------------------------\r\n\r\n  /** Find the grade record for a student (with robust fallback checks) */\r\n  const findGradeForStudent = (student: { nim: string }): GradeRecord => {\r\n    // Try by explicit nim field\r\n    let found = gradeRecords.find((g: any) => g.nim === student.nim);\r\n    if (found) return found;\r\n\r\n    // Try nested student info\r\n    found = gradeRecords.find(\r\n      (g: any) =>\r\n        g.student?.nim === student.nim ||\r\n        g.krs?.student?.nim === student.nim ||\r\n        g.krs?.nim === student.nim\r\n    );\r\n    if (found) return found;\r\n\r\n    // Try by krs_id\r\n    const studentKrsId = getStudentKrsId(student);\r\n    if (studentKrsId !== null) {\r\n      found = gradeRecords.find((g) => {\r\n        const k = extractNumeric(g.krs_id);\r\n        return k !== null && k === studentKrsId;\r\n      });\r\n      if (found) return found;\r\n    }\r\n\r\n    // Last fallback: match nim in any field\r\n    found = gradeRecords.find((g: any) =>\r\n      Object.values(g).some((v) => typeof v === 'string' && v === student.nim)\r\n    );\r\n    if (found) return found;\r\n\r\n    // Return empty grade\r\n    return {\r\n      id: 0,\r\n      krs_id: null,\r\n      aktivitas_partisipatif: null,\r\n      hasil_proyek: null,\r\n      quiz: null,\r\n      tugas: null,\r\n      uts: null,\r\n      uas: null,\r\n      nilai_angka: null,\r\n      nilai_huruf: null,\r\n      nilai_indeks: null,\r\n    } as GradeRecord;\r\n  };\r\n\r\n  const startEditTopic = (meetingId: number, currentTopik: string, currentDate: string, currentTime: string, currentLecturer: string) => {\r\n    setEditedTopics((prev) => ({ ...prev, [meetingId]: currentTopik || '' }));\r\n    setEditedDates((prev) => ({ ...prev, [meetingId]: currentDate || '' }));\r\n    setEditedTimes((prev) => ({ ...prev, [meetingId]: currentTime || '' }));\r\n    setEditedLecturers((prev) => ({ ...prev, [meetingId]: currentLecturer || '' }));\r\n  };\r\n\r\n  const cancelEditTopic = (meetingId: number) => {\r\n    setEditedTopics((prev) => {\r\n      const next = { ...prev };\r\n      delete next[meetingId];\r\n      return next;\r\n    });\r\n    setEditedDates((prev) => {\r\n      const next = { ...prev };\r\n      delete next[meetingId];\r\n      return next;\r\n    });\r\n    setEditedTimes((prev) => {\r\n      const next = { ...prev };\r\n      delete next[meetingId];\r\n      return next;\r\n    });\r\n    setEditedLecturers((prev) => {\r\n      const next = { ...prev };\r\n      delete next[meetingId];\r\n      return next;\r\n    });\r\n  };\r\n\r\n  const saveTopic = async (meetingId: number) => {\r\n    const newTopic = editedTopics[meetingId] ?? '';\r\n    const newDateRaw = editedDates[meetingId] ?? '';\r\n    const newTimeRaw = editedTimes[meetingId] ?? '';\r\n    const newLecturer = editedLecturers[meetingId] ?? '';\r\n\r\n    // Convert to expected formats\r\n    // Use UTC to avoid timezone conversion issues - keep the date as-is\r\n    const newDateISO = newDateRaw ? `${newDateRaw}T00:00:00.000Z` : undefined;\r\n    const newTimeWithSeconds = newTimeRaw ? `${newTimeRaw}:00` : undefined;\r\n\r\n    console.log('[MEETING]  Saving meeting', meetingId, 'with topic:', newTopic);\r\n    console.log('[MEETING] Date input:', newDateRaw, ' ISO:', newDateISO);\r\n    console.log('[MEETING] Lecturer:', newLecturer);\r\n\r\n    try {\r\n      await updateMeetingMutation.mutateAsync({\r\n        id: meetingId,\r\n        data: {\r\n          topik: newTopic || undefined,\r\n          tgl_pertemuan: newDateISO,\r\n          jam_pertemuan: newTimeWithSeconds,\r\n          id_dosen: newLecturer || undefined,\r\n        },\r\n      });\r\n\r\n      console.log('[MEETING]  Meeting saved successfully');\r\n\r\n      // Optimistically update cache\r\n      queryClient.setQueryData<MeetingSchedule[]>(\r\n        ['class-meetings', classIdNum],\r\n        (prev) => {\r\n          if (!prev) return prev;\r\n          return prev.map((m) =>\r\n            m.id === meetingId\r\n              ? {\r\n                  ...m,\r\n                  topik: newTopic,\r\n                  tgl_pertemuan: newDateISO || m.tgl_pertemuan,\r\n                  jam_pertemuan: newTimeWithSeconds || m.jam_pertemuan,\r\n                  id_dosen: newLecturer || m.id_dosen,\r\n                }\r\n              : m\r\n          );\r\n        }\r\n      );\r\n\r\n      cancelEditTopic(meetingId);\r\n    } catch (e) {\r\n      alert(e instanceof Error ? e.message : 'Failed to update topic');\r\n    }\r\n  };\r\n\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // Memoized Data\r\n  // ---------------------------------------------------------------------------\r\n\r\n  /** Meetings sorted by date (invalid/empty dates last) */\r\n  const sortedMeetings = useMemo(() => {\r\n    const getTimeValue = (val: string | SqlNullTime | undefined | null): number => {\r\n      if (!val) return Number.POSITIVE_INFINITY;\r\n      if (typeof val === 'string') {\r\n        const t = Date.parse(val);\r\n        return isNaN(t) ? Number.POSITIVE_INFINITY : t;\r\n      }\r\n      if ('Valid' in val) {\r\n        if (!val.Valid) return Number.POSITIVE_INFINITY;\r\n        const t = Date.parse(val.Time);\r\n        return isNaN(t) ? Number.POSITIVE_INFINITY : t;\r\n      }\r\n      return Number.POSITIVE_INFINITY;\r\n    };\r\n\r\n    return [...meetings].sort((a, b) => {\r\n      const diff = getTimeValue(a.tgl_pertemuan) - getTimeValue(b.tgl_pertemuan);\r\n      return diff !== 0 ? diff : a.pertemuan_ke - b.pertemuan_ke;\r\n    });\r\n  }, [meetings]);\r\n\r\n\r\n  /** Attendance lookup: { nim: { meetingId: status } } */\r\n  const attendanceLookup = useMemo(() => {\r\n    const lookup: Record<string, Record<number, string>> = {};\r\n\r\n    Object.values(attendanceMap).forEach((records) => {\r\n      records.forEach((record) => {\r\n        if (!lookup[record.nim]) {\r\n          lookup[record.nim] = {};\r\n        }\r\n        const status = extractString(record.status_kehadiran as string | SqlNullString);\r\n        lookup[record.nim][record.id_pertemuan] = status;\r\n      });\r\n    });\r\n\r\n    return lookup;\r\n  }, [attendanceMap]);\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // Status Display Helpers\r\n  // ---------------------------------------------------------------------------\r\n\r\n  const getStatusIcon = (status: string) => {\r\n    switch (status?.toLowerCase()) {\r\n      case 'hadir':\r\n      case 'present':\r\n        return <CheckCircle className=\"h-4 w-4 text-green-600\" />;\r\n      case 'izin':\r\n      case 'excused':\r\n        return <Clock className=\"h-4 w-4 text-blue-600\" />;\r\n      case 'sakit':\r\n      case 'sick':\r\n        return <AlertCircle className=\"h-4 w-4 text-yellow-600\" />;\r\n      case 'terlambat':\r\n      case 'late':\r\n        return <ClockAlert className=\"h-4 w-4 text-orange-600\" />;\r\n      case 'pengganti':\r\n      case 'substitute':\r\n        return <CheckCircle className=\"h-4 w-4 text-purple-600\" />;\r\n      case 'alpa':\r\n      case 'alfa':\r\n      case 'absent':\r\n        return <XCircle className=\"h-4 w-4 text-red-600\" />;\r\n      default:\r\n        return <Minus className=\"h-4 w-4 text-gray-300\" />;\r\n    }\r\n  };\r\n\r\n  const getStatusColor = (status: string) => {\r\n    switch (status?.toLowerCase()) {\r\n      case 'hadir':\r\n      case 'present':\r\n        return 'bg-green-50 text-green-700';\r\n      case 'izin':\r\n      case 'excused':\r\n        return 'bg-blue-50 text-blue-700';\r\n      case 'sakit':\r\n      case 'sick':\r\n        return 'bg-yellow-50 text-yellow-700';\r\n      case 'terlambat':\r\n      case 'late':\r\n        return 'bg-orange-50 text-orange-700';\r\n      case 'pengganti':\r\n      case 'substitute':\r\n        return 'bg-purple-50 text-purple-700';\r\n      case 'alpa':\r\n      case 'alfa':\r\n      case 'absent':\r\n        return 'bg-red-50 text-red-700';\r\n      default:\r\n        return 'bg-gray-50 text-gray-400';\r\n    }\r\n  };\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // Effects\r\n  // ---------------------------------------------------------------------------\r\n\r\n  /** Build initial attendance snapshot when data loads */\r\n  useEffect(() => {\r\n    // Skip if we just saved - the cache was already updated manually\r\n    if (justSavedAttendanceRef.current) {\r\n      console.log('[EFFECT] Skipping attendance snapshot update - just saved');\r\n      return;\r\n    }\r\n\r\n    console.log('[EFFECT] Building attendance snapshot, isEditing:', isAttendanceEditing);\r\n\r\n    const snap: Record<string, string> = {};\r\n    Object.values(attendanceMap).forEach((records) => {\r\n      records.forEach((r) => {\r\n        const status = extractString(r.status_kehadiran as string | SqlNullString);\r\n        snap[`${r.nim}-${r.id_pertemuan}`] = normalizeStatus(status);\r\n      });\r\n    });\r\n    setInitialAttendanceSnapshot(snap);\r\n    if (!isAttendanceEditing) {\r\n      console.log('[EFFECT] Setting original cache (not editing)');\r\n      setOriginalAttendanceCache(attendanceMap);\r\n    }\r\n  }, [attendanceMap, isAttendanceEditing]);\r\n\r\n  /** Keyboard shortcuts for attendance status brush */\r\n  useEffect(() => {\r\n    if (!isAttendanceEditing) return;\r\n\r\n    const handler = (e: KeyboardEvent) => {\r\n      if (KEYBOARD_STATUS_MAP[e.key]) {\r\n        e.preventDefault();\r\n        setCurrentShortcutStatus(KEYBOARD_STATUS_MAP[e.key]);\r\n      } else if (e.key === 'Escape') {\r\n        setCurrentShortcutStatus(null);\r\n      }\r\n    };\r\n\r\n    window.addEventListener('keydown', handler);\r\n    return () => window.removeEventListener('keydown', handler);\r\n  }, [isAttendanceEditing]);\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // Change Detection\r\n  // ---------------------------------------------------------------------------\r\n\r\n  const recalcModified = () => {\r\n    const next = new Set<string>();\r\n    Object.entries(pendingStatusChanges).forEach(([key, val]) => {\r\n      const original = initialAttendanceSnapshot[key] ?? '';\r\n      if (normalizeStatus(original) !== normalizeStatus(val)) {\r\n        next.add(key);\r\n      }\r\n    });\r\n    setModifiedCells(next);\r\n  };\r\n\r\n  /** Detect whether there are unsaved changes */\r\n  const hasUnsavedChanges = useMemo(() => {\r\n    // 1) Attendance modified\r\n    if (modifiedCells.size > 0) return true;\r\n\r\n    // 2) Meeting descriptions/dates/times/lecturers\r\n    for (const meeting of meetings) {\r\n      const id = meeting.id;\r\n\r\n      // Topic\r\n      const editedTopik = editedTopics[id] ?? '';\r\n      const currentTopik = extractString(meeting.topik as string | SqlNullString);\r\n      if (editedTopik !== currentTopik) return true;\r\n\r\n      // Date\r\n      const editedDate = editedDates[id] ?? '';\r\n      const currentDateISO = extractDateISO(meeting.tgl_pertemuan);\r\n      if (editedDate !== currentDateISO) return true;\r\n\r\n      // Time\r\n      const editedTime = editedTimes[id] ?? '';\r\n      const currentTime = extractTimeHHMM(meeting.jam_pertemuan as string | SqlNullString);\r\n      if (editedTime !== currentTime) return true;\r\n\r\n      // Lecturer\r\n      const editedLecturer = editedLecturers[id] ?? '';\r\n      const currentLecturer = extractString(meeting.id_dosen as string | SqlNullString);\r\n      if (editedLecturer !== currentLecturer) return true;\r\n    }\r\n\r\n    // 3) Grades\r\n    for (const [gradeKey, edited] of Object.entries(editedGrades)) {\r\n      let original: GradeRecord | null = null;\r\n\r\n      if (gradeKey.startsWith('id:')) {\r\n        const id = Number(gradeKey.split(':')[1]);\r\n        original = gradeRecords.find((g) => g.id === id) ?? null;\r\n      } else if (gradeKey.startsWith('krs:')) {\r\n        const krsId = Number(gradeKey.split(':')[1]);\r\n        original =\r\n          gradeRecords.find((g) => {\r\n            const k = extractNumeric(g.krs_id);\r\n            return k !== null && k === krsId;\r\n          }) ?? null;\r\n      } else if (gradeKey.startsWith('nim:')) {\r\n        const nim = gradeKey.split(':')[1];\r\n        original =\r\n          gradeRecords.find(\r\n            (g: any) => g.nim === nim || g.student?.nim === nim\r\n          ) ?? null;\r\n      }\r\n\r\n      if (!original) {\r\n        if (Object.values(edited).some((v) => v !== null && v !== undefined && v !== '')) {\r\n          return true;\r\n        }\r\n        continue;\r\n      }\r\n\r\n      for (const field of GRADE_COMPARE_FIELDS) {\r\n        const eVal = extractPrimitive((edited as any)[field]);\r\n        const oVal = extractPrimitive((original as any)[field]);\r\n        if (eVal !== oVal) return true;\r\n      }\r\n    }\r\n\r\n    // 4) Bobot (grade weight) edits\r\n    if (hasEditedBobots) return true;\r\n\r\n    return false;\r\n  }, [modifiedCells, editedGrades, editedTopics, editedDates, editedTimes, editedLecturers, meetings, gradeRecords, hasEditedBobots]);\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // Attendance Actions\r\n  // ---------------------------------------------------------------------------\r\n\r\n  const updateSingleCell = (key: string, newStatus: string) => {\r\n    const [nim, meetingIdStr] = key.split('-');\r\n    const meetingId = Number(meetingIdStr);\r\n    const queryKey = ['class-attendances', classId, meetingIds];\r\n\r\n    queryClient.setQueryData(queryKey, (old: typeof attendanceMap) => {\r\n      const clone = { ...(old || {}) };\r\n      const arr = [...(clone[meetingId] || [])];\r\n      const existingIdx = arr.findIndex((r) => r.nim === nim);\r\n\r\n      if (existingIdx >= 0) {\r\n        arr[existingIdx] = { ...arr[existingIdx], status_kehadiran: newStatus };\r\n      } else {\r\n        arr.push({\r\n          id: -Date.now(),\r\n          id_pertemuan: meetingId,\r\n          nim,\r\n          status_kehadiran: newStatus,\r\n        } as AttendanceRecord);\r\n      }\r\n\r\n      clone[meetingId] = arr;\r\n      return clone;\r\n    });\r\n\r\n    setPendingStatusChanges((prev) => ({ ...prev, [key]: newStatus }));\r\n    recalcModified();\r\n  };\r\n\r\n  const commitAttendanceChanges = async (skipExit = false) => {\r\n    if (!isAttendanceEditing) return;\r\n\r\n    const changes = Object.entries(pendingStatusChanges);\r\n    if (!changes.length) {\r\n      if (!skipExit) setIsAttendanceEditing(false);\r\n      return;\r\n    }\r\n\r\n    setSavingCells((prev) => {\r\n      const next = { ...prev };\r\n      changes.forEach(([key]) => (next[key] = true));\r\n      return next;\r\n    });\r\n\r\n    try {\r\n      await Promise.all(\r\n        changes.map(async ([key, status]) => {\r\n          const [nim, meetingIdStr] = key.split('-');\r\n          const meetingId = Number(meetingIdStr);\r\n          const existing = attendanceMap[meetingId]?.find((r) => r.nim === nim);\r\n\r\n          if (existing && existing.id > 0) {\r\n            // Only update if it has a real database ID (positive number)\r\n            await updateAttendanceMutation.mutateAsync({\r\n              id: existing.id,\r\n              data: { status_kehadiran: status || undefined },\r\n            });\r\n          } else {\r\n            // Create new record if it doesn't exist or has a temporary ID (negative number)\r\n            await createAttendanceMutation.mutateAsync({\r\n              id_pertemuan: meetingId,\r\n              nim,\r\n              status_kehadiran: status || undefined,\r\n            });\r\n          }\r\n        })\r\n      );\r\n\r\n      // Manually refetch fresh data from the server\r\n      const map: Record<number, AttendanceRecord[]> = {};\r\n      await Promise.all(\r\n        meetingIds.map(async (meetingId) => {\r\n          const records = await apiService.getMeetingAttendances(meetingId);\r\n          map[meetingId] = records;\r\n        })\r\n      );\r\n\r\n      // Update the query cache with fresh data\r\n      queryClient.setQueryData(['class-attendances', classId, meetingIds], map);\r\n\r\n      // Update the original cache so exitAttendanceEditMode doesn't restore old data\r\n      // NOTE: This is a state update and won't be immediately reflected in the current closure\r\n      setOriginalAttendanceCache(map);\r\n\r\n      // Mark that we just saved successfully so exitAttendanceEditMode won't restore old data\r\n      justSavedAttendanceRef.current = true;\r\n\r\n      if (!skipExit) {\r\n        setIsAttendanceEditing(false);\r\n      }\r\n      setPendingStatusChanges({});\r\n      setModifiedCells(new Set());\r\n      setActiveCell(null);\r\n    } catch (e) {\r\n      alert(e instanceof Error ? e.message : 'Failed to commit changes');\r\n    } finally {\r\n      setSavingCells({});\r\n    }\r\n  };\r\n\r\n  // cancelAttendanceChanges removed  use exitAttendanceEditMode or exitAllEditModes instead\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // Enter / Exit per-section edit modes\r\n  // ---------------------------------------------------------------------------\r\n\r\n  const enterAttendanceEditMode = () => {\r\n    setOriginalAttendanceCache(attendanceMap);\r\n    setPendingStatusChanges({});\r\n    setModifiedCells(new Set());\r\n    setActiveCell(null);\r\n    setCurrentShortcutStatus(null);\r\n    setIsAttendanceEditing(true);\r\n  };\r\n\r\n  const exitAttendanceEditMode = () => {\r\n    const queryKey = ['class-attendances', classId, meetingIds];\r\n\r\n    // Don't restore old data if we just saved successfully\r\n    if (justSavedAttendanceRef.current) {\r\n      justSavedAttendanceRef.current = false; // Reset the flag\r\n    } else {\r\n      queryClient.setQueryData(queryKey, originalAttendanceCache);\r\n    }\r\n\r\n    setPendingStatusChanges({});\r\n    setModifiedCells(new Set());\r\n    setActiveCell(null);\r\n    setCurrentShortcutStatus(null);\r\n    setIsAttendanceEditing(false);\r\n  };\r\n\r\n  const enterMeetingEditMode = () => {\r\n    console.log('[MEETING]  Entering meeting edit mode');\r\n    // Initialize meeting description edit fields for all meetings\r\n    const topics: Record<number, string> = {};\r\n    const dates: Record<number, string> = {};\r\n    const times: Record<number, string> = {};\r\n    const lecturers: Record<number, string> = {};\r\n    meetings.forEach((meeting) => {\r\n      topics[meeting.id] = extractString(meeting.topik as string | SqlNullString);\r\n      dates[meeting.id] = extractDateISO(meeting.tgl_pertemuan);\r\n      times[meeting.id] = extractTimeHHMM(meeting.jam_pertemuan as string | SqlNullString);\r\n      lecturers[meeting.id] = extractString(meeting.id_dosen as string | SqlNullString);\r\n    });\r\n    setEditedTopics(topics);\r\n    setEditedDates(dates);\r\n    setEditedTimes(times);\r\n    setEditedLecturers(lecturers);\r\n    setIsMeetingEditing(true);\r\n  };\r\n\r\n  const exitMeetingEditMode = () => {\r\n    console.log('[MEETING]  Exiting meeting edit mode - clearing edits');\r\n    setEditedTopics({});\r\n    setEditedDates({});\r\n    setEditedTimes({});\r\n    setEditedLecturers({});\r\n    setIsMeetingEditing(false);\r\n  };\r\n\r\n  const enterGradesEditMode = () => {\r\n    console.log('[GRADES]  Entering grades edit mode');\r\n    const gradeMap: Record<string, Partial<GradeRecord>> = {};\r\n    students.forEach((student) => {\r\n      const grade = findGradeForStudent(student) || ({} as GradeRecord);\r\n      const studentKrsId = getStudentKrsId(student);\r\n      const gradeKey = generateGradeKey(grade, studentKrsId, student.nim);\r\n      gradeMap[gradeKey] = grade;\r\n    });\r\n    console.log('[GRADES] Initial grade map:', gradeMap);\r\n    setEditedGrades(gradeMap);\r\n    setIsGradesEditing(true);\r\n  };\r\n\r\n  const exitGradesEditMode = () => {\r\n    console.log('[GRADES]  Exiting grades edit mode - clearing edits');\r\n    setEditedGrades({});\r\n    setCompletedGradeKeys(new Set());\r\n    setEditedBobots({});\r\n    setBobotError(null);\r\n    setIsBobotCompleted(false);\r\n    setIsGradesEditing(false);\r\n  };\r\n\r\n  const exitAllEditModes = () => {\r\n    exitAttendanceEditMode();\r\n    exitMeetingEditMode();\r\n    exitGradesEditMode();\r\n  };\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // Grade Actions\r\n  // ---------------------------------------------------------------------------\r\n\r\n  const saveGrade = async (gradeKey: string, grade: GradeRecord, student?: any) => {\r\n    console.log('[GRADES]  Saving grade for key:', gradeKey, 'Grade ID:', grade?.id);\r\n    const idNum = grade?.id && grade.id > 0 ? grade.id : null;\r\n    if (idNum) setSavingGradeIds((prev) => new Set([...prev, idNum]));\r\n\r\n    try {\r\n      const editedGrade = editedGrades[gradeKey];\r\n      if (!editedGrade) {\r\n        console.log('[GRADES]  No edited grade found for key:', gradeKey);\r\n        return;\r\n      }\r\n\r\n      // Check if any grade component fields have been modified\r\n      const gradeComponentFields: (keyof GradeRecord)[] = [\r\n        'aktivitas_partisipatif',\r\n        'hasil_proyek',\r\n        'quiz',\r\n        'tugas',\r\n        'uts',\r\n        'uas',\r\n      ];\r\n\r\n      const hasChanges = gradeComponentFields.some((field) => {\r\n        const originalValue = extractNumeric(grade[field]);\r\n        const editedValue = extractNumeric(editedGrade[field]);\r\n        return originalValue !== editedValue;\r\n      });\r\n\r\n      if (!hasChanges) {\r\n        console.log('[GRADES]  No changes detected, skipping save');\r\n        // Mark as completed to show Edit button\r\n        setCompletedGradeKeys((prev) => new Set([...prev, gradeKey]));\r\n        if (idNum) setSavingGradeIds((prev) => new Set([...prev].filter((id) => id !== idNum)));\r\n        return;\r\n      }\r\n\r\n      // ALWAYS calculate numeric grade from components based on weights\r\n      // If user manually entered nilai_angka, it will be overridden by the calculated value\r\n      const calculatedNumeric = calculateNumericGrade(editedGrade, gradeComponents);\r\n      const nilaiAngka = calculatedNumeric !== null ? calculatedNumeric : extractNumeric(editedGrade.nilai_angka);\r\n\r\n      // ALWAYS calculate letter grade and index from the numeric grade\r\n      let nilaiHuruf: string | undefined = undefined;\r\n      let nilaiIndeks: number | undefined = undefined;\r\n\r\n      if (nilaiAngka !== null) {\r\n        const { huruf, indeks } = calculateLetterGrade(nilaiAngka);\r\n        nilaiHuruf = huruf;\r\n        nilaiIndeks = indeks;\r\n        console.log('[GRADES]  Auto-calculated: Numeric=', nilaiAngka, 'Letter=', nilaiHuruf, 'Index=', nilaiIndeks);\r\n      }\r\n\r\n      const updateData = {\r\n        aktivitas_partisipatif: extractNumeric(editedGrade.aktivitas_partisipatif) ?? undefined,\r\n        hasil_proyek: extractNumeric(editedGrade.hasil_proyek) ?? undefined,\r\n        quiz: extractNumeric(editedGrade.quiz) ?? undefined,\r\n        tugas: extractNumeric(editedGrade.tugas) ?? undefined,\r\n        uts: extractNumeric(editedGrade.uts) ?? undefined,\r\n        uas: extractNumeric(editedGrade.uas) ?? undefined,\r\n        nilai_angka: nilaiAngka ?? undefined,\r\n        nilai_huruf: nilaiHuruf,\r\n        nilai_indeks: nilaiIndeks,\r\n      };\r\n\r\n      if (grade.id && grade.id > 0) {\r\n        console.log('[GRADES]  Updating existing grade with ID:', grade.id);\r\n        await updateGradeMutation.mutateAsync({ id: grade.id, data: updateData });\r\n      } else if (grade.krs_id) {\r\n        const krsId = extractNumeric(grade.krs_id);\r\n        console.log('[GRADES]  Creating new grade with KRS ID:', krsId);\r\n        await createGradeMutation.mutateAsync({ krs_id: krsId as number, ...updateData } as any);\r\n      } else {\r\n        // Try to get krs_id from student or editedGrade\r\n        const kFromStudent = getStudentKrsId(student);\r\n        const krsId = kFromStudent ?? extractNumeric(editedGrade?.krs_id);\r\n        if (krsId) {\r\n          console.log('[GRADES]  Creating new grade with KRS ID from student:', krsId);\r\n          await createGradeMutation.mutateAsync({ krs_id: Number(krsId), ...updateData } as any);\r\n        } else {\r\n          console.log('[GRADES]  Missing KRS ID for grade creation');\r\n          throw new Error('Missing KRS id for grade creation');\r\n        }\r\n      }\r\n\r\n      console.log('[GRADES]  Grade saved successfully');\r\n\r\n      setEditedGrades((prev) => {\r\n        const next = { ...prev };\r\n        delete next[gradeKey];\r\n        return next;\r\n      });\r\n      // Mark this row as completed so it shows Edit button instead of Save/Cancel\r\n      setCompletedGradeKeys((prev) => new Set([...prev, gradeKey]));\r\n    } catch (e) {\r\n      console.log('[GRADES]  Error saving grade:', e);\r\n      alert(e instanceof Error ? e.message : 'Failed to save grade');\r\n    } finally {\r\n      if (idNum) {\r\n        setSavingGradeIds((prev) => new Set([...prev].filter((id) => id !== idNum)));\r\n      }\r\n    }\r\n  };\r\n\r\n  // Handler for bobot changes\r\n  const handleBobotChange = (field: string, value: string) => {\r\n    const numValue = value === '' ? undefined : parseFloat(value);\r\n    setEditedBobots((prev) => ({\r\n      ...prev,\r\n      [field]: numValue,\r\n    }));\r\n    setBobotError(null);\r\n  };\r\n\r\n  const cancelBobots = () => {\r\n    setEditedBobots({});\r\n    setBobotError(null);\r\n    setIsBobotCompleted(true);\r\n  };\r\n\r\n  // Save bobot values\r\n  const saveBobots = async () => {\r\n    try {\r\n      setIsSavingBobots(true);\r\n      setBobotError(null);\r\n\r\n      // Always prepare complete bobot data (including current/default values)\r\n      const bobotData = {\r\n        bobot_partisipatif: editedBobots.bobot_partisipatif ?? gradeWeights.aktivitas_partisipatif,\r\n        bobot_proyek: editedBobots.bobot_proyek ?? gradeWeights.hasil_proyek,\r\n        bobot_kuis: editedBobots.bobot_kuis ?? gradeWeights.quiz,\r\n        bobot_tugas: editedBobots.bobot_tugas ?? gradeWeights.tugas,\r\n        bobot_uts: editedBobots.bobot_uts ?? gradeWeights.uts,\r\n        bobot_uas: editedBobots.bobot_uas ?? gradeWeights.uas,\r\n      };\r\n\r\n      // Validate total should be 100%\r\n      const total =\r\n        bobotData.bobot_partisipatif +\r\n        bobotData.bobot_proyek +\r\n        bobotData.bobot_kuis +\r\n        bobotData.bobot_tugas +\r\n        bobotData.bobot_uts +\r\n        bobotData.bobot_uas;\r\n\r\n      if (Math.abs(total - 100) > 0.01) {\r\n        setBobotError(`Total must be 100%. Current total: ${total.toFixed(1)}%`);\r\n        return false;\r\n      }\r\n\r\n      // Send complete bobot data to update all values\r\n      await apiService.updateClass(classIdNum, bobotData);\r\n\r\n      // Refetch class data to get updated values\r\n      await queryClient.invalidateQueries({ queryKey: ['class', classId] });\r\n\r\n      // Clear edited bobots and mark as completed\r\n      setEditedBobots({});\r\n      setIsBobotCompleted(true);\r\n      console.log('[BOBOTS]  Bobot values saved successfully');\r\n      return true;\r\n    } catch (error) {\r\n      console.error('[BOBOTS]  Failed to save bobot values:', error);\r\n      setBobotError(error instanceof Error ? error.message : 'Failed to save grade weights');\r\n      return false;\r\n    } finally {\r\n      setIsSavingBobots(false);\r\n    }\r\n  };\r\n\r\n  const saveAllAndFinish = async () => {\r\n    console.log('[SAVE ALL]  Starting save all and finish');\r\n    console.log('[SAVE ALL] Attendance editing:', isAttendanceEditing);\r\n    console.log('[SAVE ALL] Meeting editing:', isMeetingEditing);\r\n    console.log('[SAVE ALL] Grades editing:', isGradesEditing);\r\n\r\n    setIsSavingAll(true);\r\n    try {\r\n      // Save edited meeting descriptions (only if meeting editing active)\r\n      const meetingSavePromises = isMeetingEditing\r\n        ? Object.keys(editedTopics).map((idStr) => Number(idStr)).filter((id) => !Number.isNaN(id)).map((id) => saveTopic(id))\r\n        : [];\r\n\r\n      // Save bobot values if edited (only if grades editing active)\r\n      let bobotSaved = true;\r\n      if (isGradesEditing && hasEditedBobots) {\r\n        console.log('[SAVE ALL] Saving bobot values...');\r\n        bobotSaved = await saveBobots();\r\n        if (!bobotSaved) {\r\n          throw new Error('Failed to save grade weights');\r\n        }\r\n      }\r\n\r\n      // Save all edited grades\r\n      const gradeSavePromises = isGradesEditing\r\n        ? Object.entries(editedGrades).map(([gradeKey]) => {\r\n        let targetStudent: any = undefined;\r\n\r\n        // Find the student based on the grade key\r\n        if (gradeKey.startsWith('nim:')) {\r\n          const nim = gradeKey.substring(4);\r\n          targetStudent = students.find((s) => s.nim === nim);\r\n        } else if (gradeKey.startsWith('krs:')) {\r\n          const krsId = Number(gradeKey.substring(4));\r\n          targetStudent = students.find((s) => getStudentKrsId(s) === krsId);\r\n        } else if (gradeKey.startsWith('id:')) {\r\n          const gradeId = Number(gradeKey.substring(3));\r\n          // Find student by looking for their grade with this ID\r\n          targetStudent = students.find((s) => {\r\n            const grade = findGradeForStudent(s);\r\n            return grade?.id === gradeId;\r\n          });\r\n        }\r\n\r\n        const originalGrade = targetStudent\r\n          ? findGradeForStudent(targetStudent)\r\n          : (editedGrades[gradeKey] as GradeRecord);\r\n        return saveGrade(gradeKey, originalGrade, targetStudent);\r\n        })\r\n        : [];\r\n\r\n      console.log('[SAVE ALL] Meeting promises:', meetingSavePromises.length);\r\n      console.log('[SAVE ALL] Grade promises:', gradeSavePromises.length);\r\n\r\n      // Commit attendance changes (skip automatic exit)\r\n      const attendancePromise = isAttendanceEditing ? commitAttendanceChanges(true) : Promise.resolve();\r\n\r\n      await Promise.all([\r\n        Promise.all(meetingSavePromises),\r\n        Promise.all(gradeSavePromises),\r\n        attendancePromise,\r\n      ]);\r\n\r\n      console.log('[SAVE ALL]  All saves completed, exiting edit modes');\r\n\r\n      exitEditMode();\r\n    } catch (err) {\r\n      alert(err instanceof Error ? err.message : 'Failed to save changes');\r\n    } finally {\r\n      setIsSavingAll(false);\r\n    }\r\n  };\r\n\r\n  const updateGradeField = (gradeKey: string, field: keyof GradeRecord, value: any) => {\r\n    setEditedGrades((prev) => {\r\n      const updatedGrade = {\r\n        ...prev[gradeKey],\r\n        [field]: value === '' ? null : value,\r\n      };\r\n\r\n      // Check if the updated field is a grade component (not the final grades)\r\n      const isGradeComponent = gradeComponents.some((comp) => comp.key === field);\r\n\r\n      if (isGradeComponent) {\r\n        // Auto-calculate numeric grade from components\r\n        const calculatedNumeric = calculateNumericGrade(updatedGrade, gradeComponents);\r\n\r\n        if (calculatedNumeric !== null) {\r\n          // Auto-calculate letter grade and index from numeric\r\n          const { huruf, indeks } = calculateLetterGrade(calculatedNumeric);\r\n\r\n          // Update all calculated fields\r\n          updatedGrade.nilai_angka = calculatedNumeric;\r\n          updatedGrade.nilai_huruf = huruf;\r\n          updatedGrade.nilai_indeks = indeks;\r\n        } else {\r\n          // If no valid components, clear the calculated fields\r\n          updatedGrade.nilai_angka = null;\r\n          updatedGrade.nilai_huruf = null;\r\n          updatedGrade.nilai_indeks = null;\r\n        }\r\n      }\r\n\r\n      return {\r\n        ...prev,\r\n        [gradeKey]: updatedGrade,\r\n      };\r\n    });\r\n  };\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // Navigation\r\n  // ---------------------------------------------------------------------------\r\n\r\n  const handleBack = () => {\r\n    navigate(-1);\r\n  };\r\n\r\n  const exitEditMode = () => {\r\n    exitAllEditModes();\r\n  };\r\n\r\n  // enterEditMode removed  use enterAttendanceEditMode / enterMeetingEditMode / enterGradesEditMode as needed\r\n\r\n  const handleGeneratePDF = async () => {\r\n    if (!contentRef.current) return;\r\n    (window.React?.startTransition || ((fn: () => void) => fn()))(() => {\r\n      setIsGeneratingPDF(true);\r\n    });\r\n    await new Promise((r) => setTimeout(r, 0));\r\n    try {\r\n      const [{ default: html2canvas }, { default: jsPDF }] = await Promise.all([\r\n        import('html2canvas-pro'),\r\n        import('jspdf')\r\n      ]);\r\n\r\n      const canvas = await html2canvas(contentRef.current, {\r\n        scale: 1.5,\r\n        useCORS: true,\r\n        logging: false,\r\n        backgroundColor: '#ffffff',\r\n      });\r\n      const imgWidth = 210;\r\n      const pageHeight = 297;\r\n      const imgHeight = (canvas.height * imgWidth) / canvas.width;\r\n      let heightLeft = imgHeight;\r\n      const pdf = new jsPDF('p', 'mm', 'a4');\r\n      let position = 0;\r\n      const imgData = canvas.toDataURL('image/jpeg', 0.85);\r\n      pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);\r\n      heightLeft -= pageHeight;\r\n      while (heightLeft > 0) {\r\n        position = heightLeft - imgHeight;\r\n        pdf.addPage();\r\n        pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);\r\n        heightLeft -= pageHeight;\r\n      }\r\n      const filename = `Class_Summary_${className}_${courseName.replace(/\\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;\r\n      pdf.save(filename);\r\n    } catch (error) {\r\n      console.error('Error generating PDF:', error);\r\n      alert('Failed to generate PDF. Please try again.');\r\n    } finally {\r\n      setIsGeneratingPDF(false);\r\n    }\r\n  };\r\n\r\n  const handleGenerateXLSX = async () => {\r\n    setIsGeneratingXLSX(true);\r\n    try {\r\n      const XLSX = await import('xlsx');\r\n      const workbook = XLSX.utils.book_new();\r\n\r\n      // Sheet 1: Class Description\r\n      const classDescData = [\r\n        ['Class Summary Report'],\r\n        [],\r\n        ['Course Code', courseCode],\r\n        ['Course Name', courseName],\r\n        ['Class', className],\r\n        ['Total SKS', totalSks],\r\n        ['Lecturers', lecturerNames.join(', ')],\r\n        ['Total Students', students.length],\r\n        ['Total Meetings', meetings.length],\r\n        ['Generated Date', new Date().toLocaleDateString('id-ID')],\r\n      ];\r\n      const classDescSheet = XLSX.utils.aoa_to_sheet(classDescData);\r\n      classDescSheet['!cols'] = [{ wch: 20 }, { wch: 40 }];\r\n      XLSX.utils.book_append_sheet(workbook, classDescSheet, 'Class Description');\r\n\r\n      // Sheet 2: Attendance Overview\r\n      const attendanceHeaders = ['NIM', 'Name', ...sortedMeetings.map(m => `P${m.pertemuan_ke}`)];\r\n      const attendanceData = [attendanceHeaders];\r\n      \r\n      students.forEach((student) => {\r\n        const studentAttendance = attendanceLookup[student.nim] || {};\r\n        const row = [student.nim, student.nama];\r\n        \r\n        sortedMeetings.forEach((meeting) => {\r\n          const status = studentAttendance[meeting.id] || '';\r\n          row.push(status || '-');\r\n        });\r\n        \r\n        attendanceData.push(row);\r\n      });\r\n      \r\n      const attendanceSheet = XLSX.utils.aoa_to_sheet(attendanceData);\r\n      attendanceSheet['!cols'] = [\r\n        { wch: 15 },\r\n        { wch: 25 },\r\n        ...sortedMeetings.map(() => ({ wch: 12 })),\r\n      ];\r\n      XLSX.utils.book_append_sheet(workbook, attendanceSheet, 'Attendance Overview');\r\n\r\n      // Sheet 3: Meeting Summary\r\n      const meetingSummaryData = [\r\n        ['Meeting', 'Date', 'Time', 'Lecturers', 'Topic'],\r\n        ...sortedMeetings.map((meeting) => {\r\n          const hasValidDate = meeting.tgl_pertemuan && (\r\n            typeof meeting.tgl_pertemuan === 'string' ||\r\n            (typeof meeting.tgl_pertemuan === 'object' && 'Valid' in meeting.tgl_pertemuan && meeting.tgl_pertemuan.Valid)\r\n          );\r\n\r\n          let topik = '';\r\n          if (meeting.topik) {\r\n            if (typeof meeting.topik === 'string') {\r\n              topik = meeting.topik;\r\n            } else if ('String' in meeting.topik && meeting.topik.Valid) {\r\n              topik = meeting.topik.String;\r\n            }\r\n          }\r\n\r\n          const lecturerId = extractString(meeting.id_dosen as string | SqlNullString);\r\n          const lecturerName = lecturerId && lecturerLookup[lecturerId] ? lecturerLookup[lecturerId] : '-';\r\n\r\n          return [\r\n            `P${meeting.pertemuan_ke}`,\r\n            hasValidDate ? formatDate(meeting.tgl_pertemuan) : '-',\r\n            formatTime(meeting.jam_pertemuan as any),\r\n            lecturerName,\r\n            topik || '-',\r\n          ];\r\n        }),\r\n      ];\r\n\r\n      const meetingSheet = XLSX.utils.aoa_to_sheet(meetingSummaryData);\r\n      meetingSheet['!cols'] = [{ wch: 15 }, { wch: 20 }, { wch: 12 }, { wch: 25 }, { wch: 40 }];\r\n      XLSX.utils.book_append_sheet(workbook, meetingSheet, 'Meeting Summary');\r\n\r\n      // Sheet 4: Grades Overview (with weights row at the bottom)\r\n      const gradesHeaders = [\r\n        'NIM', 'Name', 'Participation', 'Project', 'Quiz', \r\n        'Assignment', 'Midterm', 'Final', 'Numeric Grade', \r\n        'Letter Grade', 'Grade Index'\r\n      ];\r\n      const gradesData: (string | number)[][] = [gradesHeaders];\r\n      \r\n      students.forEach((student) => {\r\n        const grade = findGradeForStudent(student) || ({\r\n          aktivitas_partisipatif: null,\r\n          hasil_proyek: null,\r\n          quiz: null,\r\n          tugas: null,\r\n          uts: null,\r\n          uas: null,\r\n          nilai_angka: null,\r\n          nilai_huruf: null,\r\n          nilai_indeks: null,\r\n        } as GradeRecord);\r\n        \r\n        const getValue = (key: keyof GradeRecord): any => {\r\n          const val = grade[key];\r\n          if (val === null || val === undefined) return '';\r\n          if (typeof val === 'object' && 'Float64' in val) return val.Valid ? val.Float64 : '';\r\n          if (typeof val === 'object' && 'String' in val) return val.Valid ? val.String : '';\r\n          if (typeof val === 'object' && 'Int32' in val) return val.Valid ? val.Int32 : '';\r\n          return val;\r\n        };\r\n\r\n        gradesData.push([\r\n          student.nim,\r\n          student.nama,\r\n          (() => { const v = getValue('aktivitas_partisipatif'); return v !== '' ? v : '-'; })(),\r\n          (() => { const v = getValue('hasil_proyek'); return v !== '' ? v : '-'; })(),\r\n          (() => { const v = getValue('quiz'); return v !== '' ? v : '-'; })(),\r\n          (() => { const v = getValue('tugas'); return v !== '' ? v : '-'; })(),\r\n          (() => { const v = getValue('uts'); return v !== '' ? v : '-'; })(),\r\n          (() => { const v = getValue('uas'); return v !== '' ? v : '-'; })(),\r\n          (() => { const v = getValue('nilai_angka'); return v !== '' ? v : '-'; })(),\r\n          (() => { const v = getValue('nilai_huruf'); return v !== '' ? v : '-'; })(),\r\n          (() => { const v = getValue('nilai_indeks'); return v !== '' ? v : '-'; })(),\r\n        ]);\r\n      });\r\n      \r\n      // Add grade weights row at the bottom\r\n      gradesData.push([\r\n        'Component Weights',\r\n        '',\r\n        `${gradeWeights.aktivitas_partisipatif}%`,\r\n        `${gradeWeights.hasil_proyek}%`,\r\n        `${gradeWeights.quiz}%`,\r\n        `${gradeWeights.tugas}%`,\r\n        `${gradeWeights.uts}%`,\r\n        `${gradeWeights.uas}%`,\r\n        'Total: 100%',\r\n        '',\r\n        '',\r\n      ]);\r\n      \r\n      const gradesSheet = XLSX.utils.aoa_to_sheet(gradesData);\r\n      gradesSheet['!cols'] = [\r\n        { wch: 15 }, // NIM\r\n        { wch: 25 }, // Name\r\n        { wch: 13 }, // Participation\r\n        { wch: 10 }, // Project\r\n        { wch: 8 },  // Quiz\r\n        { wch: 12 }, // Assignment\r\n        { wch: 10 }, // Midterm\r\n        { wch: 8 },  // Final\r\n        { wch: 13 }, // Numeric\r\n        { wch: 12 }, // Letter\r\n        { wch: 11 }, // Index\r\n      ];\r\n      XLSX.utils.book_append_sheet(workbook, gradesSheet, 'Grades Overview');\r\n\r\n      // Generate filename\r\n      const filename = `Class_Summary_${className}_${courseName.replace(/\\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;\r\n      \r\n      // Save XLSX\r\n      XLSX.writeFile(workbook, filename);\r\n    } catch (error) {\r\n      console.error('Error generating XLSX:', error);\r\n      alert('Failed to generate XLSX. Please try again.');\r\n    } finally {\r\n      setIsGeneratingXLSX(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"p-6 space-y-6\">\r\n      {/* Breadcrumb */}\r\n      <nav className=\"flex items-center space-x-2 text-sm text-gray-600\">\r\n        <button\r\n          onClick={() => navigate(`/${fromPage}`)}\r\n          className=\"flex items-center hover:text-gray-900 transition-colors\"\r\n        >\r\n          <Home className=\"h-4 w-4\" />\r\n        </button>\r\n        <ChevronRight className=\"h-4 w-4\" />\r\n        <button\r\n          onClick={handleBack}\r\n          className=\"hover:text-gray-900 transition-colors\"\r\n        >\r\n          {fromPage === 'lecturer/class-schedule' ? 'Class Schedule' : \r\n           fromPage === 'admin/class-management' ? 'Class Management' : 'Dashboard'}\r\n        </button>\r\n        <ChevronRight className=\"h-4 w-4\" />\r\n        <span className=\"text-gray-900 font-medium\">Class Summary</span>\r\n      </nav>\r\n\r\n      {/* PDF Generation Button - Outside of PDF Content */}\r\n        <div className=\"flex justify-end gap-3\">\r\n        <div className=\"flex items-center gap-3\">\r\n          <button\r\n            onClick={() => (isAttendanceEditing ? exitAttendanceEditMode() : enterAttendanceEditMode())}\r\n            className={`btn-secondary flex items-center gap-2 hover:cursor-pointer transition-all active:scale-95 ${isAttendanceEditing ? 'bg-blue-600 text-white' : ''}`}\r\n          >\r\n            {isAttendanceEditing ? 'Stop Attendance Editing' : 'Edit Attendance'}\r\n          </button>\r\n\r\n          <button\r\n            onClick={() => (isMeetingEditing ? exitMeetingEditMode() : enterMeetingEditMode())}\r\n            className={`btn-secondary flex items-center gap-2 hover:cursor-pointer transition-all active:scale-95 ${isMeetingEditing ? 'bg-blue-600 text-white' : ''}`}\r\n          >\r\n            {isMeetingEditing ? 'Stop Meeting Editing' : 'Edit Meetings'}\r\n          </button>\r\n\r\n          <button\r\n            onClick={() => (isGradesEditing ? exitGradesEditMode() : enterGradesEditMode())}\r\n            className={`btn-secondary flex items-center gap-2 hover:cursor-pointer transition-all active:scale-95 ${isGradesEditing ? 'bg-blue-600 text-white' : ''}`}\r\n          >\r\n            {isGradesEditing ? 'Stop Grades Editing' : 'Edit Grades'}\r\n          </button>\r\n\r\n          {anyEditing && (\r\n            <>\r\n              <button onClick={saveAllAndFinish} className=\"btn-primary\" disabled={isSavingAll || !hasUnsavedChanges}>Save & Finish</button>\r\n              <button onClick={() => exitAllEditModes()} className=\"btn-secondary\">Cancel</button>\r\n            </>\r\n          )}\r\n        </div>\r\n        {isAttendanceEditing && (\r\n          <div className=\"text-xs text-gray-600 flex flex-col gap-3 p-3 bg-blue-50 rounded border border-blue-200\">\r\n            <div>\r\n              <span className=\"font-medium text-gray-900\">Status Brush:</span>\r\n              <p className=\"text-gray-600 mt-1\">Choose a status with buttons below or use keyboard shortcuts (1..6), then click cells to apply. Press Esc to clear.</p>\r\n            </div>\r\n            <div className=\"flex flex-wrap gap-2\">\r\n              <button\r\n                onClick={() => setCurrentShortcutStatus('Hadir')}\r\n                className={`px-3 py-1 rounded text-xs font-medium transition-all ${\r\n                  currentShortcutStatus === 'Hadir'\r\n                    ? 'bg-green-600 text-white'\r\n                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'\r\n                }`}\r\n                title=\"Press 1\"\r\n              >\r\n                1 - Hadir\r\n              </button>\r\n              <button\r\n                onClick={() => setCurrentShortcutStatus('Izin')}\r\n                className={`px-3 py-1 rounded text-xs font-medium transition-all ${\r\n                  currentShortcutStatus === 'Izin'\r\n                    ? 'bg-blue-600 text-white'\r\n                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'\r\n                }`}\r\n                title=\"Press 2\"\r\n              >\r\n                2 - Izin\r\n              </button>\r\n              <button\r\n                onClick={() => setCurrentShortcutStatus('Sakit')}\r\n                className={`px-3 py-1 rounded text-xs font-medium transition-all ${\r\n                  currentShortcutStatus === 'Sakit'\r\n                    ? 'bg-yellow-600 text-white'\r\n                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'\r\n                }`}\r\n                title=\"Press 3\"\r\n              >\r\n                3 - Sakit\r\n              </button>\r\n              <button\r\n                onClick={() => setCurrentShortcutStatus('Alfa')}\r\n                className={`px-3 py-1 rounded text-xs font-medium transition-all ${\r\n                  currentShortcutStatus === 'Alfa'\r\n                    ? 'bg-red-600 text-white'\r\n                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'\r\n                }`}\r\n                title=\"Press 4\"\r\n              >\r\n                4 - Alfa\r\n              </button>\r\n              <button\r\n                onClick={() => setCurrentShortcutStatus('Terlambat')}\r\n                className={`px-3 py-1 rounded text-xs font-medium transition-all ${\r\n                  currentShortcutStatus === 'Terlambat'\r\n                    ? 'bg-orange-600 text-white'\r\n                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'\r\n                }`}\r\n                title=\"Press 5\"\r\n              >\r\n                5 - Terlambat\r\n              </button>\r\n              <button\r\n                onClick={() => setCurrentShortcutStatus('Pengganti')}\r\n                className={`px-3 py-1 rounded text-xs font-medium transition-all ${\r\n                  currentShortcutStatus === 'Pengganti'\r\n                    ? 'bg-purple-600 text-white'\r\n                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'\r\n                }`}\r\n                title=\"Press 6\"\r\n              >\r\n                6 - Tugas\r\n              </button>\r\n              <button\r\n                onClick={() => setCurrentShortcutStatus(null)}\r\n                className={`px-3 py-1 rounded text-xs font-medium transition-all ${\r\n                  currentShortcutStatus === null\r\n                    ? 'bg-gray-600 text-white'\r\n                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'\r\n                }`}\r\n                title=\"Press Esc\"\r\n              >\r\n                Clear Brush\r\n              </button>\r\n            </div>\r\n            <div className=\"text-xs text-gray-700 bg-white p-2 rounded border border-gray-200\">\r\n              <span className=\"font-medium\">Current: </span>\r\n              <span className=\"font-semibold\">\r\n                {currentShortcutStatus === null ? 'None' : (currentShortcutStatus === '' ? 'Kosong' : currentShortcutStatus)}\r\n              </span>\r\n            </div>\r\n          </div>\r\n        )}\r\n        <button\r\n          onClick={handleGeneratePDF}\r\n          disabled={isGeneratingPDF || loading}\r\n          className=\"btn-primary flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed hover:cursor-pointer transition-all active:scale-95\"\r\n        >\r\n          {isGeneratingPDF ? (\r\n            <>\r\n              <Loader2 className=\"h-4 w-4 animate-spin\" />\r\n              <span>Generating PDF...</span>\r\n            </>\r\n          ) : (\r\n            <>\r\n              <Download className=\"h-4 w-4\" />\r\n              <span>Generate PDF Report</span>\r\n            </>\r\n          )}\r\n        </button>\r\n        \r\n        <button\r\n          onClick={handleGenerateXLSX}\r\n          disabled={isGeneratingXLSX || loading}\r\n          className=\"btn-primary flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed hover:cursor-pointer transition-all active:scale-95\"\r\n        >\r\n          {isGeneratingXLSX ? (\r\n            <>\r\n              <Loader2 className=\"h-4 w-4 animate-spin\" />\r\n              <span>Generating XLSX...</span>\r\n            </>\r\n          ) : (\r\n            <>\r\n              <FileSpreadsheet className=\"h-4 w-4\" />\r\n              <span>Generate XLSX Report</span>\r\n            </>\r\n          )}\r\n        </button>\r\n      </div>\r\n\r\n      {/* Content to be captured in PDF */}\r\n      <div ref={contentRef} className=\"bg-white rounded-lg shadow-sm border border-gray-200\">\r\n        {/* Header */}\r\n        <div className=\"px-6 pt-6 pb-3\">\r\n          <div>\r\n            <h1 className=\"text-2xl font-bold text-gray-900\">Class Summary</h1>\r\n            <p className=\"text-base text-gray-600 mt-1\">\r\n              {courseCode && <span className=\"font-medium\">{courseCode}</span>}\r\n              {courseCode && ' - '}\r\n              {courseName} - Class {className}\r\n              {totalSks > 0 && ` (${totalSks} SKS)`}\r\n            </p>\r\n            {lecturerNames.length > 0 && (\r\n              <p className=\"text-sm text-gray-500 mt-2\">\r\n                {lecturerNames.join(', ')}\r\n              </p>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Content */}\r\n        <div>\r\n        {loading ? (\r\n          <div className=\"flex items-center justify-center py-12 bg-white rounded-lg shadow-sm border border-gray-200\">\r\n            <Loader2 className=\"h-8 w-8 text-blue-600 animate-spin\" />\r\n            <span className=\"ml-3 text-gray-600\">Loading attendance data...</span>\r\n          </div>\r\n        ) : error ? (\r\n          <div className=\"flex items-center gap-3 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700\">\r\n            <AlertCircle className=\"h-5 w-5 flex-shrink-0\" />\r\n            <div>\r\n              <p className=\"font-medium\">Error loading attendance data</p>\r\n              <p className=\"text-sm text-red-600\">\r\n                {error instanceof Error ? error.message : 'Unknown error'}\r\n              </p>\r\n            </div>\r\n          </div>\r\n        ) : meetings.length === 0 ? (\r\n          <div className=\"text-center py-12 text-gray-500 bg-white rounded-lg shadow-sm border border-gray-200\">\r\n            <AlertCircle className=\"h-12 w-12 text-gray-300 mx-auto mb-3\" />\r\n            <p>No meetings scheduled for this class</p>\r\n          </div>\r\n        ) : students.length === 0 ? (\r\n          <div className=\"text-center py-12 text-gray-500 bg-white rounded-lg shadow-sm border border-gray-200\">\r\n            <AlertCircle className=\"h-12 w-12 text-gray-300 mx-auto mb-3\" />\r\n            <p>No students enrolled in this class</p>\r\n          </div>\r\n        ) : (\r\n          <>\r\n            {/* Attendance Table Section */}\r\n            <div className=\"px-6 py-3\">\r\n              <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Attendance Overview</h3>\r\n              <div className=\"border border-gray-300 rounded-lg overflow-hidden\">\r\n                <div className=\"overflow-x-auto\">\r\n                  <div className=\"flex gap-0\">\r\n                    {/* Fixed NIM/Name Table */}\r\n                    <div className=\"flex-shrink-0 sticky left-0 z-10\">\r\n                      <table className=\"border-collapse\">\r\n                        <thead>\r\n                          <tr className=\"bg-gray-50\">\r\n                            <th className=\"bg-gray-50 border-r border-b border-gray-300 px-2 py-2 text-left text-xs font-semibold text-gray-700 w-24 align-top\">\r\n                              <div className=\"min-h-[3.5rem] flex items-center\">NIM</div>\r\n                            </th>\r\n                            <th className=\"bg-gray-50 border-r border-b border-gray-300 px-2 py-2 text-left text-xs font-semibold text-gray-700 w-52 align-top\">\r\n                              <div className=\"min-h-[3.5rem] flex items-center\">Name</div>\r\n                            </th>\r\n                          </tr>\r\n                        </thead>\r\n                        <tbody>\r\n                          {students.map((student) => (\r\n                            <tr key={student.nim} className=\"hover:bg-gray-50 h-9\">\r\n                              <td className=\"bg-white border-r border-b border-gray-300 px-2 py-1.5 text-xs font-medium text-gray-900\">\r\n                                {student.nim}\r\n                              </td>\r\n                              <td className=\"bg-white border-r border-b border-gray-300 px-2 py-1.5 text-xs text-gray-900 truncate\">\r\n                                {student.nama}\r\n                              </td>\r\n                            </tr>\r\n                          ))}\r\n                        </tbody>\r\n                      </table>\r\n                    </div>\r\n\r\n                    {/* Scrollable Meetings Table */}\r\n                    <div className=\"flex-1\">\r\n                      <table className=\"border-collapse\">\r\n                        <thead>\r\n                          <tr className=\"bg-gray-50\">\r\n                            {sortedMeetings.map((meeting) => {\r\n                              // Check if tgl_pertemuan exists and is valid\r\n                              const hasValidDate = meeting.tgl_pertemuan && (\r\n                                typeof meeting.tgl_pertemuan === 'string' ||\r\n                                (typeof meeting.tgl_pertemuan === 'object' && 'Valid' in meeting.tgl_pertemuan && meeting.tgl_pertemuan.Valid)\r\n                              );\r\n                              \r\n                              return (\r\n                                <th\r\n                                  key={meeting.id}\r\n                                  className=\"border-r border-b border-gray-300 px-1 py-2 text-center text-xs font-semibold text-gray-700 w-14 align-top\"\r\n                                >\r\n                                  <div className=\"min-h-[3.5rem] flex flex-col items-center justify-center gap-0.5\">\r\n                                    <span className=\"font-bold text-[10px]\">P{meeting.pertemuan_ke}</span>\r\n                                    {hasValidDate && (\r\n                                      <span className=\"text-gray-500 font-normal text-[9px] whitespace-pre-line\">\r\n                                        {formatDateCompact(meeting.tgl_pertemuan)}\r\n                                      </span>\r\n                                    )}\r\n                                  </div>\r\n                                </th>\r\n                              );\r\n                            })}\r\n                          </tr>\r\n                        </thead>\r\n                        <tbody>\r\n                          {students.map((student) => {\r\n                            const studentAttendance = attendanceLookup[student.nim] || {};\r\n                            \r\n                            return (\r\n                              <tr key={student.nim} className=\"hover:bg-gray-50 h-9\">\r\n                                {sortedMeetings.map((meeting) => {\r\n                                  const status = pendingStatusChanges[`${student.nim}-${meeting.id}`] ?? studentAttendance[meeting.id] ?? '';\r\n                                  const cellKey = `${student.nim}-${meeting.id}`;\r\n                                  const isModified = modifiedCells.has(cellKey);\r\n                                  const isSaving = savingCells[cellKey];\r\n                                  return (\r\n                                    <td\r\n                                      key={meeting.id}\r\n                                      className={`border-r border-b border-gray-300 px-1 py-1.5 text-center ${getStatusColor(status)} ${isAttendanceEditing ? 'cursor-pointer' : ''} ${isModified ? 'bg-yellow-50' : ''} ${activeCell === cellKey ? 'outline outline-2 outline-blue-500' : ''}`}\r\n                                      onClick={() => {\r\n                                        if (!isAttendanceEditing) return;\r\n                                        if (currentShortcutStatus !== null) {\r\n                                          updateSingleCell(cellKey, currentShortcutStatus);\r\n                                        } else {\r\n                                          setActiveCell(cellKey);\r\n                                        }\r\n                                      }}\r\n                                    >\r\n                                      {isAttendanceEditing && activeCell === cellKey ? (\r\n                                        <select\r\n                                          autoFocus\r\n                                          value={status}\r\n                                          onChange={(e) => updateSingleCell(cellKey, e.target.value)}\r\n                                          onBlur={() => setActiveCell(null)}\r\n                                          className=\"text-[10px] px-1 py-0.5 bg-white border border-gray-300 rounded w-full\"\r\n                                        >\r\n                                          <option value=\"\"></option>\r\n                                          {ATTENDANCE_STATUSES.slice(1).map(s => <option key={s} value={s}>{s}</option>)}\r\n                                        </select>\r\n                                      ) : isSaving ? (\r\n                                        <Loader2 className=\"h-4 w-4 animate-spin text-gray-500 mx-auto\" />\r\n                                      ) : (\r\n                                        getStatusIcon(status)\r\n                                      )}\r\n                                    </td>\r\n                                  );\r\n                                })}\r\n                              </tr>\r\n                            );\r\n                          })}\r\n                        </tbody>\r\n                      </table>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Legend */}\r\n            <div className=\"px-6 py-3\">\r\n              <div className=\"flex items-center gap-4 text-xs flex-wrap\">\r\n                <span className=\"font-medium text-gray-700\">Legend:</span>\r\n                <div className=\"flex items-center gap-1\">\r\n                  <CheckCircle className=\"h-4 w-4 text-green-600\" />\r\n                  <span className=\"text-gray-600\">Present</span>\r\n                </div>\r\n                <div className=\"flex items-center gap-1\">\r\n                  <ClockAlert className=\"h-4 w-4 text-orange-600\" />\r\n                  <span className=\"text-gray-600\">Late</span>\r\n                </div>\r\n                <div className=\"flex items-center gap-1\">\r\n                  <Clock className=\"h-4 w-4 text-blue-600\" />\r\n                  <span className=\"text-gray-600\">Excused</span>\r\n                </div>\r\n                <div className=\"flex items-center gap-1\">\r\n                  <AlertCircle className=\"h-4 w-4 text-yellow-600\" />\r\n                  <span className=\"text-gray-600\">Sick</span>\r\n                </div>\r\n                <div className=\"flex items-center gap-1\">\r\n                  <XCircle className=\"h-4 w-4 text-red-600\" />\r\n                  <span className=\"text-gray-600\">Absent</span>\r\n                </div>\r\n                <div className=\"flex items-center gap-1\">\r\n                  <CheckCircle className=\"h-4 w-4 text-purple-600\" />\r\n                  <span className=\"text-gray-600\">Tugas</span>\r\n                </div>\r\n                <div className=\"flex items-center gap-1\">\r\n                  <Minus className=\"h-4 w-4 text-gray-300\" />\r\n                  <span className=\"text-gray-600\">No data</span>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Meeting Descriptions Table */}\r\n            <div className=\"px-6 py-3\">\r\n              <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Meeting Descriptions</h3>\r\n              <div className=\"border border-gray-300 rounded-lg overflow-hidden\">\r\n                <table className=\"w-full border-collapse text-xs\">\r\n                  <thead>\r\n                    <tr className=\"bg-gray-50\">\r\n                      <th className=\"border-b border-gray-300 px-3 py-2 text-left font-semibold text-gray-700 w-16\">\r\n                        Meeting\r\n                      </th>\r\n                      <th className=\"border-b border-gray-300 px-3 py-2 text-left font-semibold text-gray-700 w-40\">Date</th>\r\n                      <th className=\"border-b border-gray-300 px-3 py-2 text-left font-semibold text-gray-700 w-20\">Time</th>\r\n                      <th className=\"border-b border-gray-300 px-3 py-2 text-left font-semibold text-gray-700 w-48\">Lecturers</th>\r\n                      <th className=\"border-b border-gray-300 px-3 py-2 text-left font-semibold text-gray-700\">\r\n                        Topic\r\n                      </th>\r\n                    </tr>\r\n                  </thead>\r\n                  <tbody>\r\n                    {sortedMeetings.map((meeting) => {\r\n                      const hasValidDate = meeting.tgl_pertemuan && (\r\n                        typeof meeting.tgl_pertemuan === 'string' ||\r\n                        (typeof meeting.tgl_pertemuan === 'object' && 'Valid' in meeting.tgl_pertemuan && meeting.tgl_pertemuan.Valid)\r\n                      );\r\n                      let currentTopik = '';\r\n                      if (meeting.topik) {\r\n                        if (typeof meeting.topik === 'string') currentTopik = meeting.topik;\r\n                        else if ('String' in meeting.topik && meeting.topik.Valid) currentTopik = meeting.topik.String;\r\n                      }\r\n                      \r\n                      return (\r\n                        <tr key={meeting.id} className=\"hover:bg-gray-50\">\r\n                          <td className=\"border-b border-gray-300 px-3 py-2 font-medium text-gray-900\">\r\n                            P{meeting.pertemuan_ke}\r\n                          </td>\r\n                          <td className=\"border-b border-gray-300 px-3 py-2 text-gray-600\">\r\n                            {editedTopics[meeting.id] !== undefined ? (\r\n                              <input\r\n                                type=\"date\"\r\n                                value={editedDates[meeting.id] || (() => {\r\n                                  if (!hasValidDate) return '';\r\n                                  let rawDate = '';\r\n                                  if (typeof meeting.tgl_pertemuan === 'string') rawDate = meeting.tgl_pertemuan;\r\n                                  else if (typeof meeting.tgl_pertemuan === 'object' && meeting.tgl_pertemuan.Valid) rawDate = meeting.tgl_pertemuan.Time;\r\n                                  if (!rawDate) return '';\r\n                                  const d = new Date(rawDate);\r\n                                  return isNaN(d.getTime()) ? '' : d.toISOString().slice(0,10);\r\n                                })()}\r\n                                onChange={(e) => setEditedDates((p) => ({ ...p, [meeting.id]: e.target.value }))}\r\n                                className=\"input-field text-xs\"\r\n                              />\r\n                            ) : (\r\n                              hasValidDate ? formatDate(meeting.tgl_pertemuan) : '-'\r\n                            )}\r\n                          </td>\r\n                          <td className=\"border-b border-gray-300 px-3 py-2 text-gray-600\">\r\n                            {editedTopics[meeting.id] !== undefined ? (\r\n                              <input\r\n                                type=\"time\"\r\n                                value={editedTimes[meeting.id] || (() => {\r\n                                  const raw = typeof meeting.jam_pertemuan === 'string'\r\n                                    ? meeting.jam_pertemuan\r\n                                    : (meeting.jam_pertemuan && 'String' in (meeting.jam_pertemuan as any) && (meeting.jam_pertemuan as any).Valid\r\n                                      ? (meeting.jam_pertemuan as any).String\r\n                                      : '');\r\n                                  if (!raw) return '';\r\n                                  // Strip seconds if present\r\n                                  const parts = raw.split(':');\r\n                                  return parts.length >= 2 ? `${parts[0].padStart(2,'0')}:${parts[1].padStart(2,'0')}` : raw;\r\n                                })()}\r\n                                onChange={(e) => setEditedTimes((p) => ({ ...p, [meeting.id]: e.target.value }))}\r\n                                className=\"input-field text-xs\"\r\n                              />\r\n                            ) : (\r\n                              formatTime(meeting.jam_pertemuan as any)\r\n                            )}\r\n                          </td>\r\n                          <td className=\"border-b border-gray-300 px-3 py-2 text-gray-600\">\r\n                            {editedTopics[meeting.id] !== undefined ? (\r\n                              <select\r\n                                value={editedLecturers[meeting.id] || ''}\r\n                                onChange={(e) => setEditedLecturers((p) => ({ ...p, [meeting.id]: e.target.value }))}\r\n                                className=\"input-field text-xs w-full\"\r\n                              >\r\n                                <option value=\"\">- No Lecturer -</option>\r\n                                {lecturerIds.map((lecturerId) => (\r\n                                  <option key={lecturerId} value={lecturerId}>\r\n                                    {lecturerLookup[lecturerId] || lecturerId}\r\n                                  </option>\r\n                                ))}\r\n                              </select>\r\n                            ) : (\r\n                              (() => {\r\n                                const lecturerId = extractString(meeting.id_dosen as string | SqlNullString);\r\n                                return lecturerId && lecturerLookup[lecturerId] ? lecturerLookup[lecturerId] : '-';\r\n                              })()\r\n                            )}\r\n                          </td>\r\n                          <td className=\"border-b border-gray-300 px-3 py-2 text-gray-600\">\r\n                            {isMeetingEditing ? (\r\n                              editedTopics[meeting.id] !== undefined ? (\r\n                                <div className=\"flex items-center gap-2\">\r\n                                  <input\r\n                                    value={editedTopics[meeting.id]}\r\n                                    onChange={(e) => setEditedTopics((p) => ({ ...p, [meeting.id]: e.target.value }))}\r\n                                    className=\"input-field w-full text-xs\"\r\n                                    placeholder=\"Enter topic/description\"\r\n                                  />\r\n                                  <button\r\n                                    onClick={() => saveTopic(meeting.id)}\r\n                                    disabled={updateMeetingMutation.isPending}\r\n                                    className=\"px-2 py-1 text-xs rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50\"\r\n                                  >\r\n                                    Save\r\n                                  </button>\r\n                                  <button\r\n                                    onClick={() => cancelEditTopic(meeting.id)}\r\n                                    disabled={updateMeetingMutation.isPending}\r\n                                    className=\"px-2 py-1 text-xs rounded bg-gray-200 text-gray-700 hover:bg-gray-300\"\r\n                                  >\r\n                                    Cancel\r\n                                  </button>\r\n                                </div>\r\n                              ) : (\r\n                                <div className=\"flex items-center justify-between gap-2\">\r\n                                  <span className=\"truncate max-w-[28rem]\">{currentTopik || '-'}</span>\r\n                                  <button\r\n                                    onClick={() => {\r\n                                      let dateForInput = '';\r\n                                      if (hasValidDate) {\r\n                                        let rawDate = '';\r\n                                        if (typeof meeting.tgl_pertemuan === 'string') rawDate = meeting.tgl_pertemuan;\r\n                                        else if (typeof meeting.tgl_pertemuan === 'object' && meeting.tgl_pertemuan.Valid) rawDate = meeting.tgl_pertemuan.Time;\r\n                                        if (rawDate) {\r\n                                          const d = new Date(rawDate);\r\n                                          if (!isNaN(d.getTime())) dateForInput = d.toISOString().slice(0,10);\r\n                                        }\r\n                                      }\r\n                                      let timeForInput = '';\r\n                                      const rawTime = typeof meeting.jam_pertemuan === 'string'\r\n                                        ? meeting.jam_pertemuan\r\n                                        : (meeting.jam_pertemuan && 'String' in (meeting.jam_pertemuan as any) && (meeting.jam_pertemuan as any).Valid\r\n                                          ? (meeting.jam_pertemuan as any).String\r\n                                          : '');\r\n                                      if (rawTime) {\r\n                                        const parts = rawTime.split(':');\r\n                                        if (parts.length >= 2) timeForInput = `${parts[0].padStart(2,'0')}:${parts[1].padStart(2,'0')}`;\r\n                                      }\r\n                                      const lecturerForInput = extractString(meeting.id_dosen as string | SqlNullString);\r\n                                      startEditTopic(meeting.id, currentTopik, dateForInput, timeForInput, lecturerForInput);\r\n                                    }}\r\n                                    className=\"px-2 py-1 text-xs rounded bg-primary-600 text-white hover:bg-primary-700\"\r\n                                  >\r\n                                    Edit\r\n                                  </button>\r\n                                </div>\r\n                              )\r\n                            ) : (\r\n                              <span>{currentTopik || '-'}</span>\r\n                            )}\r\n                          </td>\r\n                        </tr>\r\n                      );\r\n                    })}\r\n                  </tbody>\r\n                </table>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Grades Overview Table */}\r\n            <div className=\"px-6 py-3 pb-6\">\r\n              <div className=\"flex items-center justify-between mb-4\">\r\n                <h3 className=\"text-lg font-semibold text-gray-900\">Grades Overview</h3>\r\n                {/* Grade editing is enabled when `isGradesEditing` is active */}\r\n              </div>\r\n              <div className=\"border border-gray-300 rounded-lg overflow-hidden\">\r\n                <div className=\"overflow-x-auto\">\r\n                  <table className=\"w-full border-collapse text-xs\">\r\n                    <thead>\r\n                      <tr className=\"bg-gray-50\">\r\n                        <th className=\"border-r border-b border-gray-300 px-3 py-2 text-left font-semibold text-gray-700 w-28\">\r\n                          NIM\r\n                        </th>\r\n                        <th className=\"border-r border-b border-gray-300 px-3 py-2 text-left font-semibold text-gray-700 w-48\">\r\n                          Name\r\n                        </th>\r\n                        <th className=\"border-r border-b border-gray-300 px-3 py-2 text-center font-semibold text-gray-700 w-24\">\r\n                          Participation\r\n                        </th>\r\n                        <th className=\"border-r border-b border-gray-300 px-3 py-2 text-center font-semibold text-gray-700 w-24\">\r\n                          Project\r\n                        </th>\r\n                        <th className=\"border-r border-b border-gray-300 px-3 py-2 text-center font-semibold text-gray-700 w-24\">\r\n                          Quiz\r\n                        </th>\r\n                        <th className=\"border-r border-b border-gray-300 px-3 py-2 text-center font-semibold text-gray-700 w-24\">\r\n                          Assignment\r\n                        </th>\r\n                        <th className=\"border-r border-b border-gray-300 px-3 py-2 text-center font-semibold text-gray-700 w-24\">\r\n                          Midterm\r\n                        </th>\r\n                        <th className=\"border-r border-b border-gray-300 px-3 py-2 text-center font-semibold text-gray-700 w-24\">\r\n                          Final\r\n                        </th>\r\n                        <th className=\"border-r border-b border-gray-300 px-3 py-2 text-center font-semibold text-gray-700 w-20\">\r\n                          <div className=\"flex flex-col items-center\">\r\n                            <span>Numeric</span>\r\n                            <span className=\"text-xs font-normal text-gray-500\">(Auto)</span>\r\n                          </div>\r\n                        </th>\r\n                        <th className=\"border-r border-b border-gray-300 px-3 py-2 text-center font-semibold text-gray-700 w-20\">\r\n                          <div className=\"flex flex-col items-center\">\r\n                            <span>Letter</span>\r\n                            <span className=\"text-xs font-normal text-gray-500\">(Auto)</span>\r\n                          </div>\r\n                        </th>\r\n                        <th className={`border-b border-gray-300 px-3 py-2 text-center font-semibold text-gray-700 w-20 ${isGradesEditing ? 'border-r' : ''}`}>\r\n                          <div className=\"flex flex-col items-center\">\r\n                            <span>Index</span>\r\n                            <span className=\"text-xs font-normal text-gray-500\">(Auto)</span>\r\n                          </div>\r\n                        </th>\r\n                        {isGradesEditing && (\r\n                          <th className=\"border-b border-gray-300 px-3 py-2 text-center font-semibold text-gray-700 w-16\">\r\n                            Action\r\n                          </th>\r\n                        )}\r\n                      </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                      {students.map((student) => {\r\n                        const grade = findGradeForStudent(student) || ({\r\n                          id: 0,\r\n                          krs_id: null,\r\n                          aktivitas_partisipatif: null,\r\n                          hasil_proyek: null,\r\n                          quiz: null,\r\n                          tugas: null,\r\n                          uts: null,\r\n                          uas: null,\r\n                          nilai_angka: null,\r\n                          nilai_huruf: null,\r\n                          nilai_indeks: null,\r\n                        } as GradeRecord);\r\n                        \r\n                        const studentKrsId = (student as any).id_krs ?? (student as any).krs_id ?? (student as any).krsId ?? (student as any).krs?.id ?? (student as any).krs?.KRS?.id;\r\n                        const gradeKey = grade.id && grade.id > 0\r\n                          ? `id:${grade.id}`\r\n                          : (grade.krs_id ? `krs:${typeof grade.krs_id === 'object' ? (grade.krs_id as any).Int32 : grade.krs_id}` : (studentKrsId ? `krs:${studentKrsId}` : `nim:${student.nim}`));\r\n                        const isCompleted = completedGradeKeys.has(gradeKey);\r\n                        const isEditing = isGradesEditing && !isCompleted;\r\n                        const isSaving = grade.id ? savingGradeIds.has(grade.id) : false;\r\n                        const edited = editedGrades[gradeKey] || grade;\r\n                        \r\n                        // Helper to get display value (properly handles SqlNull types)\r\n                        const getValue = (key: keyof GradeRecord): any => {\r\n                          const val = edited[key];\r\n                          if (val === null || val === undefined) return '';\r\n                          if (typeof val === 'object' && 'Float64' in val) return val.Valid ? val.Float64 : '';\r\n                          if (typeof val === 'object' && 'String' in val) return val.Valid ? val.String : '';\r\n                          if (typeof val === 'object' && 'Int32' in val) return val.Valid ? val.Int32 : '';\r\n                          return val;\r\n                        };\r\n\r\n                        // Calculate numeric grade if needed (differentiate between 0 and null)\r\n                        const nilaiAngkaValue = getValue('nilai_angka');\r\n                        const displayNumeric = nilaiAngkaValue !== '' ? nilaiAngkaValue : (isGradesEditing && edited ? calculateNumericGrade(edited, gradeComponents) : null);\r\n                        const { huruf: calcHuruf, indeks: calcIndeks } = displayNumeric !== null && displayNumeric !== '' ? calculateLetterGrade(displayNumeric) : { huruf: '', indeks: 0 };\r\n                        const nilaiHurufValue = getValue('nilai_huruf');\r\n                        const displayHuruf = nilaiHurufValue !== '' ? nilaiHurufValue : calcHuruf;\r\n                        const nilaiIndeksValue = getValue('nilai_indeks');\r\n                        const displayIndeks = nilaiIndeksValue !== '' ? nilaiIndeksValue : calcIndeks;\r\n\r\n                        return (\r\n                          <tr key={student.nim} className=\"hover:bg-gray-50\">\r\n                            <td className=\"border-r border-b border-gray-300 px-3 py-2 font-medium text-gray-900 w-28\">\r\n                              {student.nim}\r\n                            </td>\r\n                            <td className=\"border-r border-b border-gray-300 px-3 py-2 text-gray-900 w-48\">\r\n                              {student.nama}\r\n                            </td>\r\n                            {/* Participation */}\r\n                            <td className=\"border-r border-b border-gray-300 px-3 py-2 text-center w-24\">\r\n                              {isEditing ? (\r\n                                <input\r\n                                  type=\"number\"\r\n                                  step=\"0.1\"\r\n                                  value={getValue('aktivitas_partisipatif')}\r\n                                  onChange={(e) => updateGradeField(gradeKey, 'aktivitas_partisipatif', e.target.value ? parseFloat(e.target.value) : null)}\r\n                                  className=\"input-field text-xs w-full [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none\"\r\n                                />\r\n                              ) : (\r\n                                <span className=\"text-gray-600\">{(() => { const v = getValue('aktivitas_partisipatif'); return v !== '' ? v : '-'; })()}</span>\r\n                              )}\r\n                            </td>\r\n                            {/* Project */}\r\n                            <td className=\"border-r border-b border-gray-300 px-3 py-2 text-center w-24\">\r\n                              {isEditing ? (\r\n                                <input\r\n                                  type=\"number\"\r\n                                  step=\"0.1\"\r\n                                  value={getValue('hasil_proyek')}\r\n                                      onChange={(e) => updateGradeField(gradeKey, 'hasil_proyek', e.target.value ? parseFloat(e.target.value) : null)}\r\n                                  className=\"input-field text-xs w-full [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none\"\r\n                                />\r\n                              ) : (\r\n                                <span className=\"text-gray-600\">{(() => { const v = getValue('hasil_proyek'); return v !== '' ? v : '-'; })()}</span>\r\n                              )}\r\n                            </td>\r\n                            {/* Quiz */}\r\n                            <td className=\"border-r border-b border-gray-300 px-3 py-2 text-center w-24\">\r\n                              {isEditing ? (\r\n                                <input\r\n                                  type=\"number\"\r\n                                  step=\"0.1\"\r\n                                  value={getValue('quiz')}\r\n                                  onChange={(e) => updateGradeField(gradeKey, 'quiz', e.target.value ? parseFloat(e.target.value) : null)}\r\n                                  className=\"input-field text-xs w-full [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none\"\r\n                                />\r\n                              ) : (\r\n                                <span className=\"text-gray-600\">{(() => { const v = getValue('quiz'); return v !== '' ? v : '-'; })()}</span>\r\n                              )}\r\n                            </td>\r\n                            {/* Assignment */}\r\n                            <td className=\"border-r border-b border-gray-300 px-3 py-2 text-center w-24\">\r\n                              {isEditing ? (\r\n                                <input\r\n                                  type=\"number\"\r\n                                  step=\"0.1\"\r\n                                  value={getValue('tugas')}\r\n                                  onChange={(e) => updateGradeField(gradeKey, 'tugas', e.target.value ? parseFloat(e.target.value) : null)}\r\n                                  className=\"input-field text-xs w-full [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none\"\r\n                                />\r\n                              ) : (\r\n                                <span className=\"text-gray-600\">{(() => { const v = getValue('tugas'); return v !== '' ? v : '-'; })()}</span>\r\n                              )}\r\n                            </td>\r\n                            {/* Midterm */}\r\n                            <td className=\"border-r border-b border-gray-300 px-3 py-2 text-center w-24\">\r\n                              {isEditing ? (\r\n                                <input\r\n                                  type=\"number\"\r\n                                  step=\"0.1\"\r\n                                  value={getValue('uts')}\r\n                                  onChange={(e) => updateGradeField(gradeKey, 'uts', e.target.value ? parseFloat(e.target.value) : null)}\r\n                                  className=\"input-field text-xs w-full [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none\"\r\n                                />\r\n                              ) : (\r\n                                <span className=\"text-gray-600\">{(() => { const v = getValue('uts'); return v !== '' ? v : '-'; })()}</span>\r\n                              )}\r\n                            </td>\r\n                            {/* Final */}\r\n                            <td className=\"border-r border-b border-gray-300 px-3 py-2 text-center w-24\">\r\n                              {isEditing ? (\r\n                                <input\r\n                                  type=\"number\"\r\n                                  step=\"0.1\"\r\n                                  value={getValue('uas')}\r\n                                  onChange={(e) => updateGradeField(gradeKey, 'uas', e.target.value ? parseFloat(e.target.value) : null)}\r\n                                  className=\"input-field text-xs w-full [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none\"\r\n                                />\r\n                              ) : (\r\n                                <span className=\"text-gray-600\">{(() => { const v = getValue('uas'); return v !== '' ? v : '-'; })()}</span>\r\n                              )}\r\n                            </td>\r\n                            {/* Numeric (Auto-calculated) */}\r\n                            <td className=\"border-r border-b border-gray-300 px-3 py-2 text-center font-semibold text-gray-900 w-20\">\r\n                              <div className={`px-2 py-1 rounded ${isEditing ? 'bg-blue-50 text-blue-900' : ''}`}>\r\n                                <span>{displayNumeric !== null && displayNumeric !== '' ? displayNumeric : '-'}</span>\r\n                                {isEditing && displayNumeric !== null && displayNumeric !== '' && (\r\n                                  <span className=\"text-xs text-blue-600 ml-1\"></span>\r\n                                )}\r\n                              </div>\r\n                            </td>\r\n                            {/* Letter (Auto-calculated) */}\r\n                            <td className=\"border-r border-b border-gray-300 px-3 py-2 text-center font-bold text-blue-600 w-20\">\r\n                              <div className={`px-2 py-1 rounded ${isEditing ? 'bg-blue-50' : ''}`}>\r\n                                <span>{displayHuruf || '-'}</span>\r\n                                {isEditing && displayHuruf && (\r\n                                  <span className=\"text-xs ml-1\"></span>\r\n                                )}\r\n                              </div>\r\n                            </td>\r\n                            {/* Index (Auto-calculated) */}\r\n                            <td className={`border-b border-gray-300 px-3 py-2 text-center font-semibold text-gray-900 w-20 ${isGradesEditing ? 'border-r' : ''}`}>\r\n                              <div className={`px-2 py-1 rounded ${isEditing ? 'bg-blue-50 text-blue-900' : ''}`}>\r\n                                <span>{displayIndeks || '-'}</span>\r\n                                {isEditing && displayIndeks && (\r\n                                  <span className=\"text-xs text-blue-600 ml-1\"></span>\r\n                                )}\r\n                              </div>\r\n                            </td>\r\n                            {/* Action Column */}\r\n                            {isGradesEditing && (\r\n                              <td className=\"border-b border-gray-300 px-3 py-2 text-center\">\r\n                                {isCompleted ? (\r\n                                  <button\r\n                                    onClick={() => {\r\n                                      // Remove from completed set to allow editing again\r\n                                      setCompletedGradeKeys((prev) => {\r\n                                        const next = new Set(prev);\r\n                                        next.delete(gradeKey);\r\n                                        return next;\r\n                                      });\r\n                                      // Re-add to editedGrades\r\n                                      const currentGrade = findGradeForStudent(student);\r\n                                      if (currentGrade) {\r\n                                        setEditedGrades(prev => ({\r\n                                          ...prev,\r\n                                          [gradeKey]: currentGrade,\r\n                                        }));\r\n                                      }\r\n                                    }}\r\n                                    className=\"px-2 py-1 text-xs rounded bg-blue-600 text-white hover:bg-blue-700\"\r\n                                  >\r\n                                    Edit\r\n                                  </button>\r\n                                ) : (\r\n                                  <div className=\"flex gap-2 justify-center\">\r\n                                    <button\r\n                                      onClick={() => saveGrade(gradeKey, grade, student)}\r\n                                      disabled={isSaving}\r\n                                      className=\"px-2 py-1 text-xs rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50\"\r\n                                    >\r\n                                      {isSaving ? 'Saving...' : 'Save'}\r\n                                    </button>\r\n                                    <button\r\n                                      onClick={() => {\r\n                                        // Restore original grade data\r\n                                        const originalGrade = findGradeForStudent(student);\r\n                                        if (originalGrade) {\r\n                                          setEditedGrades(prev => ({\r\n                                            ...prev,\r\n                                            [gradeKey]: originalGrade,\r\n                                          }));\r\n                                        } else {\r\n                                          setEditedGrades(prev => {\r\n                                            const next = { ...prev };\r\n                                            delete next[gradeKey];\r\n                                            return next;\r\n                                          });\r\n                                        }\r\n                                        // Mark as completed so it shows Edit button\r\n                                        setCompletedGradeKeys((prev) => new Set([...prev, gradeKey]));\r\n                                      }}\r\n                                      disabled={isSaving}\r\n                                      className=\"px-2 py-1 text-xs rounded bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50\"\r\n                                    >\r\n                                      Cancel\r\n                                    </button>\r\n                                  </div>\r\n                                )}\r\n                              </td>\r\n                            )}\r\n                          </tr>\r\n                        );\r\n                      })}\r\n                      {/* Grade Weights Row */}\r\n                      <tr className=\"bg-blue-50 font-bold\">\r\n                        <td colSpan={2} className=\"border-r border-b border-gray-300 px-3 py-2 text-gray-900\">\r\n                          Component Weights\r\n                          {isGradesEditing && (\r\n                            <div className=\"text-xs font-normal text-gray-500 mt-1\">\r\n                              (Total must be 100%)\r\n                            </div>\r\n                          )}\r\n                        </td>\r\n                        <td className=\"border-r border-b border-gray-300 px-3 py-2 text-center text-blue-600 w-24\">\r\n                          {isGradesEditing ? (\r\n                            <input\r\n                              type=\"text\"\r\n                              value={gradeWeights.aktivitas_partisipatif}\r\n                              onChange={(e) => handleBobotChange('bobot_partisipatif', e.target.value)}\r\n                              className=\"w-full px-2 py-1 text-center border border-blue-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                            />\r\n                          ) : (\r\n                            `${gradeWeights.aktivitas_partisipatif}%`\r\n                          )}\r\n                        </td>\r\n                        <td className=\"border-r border-b border-gray-300 px-3 py-2 text-center text-blue-600 w-24\">\r\n                          {isGradesEditing ? (\r\n                            <input\r\n                              type=\"text\"\r\n                              value={gradeWeights.hasil_proyek}\r\n                              onChange={(e) => handleBobotChange('bobot_proyek', e.target.value)}\r\n                              className=\"w-full px-2 py-1 text-center border border-blue-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                            />\r\n                          ) : (\r\n                            `${gradeWeights.hasil_proyek}%`\r\n                          )}\r\n                        </td>\r\n                        <td className=\"border-r border-b border-gray-300 px-3 py-2 text-center text-blue-600 w-24\">\r\n                          {isGradesEditing ? (\r\n                            <input\r\n                              type=\"text\"\r\n                              value={gradeWeights.quiz}\r\n                              onChange={(e) => handleBobotChange('bobot_kuis', e.target.value)}\r\n                              className=\"w-full px-2 py-1 text-center border border-blue-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                            />\r\n                          ) : (\r\n                            `${gradeWeights.quiz}%`\r\n                          )}\r\n                        </td>\r\n                        <td className=\"border-r border-b border-gray-300 px-3 py-2 text-center text-blue-600 w-24\">\r\n                          {isGradesEditing ? (\r\n                            <input\r\n                              type=\"text\"\r\n                              value={gradeWeights.tugas}\r\n                              onChange={(e) => handleBobotChange('bobot_tugas', e.target.value)}\r\n                              className=\"w-full px-2 py-1 text-center border border-blue-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                            />\r\n                          ) : (\r\n                            `${gradeWeights.tugas}%`\r\n                          )}\r\n                        </td>\r\n                        <td className=\"border-r border-b border-gray-300 px-3 py-2 text-center text-blue-600 w-24\">\r\n                          {isGradesEditing ? (\r\n                            <input\r\n                              type=\"text\"\r\n                              value={gradeWeights.uts}\r\n                              onChange={(e) => handleBobotChange('bobot_uts', e.target.value)}\r\n                              className=\"w-full px-2 py-1 text-center border border-blue-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                            />\r\n                          ) : (\r\n                            `${gradeWeights.uts}%`\r\n                          )}\r\n                        </td>\r\n                        <td className=\"border-r border-b border-gray-300 px-3 py-2 text-center text-blue-600 w-24\">\r\n                          {isGradesEditing ? (\r\n                            <input\r\n                              type=\"text\"\r\n                              value={gradeWeights.uas}\r\n                              onChange={(e) => handleBobotChange('bobot_uas', e.target.value)}\r\n                              className=\"w-full px-2 py-1 text-center border border-blue-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                            />\r\n                          ) : (\r\n                            `${gradeWeights.uas}%`\r\n                          )}\r\n                        </td>\r\n                        <td colSpan={3} className=\"border-r border-b border-gray-300 px-3 py-2 text-center font-semibold text-gray-900\">\r\n                          <div className=\"text-blue-600\">\r\n                            Total: {(\r\n                              gradeWeights.aktivitas_partisipatif +\r\n                              gradeWeights.hasil_proyek +\r\n                              gradeWeights.quiz +\r\n                              gradeWeights.tugas +\r\n                              gradeWeights.uts +\r\n                              gradeWeights.uas\r\n                            ).toFixed(1)}%\r\n                          </div>\r\n                          {bobotError && (\r\n                            <div className=\"text-xs text-red-600 mt-1\">\r\n                              {bobotError}\r\n                            </div>\r\n                          )}\r\n                        </td>\r\n                        {/* Action Column for Bobot */}\r\n                        <td className={`border-b border-gray-300 px-3 py-2 text-center ${isGradesEditing ? '' : 'hidden'}`}>\r\n                          {isGradesEditing && (\r\n                            <>\r\n                              {isBobotCompleted ? (\r\n                                <button\r\n                                  onClick={() => {\r\n                                    setIsBobotCompleted(false);\r\n                                  }}\r\n                                  className=\"px-2 py-1 text-xs rounded bg-blue-600 text-white hover:bg-blue-700\"\r\n                                >\r\n                                  Edit\r\n                                </button>\r\n                              ) : (\r\n                                <div className=\"flex gap-2 justify-center\">\r\n                                  <button\r\n                                    onClick={() => saveBobots()}\r\n                                    disabled={isSavingBobots}\r\n                                    className=\"px-2 py-1 text-xs rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50\"\r\n                                  >\r\n                                    {isSavingBobots ? 'Saving...' : 'Save'}\r\n                                  </button>\r\n                                  <button\r\n                                    onClick={cancelBobots}\r\n                                    disabled={isSavingBobots}\r\n                                    className=\"px-2 py-1 text-xs rounded bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50\"\r\n                                  >\r\n                                    Cancel\r\n                                  </button>\r\n                                </div>\r\n                              )}\r\n                            </>\r\n                          )}\r\n                        </td>\r\n                      </tr>\r\n                    </tbody>\r\n                  </table>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </>\r\n        )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ClassSummary;\r\n"],"file":"assets/ClassSummary-CZ10owQN.js"}