import{u as l}from"./query-vendor-B--u1oZD.js";import{d as f,k as h}from"./index-CU8_O-g9.js";function g(n,e){const r=["courses",n?.kode_prodi??null,n?.semester??null,n?.include_classes??null];return l({queryKey:r,queryFn:()=>f.getCourses(n)})}const u="https://it-adb-backend-lh5hkzknhq-et.a.run.app";function T(n){try{const e=n.split(".")[1];if(!e)return null;const r=e.replace(/-/g,"+").replace(/_/g,"/"),s=decodeURIComponent(atob(r).split("").map(o=>"%"+("00"+o.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(s)}catch(e){return h.error("Failed to decode JWT:",e),null}}class k{baseUrl;accessToken=null;refreshToken=null;tokenOperationInProgress=!1;refreshPromise=null;refreshTimerId=null;onAuthError=null;constructor(e=u){this.baseUrl=e,this.loadTokensFromStorage()}setAuthErrorHandler(e){this.onAuthError=e}loadTokensFromStorage(){try{this.accessToken=localStorage.getItem("accessToken"),this.refreshToken=localStorage.getItem("refreshToken"),this.accessToken&&this.scheduleTokenRefresh()}catch(e){h.error("Error loading tokens from storage:",e),this.accessToken=null,this.refreshToken=null}}scheduleTokenRefresh(){if(this.refreshTimerId&&(clearTimeout(this.refreshTimerId),this.refreshTimerId=null),!this.accessToken||!this.refreshToken)return;const e=T(this.accessToken);if(!e||!e.exp)return;const r=Math.floor(Date.now()/1e3),s=e.exp-r,o=Math.max(0,s-120);this.refreshTimerId=setTimeout(async()=>{try{await this.refreshAccessToken()}catch(i){h.error("Proactive token refresh failed:",i)}},o*1e3)}setTokens(e,r){if(!this.tokenOperationInProgress)try{this.tokenOperationInProgress=!0,this.accessToken=e,localStorage.setItem("accessToken",e),r&&(this.refreshToken=r,localStorage.setItem("refreshToken",r)),this.scheduleTokenRefresh()}finally{this.tokenOperationInProgress=!1}}clearTokens(){if(!this.tokenOperationInProgress)try{this.tokenOperationInProgress=!0,this.refreshTimerId&&(clearTimeout(this.refreshTimerId),this.refreshTimerId=null),this.accessToken=null,this.refreshToken=null,this.refreshPromise=null,localStorage.removeItem("accessToken"),localStorage.removeItem("refreshToken")}finally{this.tokenOperationInProgress=!1}}hasTokens(){return!!this.accessToken}async request(e,r={},s=!1){const o=`${this.baseUrl}${e}`,i={"Content-Type":"application/json"};r.headers&&Object.entries(r.headers).forEach(([t,a])=>{typeof a=="string"&&(i[t]=a)}),this.accessToken&&(i.Token=this.accessToken);try{const t=await fetch(o,{...r,headers:i});if(t.status===401&&this.refreshToken&&!s&&!e.includes("/auth/refresh"))try{return this.refreshPromise||(this.refreshPromise=this.refreshAccessToken().finally(()=>{this.refreshPromise=null})),await this.refreshPromise,this.request(e,r,!0)}catch(a){throw h.error("Token refresh failed:",a),this.clearTokens(),this.onAuthError&&this.onAuthError(),new Error("Session expired. Please login again.")}if(!t.ok){const c=`${(await t.json().catch(()=>({error:`HTTP ${t.status}: ${t.statusText}`}))).error||t.statusText} (HTTP ${t.status})`;throw new Error(c)}return t.json()}catch(t){throw h.error("API request failed:",t),t}}async refreshAccessToken(){if(!this.refreshToken)throw new Error("No refresh token available");const e=`${this.baseUrl}/auth/refresh`,r={"Content-Type":"application/json"};try{const s=await fetch(e,{method:"POST",headers:r,body:JSON.stringify({refresh_token:this.refreshToken})});if(!s.ok){const i=await s.json().catch(()=>({error:`HTTP ${s.status}: ${s.statusText}`}));throw new Error(i.error||"Token refresh failed")}const o=await s.json();return this.setTokens(o.access_token,o.refresh_token),h.log("Access token refreshed successfully"),o.access_token}catch(s){throw h.error("Failed to refresh access token:",s),s}}get(e){return this.request(e,{method:"GET"})}post(e,r){return this.request(e,{method:"POST",body:r?JSON.stringify(r):void 0})}put(e,r){return this.request(e,{method:"PUT",body:r?JSON.stringify(r):void 0})}delete(e){return this.request(e,{method:"DELETE"})}}new k;export{g as u};
//# sourceMappingURL=client-CAckhWQ1.js.map
