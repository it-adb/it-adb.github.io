import{d as re,j as t}from"./query-vendor-B--u1oZD.js";import{g as o}from"./react-vendor-XXJdR_Id.js";import{c as b,b as le}from"./index-DzRMt0hm.js";import{g as T}from"./status-sB_rSvKV.js";import{a as de,f as oe,u as ce,b as me,d as ue,e as xe,c as ge}from"./useLecturerAssignments-lytpHA33.js";import{g as W,i as pe,W as he}from"./ui-vendor-C-UqR_Df.js";const Ne=({selectedMeeting:i,onClose:K})=>{const{data:I,isLoading:X}=de(i?.classId),{data:E,isLoading:Y}=oe(i?.meetingId),{data:j,refetch:G}=ce(i?.classId),w=o.useMemo(()=>I??[],[I]),P=o.useMemo(()=>E??[],[E]),{data:L=[]}=me({id_kelas:i?.classId?String(i.classId):void 0}),$=o.useMemo(()=>{const e=new Set;return L.forEach(s=>{const a=b(s.id_dosen);a&&e.add(a)}),Array.from(e)},[L]),M=re({queries:$.map(e=>({queryKey:["lecturer",e],queryFn:()=>le.getLecturerByID(e),enabled:!!e}))}),_=o.useMemo(()=>{const e={};return M.forEach(s=>{const a=s.data;a?.id&&a?.nama_dosen&&(e[a.id]=a.nama_dosen)}),e},[M]),c=o.useMemo(()=>{if(!i||!j||j.length===0)return null;const e=j.find(d=>d.id===i.meetingId);if(!e)return null;let s="",a="",l="",n="";if(typeof e.tgl_pertemuan=="string")s=e.tgl_pertemuan;else if(e.tgl_pertemuan&&typeof e.tgl_pertemuan=="object"){const d=e.tgl_pertemuan;d.Time?s=d.Time:d.String?s=d.String:s=b(d,"")}if(typeof e.jam_pertemuan=="string")a=e.jam_pertemuan;else if(e.jam_pertemuan&&typeof e.jam_pertemuan=="object"){const d=e.jam_pertemuan;d.String?a=d.String:a=b(d,"")}if(e.topik){if(typeof e.topik=="string")l=e.topik;else if(typeof e.topik=="object"){const d=e.topik;d.String?l=d.String:l=b(d,"")}}if(e.id_dosen){if(typeof e.id_dosen=="string")n=e.id_dosen;else if(typeof e.id_dosen=="object"){const d=e.id_dosen;d.String?n=d.String:n=b(d,"")}}console.log("ðŸ“… Meeting data from API:",{tglPertemuan:s,jamPertemuan:a,topik:l,idDosen:n,rawData:e.tgl_pertemuan});let r;if(s&&a){const d=s.includes("T")?s.split("T")[0]:s.split(" ")[0]||s,ie=a.length===5?`${a}:00`:a.split(".")[0]||a,Q=`${d}T${ie}`;r=new Date(Q),console.log("ðŸ“… Parsed meeting datetime:",Q,"â†’",r)}else console.warn("âš ï¸ Missing date or time:",{tglPertemuan:s,jamPertemuan:a});return{meetingDateTime:r,topic:l,lecturerId:n}},[i,j]),x=ue(),g=xe(),v=ge(),[u,m]=o.useState({}),[J,N]=o.useState(!1),[D,B]=o.useState(!1),[S,k]=o.useState(!1),[y,H]=o.useState(""),[h,F]=o.useState(""),[A,U]=o.useState(""),[C,z]=o.useState(""),f=o.useMemo(()=>{if(!w||w.length===0)return[];const e=new Map(P.map(s=>[s.nim,{status:b(s.status_kehadiran,""),id:s.id}]));return w.map(s=>{const a=e.get(s.nim);return{...s,status:a?.status||"Belum Absen",attendanceId:a?.id}})},[w,P]),V=o.useMemo(()=>{const e=c?.meetingDateTime||i?.meetingDateTime;if(!e)return!1;const s=new Date,a=new Date(e),l=new Date(a.getTime()-300*1e3);return s>=l},[c?.meetingDateTime,i?.meetingDateTime]),R=async(e,s,a)=>{if(!i)return;const l=new Date().toISOString();try{a?await g.mutateAsync({id:a,data:{status_kehadiran:s,waktu_masuk:l}}):await x.mutateAsync({id_pertemuan:i.meetingId,nim:e,status_kehadiran:s,waktu_masuk:l})}catch(n){console.error("Failed to update attendance:",n),alert(`Failed to update attendance: ${n instanceof Error?n.message:"Unknown error"}`)}},Z=async()=>{if(!i||Object.keys(u).length===0)return;B(!0);const e=[],s=new Date().toISOString();for(const a of Object.keys(u)){const l=u[a],n=f.find(r=>r.nim===a);if(n)try{n.attendanceId?await g.mutateAsync({id:n.attendanceId,data:{status_kehadiran:l,waktu_masuk:s}}):await x.mutateAsync({id_pertemuan:i.meetingId,nim:a,status_kehadiran:l,waktu_masuk:s})}catch(r){console.error(`Failed to update attendance for ${a}:`,r),e.push(`${n.nama} (${a})`)}}B(!1),e.length>0?alert(`Failed to update attendance for: ${e.join(", ")}`):(m({}),N(!1))},ee=()=>{const e={};f.forEach(s=>{e[s.nim]=s.status==="Belum Absen"?"Hadir":s.status||"Hadir"}),m(e),N(!0)},te=()=>{m({}),N(!1)},se=async()=>{if(!(!i||!y||!h))try{const e=h.length===5?`${h}:00`:h;console.log("ðŸ’¾ Saving meeting update:",{id:i.meetingId,tgl_pertemuan:y,jam_pertemuan:e,topik:A||void 0,id_dosen:C||void 0}),await v.mutateAsync({id:i.meetingId,data:{tgl_pertemuan:y,jam_pertemuan:e,topik:A||void 0,id_dosen:C||void 0}}),console.log("âœ… Meeting saved, refetching data..."),await G(),console.log("âœ… Data refetched"),k(!1),alert("Meeting schedule updated successfully!")}catch(e){console.error("Failed to update meeting:",e),alert(`Failed to update meeting: ${e instanceof Error?e.message:"Unknown error"}`)}};o.useEffect(()=>{const e=c?.meetingDateTime||i?.meetingDateTime,s=c?.topic||i?.topic||"",a=c?.lecturerId||"";if(e){const l=new Date(e),n=l.toISOString().split("T")[0],r=`${String(l.getHours()).padStart(2,"0")}:${String(l.getMinutes()).padStart(2,"0")}`;H(n),F(r),U(s),z(a)}},[c?.meetingDateTime,c?.topic,c?.lecturerId,i?.meetingDateTime,i?.topic]);const ae=()=>{k(!0)},ne=()=>{m({}),N(!1),k(!1),K()},p=c?.meetingDateTime||i?.meetingDateTime,q=o.useMemo(()=>p?new Date(p).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric"}):i?.dateLabel,[p,i?.dateLabel]),O=c?.topic||i?.topic;return i?t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-2 sm:p-4 bg-black/30",children:t.jsxs("div",{className:"w-full h-full max-h-screen sm:max-h-[90vh] max-w-sm sm:max-w-2xl lg:max-w-4xl bg-white rounded-lg shadow-lg flex flex-col",children:[t.jsxs("div",{className:"px-3 sm:px-4 py-3 border-b border-gray-200 flex items-center justify-between flex-shrink-0",children:[t.jsxs("div",{className:"flex-1 min-w-0 pr-2",children:[t.jsx("div",{className:"text-xs sm:text-sm text-gray-500 truncate",children:i.subtitle}),t.jsx("h3",{className:"text-sm sm:text-base font-semibold text-gray-900 line-clamp-2",children:i.title}),q&&t.jsx("div",{className:"text-xs text-gray-500 mt-0.5",children:q}),p&&t.jsxs("div",{className:"text-xs text-gray-600 mt-0.5 font-medium",children:[t.jsx(W,{className:"inline h-3 w-3 mr-1"}),new Date(p).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1})]}),O&&!S&&t.jsxs("div",{className:"text-xs text-gray-600 mt-1 italic",children:["Topic: ",O]}),c?.lecturerId&&_[c.lecturerId]&&!S&&t.jsxs("div",{className:"text-xs text-gray-600 mt-0.5 flex items-center",children:[t.jsx(pe,{className:"inline h-3 w-3 mr-1"}),_[c.lecturerId]]})]}),t.jsxs("div",{className:"flex items-center gap-1 sm:gap-2 flex-shrink-0",children:[!S&&t.jsxs("button",{onClick:ae,className:"px-2 py-1 text-xs font-medium rounded bg-blue-600 text-white hover:bg-blue-700 cursor-pointer flex items-center gap-1 whitespace-nowrap",title:"Edit meeting schedule",children:[t.jsx(he,{className:"h-3 w-3"}),t.jsx("span",{className:"hidden sm:inline",children:"Edit Schedule"}),t.jsx("span",{className:"sm:hidden",children:"Edit"})]}),t.jsx("button",{onClick:ne,className:"px-2 py-1 text-sm rounded hover:bg-gray-100 cursor-pointer","aria-label":"Close",children:"Close"})]})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-3 sm:p-4",children:[S&&t.jsxs("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[t.jsx("h4",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Edit Meeting Schedule"}),t.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Date"}),t.jsx("input",{type:"date",value:y,onChange:e=>H(e.target.value),className:"input-field w-full text-sm"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Time"}),t.jsx("input",{type:"time",value:h,onChange:e=>F(e.target.value),className:"input-field w-full text-sm"})]})]}),t.jsxs("div",{className:"mb-3",children:[t.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Topic/Description (Optional)"}),t.jsx("textarea",{value:A,onChange:e=>U(e.target.value),className:"input-field w-full text-sm",rows:3,placeholder:"Enter meeting topic or description...",maxLength:500}),t.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[A.length,"/500 characters"]})]}),t.jsxs("div",{className:"mb-3",children:[t.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Lecturer (Optional)"}),t.jsxs("select",{value:C,onChange:e=>z(e.target.value),className:"input-field w-full text-sm",children:[t.jsx("option",{value:"",children:"- No Lecturer -"}),$.map(e=>t.jsx("option",{value:e,children:_[e]||e},e))]})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{onClick:se,disabled:v.isPending||!y||!h,className:"px-3 py-1.5 text-sm font-medium rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer",children:v.isPending?"Saving...":"Save Changes"}),t.jsx("button",{onClick:()=>k(!1),disabled:v.isPending,className:"px-3 py-1.5 text-sm font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50 cursor-pointer",children:"Cancel"})]})]}),V?X||Y?t.jsx("div",{className:"text-center text-gray-500 py-6",children:"Loading students and attendances..."}):f.length===0?t.jsx("div",{className:"text-center text-gray-500 py-6",children:"No students found for this class."}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"mb-3 sm:mb-4 flex gap-1 sm:gap-2 justify-end flex-wrap",children:J?t.jsxs(t.Fragment,{children:[t.jsx("button",{onClick:Z,disabled:D||Object.keys(u).length===0,className:"px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm font-medium rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer whitespace-nowrap",children:D?"Saving...":`Save (${Object.keys(u).length})`}),t.jsx("button",{onClick:te,disabled:D,className:"px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50 cursor-pointer whitespace-nowrap",children:"Cancel"})]}):t.jsx("button",{onClick:ee,className:"px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm font-medium rounded bg-primary-600 text-white hover:bg-primary-700 cursor-pointer whitespace-nowrap",children:"Edit All"})}),t.jsxs("div",{className:"space-y-2 sm:overflow-x-auto sm:border sm:border-gray-200 sm:rounded-lg",children:[t.jsx("div",{className:"sm:hidden space-y-2",children:f.map(e=>{const s=e.status,a=u[e.nim]!==void 0,l=a?u[e.nim]:s;return t.jsxs("div",{className:"border border-gray-200 rounded-lg p-2 bg-white",children:[t.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("p",{className:"text-xs font-semibold text-gray-900 break-words",children:e.nama}),t.jsx("p",{className:"text-xs text-gray-500 font-mono",children:e.nim})]}),!a&&t.jsx("span",{className:`flex-shrink-0 px-2 py-0.5 rounded text-xs font-medium inline-block ${s==="Hadir"?"bg-green-100 text-green-700":s==="Izin"||s==="Sakit"?"bg-yellow-100 text-yellow-700":s==="Terlambat"?"bg-blue-100 text-blue-700":s==="Pengganti"?"bg-purple-100 text-purple-700":s==="Belum Absen"?"bg-gray-100 text-gray-700":"bg-red-100 text-red-700"}`,children:T(s)||"Belum Absen"})]}),a?t.jsxs("div",{className:"space-y-2",children:[t.jsx("div",{className:"grid grid-cols-3 gap-0.5",children:["Hadir","Izin","Sakit","Alfa","Terlambat","Pengganti"].map(n=>t.jsx("button",{onClick:()=>m(r=>({...r,[e.nim]:n})),className:`px-1.5 py-1 text-xs font-medium rounded transition-colors cursor-pointer ${l===n?"bg-primary-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:T(n)},n))}),t.jsxs("div",{className:"flex gap-1",children:[t.jsx("button",{onClick:async()=>{await R(e.nim,l,e.attendanceId),m(n=>{const r={...n};return delete r[e.nim],r})},disabled:x.isPending||g.isPending,className:"flex-1 px-2 py-1 text-xs font-medium rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 cursor-pointer",children:x.isPending||g.isPending?"Saving...":"Save"}),t.jsx("button",{onClick:()=>m(n=>{const r={...n};return delete r[e.nim],r}),disabled:x.isPending||g.isPending,className:"px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50 cursor-pointer",children:"X"})]})]}):t.jsx("button",{onClick:()=>m(n=>({...n,[e.nim]:s==="Belum Absen"?"Hadir":s||"Hadir"})),className:"w-full px-2 py-1 text-xs font-medium rounded bg-primary-600 text-white hover:bg-primary-700 cursor-pointer",children:"Edit"})]},e.nim)})}),t.jsxs("table",{className:"hidden sm:table w-full text-xs sm:text-sm",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"bg-gray-50 border-b border-gray-200",children:[t.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-semibold text-gray-700 whitespace-nowrap",children:"NIM"}),t.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-semibold text-gray-700",children:"Name"}),t.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Status"}),t.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Action"})]})}),t.jsx("tbody",{children:f.map(e=>{const s=e.status,a=u[e.nim]!==void 0,l=a?u[e.nim]:s;return t.jsxs("tr",{className:"border-b border-gray-100 hover:bg-gray-50",children:[t.jsx("td",{className:"px-2 sm:px-3 py-2 font-mono text-gray-900 whitespace-nowrap text-xs",children:e.nim}),t.jsx("td",{className:"px-2 sm:px-3 py-2 text-gray-900",children:e.nama}),t.jsx("td",{className:"px-2 sm:px-3 py-2",children:a?t.jsx("div",{className:"flex gap-1 flex-wrap",children:["Hadir","Izin","Sakit","Alfa","Terlambat","Pengganti"].map(n=>t.jsx("button",{onClick:()=>m(r=>({...r,[e.nim]:n})),className:`px-2 py-0.5 text-xs font-medium rounded transition-colors cursor-pointer ${l===n?"bg-primary-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:T(n)},n))}):t.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-medium inline-block ${s==="Hadir"?"bg-green-100 text-green-700":s==="Izin"||s==="Sakit"?"bg-yellow-100 text-yellow-700":s==="Terlambat"?"bg-blue-100 text-blue-700":s==="Pengganti"?"bg-purple-100 text-purple-700":s==="Belum Absen"?"bg-gray-100 text-gray-700":"bg-red-100 text-red-700"}`,children:T(s)||"Belum Absen"})}),t.jsx("td",{className:"px-2 sm:px-3 py-2 whitespace-nowrap",children:a?t.jsxs("div",{className:"flex gap-1",children:[t.jsx("button",{onClick:async()=>{await R(e.nim,l,e.attendanceId),m(n=>{const r={...n};return delete r[e.nim],r})},disabled:x.isPending||g.isPending,className:"px-2 py-1 text-xs font-medium rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 cursor-pointer",children:x.isPending||g.isPending?"Saving...":"Save"}),t.jsx("button",{onClick:()=>m(n=>{const r={...n};return delete r[e.nim],r}),disabled:x.isPending||g.isPending,className:"px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50 cursor-pointer",children:"Cancel"})]}):t.jsx("button",{onClick:()=>m(n=>({...n,[e.nim]:s==="Belum Absen"?"Hadir":s||"Hadir"})),className:"px-2 py-1 text-xs font-medium rounded bg-primary-600 text-white hover:bg-primary-700 cursor-pointer",children:"Edit"})})]},e.nim)})})]})]})]}):t.jsxs("div",{className:"text-center py-8",children:[t.jsx(W,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),t.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Attendance Not Available Yet"}),t.jsx("p",{className:"text-gray-600",children:"Attendance editing will be available 5 minutes before the class starts."}),p&&t.jsxs("p",{className:"text-sm text-gray-500 mt-2",children:["Class starts at: ",new Date(p).toLocaleString("en-US",{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})]})]})]})]})}):null};export{Ne as A};
//# sourceMappingURL=AttendanceModal-FZ3mXfN7.js.map
