import{j as e,u as le,b as ne,c as oe}from"./query-vendor-B--u1oZD.js";import{u as Te,r as o,g as de}from"./react-vendor-XXJdR_Id.js";import{a4 as Ce,e as Z,k as Ae,a as Se,C as Ee,M as Me,a5 as Ie,B as me,a1 as Re,J as se,X as xe,a3 as re,P as ee,Y as Pe,z as Ue,_ as Fe}from"./ui-vendor-Bvty7Z9l.js";import{c as _,b as I,h as E,g as ae,u as Le}from"./index-BFadXLuC.js";import{u as qe}from"./useCourses-bNuKZiCW.js";import{u as $e}from"./useLecturerAssignments-DTgRc4eP.js";const Oe=({title:t,subtitle:a,showBack:r=!1,backUrl:l,actions:i,breadcrumbs:h,icon:c})=>{const d=Te(),p=()=>{d(l||-1)};return e.jsxs("div",{className:"mb-6",children:[h&&h.length>0&&e.jsx("nav",{className:"flex mb-2","aria-label":"Breadcrumb",children:e.jsx("ol",{className:"flex items-center space-x-2 text-sm text-gray-500",children:h.map((x,b)=>e.jsxs("li",{className:"flex items-center",children:[b>0&&e.jsx("span",{className:"mx-2",children:"/"}),x.href?e.jsx("a",{href:x.href,className:"hover:text-primary-600 transition-colors",children:x.label}):e.jsx("span",{className:"text-gray-700",children:x.label})]},b))})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[r&&e.jsx("button",{onClick:p,className:"p-2 rounded-lg hover:bg-gray-100 transition-colors","aria-label":"Go back",children:e.jsx(Ce,{className:"h-5 w-5 text-gray-600"})}),c&&e.jsx("div",{className:"p-2 bg-primary-50 rounded-lg text-primary-600",children:c}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:t}),a&&e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:a})]})]}),i&&e.jsx("div",{className:"flex items-center gap-3",children:i})]})]})},De=({stats:t})=>{const a=[{icon:Z,label:"Total Pengguna",value:t.total,color:"text-blue-600",bgColor:"bg-blue-50"},{icon:Z,label:"Mahasiswa",value:t.students,color:"text-green-600",bgColor:"bg-green-50"},{icon:Z,label:"Dosen",value:t.lecturers,color:"text-purple-600",bgColor:"bg-purple-50"},{icon:Ae,label:"Admin",value:t.admins,color:"text-red-600",bgColor:"bg-red-50"}];return e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6",children:a.map(r=>e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:r.label}),e.jsx("p",{className:"text-2xl font-semibold text-gray-900",children:r.value})]}),e.jsx("div",{className:`p-3 rounded-lg ${r.bgColor}`,children:e.jsx(r.icon,{className:`w-6 h-6 ${r.color}`})})]})},r.label))})},ce={email:"",name:"",password:"",roles:[]},Ke=t=>{switch(t){case"admin":return"bg-red-100 text-red-800";case"lecturer":return"bg-blue-100 text-blue-800";case"student":return"bg-green-100 text-green-800";case"staff":return"bg-purple-100 text-purple-800";case"student_applicant":return"bg-yellow-100 text-yellow-800";case"alumni":return"bg-gray-100 text-gray-800";default:return"bg-gray-100 text-gray-800"}},he=t=>({admin:"Admin",lecturer:"Dosen",student:"Mahasiswa",staff:"Staff",student_applicant:"Pendaftar",alumni:"Alumni",guest:"Guest"})[t]||t,K=_,Ge=[{value:"admin",label:"Admin"},{value:"staff",label:"Staff"},{value:"lecturer",label:"Dosen"},{value:"student",label:"Mahasiswa"},{value:"alumni",label:"Alumni"},{value:"student_applicant",label:"Pendaftar"}],ze=({users:t,loading:a,currentPage:r,totalUsers:l,itemsPerPage:i,onPageChange:h,onEditUser:c,onDeleteUser:d,onManageAssignments:p})=>{const x=Math.ceil(l/i);return e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Pengguna"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Role"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Entitas"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Kontak"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Aksi"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:a?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex items-center justify-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),e.jsx("span",{className:"ml-2 text-gray-500",children:"Memuat data..."})]})})}):t.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-6 py-12 text-center text-gray-500",children:"Tidak ada pengguna ditemukan"})}):t.map(b=>e.jsx(Be,{user:b,onEdit:c,onDelete:d,onManageAssignments:p},b.id))})]})}),x>1&&e.jsxs("div",{className:"px-6 py-4 border-t border-gray-200 flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-gray-500",children:["Menampilkan ",(r-1)*i+1," -"," ",Math.min(r*i,l)," dari ",l," pengguna"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>h(r-1),disabled:r===1,className:"p-2 rounded-lg border border-gray-300 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx(Se,{className:"w-4 h-4"})}),e.jsxs("span",{className:"text-sm text-gray-700",children:["Halaman ",r," dari ",x]}),e.jsx("button",{onClick:()=>h(r+1),disabled:r===x,className:"p-2 rounded-lg border border-gray-300 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx(Ee,{className:"w-4 h-4"})})]})]})]})},Be=({user:t,onEdit:a,onDelete:r,onManageAssignments:l})=>{const i=K(t.name)||t.email.split("@")[0],h=t.roles||[],d=t.studentInfo?{email:K(t.studentInfo.email),phone:K(t.studentInfo.no_hp)}:t.lecturerInfo?{email:K(t.lecturerInfo.email),phone:K(t.lecturerInfo.no_hp)}:{email:t.email,phone:""},x=(()=>{const b=[];return t.studentInfo&&b.push(`NIM: ${t.studentInfo.nim}`),t.lecturerInfo&&b.push(`NIDN: ${K(t.lecturerInfo.nuptk)||t.lecturerInfo.id}`),b})();return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"h-10 w-10 flex-shrink-0",children:e.jsx("div",{className:"h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center",children:e.jsx("span",{className:"text-blue-600 font-medium text-sm",children:i.charAt(0).toUpperCase()})})}),e.jsxs("div",{className:"ml-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:i}),e.jsx("div",{className:"text-sm text-gray-500",children:t.email})]})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-wrap gap-1",children:[h.map((b,v)=>e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${Ke(b.role)}`,children:he(b.role)},v)),h.length===0&&e.jsx("span",{className:"text-gray-400 text-sm",children:"-"})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("div",{className:"text-sm text-gray-900",children:x.length>0?x.map((b,v)=>e.jsx("div",{children:b},v)):e.jsx("span",{className:"text-gray-400",children:"-"})})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"text-sm text-gray-500 space-y-1",children:[d.email&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Me,{className:"w-3 h-3"}),e.jsx("span",{className:"truncate max-w-[150px]",children:d.email})]}),d.phone&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ie,{className:"w-3 h-3"}),d.phone]})]})}),e.jsx("td",{className:"px-6 py-4 text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[t.roles?.some(b=>b.role==="student"||b.role==="lecturer")&&e.jsx("button",{onClick:()=>l(t),className:"p-2 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors",title:"Manage Assignments",children:e.jsx(me,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>a(t),className:"p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors",title:"Edit",children:e.jsx(Re,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>r(t),className:"p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors",title:"Hapus",children:e.jsx(se,{className:"w-4 h-4"})})]})})]})},ue=({isOpen:t,isEdit:a,formData:r,formError:l,actionLoading:i,students:h,lecturers:c,onClose:d,onSubmit:p,onFormChange:x,onAddRole:b,onRemoveRole:v,onUpdateRoleEntity:N})=>{if(!t)return null;const T=a?"Edit Pengguna":"Tambah Pengguna",y=a?"Simpan Perubahan":"Tambah Pengguna";return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/50 z-40",onClick:d}),e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-50 p-4 pointer-events-none",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto pointer-events-auto",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-200",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:T}),e.jsx("button",{onClick:d,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(xe,{className:"w-5 h-5"})})]}),e.jsxs("form",{onSubmit:p,children:[e.jsxs("div",{className:"px-6 py-4 space-y-4",children:[l&&e.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm",children:l}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Email ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"email",value:r.email,onChange:n=>x({email:n.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"email@example.com",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nama"}),e.jsx("input",{type:"text",value:r.name,onChange:n=>x({name:n.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Nama lengkap"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Password ",!a&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"password",value:r.password,onChange:n=>x({password:n.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:a?"Kosongkan jika tidak ingin mengubah":"Masukkan password",required:!a})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Role"}),e.jsx("div",{className:"space-y-2 mb-3",children:r.roles.map((n,j)=>e.jsx(He,{role:n.role,entityId:n.entity_id,students:h,lecturers:c,onUpdateEntity:(R,u)=>N(j,R,u),onRemove:()=>v(j)},j))}),e.jsxs("select",{onChange:n=>{n.target.value&&(b(n.target.value),n.target.value="")},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",defaultValue:"",children:[e.jsx("option",{value:"",children:"+ Tambah Role"}),Ge.filter(n=>!r.roles.some(j=>j.role===n.value)).map(n=>e.jsx("option",{value:n.value,children:n.label},n.value))]})]})]}),e.jsxs("div",{className:"px-6 py-4 border-t border-gray-200 flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:d,className:"px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors",disabled:i,children:"Batal"}),e.jsxs("button",{type:"submit",className:"px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 flex items-center gap-2",disabled:i,children:[i&&e.jsx(re,{className:"w-4 h-4 animate-spin"}),y]})]})]})]})})]})},He=({role:t,entityId:a,students:r,lecturers:l,onUpdateEntity:i,onRemove:h})=>{const c=t==="student"||t==="alumni",d=t==="lecturer";return e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 min-w-[80px]",children:he(t)}),c&&e.jsxs("select",{value:a||"",onChange:p=>i("mahasiswa",p.target.value),className:"flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Pilih Mahasiswa"}),r.map(p=>e.jsxs("option",{value:p.nim,children:[p.nim," - ",p.nama||"(No Name)"]},p.nim))]}),d&&e.jsxs("select",{value:a||"",onChange:p=>i("dosen",p.target.value),className:"flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Pilih Dosen"}),l.map(p=>e.jsxs("option",{value:p.id,children:[p.id," - ",p.nama_dosen||"(No Name)"]},p.id))]}),!c&&!d&&e.jsx("span",{className:"flex-1 text-sm text-gray-500",children:"Tidak memerlukan entitas"}),e.jsx("button",{type:"button",onClick:h,className:"p-1 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors",children:e.jsx(se,{className:"w-4 h-4"})})]})};function Je(t,a){const r=["users",t.q??null,t.limit??null,t.offset??null];return le({queryKey:r,queryFn:()=>I.getUsers(t),...a??{}})}const ie=["users"];function Qe(t,a){return le({queryKey:["students",null],queryFn:()=>I.getStudents(t)})}function Ve(t,a){return le({queryKey:["lecturers",null],queryFn:()=>I.getLecturers(t)})}function We(t){const a=ne();return oe({mutationFn:r=>I.createUser(r),onSuccess:(...r)=>{a.invalidateQueries({queryKey:ie})},...t})}function Xe(t){const a=ne();return oe({mutationFn:({id:r,data:l})=>I.updateUser(r,l),onSuccess:(...r)=>{a.invalidateQueries({queryKey:ie})},...t})}function Ye(t){const a=ne();return oe({mutationFn:({id:r})=>I.deleteUser(r),onSuccess:(...r)=>{a.invalidateQueries({queryKey:ie})},...t})}const Ze="https://it-adb-backend-lh5hkzknhq-et.a.run.app";function es(t){try{const a=t.split(".")[1];if(!a)return null;const r=a.replace(/-/g,"+").replace(/_/g,"/"),l=decodeURIComponent(atob(r).split("").map(i=>"%"+("00"+i.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(l)}catch(a){return E.error("Failed to decode JWT:",a),null}}class ss{baseUrl;accessToken=null;refreshToken=null;tokenOperationInProgress=!1;refreshPromise=null;refreshTimerId=null;onAuthError=null;constructor(a=Ze){this.baseUrl=a,this.loadTokensFromStorage()}setAuthErrorHandler(a){this.onAuthError=a}loadTokensFromStorage(){try{this.accessToken=localStorage.getItem("accessToken"),this.refreshToken=localStorage.getItem("refreshToken"),this.accessToken&&this.scheduleTokenRefresh()}catch(a){E.error("Error loading tokens from storage:",a),this.accessToken=null,this.refreshToken=null}}scheduleTokenRefresh(){if(this.refreshTimerId&&(clearTimeout(this.refreshTimerId),this.refreshTimerId=null),!this.accessToken||!this.refreshToken)return;const a=es(this.accessToken);if(!a||!a.exp)return;const r=Math.floor(Date.now()/1e3),l=a.exp-r,i=Math.max(0,l-120);E.log(`Token expires in ${l}s, scheduling refresh in ${i}s`),this.refreshTimerId=setTimeout(async()=>{try{E.log("Proactively refreshing access token..."),await this.refreshAccessToken()}catch(h){E.error("Proactive token refresh failed:",h)}},i*1e3)}setTokens(a,r){if(this.tokenOperationInProgress){E.warn("Token operation already in progress");return}try{this.tokenOperationInProgress=!0,this.accessToken=a,localStorage.setItem("accessToken",a),r&&(this.refreshToken=r,localStorage.setItem("refreshToken",r)),this.scheduleTokenRefresh()}finally{this.tokenOperationInProgress=!1}}clearTokens(){if(this.tokenOperationInProgress){E.warn("Token operation already in progress");return}try{this.tokenOperationInProgress=!0,this.refreshTimerId&&(clearTimeout(this.refreshTimerId),this.refreshTimerId=null),this.accessToken=null,this.refreshToken=null,this.refreshPromise=null,localStorage.removeItem("accessToken"),localStorage.removeItem("refreshToken")}finally{this.tokenOperationInProgress=!1}}hasTokens(){return!!this.accessToken}async request(a,r={},l=!1){const i=`${this.baseUrl}${a}`,h={"Content-Type":"application/json"};r.headers&&Object.entries(r.headers).forEach(([c,d])=>{typeof d=="string"&&(h[c]=d)}),this.accessToken&&(h.Token=this.accessToken);try{const c=await fetch(i,{...r,headers:h});if(c.status===401&&this.refreshToken&&!l&&!a.includes("/auth/refresh")){E.log("Access token expired, attempting to refresh...");try{return this.refreshPromise||(this.refreshPromise=this.refreshAccessToken().finally(()=>{this.refreshPromise=null})),await this.refreshPromise,this.request(a,r,!0)}catch(d){throw E.error("Token refresh failed:",d),this.clearTokens(),this.onAuthError&&this.onAuthError(),new Error("Session expired. Please login again.")}}if(!c.ok){const p=`${(await c.json().catch(()=>({error:`HTTP ${c.status}: ${c.statusText}`}))).error||c.statusText} (HTTP ${c.status})`;throw new Error(p)}return c.json()}catch(c){throw E.error("API request failed:",c),c}}async refreshAccessToken(){if(!this.refreshToken)throw new Error("No refresh token available");const a=`${this.baseUrl}/auth/refresh`,r={"Content-Type":"application/json"};try{const l=await fetch(a,{method:"POST",headers:r,body:JSON.stringify({refresh_token:this.refreshToken})});if(!l.ok){const h=await l.json().catch(()=>({error:`HTTP ${l.status}: ${l.statusText}`}));throw new Error(h.error||"Token refresh failed")}const i=await l.json();return this.setTokens(i.access_token,i.refresh_token),E.log("Access token refreshed successfully"),i.access_token}catch(l){throw E.error("Failed to refresh access token:",l),l}}get(a){return this.request(a,{method:"GET"})}post(a,r){return this.request(a,{method:"POST",body:r?JSON.stringify(r):void 0})}put(a,r){return this.request(a,{method:"PUT",body:r?JSON.stringify(r):void 0})}delete(a){return this.request(a,{method:"DELETE"})}}new ss;const ts=({user:t,isOpen:a,onClose:r,currentSemester:l})=>{const[i,h]=o.useState("enrollments"),[c,d]=o.useState(!1),[p,x]=o.useState(null),[b,v]=o.useState(null),[N,T]=o.useState([]),[y,n]=o.useState({kode_mk:"",id_kelas:""}),[j,R]=o.useState([]),[u,P]=o.useState({kode_mk:"",id_kelas:"",sks_ajar:"",tatap_muka:""}),[U,G]=o.useState(!1),{data:H=[]}=qe({semester:l,include_classes:!0}),M=o.useMemo(()=>{const s=[];return H.forEach(g=>{g.classes&&Array.isArray(g.classes)&&s.push(...g.classes)}),s},[H]),C=t?.roles?.find(s=>s.role==="student"),k=t?.roles?.find(s=>s.role==="lecturer"),{data:z}=$e(k?.entity_id&&l?{id_dosen:k.entity_id,semester:l}:void 0);de.useEffect(()=>{z&&R(z)},[z]),de.useEffect(()=>{a&&C?.entity_id&&l&&W()},[a,C?.entity_id,l]);const W=async()=>{if(!(!C?.entity_id||!l)){d(!0),x(null);try{const s=await I.getEnrollments(C.entity_id,l);T(s.map(g=>({kode_mk:_(g.kode_mk)||"",id_kelas:ae(g.id_kelas)??void 0})))}catch(s){x(s instanceof Error?s.message:"Failed to load enrollments")}finally{d(!1)}}},F=()=>{if(!y.kode_mk){x("Please select a course");return}const s=y.id_kelas?Number(y.id_kelas):void 0;if(N.some(g=>g.kode_mk===y.kode_mk&&g.id_kelas===s)){x("Already enrolled in this class");return}T([...N,{kode_mk:y.kode_mk,id_kelas:s}]),n({kode_mk:"",id_kelas:""}),x(null)},X=s=>{T(N.filter((g,S)=>S!==s))},J=async()=>{if(!(!C?.entity_id||!l)){d(!0),x(null),v(null);try{const s=N.map(g=>({nim:C.entity_id,kode_mk:g.kode_mk,semester:l,id_kelas:g.id_kelas}));await I.updateEnrollments(C.entity_id,l,s),v("Enrollments saved successfully!"),setTimeout(()=>v(null),3e3)}catch(s){x(s instanceof Error?s.message:"Failed to save enrollments")}finally{d(!1)}}},Q=async()=>{if(!k?.entity_id||!u.kode_mk||!u.id_kelas||!l){x("Please fill in all required fields");return}d(!0),x(null);try{const s={id_dosen:k.entity_id,id_kelas:u.id_kelas,kode_mk:u.kode_mk,semester:l,sks_ajar:u.sks_ajar?parseInt(u.sks_ajar,10):void 0,tatap_muka:u.tatap_muka?parseInt(u.tatap_muka,10):void 0};if(await I.createLecturerAssignment(s),v("Teaching assignment created successfully"),P({kode_mk:"",id_kelas:"",sks_ajar:"",tatap_muka:""}),G(!1),k?.entity_id&&l){const g=await I.getLecturerAssignments({id_dosen:k.entity_id,semester:l});R(g)}}catch(s){x(s instanceof Error?s.message:"Failed to add teaching assignment")}finally{d(!1)}},A=async s=>{if(confirm("Are you sure you want to remove this teaching assignment?")){d(!0),x(null);try{await I.deleteLecturerAssignment(s),v("Teaching assignment removed successfully"),R(j.filter(g=>g.id!==s))}catch(g){x(g instanceof Error?g.message:"Failed to remove teaching assignment")}finally{d(!1)}}},B=o.useMemo(()=>{const s=new Map;return M.forEach(g=>{const S=_(g.kode_mk);S&&!s.has(S)&&s.set(S,S)}),Array.from(s.values())},[M]),L=o.useMemo(()=>y.kode_mk?M.filter(s=>_(s.kode_mk)===y.kode_mk):[],[M,y.kode_mk]);if(!a||!t)return null;const q=!!C,V=!!k;return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/50 z-40",onClick:r}),e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-50 p-4 pointer-events-none",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto pointer-events-auto",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-200 sticky top-0 bg-white z-10",children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-900",children:["Manage Assignments - ",_(t.name)||t.email]}),e.jsx("button",{onClick:r,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(xe,{className:"w-5 h-5"})})]}),q&&V&&e.jsx("div",{className:"px-6 pt-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("button",{onClick:()=>h("enrollments"),className:`pb-2 px-1 border-b-2 font-medium text-sm transition-colors ${i==="enrollments"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700"}`,children:[e.jsx(Z,{className:"w-4 h-4 inline mr-2"}),"Class Enrollments"]}),e.jsxs("button",{onClick:()=>h("teaching"),className:`pb-2 px-1 border-b-2 font-medium text-sm transition-colors ${i==="teaching"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700"}`,children:[e.jsx(me,{className:"w-4 h-4 inline mr-2"}),"Teaching Assignments"]})]})}),e.jsxs("div",{className:"p-6 space-y-4",children:[p&&e.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm",children:p}),b&&e.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg text-green-600 text-sm",children:b}),(i==="enrollments"||!V)&&q&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-900",children:"Student Enrollments"}),e.jsxs("span",{className:"text-xs text-gray-500",children:["Semester: ",l||"N/A"]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg p-4 space-y-3",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700",children:"Add Enrollment"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("select",{value:y.kode_mk,onChange:s=>n({...y,kode_mk:s.target.value,id_kelas:""}),className:"px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"Select Course"}),B.map(s=>e.jsx("option",{value:s,children:s},s))]}),e.jsxs("select",{value:y.id_kelas,onChange:s=>n({...y,id_kelas:s.target.value}),className:"px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500",disabled:!y.kode_mk,children:[e.jsx("option",{value:"",children:"Any Class"}),L.map(s=>e.jsx("option",{value:s.id,children:_(s.nama_kelas)||`Class ${s.id}`},s.id))]}),e.jsxs("button",{onClick:F,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center justify-center gap-2",disabled:!y.kode_mk,children:[e.jsx(ee,{className:"w-4 h-4"}),"Add"]})]})]}),e.jsx("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:N.length===0?e.jsx("div",{className:"p-8 text-center text-gray-500 text-sm",children:"No enrollments yet. Add courses above."}):e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Course Code"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Class"}),e.jsx("th",{className:"px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase",children:"Action"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:N.map((s,g)=>{const S=M.find(te=>te.id===s.id_kelas);return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 font-medium text-gray-900",children:s.kode_mk}),e.jsx("td",{className:"px-4 py-3 text-gray-600",children:S?_(S.nama_kelas)||`Class ${S.id}`:"Any Class"}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsx("button",{onClick:()=>X(g),className:"p-1 text-red-600 hover:bg-red-50 rounded transition-colors",children:e.jsx(se,{className:"w-4 h-4"})})})]},g)})})]})}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:J,disabled:c,className:"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 disabled:opacity-50",children:c?e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"w-4 h-4 animate-spin"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Pe,{className:"w-4 h-4"}),"Save Enrollments"]})})})]}),(i==="teaching"||!q)&&V&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-900",children:"Teaching Assignments"}),e.jsxs("button",{onClick:()=>G(!U),disabled:c,className:"px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center gap-2 disabled:opacity-50",children:[e.jsx(ee,{className:"w-4 h-4"}),"Add Assignment"]})]}),U&&e.jsxs("div",{className:"p-4 bg-gray-50 border border-gray-200 rounded-lg space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Course ",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsxs("select",{value:u.kode_mk,onChange:s=>P({...u,kode_mk:s.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm",children:[e.jsx("option",{value:"",children:"Select course..."}),Array.from(new Set(M.map(s=>_(s.kode_mk)))).map(s=>e.jsx("option",{value:s||"",children:s},s))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Class ",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsxs("select",{value:u.id_kelas,onChange:s=>P({...u,id_kelas:s.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm",children:[e.jsx("option",{value:"",children:"Select class..."}),M.filter(s=>_(s.kode_mk)===u.kode_mk).map(s=>e.jsx("option",{value:s.id.toString(),children:_(s.nama_kelas)||`Class ${s.id}`},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"SKS Ajar"}),e.jsx("input",{type:"number",value:u.sks_ajar,onChange:s=>P({...u,sks_ajar:s.target.value}),min:"0",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tatap Muka"}),e.jsx("input",{type:"number",value:u.tatap_muka,onChange:s=>P({...u,tatap_muka:s.target.value}),min:"0",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm",placeholder:"0"})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>{G(!1),P({kode_mk:"",id_kelas:"",sks_ajar:"",tatap_muka:""})},disabled:c,className:"px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors text-sm disabled:opacity-50",children:"Cancel"}),e.jsx("button",{onClick:Q,disabled:c||!u.kode_mk||!u.id_kelas,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center gap-2 disabled:opacity-50",children:c?e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"w-4 h-4 animate-spin"}),"Creating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"w-4 h-4"}),"Create Assignment"]})})]})]}),e.jsx("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:j.length===0?e.jsx("div",{className:"p-8 text-center text-gray-500 text-sm",children:"No teaching assignments found."}):e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Course"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Class"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Semester"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"SKS"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Tatap Muka"}),e.jsx("th",{className:"px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase",children:"Action"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:j.map(s=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 font-medium text-gray-900",children:_(s.kode_mk)||"-"}),e.jsx("td",{className:"px-4 py-3 text-gray-600",children:_(s.id_kelas)||"-"}),e.jsx("td",{className:"px-4 py-3 text-gray-600",children:_(s.semester)||"-"}),e.jsx("td",{className:"px-4 py-3 text-gray-600",children:ae(s.sks_ajar)||"-"}),e.jsx("td",{className:"px-4 py-3 text-gray-600",children:ae(s.tatap_muka)||"-"}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsx("button",{onClick:()=>A(s.id),disabled:c,className:"p-1 text-red-600 hover:bg-red-50 rounded transition-colors disabled:opacity-50",children:e.jsx(se,{className:"w-4 h-4"})})})]},s.id))})]})})]}),!q&&!V&&e.jsxs("div",{className:"p-8 text-center text-gray-500",children:["This user doesn't have student or lecturer role.",e.jsx("br",{}),"Add appropriate roles first to manage assignments."]})]})]})})]})};function as(){const[t,a]=o.useState(1),[r,l]=o.useState(0),i=50,[h,c]=o.useState(""),[d,p]=o.useState("all"),[x,b]=o.useState(!1),[v,N]=o.useState(!1),[T,y]=o.useState(null),[n,j]=o.useState(ce),[R,u]=o.useState(null),[P,U]=o.useState(!1),[G,H]=o.useState([]),[M,C]=o.useState([]),{data:k,isLoading:z,error:W}=Qe(),{data:F,isLoading:X,error:J}=Ve(),Q=o.useMemo(()=>({q:h||void 0,limit:i,offset:(t-1)*i}),[i,t,h]),A=Je(Q,{enabled:!0}),B=We(),L=Xe(),q=Ye();o.useEffect(()=>{k&&H(k)},[k]),o.useEffect(()=>{F&&C(F)},[F]),o.useEffect(()=>{A.data&&l(A.data.total)},[A.data]),o.useEffect(()=>{a(1)},[h,d]);const V=A.isLoading||z||X,s=A.error||W||J,g=o.useMemo(()=>(A.data?.data??[]).map(m=>{const w=m.roles||[],$=w.find(D=>D.role==="student"),O=w.find(D=>D.role==="lecturer"),Y={...m};return $?.entity_id&&k&&(Y.studentInfo=k.find(D=>D.nim===$.entity_id)),O?.entity_id&&F&&(Y.lecturerInfo=F.find(D=>D.id===O.entity_id)),Y}),[A.data,k,F]),S=o.useMemo(()=>g.filter(f=>{const m=f.roles?.map(w=>w.role)||[];return d==="all"||m.includes(d)}),[g,d]),te=o.useMemo(()=>{const f=g.flatMap(m=>m.roles?.map(w=>w.role)||[]);return{total:r,students:f.filter(m=>m==="student").length,lecturers:f.filter(m=>m==="lecturer").length,admins:f.filter(m=>m==="admin").length,staff:f.filter(m=>m==="staff").length}},[g,r]),ge=o.useCallback(()=>{u(null),j(ce),b(!0)},[]),pe=o.useCallback(()=>{b(!1)},[]),fe=o.useCallback(f=>{u(null),y(f),j({email:f.email,name:K(f.name),password:"",roles:f.roles||[]}),N(!0)},[]),be=o.useCallback(()=>{N(!1),y(null)},[]),ye=o.useCallback(async f=>{if(f.preventDefault(),u(null),!n.email.trim()||!n.email.includes("@")){u("Email tidak valid");return}if(!n.password.trim()){u("Password wajib diisi jika tidak menggunakan Google OAuth");return}U(!0);try{const m={email:n.email.trim(),name:n.name.trim()||void 0,password:n.password.trim()||void 0,auth_provider:"local",roles:n.roles};await B.mutateAsync(m),b(!1)}catch(m){u(m.message||"Gagal menambahkan pengguna")}finally{U(!1)}},[n,B]),je=o.useCallback(async f=>{if(f.preventDefault(),!!T){if(u(null),!n.email.trim()||!n.email.includes("@")){u("Email tidak valid");return}U(!0);try{const m={email:n.email.trim(),name:n.name.trim()||void 0,roles:n.roles};n.password.trim()&&(m.password=n.password.trim()),await L.mutateAsync({id:T.id,data:m}),N(!1)}catch(m){u(m.message||"Gagal mengupdate pengguna")}finally{U(!1)}}},[n,T,L]),ke=o.useCallback(async f=>{const m=K(f.name)||f.email;if(confirm(`Apakah Anda yakin ingin menghapus pengguna "${m}"?`))try{await q.mutateAsync({id:f.id})}catch(w){alert(`Gagal menghapus pengguna: ${w.message}`)}},[q]),ve=o.useCallback(f=>{if(n.roles.some(m=>m.role===f)){u("Role sudah ditambahkan");return}j(m=>({...m,roles:[...m.roles,{role:f}]}))},[n.roles]),Ne=o.useCallback(f=>{j(m=>({...m,roles:m.roles.filter((w,$)=>$!==f)}))},[]),we=o.useCallback((f,m,w)=>{j($=>{const O=[...$.roles];if(w)O[f]={...O[f],entity_type:m,entity_id:w};else{const{entity_type:Y,entity_id:D,..._e}=O[f];O[f]=_e}return{...$,roles:O}})},[]);return{users:g,students:G,lecturers:M,userStats:te,totalUsers:r,loading:V,loadError:s,actionLoading:P,currentPage:t,itemsPerPage:i,setCurrentPage:a,searchTerm:h,setSearchTerm:c,selectedRole:d,setSelectedRole:p,filteredUsers:S,formData:n,setFormData:j,formError:R,setFormError:u,isAddModalOpen:x,setIsAddModalOpen:b,isEditModalOpen:v,setIsEditModalOpen:N,editingUser:T,setEditingUser:y,handleAddUser:ye,handleEditUser:je,handleDeleteUser:ke,openAddModal:ge,openEditModal:fe,closeAddModal:pe,closeEditModal:be,addRole:ve,removeRole:Ne,updateRoleEntity:we}}const cs=()=>{const{currentSemester:t}=Le(),[a,r]=o.useState(null),{students:l,lecturers:i,userStats:h,totalUsers:c,loading:d,loadError:p,actionLoading:x,currentPage:b,itemsPerPage:v,setCurrentPage:N,searchTerm:T,setSearchTerm:y,selectedRole:n,setSelectedRole:j,filteredUsers:R,formData:u,setFormData:P,formError:U,isAddModalOpen:G,isEditModalOpen:H,handleAddUser:M,handleEditUser:C,handleDeleteUser:k,openAddModal:z,openEditModal:W,closeAddModal:F,closeEditModal:X,addRole:J,removeRole:Q,updateRoleEntity:A}=as(),B=L=>{P(q=>({...q,...L}))};return e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6",children:[e.jsx(Oe,{title:"Manajemen Pengguna",subtitle:"Kelola pengguna sistem dan hak akses"}),e.jsx("div",{className:"flex gap-2 mt-4 sm:mt-0",children:e.jsxs("button",{onClick:z,className:"inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(ee,{className:"w-4 h-4"}),"Tambah Pengguna"]})})]}),p&&e.jsxs("div",{className:"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-600",children:["Gagal memuat data: ",p.message]}),e.jsx(De,{stats:h}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 mb-6",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(Ue,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Cari berdasarkan nama atau email...",value:T,onChange:L=>y(L.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Fe,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsxs("select",{value:n,onChange:L=>j(L.target.value),className:"pl-10 pr-8 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none bg-white",children:[e.jsx("option",{value:"all",children:"Semua Role"}),e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"lecturer",children:"Dosen"}),e.jsx("option",{value:"student",children:"Mahasiswa"}),e.jsx("option",{value:"staff",children:"Staff"}),e.jsx("option",{value:"alumni",children:"Alumni"}),e.jsx("option",{value:"student_applicant",children:"Pendaftar"})]})]})]}),e.jsx(ze,{users:R,loading:d,currentPage:b,totalUsers:n==="all"?c:R.length,itemsPerPage:v,onManageAssignments:r,onPageChange:N,onEditUser:W,onDeleteUser:k}),e.jsx(ue,{isOpen:G,isEdit:!1,formData:u,formError:U,actionLoading:x,students:l,lecturers:i,onClose:F,onSubmit:M,onFormChange:B,onAddRole:J,onRemoveRole:Q,onUpdateRoleEntity:A}),e.jsx(ue,{isOpen:H,isEdit:!0,formData:u,formError:U,actionLoading:x,students:l,lecturers:i,onClose:X,onSubmit:C,onFormChange:B,onAddRole:J,onRemoveRole:Q,onUpdateRoleEntity:A}),e.jsx(ts,{user:a,isOpen:!!a,onClose:()=>r(null),currentSemester:t})]})};export{cs as default};
//# sourceMappingURL=index-CNp5Acia.js.map
