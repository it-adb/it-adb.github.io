{"version":3,"file":"client-C5MoUn0x.js","sources":["../../src/hooks/useCourses.ts","../../src/services/api/client.ts"],"sourcesContent":["import { useQuery } from '@tanstack/react-query';\r\nimport type { UseQueryOptions } from '@tanstack/react-query';\r\nimport { apiService } from '../services/api';\r\nimport type { CourseWithClasses, GetCoursesParams } from '../types';\r\n\r\nexport function useCourses(\r\n  params?: GetCoursesParams,\r\n  options?: Omit<UseQueryOptions<CourseWithClasses[], Error>, 'queryKey' | 'queryFn'>\r\n) {\r\n  const key = ['courses', params?.kode_prodi ?? null, params?.semester ?? null, params?.include_classes ?? null] as const;\r\n  return useQuery<CourseWithClasses[], Error>({\r\n    queryKey: key,\r\n    queryFn: () => apiService.getCourses(params),\r\n    ...(options ?? {}),\r\n  });\r\n}\r\n","/**\r\n * API Client - Base HTTP client with authentication\r\n * Handles token management, request/response, and error handling\r\n */\r\n\r\nimport { apiLogger } from '@/utils/logger';\r\n\r\n// Re-export types for backward compatibility\r\nexport type { SqlNullString } from '@/types';\r\n\r\nconst API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:8080';\r\n\r\n/**\r\n * Decode JWT token without verification (for client-side expiration check)\r\n */\r\nfunction decodeJWT(token: string): { exp?: number; iat?: number } | null {\r\n  try {\r\n    const base64Url = token.split('.')[1];\r\n    if (!base64Url) return null;\r\n    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');\r\n    const jsonPayload = decodeURIComponent(\r\n      atob(base64)\r\n        .split('')\r\n        .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))\r\n        .join('')\r\n    );\r\n    return JSON.parse(jsonPayload);\r\n  } catch (error) {\r\n    apiLogger.error('Failed to decode JWT:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport interface ApiError {\r\n  error: string;\r\n}\r\n\r\nexport interface MessageResponse {\r\n  message: string;\r\n}\r\n\r\n/**\r\n * Core API Client class handling HTTP requests and authentication\r\n */\r\nexport class ApiClient {\r\n  private baseUrl: string;\r\n  private accessToken: string | null = null;\r\n  private refreshToken: string | null = null;\r\n  private tokenOperationInProgress = false;\r\n  private refreshPromise: Promise<string> | null = null;\r\n  private refreshTimerId: ReturnType<typeof setTimeout> | null = null;\r\n  private onAuthError: (() => void) | null = null;\r\n\r\n  constructor(baseUrl: string = API_BASE_URL) {\r\n    this.baseUrl = baseUrl;\r\n    this.loadTokensFromStorage();\r\n  }\r\n\r\n  setAuthErrorHandler(handler: () => void): void {\r\n    this.onAuthError = handler;\r\n  }\r\n\r\n  private loadTokensFromStorage(): void {\r\n    try {\r\n      this.accessToken = localStorage.getItem('accessToken');\r\n      this.refreshToken = localStorage.getItem('refreshToken');\r\n      \r\n      if (this.accessToken) {\r\n        this.scheduleTokenRefresh();\r\n      }\r\n    } catch (error) {\r\n      apiLogger.error('Error loading tokens from storage:', error);\r\n      this.accessToken = null;\r\n      this.refreshToken = null;\r\n    }\r\n  }\r\n\r\n  private scheduleTokenRefresh(): void {\r\n    if (this.refreshTimerId) {\r\n      clearTimeout(this.refreshTimerId);\r\n      this.refreshTimerId = null;\r\n    }\r\n\r\n    if (!this.accessToken || !this.refreshToken) {\r\n      return;\r\n    }\r\n\r\n    const payload = decodeJWT(this.accessToken);\r\n    if (!payload || !payload.exp) {\r\n      return;\r\n    }\r\n\r\n    const now = Math.floor(Date.now() / 1000);\r\n    const expiresIn = payload.exp - now;\r\n    const refreshIn = Math.max(0, expiresIn - 120);\r\n\r\n    this.refreshTimerId = setTimeout(async () => {\r\n      try {\r\n        await this.refreshAccessToken();\r\n      } catch (error) {\r\n        apiLogger.error('Proactive token refresh failed:', error);\r\n      }\r\n    }, refreshIn * 1000);\r\n  }\r\n\r\n  setTokens(accessToken: string, refreshToken?: string): void {\r\n    if (this.tokenOperationInProgress) {\r\n      return;\r\n    }\r\n    \r\n    try {\r\n      this.tokenOperationInProgress = true;\r\n      this.accessToken = accessToken;\r\n      localStorage.setItem('accessToken', accessToken);\r\n      \r\n      if (refreshToken) {\r\n        this.refreshToken = refreshToken;\r\n        localStorage.setItem('refreshToken', refreshToken);\r\n      }\r\n      \r\n      this.scheduleTokenRefresh();\r\n    } finally {\r\n      this.tokenOperationInProgress = false;\r\n    }\r\n  }\r\n\r\n  clearTokens(): void {\r\n    if (this.tokenOperationInProgress) {\r\n      return;\r\n    }\r\n    \r\n    try {\r\n      this.tokenOperationInProgress = true;\r\n      \r\n      if (this.refreshTimerId) {\r\n        clearTimeout(this.refreshTimerId);\r\n        this.refreshTimerId = null;\r\n      }\r\n      \r\n      this.accessToken = null;\r\n      this.refreshToken = null;\r\n      this.refreshPromise = null;\r\n      localStorage.removeItem('accessToken');\r\n      localStorage.removeItem('refreshToken');\r\n    } finally {\r\n      this.tokenOperationInProgress = false;\r\n    }\r\n  }\r\n\r\n  hasTokens(): boolean {\r\n    return Boolean(this.accessToken);\r\n  }\r\n\r\n  /**\r\n   * Make an HTTP request with automatic token handling and retry\r\n   */\r\n  async request<T>(\r\n    endpoint: string,\r\n    options: RequestInit = {},\r\n    isRetry: boolean = false\r\n  ): Promise<T> {\r\n    const url = `${this.baseUrl}${endpoint}`;\r\n    const headers: Record<string, string> = {\r\n      'Content-Type': 'application/json',\r\n    };\r\n\r\n    if (options.headers) {\r\n      Object.entries(options.headers).forEach(([key, value]) => {\r\n        if (typeof value === 'string') {\r\n          headers[key] = value;\r\n        }\r\n      });\r\n    }\r\n\r\n    if (this.accessToken) {\r\n      headers['Token'] = this.accessToken;\r\n    }\r\n\r\n    try {\r\n      const response = await fetch(url, {\r\n        ...options,\r\n        headers,\r\n      });\r\n\r\n      if (response.status === 401 && this.refreshToken && !isRetry && !endpoint.includes('/auth/refresh')) {\r\n        try {\r\n          if (!this.refreshPromise) {\r\n            this.refreshPromise = this.refreshAccessToken().finally(() => {\r\n              this.refreshPromise = null;\r\n            });\r\n          }\r\n          \r\n          await this.refreshPromise;\r\n          return this.request<T>(endpoint, options, true);\r\n        } catch (refreshError) {\r\n          apiLogger.error('Token refresh failed:', refreshError);\r\n          this.clearTokens();\r\n          if (this.onAuthError) {\r\n            this.onAuthError();\r\n          }\r\n          throw new Error('Session expired. Please login again.');\r\n        }\r\n      }\r\n\r\n      if (!response.ok) {\r\n        const error: ApiError = await response.json().catch(() => ({\r\n          error: `HTTP ${response.status}: ${response.statusText}`,\r\n        }));\r\n        \r\n        const errorMessage = `${error.error || response.statusText} (HTTP ${response.status})`;\r\n        throw new Error(errorMessage);\r\n      }\r\n\r\n      return response.json();\r\n    } catch (error) {\r\n      apiLogger.error('API request failed:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Refresh the access token using the refresh token\r\n   */\r\n  async refreshAccessToken(): Promise<string> {\r\n    if (!this.refreshToken) {\r\n      throw new Error('No refresh token available');\r\n    }\r\n\r\n    const url = `${this.baseUrl}/auth/refresh`;\r\n    const headers: Record<string, string> = {\r\n      'Content-Type': 'application/json',\r\n    };\r\n\r\n    try {\r\n      const response = await fetch(url, {\r\n        method: 'POST',\r\n        headers,\r\n        body: JSON.stringify({ refresh_token: this.refreshToken }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const error: ApiError = await response.json().catch(() => ({\r\n          error: `HTTP ${response.status}: ${response.statusText}`,\r\n        }));\r\n        throw new Error(error.error || 'Token refresh failed');\r\n      }\r\n\r\n      const data = await response.json() as { access_token: string; refresh_token?: string };\r\n      this.setTokens(data.access_token, data.refresh_token);\r\n      \r\n      apiLogger.log('Access token refreshed successfully');\r\n      return data.access_token;\r\n    } catch (error) {\r\n      apiLogger.error('Failed to refresh access token:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  // Convenience methods for HTTP verbs\r\n  get<T>(endpoint: string): Promise<T> {\r\n    return this.request<T>(endpoint, { method: 'GET' });\r\n  }\r\n\r\n  post<T>(endpoint: string, body?: unknown): Promise<T> {\r\n    return this.request<T>(endpoint, {\r\n      method: 'POST',\r\n      body: body ? JSON.stringify(body) : undefined,\r\n    });\r\n  }\r\n\r\n  put<T>(endpoint: string, body?: unknown): Promise<T> {\r\n    return this.request<T>(endpoint, {\r\n      method: 'PUT',\r\n      body: body ? JSON.stringify(body) : undefined,\r\n    });\r\n  }\r\n\r\n  delete<T>(endpoint: string): Promise<T> {\r\n    return this.request<T>(endpoint, { method: 'DELETE' });\r\n  }\r\n}\r\n\r\n// Singleton instance\r\nexport const apiClient = new ApiClient();\r\n\r\nexport default apiClient;\r\n"],"names":["useCourses","params","options","key","useQuery","apiService","API_BASE_URL","decodeJWT","token","base64Url","base64","jsonPayload","c","error","apiLogger","ApiClient","baseUrl","handler","payload","now","expiresIn","refreshIn","accessToken","refreshToken","endpoint","isRetry","url","headers","value","response","refreshError","errorMessage","data","body"],"mappings":"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"}