import{j as e}from"./query-vendor-B--u1oZD.js";import{g as d}from"./react-vendor-XXJdR_Id.js";import{c as S}from"./index-1e-qg3UH.js";import{g as k}from"./status-sB_rSvKV.js";import{a as Z,e as ee,u as te,c as ae,d as se,b as ne}from"./useAttendances-Be9_LW9L.js";import{g as F,W as ie}from"./ui-vendor-C-UqR_Df.js";const xe=({selectedMeeting:r,onClose:U})=>{const{data:D,isLoading:z}=Z(r?.classId),{data:C,isLoading:R}=ee(r?.meetingId),{data:y,refetch:O}=te(r?.classId),f=d.useMemo(()=>D??[],[D]),P=d.useMemo(()=>C??[],[C]),c=d.useMemo(()=>{if(!r||!y||y.length===0)return null;const t=y.find(s=>s.id===r.meetingId);if(!t)return null;let a="",n="",l="";if(typeof t.tgl_pertemuan=="string")a=t.tgl_pertemuan;else if(t.tgl_pertemuan&&typeof t.tgl_pertemuan=="object"){const s=t.tgl_pertemuan;s.Time?a=s.Time:s.String?a=s.String:a=S(s,"")}if(typeof t.jam_pertemuan=="string")n=t.jam_pertemuan;else if(t.jam_pertemuan&&typeof t.jam_pertemuan=="object"){const s=t.jam_pertemuan;s.String?n=s.String:n=S(s,"")}if(t.topik){if(typeof t.topik=="string")l=t.topik;else if(typeof t.topik=="object"){const s=t.topik;s.String?l=s.String:l=S(s,"")}}console.log("ðŸ“… Meeting data from API:",{tglPertemuan:a,jamPertemuan:n,topik:l,rawData:t.tgl_pertemuan});let i;if(a&&n){const s=a.includes("T")?a.split("T")[0]:a.split(" ")[0]||a,V=n.length===5?`${n}:00`:n.split(".")[0]||n,H=`${s}T${V}`;i=new Date(H),console.log("ðŸ“… Parsed meeting datetime:",H,"â†’",i)}else console.warn("âš ï¸ Missing date or time:",{tglPertemuan:a,jamPertemuan:n});return{meetingDateTime:i,topic:l}},[r,y]),x=ae(),g=se(),j=ne(),[m,o]=d.useState({}),[W,w]=d.useState(!1),[T,_]=d.useState(!1),[A,N]=d.useState(!1),[h,E]=d.useState(""),[p,I]=d.useState(""),[v,$]=d.useState(""),b=d.useMemo(()=>{if(!f||f.length===0)return[];const t=new Map(P.map(a=>[a.nim,{status:S(a.status_kehadiran,""),id:a.id}]));return f.map(a=>{const n=t.get(a.nim);return{...a,status:n?.status||"Belum Absen",attendanceId:n?.id}})},[f,P]),X=d.useMemo(()=>{const t=c?.meetingDateTime||r?.meetingDateTime;if(!t)return!1;const a=new Date,n=new Date(t),l=new Date(n.getTime()-300*1e3);return a>=l},[c?.meetingDateTime,r?.meetingDateTime]),L=async(t,a,n)=>{if(!r)return;const l=new Date().toISOString();try{n?await g.mutateAsync({id:n,data:{status_kehadiran:a,waktu_masuk:l}}):await x.mutateAsync({id_pertemuan:r.meetingId,nim:t,status_kehadiran:a,waktu_masuk:l})}catch(i){console.error("Failed to update attendance:",i),alert(`Failed to update attendance: ${i instanceof Error?i.message:"Unknown error"}`)}},Y=async()=>{if(!r||Object.keys(m).length===0)return;_(!0);const t=[],a=new Date().toISOString();for(const n of Object.keys(m)){const l=m[n],i=b.find(s=>s.nim===n);if(i)try{i.attendanceId?await g.mutateAsync({id:i.attendanceId,data:{status_kehadiran:l,waktu_masuk:a}}):await x.mutateAsync({id_pertemuan:r.meetingId,nim:n,status_kehadiran:l,waktu_masuk:a})}catch(s){console.error(`Failed to update attendance for ${n}:`,s),t.push(`${i.nama} (${n})`)}}_(!1),t.length>0?alert(`Failed to update attendance for: ${t.join(", ")}`):(o({}),w(!1))},q=()=>{const t={};b.forEach(a=>{t[a.nim]=a.status==="Belum Absen"?"Hadir":a.status||"Hadir"}),o(t),w(!0)},G=()=>{o({}),w(!1)},J=async()=>{if(!(!r||!h||!p))try{const t=p.length===5?`${p}:00`:p;console.log("ðŸ’¾ Saving meeting update:",{id:r.meetingId,tgl_pertemuan:h,jam_pertemuan:t,topik:v||void 0}),await j.mutateAsync({id:r.meetingId,data:{tgl_pertemuan:h,jam_pertemuan:t,topik:v||void 0}}),console.log("âœ… Meeting saved, refetching data..."),await O(),console.log("âœ… Data refetched"),N(!1),alert("Meeting schedule updated successfully!")}catch(t){console.error("Failed to update meeting:",t),alert(`Failed to update meeting: ${t instanceof Error?t.message:"Unknown error"}`)}};d.useEffect(()=>{const t=c?.meetingDateTime||r?.meetingDateTime,a=c?.topic||r?.topic||"";if(t){const n=new Date(t),l=n.toISOString().split("T")[0],i=`${String(n.getHours()).padStart(2,"0")}:${String(n.getMinutes()).padStart(2,"0")}`;E(l),I(i),$(a)}},[c?.meetingDateTime,c?.topic,r?.meetingDateTime,r?.topic]);const K=()=>{N(!0)},Q=()=>{o({}),w(!1),N(!1),U()},u=c?.meetingDateTime||r?.meetingDateTime,B=d.useMemo(()=>u?new Date(u).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric"}):r?.dateLabel,[u,r?.dateLabel]),M=c?.topic||r?.topic;return r?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-2 sm:p-4 bg-black/30",children:e.jsxs("div",{className:"w-full h-full max-h-screen sm:max-h-[90vh] max-w-sm sm:max-w-2xl lg:max-w-4xl bg-white rounded-lg shadow-lg flex flex-col",children:[e.jsxs("div",{className:"px-3 sm:px-4 py-3 border-b border-gray-200 flex items-center justify-between flex-shrink-0",children:[e.jsxs("div",{className:"flex-1 min-w-0 pr-2",children:[e.jsx("div",{className:"text-xs sm:text-sm text-gray-500 truncate",children:r.subtitle}),e.jsx("h3",{className:"text-sm sm:text-base font-semibold text-gray-900 line-clamp-2",children:r.title}),B&&e.jsx("div",{className:"text-xs text-gray-500 mt-0.5",children:B}),u&&e.jsxs("div",{className:"text-xs text-gray-600 mt-0.5 font-medium",children:[e.jsx(F,{className:"inline h-3 w-3 mr-1"}),new Date(u).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1})]}),M&&!A&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1 italic",children:["Topic: ",M]})]}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2 flex-shrink-0",children:[!A&&e.jsxs("button",{onClick:K,className:"px-2 py-1 text-xs font-medium rounded bg-blue-600 text-white hover:bg-blue-700 cursor-pointer flex items-center gap-1 whitespace-nowrap",title:"Edit meeting schedule",children:[e.jsx(ie,{className:"h-3 w-3"}),e.jsx("span",{className:"hidden sm:inline",children:"Edit Schedule"}),e.jsx("span",{className:"sm:hidden",children:"Edit"})]}),e.jsx("button",{onClick:Q,className:"px-2 py-1 text-sm rounded hover:bg-gray-100 cursor-pointer","aria-label":"Close",children:"Close"})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-3 sm:p-4",children:[A&&e.jsxs("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Edit Meeting Schedule"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Date"}),e.jsx("input",{type:"date",value:h,onChange:t=>E(t.target.value),className:"input-field w-full text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Time"}),e.jsx("input",{type:"time",value:p,onChange:t=>I(t.target.value),className:"input-field w-full text-sm"})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Topic/Description (Optional)"}),e.jsx("textarea",{value:v,onChange:t=>$(t.target.value),className:"input-field w-full text-sm",rows:3,placeholder:"Enter meeting topic or description...",maxLength:500}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[v.length,"/500 characters"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:J,disabled:j.isPending||!h||!p,className:"px-3 py-1.5 text-sm font-medium rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer",children:j.isPending?"Saving...":"Save Changes"}),e.jsx("button",{onClick:()=>N(!1),disabled:j.isPending,className:"px-3 py-1.5 text-sm font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50 cursor-pointer",children:"Cancel"})]})]}),X?z||R?e.jsx("div",{className:"text-center text-gray-500 py-6",children:"Loading students and attendances..."}):b.length===0?e.jsx("div",{className:"text-center text-gray-500 py-6",children:"No students found for this class."}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-3 sm:mb-4 flex gap-1 sm:gap-2 justify-end flex-wrap",children:W?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:Y,disabled:T||Object.keys(m).length===0,className:"px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm font-medium rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer whitespace-nowrap",children:T?"Saving...":`Save (${Object.keys(m).length})`}),e.jsx("button",{onClick:G,disabled:T,className:"px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50 cursor-pointer whitespace-nowrap",children:"Cancel"})]}):e.jsx("button",{onClick:q,className:"px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm font-medium rounded bg-primary-600 text-white hover:bg-primary-700 cursor-pointer whitespace-nowrap",children:"Edit All"})}),e.jsxs("div",{className:"space-y-2 sm:overflow-x-auto sm:border sm:border-gray-200 sm:rounded-lg",children:[e.jsx("div",{className:"sm:hidden space-y-2",children:b.map(t=>{const a=t.status,n=m[t.nim]!==void 0,l=n?m[t.nim]:a;return e.jsxs("div",{className:"border border-gray-200 rounded-lg p-2 bg-white",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs font-semibold text-gray-900 break-words",children:t.nama}),e.jsx("p",{className:"text-xs text-gray-500 font-mono",children:t.nim})]}),!n&&e.jsx("span",{className:`flex-shrink-0 px-2 py-0.5 rounded text-xs font-medium inline-block ${a==="Hadir"?"bg-green-100 text-green-700":a==="Izin"||a==="Sakit"?"bg-yellow-100 text-yellow-700":a==="Terlambat"?"bg-blue-100 text-blue-700":a==="Pengganti"?"bg-purple-100 text-purple-700":a==="Belum Absen"?"bg-gray-100 text-gray-700":"bg-red-100 text-red-700"}`,children:k(a)||"Belum Absen"})]}),n?e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"grid grid-cols-3 gap-0.5",children:["Hadir","Izin","Sakit","Alfa","Terlambat","Pengganti"].map(i=>e.jsx("button",{onClick:()=>o(s=>({...s,[t.nim]:i})),className:`px-1.5 py-1 text-xs font-medium rounded transition-colors cursor-pointer ${l===i?"bg-primary-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:k(i)},i))}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:async()=>{await L(t.nim,l,t.attendanceId),o(i=>{const s={...i};return delete s[t.nim],s})},disabled:x.isPending||g.isPending,className:"flex-1 px-2 py-1 text-xs font-medium rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 cursor-pointer",children:x.isPending||g.isPending?"Saving...":"Save"}),e.jsx("button",{onClick:()=>o(i=>{const s={...i};return delete s[t.nim],s}),disabled:x.isPending||g.isPending,className:"px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50 cursor-pointer",children:"X"})]})]}):e.jsx("button",{onClick:()=>o(i=>({...i,[t.nim]:a==="Belum Absen"?"Hadir":a||"Hadir"})),className:"w-full px-2 py-1 text-xs font-medium rounded bg-primary-600 text-white hover:bg-primary-700 cursor-pointer",children:"Edit"})]},t.nim)})}),e.jsxs("table",{className:"hidden sm:table w-full text-xs sm:text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 border-b border-gray-200",children:[e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-semibold text-gray-700 whitespace-nowrap",children:"NIM"}),e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-semibold text-gray-700",children:"Name"}),e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Status"}),e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Action"})]})}),e.jsx("tbody",{children:b.map(t=>{const a=t.status,n=m[t.nim]!==void 0,l=n?m[t.nim]:a;return e.jsxs("tr",{className:"border-b border-gray-100 hover:bg-gray-50",children:[e.jsx("td",{className:"px-2 sm:px-3 py-2 font-mono text-gray-900 whitespace-nowrap text-xs",children:t.nim}),e.jsx("td",{className:"px-2 sm:px-3 py-2 text-gray-900",children:t.nama}),e.jsx("td",{className:"px-2 sm:px-3 py-2",children:n?e.jsx("div",{className:"flex gap-1 flex-wrap",children:["Hadir","Izin","Sakit","Alfa","Terlambat","Pengganti"].map(i=>e.jsx("button",{onClick:()=>o(s=>({...s,[t.nim]:i})),className:`px-2 py-0.5 text-xs font-medium rounded transition-colors cursor-pointer ${l===i?"bg-primary-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:k(i)},i))}):e.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-medium inline-block ${a==="Hadir"?"bg-green-100 text-green-700":a==="Izin"||a==="Sakit"?"bg-yellow-100 text-yellow-700":a==="Terlambat"?"bg-blue-100 text-blue-700":a==="Pengganti"?"bg-purple-100 text-purple-700":a==="Belum Absen"?"bg-gray-100 text-gray-700":"bg-red-100 text-red-700"}`,children:k(a)||"Belum Absen"})}),e.jsx("td",{className:"px-2 sm:px-3 py-2 whitespace-nowrap",children:n?e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:async()=>{await L(t.nim,l,t.attendanceId),o(i=>{const s={...i};return delete s[t.nim],s})},disabled:x.isPending||g.isPending,className:"px-2 py-1 text-xs font-medium rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 cursor-pointer",children:x.isPending||g.isPending?"Saving...":"Save"}),e.jsx("button",{onClick:()=>o(i=>{const s={...i};return delete s[t.nim],s}),disabled:x.isPending||g.isPending,className:"px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50 cursor-pointer",children:"Cancel"})]}):e.jsx("button",{onClick:()=>o(i=>({...i,[t.nim]:a==="Belum Absen"?"Hadir":a||"Hadir"})),className:"px-2 py-1 text-xs font-medium rounded bg-primary-600 text-white hover:bg-primary-700 cursor-pointer",children:"Edit"})})]},t.nim)})})]})]})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(F,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Attendance Not Available Yet"}),e.jsx("p",{className:"text-gray-600",children:"Attendance editing will be available 5 minutes before the class starts."}),u&&e.jsxs("p",{className:"text-sm text-gray-500 mt-2",children:["Class starts at: ",new Date(u).toLocaleString("en-US",{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})]})]})]})]})}):null};export{xe as A};
//# sourceMappingURL=AttendanceModal-ueH5xhk4.js.map
