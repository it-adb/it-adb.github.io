import{u as J,b as me,c as xe,j as e}from"./query-vendor-B--u1oZD.js";import{r as d,g as he}from"./react-vendor-XXJdR_Id.js";import{P as Le}from"./PageHeader-BqRIrUm4.js";import{f as te,k as Te,a as Ie,C as qe,M as Ge,a5 as $e,B as je,a3 as Ke,K as re,X as Ne,Y as de,x as ve,t as ce,d as oe,Q as De,s as ee,v as pe,c as ge,u as ye,w as le,b as Qe,P as ae,_ as ze,I as Oe,a0 as Be}from"./ui-vendor-CkH0jJa3.js";import{d as M,f as w,g as se,h as W,e as He,j as ie,u as We,a as Ve}from"./index-CU8_O-g9.js";import{u as Xe}from"./client-CAckhWQ1.js";import{u as Ye}from"./useLecturerAssignments-BaTCYOa9.js";function Je(t,o){const i=["users",t.q??null,t.limit??null,t.offset??null];return J({queryKey:i,queryFn:()=>M.getUsers(t),...o??{}})}const ue=["users"];function Ze(t,o){return J({queryKey:["students",null],queryFn:()=>M.getStudents(t)})}function es(t,o){return J({queryKey:["lecturers",null],queryFn:()=>M.getLecturers(t)})}function ss(t){const o=me();return xe({mutationFn:i=>M.createUser(i),onSuccess:(...i)=>{o.invalidateQueries({queryKey:ue})},...t})}function ts(t){const o=me();return xe({mutationFn:({id:i,data:c})=>M.updateUser(i,c),onSuccess:(...i)=>{o.invalidateQueries({queryKey:ue})},...t})}function as(t){const o=me();return xe({mutationFn:({id:i})=>M.deleteUser(i),onSuccess:(...i)=>{o.invalidateQueries({queryKey:ue})},...t})}const rs=({stats:t})=>{const o=[{icon:te,label:"Total Pengguna",value:t.total,color:"text-blue-600",bgColor:"bg-blue-50"},{icon:te,label:"Mahasiswa",value:t.students,color:"text-green-600",bgColor:"bg-green-50"},{icon:te,label:"Dosen",value:t.lecturers,color:"text-purple-600",bgColor:"bg-purple-50"},{icon:Te,label:"Admin",value:t.admins,color:"text-red-600",bgColor:"bg-red-50"}];return e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6",children:o.map(i=>e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:i.label}),e.jsx("p",{className:"text-2xl font-semibold text-gray-900",children:i.value})]}),e.jsx("div",{className:`p-3 rounded-lg ${i.bgColor}`,children:e.jsx(i.icon,{className:`w-6 h-6 ${i.color}`})})]})},i.label))})},fe={email:"",name:"",password:"",roles:[]},ns=t=>{switch(t){case"admin":return"bg-red-100 text-red-800";case"lecturer":return"bg-blue-100 text-blue-800";case"student":return"bg-green-100 text-green-800";case"staff":return"bg-purple-100 text-purple-800";case"student_applicant":return"bg-yellow-100 text-yellow-800";case"alumni":return"bg-gray-100 text-gray-800";default:return"bg-gray-100 text-gray-800"}},ke=t=>({admin:"Admin",lecturer:"Dosen",student:"Mahasiswa",staff:"Staff",student_applicant:"Pendaftar",alumni:"Alumni",guest:"Guest"})[t]||t,V=w,ls=[{value:"admin",label:"Admin"},{value:"staff",label:"Staff"},{value:"lecturer",label:"Dosen"},{value:"student",label:"Mahasiswa"},{value:"alumni",label:"Alumni"},{value:"student_applicant",label:"Pendaftar"}],is=({users:t,loading:o,currentPage:i,totalUsers:c,itemsPerPage:m,onPageChange:g,onEditUser:k,onDeleteUser:x,onManageAssignments:j})=>{const f=Math.ceil(c/m);return e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Pengguna"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Role"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Entitas"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Kontak"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Aksi"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:o?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex items-center justify-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),e.jsx("span",{className:"ml-2 text-gray-500",children:"Memuat data..."})]})})}):t.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-6 py-12 text-center text-gray-500",children:"Tidak ada pengguna ditemukan"})}):t.map(b=>e.jsx(ds,{user:b,onEdit:k,onDelete:x,onManageAssignments:j},b.id))})]})}),f>1&&e.jsxs("div",{className:"px-6 py-4 border-t border-gray-200 flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-gray-500",children:["Menampilkan ",(i-1)*m+1," -"," ",Math.min(i*m,c)," dari ",c," pengguna"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>g(i-1),disabled:i===1,className:"p-2 rounded-lg border border-gray-300 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx(Ie,{className:"w-4 h-4"})}),e.jsxs("span",{className:"text-sm text-gray-700",children:["Halaman ",i," dari ",f]}),e.jsx("button",{onClick:()=>g(i+1),disabled:i===f,className:"p-2 rounded-lg border border-gray-300 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx(qe,{className:"w-4 h-4"})})]})]})]})},ds=({user:t,onEdit:o,onDelete:i,onManageAssignments:c})=>{const m=V(t.name)||t.email.split("@")[0],g=t.roles||[],x=t.studentInfo?{email:V(t.studentInfo.email),phone:V(t.studentInfo.no_hp)}:t.lecturerInfo?{email:V(t.lecturerInfo.email),phone:V(t.lecturerInfo.no_hp)}:{email:t.email,phone:""},f=(()=>{const b=[];return t.studentInfo&&b.push(`NIM: ${t.studentInfo.nim}`),t.lecturerInfo&&b.push(`NIDN: ${V(t.lecturerInfo.nuptk)||t.lecturerInfo.id}`),b})();return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"h-10 w-10 flex-shrink-0",children:e.jsx("div",{className:"h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center",children:e.jsx("span",{className:"text-blue-600 font-medium text-sm",children:m.charAt(0).toUpperCase()})})}),e.jsxs("div",{className:"ml-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:m}),e.jsx("div",{className:"text-sm text-gray-500",children:t.email})]})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-wrap gap-1",children:[g.map((b,C)=>e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${ns(b.role)}`,children:ke(b.role)},C)),g.length===0&&e.jsx("span",{className:"text-gray-400 text-sm",children:"-"})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("div",{className:"text-sm text-gray-900",children:f.length>0?f.map((b,C)=>e.jsx("div",{children:b},C)):e.jsx("span",{className:"text-gray-400",children:"-"})})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"text-sm text-gray-500 space-y-1",children:[x.email&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ge,{className:"w-3 h-3"}),e.jsx("span",{className:"truncate max-w-[150px]",children:x.email})]}),x.phone&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx($e,{className:"w-3 h-3"}),x.phone]})]})}),e.jsx("td",{className:"px-6 py-4 text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[t.roles?.some(b=>b.role==="student"||b.role==="lecturer")&&e.jsx("button",{onClick:()=>c(t),className:"p-2 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors",title:"Manage Assignments",children:e.jsx(je,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>o(t),className:"p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors",title:"Edit",children:e.jsx(Ke,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>i(t),className:"p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors",title:"Hapus",children:e.jsx(re,{className:"w-4 h-4"})})]})})]})},be=({isOpen:t,isEdit:o,formData:i,formError:c,actionLoading:m,students:g,lecturers:k,onClose:x,onSubmit:j,onFormChange:f,onAddRole:b,onRemoveRole:C,onUpdateRoleEntity:l})=>{if(!t)return null;const n=o?"Edit Pengguna":"Tambah Pengguna",r=o?"Simpan Perubahan":"Tambah Pengguna";return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/50 z-40",onClick:x}),e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-50 p-4 pointer-events-none",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto pointer-events-auto",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-200",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:n}),e.jsx("button",{onClick:x,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(Ne,{className:"w-5 h-5"})})]}),e.jsxs("form",{onSubmit:j,children:[e.jsxs("div",{className:"px-6 py-4 space-y-4",children:[c&&e.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm",children:c}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Email ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"email",value:i.email,onChange:a=>f({email:a.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"email@example.com",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nama"}),e.jsx("input",{type:"text",value:i.name,onChange:a=>f({name:a.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Nama lengkap"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Password ",!o&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"password",value:i.password,onChange:a=>f({password:a.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:o?"Kosongkan jika tidak ingin mengubah":"Masukkan password",required:!o})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Role"}),e.jsx("div",{className:"space-y-2 mb-3",children:i.roles.map((a,N)=>e.jsx(cs,{role:a.role,entityId:a.entity_id,students:g,lecturers:k,onUpdateEntity:(F,u)=>l(N,F,u),onRemove:()=>C(N)},N))}),e.jsxs("select",{onChange:a=>{a.target.value&&(b(a.target.value),a.target.value="")},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",defaultValue:"",children:[e.jsx("option",{value:"",children:"+ Tambah Role"}),ls.filter(a=>!i.roles.some(N=>N.role===a.value)).map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))]})]})]}),e.jsxs("div",{className:"px-6 py-4 border-t border-gray-200 flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:x,className:"px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors",disabled:m,children:"Batal"}),e.jsxs("button",{type:"submit",className:"px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 flex items-center gap-2",disabled:m,children:[m&&e.jsx(de,{className:"w-4 h-4 animate-spin"}),r]})]})]})]})})]})},cs=({role:t,entityId:o,students:i,lecturers:c,onUpdateEntity:m,onRemove:g})=>{const k=t==="student"||t==="alumni",x=t==="lecturer";return e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 min-w-[80px]",children:ke(t)}),k&&e.jsxs("select",{value:o||"",onChange:j=>m("mahasiswa",j.target.value),className:"flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Pilih Mahasiswa"}),i.map(j=>e.jsxs("option",{value:j.nim,children:[j.nim," - ",j.nama||"(No Name)"]},j.nim))]}),x&&e.jsxs("select",{value:o||"",onChange:j=>m("dosen",j.target.value),className:"flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Pilih Dosen"}),c.map(j=>e.jsxs("option",{value:j.id,children:[j.id," - ",j.nama_dosen||"(No Name)"]},j.id))]}),!k&&!x&&e.jsx("span",{className:"flex-1 text-sm text-gray-500",children:"Tidak memerlukan entitas"}),e.jsx("button",{type:"button",onClick:g,className:"p-1 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors",children:e.jsx(re,{className:"w-4 h-4"})})]})},os=({studentId:t,semester:o})=>{const[i,c]=d.useState(!0),[m,g]=d.useState(null),[k,x]=d.useState([]);d.useEffect(()=>{(async()=>{if(!t||!o){g("Student ID or semester not available"),c(!1);return}try{c(!0),g(null);const r=await M.getEnrollments(t,o);if(!r||!Array.isArray(r)||r.length===0){x([]),c(!1);return}const a=new Map,N=r.filter(_=>w(_.kode_mk)).map(async _=>{const h=w(_.kode_mk);try{const P=await M.getCourseByCode(h);P&&a.set(h,P)}catch(P){console.error(`Failed to fetch course ${h}:`,P)}});await Promise.all(N);const F=r.map(async _=>{try{const h=await M.getGrades({krs_id:_.id});return{enrollment:_,grade:h[0]||null}}catch(h){return console.error(`Failed to fetch grade for enrollment ${_.id}:`,h),{enrollment:_,grade:null}}}),T=(await Promise.all(F)).map(({enrollment:_,grade:h})=>{const P=w(_.kode_mk)||"",E=a.get(P),S=se(E?.sks_tatap_muka)+se(E?.sks_praktek)+se(E?.sks_prak_lapangan)+se(E?.sks_simulasi),A=h?W(h.aktivitas_partisipatif)??void 0:void 0,G=h?W(h.hasil_proyek)??void 0:void 0,$=h?W(h.quiz)??void 0:void 0,I=h?W(h.tugas)??void 0:void 0,K=h?W(h.uts)??void 0:void 0,D=h?W(h.uas)??void 0:void 0,Q=A!==void 0&&G!==void 0&&$!==void 0&&I!==void 0&&K!==void 0&&D!==void 0;return{enrollmentId:_.id,courseCode:P,courseName:E?.nama_mk||P,credits:S,aktivitasPartisipatif:A,hasilProyek:G,quiz:$,tugas:I,uts:K,uas:D,nilaiAngka:h?W(h.nilai_angka)??void 0:void 0,nilaiHuruf:h?w(h.nilai_huruf)??void 0:void 0,nilaiIndeks:h?W(h.nilai_indeks)??void 0:void 0,hasCompleteGrades:Q}});x(T)}catch(r){console.error("Error fetching grades data:",r),g(r instanceof Error?r.message:"Failed to load grades")}finally{c(!1)}})()},[t,o]);const j=k.filter(n=>n.hasCompleteGrades),f=k.reduce((n,r)=>n+r.credits,0),b=j.reduce((n,r)=>n+r.credits,0),C=j.reduce((n,r)=>{const a=r.nilaiIndeks??0;return n+r.credits*a},0),l=b>0?C/b:null;return i?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(ve,{className:"h-6 w-6 animate-spin text-primary-600"}),e.jsx("span",{className:"ml-2 text-gray-600",children:"Loading grades..."})]}):m?e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center space-x-2 text-red-700",children:[e.jsx(ce,{className:"h-5 w-5"}),e.jsx("span",{children:m})]})}):k.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No grades available for this semester"}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 bg-white border border-gray-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(oe,{className:"h-5 w-5 text-primary-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Total Credits"}),e.jsxs("div",{className:"text-lg font-semibold",children:[f," SKS"]})]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(De,{className:"h-5 w-5 text-green-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Semester GPA (IPS)"}),e.jsx("div",{className:"text-lg font-semibold",children:l!==null?l.toFixed(2):"-"})]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(oe,{className:"h-5 w-5 text-amber-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Status"}),e.jsx("div",{className:"text-lg font-semibold",children:l!==null?l>=3?"Good Standing":l>=2?"Warning":"Probation":"-"})]})]})]}),e.jsx("div",{className:"bg-white border border-gray-200 rounded-lg overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-600 border-b-2 border-gray-200",children:[e.jsx("th",{className:"py-2 px-3",children:"Course Code"}),e.jsx("th",{className:"py-2 px-3",children:"Course Name"}),e.jsx("th",{className:"py-2 px-3 text-center",children:"SKS"}),e.jsx("th",{className:"py-2 px-3 text-center",children:"Partisipasi"}),e.jsx("th",{className:"py-2 px-3 text-center",children:"Proyek"}),e.jsx("th",{className:"py-2 px-3 text-center",children:"Quiz"}),e.jsx("th",{className:"py-2 px-3 text-center",children:"Tugas"}),e.jsx("th",{className:"py-2 px-3 text-center",children:"UTS"}),e.jsx("th",{className:"py-2 px-3 text-center",children:"UAS"}),e.jsx("th",{className:"py-2 px-3 text-center",children:"Total"}),e.jsx("th",{className:"py-2 px-3 text-center",children:"Grade"}),e.jsx("th",{className:"py-2 px-3 text-center",children:"Index"})]})}),e.jsx("tbody",{children:k.map(n=>e.jsxs("tr",{className:"border-t border-gray-100 hover:bg-gray-50",children:[e.jsx("td",{className:"py-2 px-3 font-medium text-gray-900",children:n.courseCode}),e.jsx("td",{className:"py-2 px-3",children:n.courseName}),e.jsx("td",{className:"py-2 px-3 text-center",children:n.credits}),e.jsx("td",{className:"py-2 px-3 text-center",children:n.aktivitasPartisipatif?.toFixed(1)??"-"}),e.jsx("td",{className:"py-2 px-3 text-center",children:n.hasilProyek?.toFixed(1)??"-"}),e.jsx("td",{className:"py-2 px-3 text-center",children:n.quiz?.toFixed(1)??"-"}),e.jsx("td",{className:"py-2 px-3 text-center",children:n.tugas?.toFixed(1)??"-"}),e.jsx("td",{className:"py-2 px-3 text-center",children:n.uts?.toFixed(1)??"-"}),e.jsx("td",{className:"py-2 px-3 text-center",children:n.uas?.toFixed(1)??"-"}),e.jsx("td",{className:"py-2 px-3 text-center font-medium",children:n.nilaiAngka?.toFixed(1)??"-"}),e.jsx("td",{className:"py-2 px-3 text-center font-semibold text-primary-600",children:n.hasCompleteGrades?n.nilaiHuruf??"-":"-"}),e.jsx("td",{className:"py-2 px-3 text-center",children:n.hasCompleteGrades?n.nilaiIndeks?.toFixed(2)??"-":"-"})]},n.enrollmentId))})]})})]})},ms=({studentId:t,semester:o})=>{const{data:i=[],isLoading:c}=J({queryKey:["admin-student-classes",t,o],queryFn:async()=>await M.getStudentClasses(t,{semester:o}),enabled:!!t&&!!o}),m=d.useMemo(()=>i.map(l=>l.kelas_id),[i]),g=J({queryKey:["admin-student-meetings",m],queryFn:async()=>{if(m.length===0)return{};const l={};return await Promise.all(m.map(async n=>{try{const r=await M.getMeetingsByClass(n);l[n]=r}catch(r){console.error(`Failed to fetch meetings for class ${n}:`,r),l[n]=[]}})),l},enabled:m.length>0}),k=d.useMemo(()=>g.data?Object.values(g.data).flat().map(l=>l.id):[],[g.data]),x=J({queryKey:["admin-student-attendances",t,k],queryFn:async()=>{if(k.length===0)return{};const l={};return await Promise.all(k.map(async n=>{try{const a=(await M.getMeetingAttendances(n)).find(N=>N.nim===t);a&&(l[n]=a)}catch(r){console.error(`Failed to fetch attendances for meeting ${n}:`,r)}})),l},enabled:k.length>0}),j=d.useMemo(()=>!g.data||!i.length?[]:i.map(l=>{const n=(g.data?.[l.kelas_id]||[]).sort((a,N)=>a.pertemuan_ke-N.pertemuan_ke),r={course:l,meetings:n.map(a=>({id:a.id,topik:w(a.topik),tgl_pertemuan:typeof a.tgl_pertemuan=="string"?a.tgl_pertemuan:a.tgl_pertemuan?.Time||"",pertemuan_ke:a.pertemuan_ke,attendance:x.data?.[a.id]})),stats:{totalMeetings:n.length,attended:0,excused:0,sick:0,late:0,substitute:0,absent:0,attendancePercentage:0}};if(n.forEach(a=>{const N=x.data?.[a.id];if(N)switch(w(N.status_kehadiran)?.toLowerCase()){case"hadir":case"present":r.stats.attended++;break;case"izin":case"excused":r.stats.excused++;break;case"sakit":case"sick":r.stats.sick++;break;case"terlambat":case"late":r.stats.late++;break;case"pengganti":case"substitute":r.stats.substitute++;break;case"alpa":case"alfa":case"absent":r.stats.absent++;break}}),r.stats.totalMeetings>0){const a=r.stats.attended+r.stats.late+r.stats.substitute;r.stats.attendancePercentage=Math.round(a/r.stats.totalMeetings*100)}return r}).sort((l,n)=>w(l.course.kode_mk||"").localeCompare(w(n.course.kode_mk||""))),[i,g.data,x.data,t]),f=c||g.isLoading||x.isLoading,b=l=>{switch(l?.toLowerCase()){case"hadir":case"present":return e.jsx(ee,{className:"h-4 w-4 text-green-600"});case"izin":case"excused":return e.jsx(ge,{className:"h-4 w-4 text-blue-600"});case"sakit":case"sick":return e.jsx(ce,{className:"h-4 w-4 text-yellow-600"});case"terlambat":case"late":return e.jsx(pe,{className:"h-4 w-4 text-orange-600"});case"pengganti":case"substitute":return e.jsx(ee,{className:"h-4 w-4 text-purple-600"});case"alpa":case"alfa":case"absent":return e.jsx(ye,{className:"h-4 w-4 text-red-600"});default:return e.jsx(le,{className:"h-4 w-4 text-gray-300"})}},C=l=>l>=80?"text-green-600":l>=70?"text-yellow-600":"text-red-600";return f?e.jsxs("div",{className:"flex justify-center items-center py-8",children:[e.jsx(ve,{className:"h-6 w-6 animate-spin text-primary-600"}),e.jsx("span",{className:"ml-2 text-gray-600",children:"Loading attendance..."})]}):j.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No attendance records found for this semester"}):e.jsx("div",{className:"space-y-3",children:j.map(l=>e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg overflow-hidden",children:[e.jsx("div",{className:"bg-gradient-to-r from-primary-50 to-secondary-50 px-3 py-2 border-b border-gray-200",children:e.jsxs("div",{className:"flex justify-between items-center gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("h4",{className:"font-semibold text-sm text-gray-900 truncate",children:[w(l.course.kode_mk||"")," - ",w(l.course.nama_mk||"")]}),e.jsx("p",{className:"text-xs text-gray-600 truncate",children:w(l.course.nama_kelas||"")})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs flex-shrink-0",children:[e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:`font-bold text-base ${C(l.stats.attendancePercentage)}`,children:[l.stats.attendancePercentage,"%"]})}),e.jsx("div",{className:"h-6 w-px bg-gray-300"}),e.jsxs("div",{className:"flex gap-1.5",children:[e.jsx("span",{className:"bg-green-100 text-green-700 px-1.5 py-0.5 rounded text-xs font-medium",children:l.stats.attended}),e.jsx("span",{className:"bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded text-xs font-medium",children:l.stats.late}),e.jsx("span",{className:"bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded text-xs font-medium",children:l.stats.excused}),e.jsx("span",{className:"bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded text-xs font-medium",children:l.stats.sick}),e.jsx("span",{className:"bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded text-xs font-medium",children:l.stats.substitute}),e.jsx("span",{className:"bg-red-100 text-red-700 px-1.5 py-0.5 rounded text-xs font-medium",children:l.stats.absent})]})]})]})}),l.meetings.length===0?e.jsx("div",{className:"p-3 text-center text-xs text-gray-500",children:"No meetings recorded for this course."}):e.jsx("div",{className:"p-3",children:e.jsxs("div",{className:"flex gap-2 flex-wrap items-start",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1 w-full",children:e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx(ee,{className:"h-3 w-3 text-green-600"}),e.jsx("span",{children:"Present"})]}),e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx(pe,{className:"h-3 w-3 text-orange-600"}),e.jsx("span",{children:"Late"})]}),e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx(ge,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{children:"Excused"})]}),e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx(ce,{className:"h-3 w-3 text-yellow-600"}),e.jsx("span",{children:"Sick"})]}),e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx(ee,{className:"h-3 w-3 text-purple-600"}),e.jsx("span",{children:"Substitute"})]}),e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx(ye,{className:"h-3 w-3 text-red-600"}),e.jsx("span",{children:"Absent"})]}),e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx(le,{className:"h-3 w-3 text-gray-400"}),e.jsx("span",{children:"Not Marked"})]})]})}),e.jsx("div",{className:"flex gap-1 flex-wrap",children:l.meetings.map(n=>{const r=n.attendance,a=r?w(r.status_kehadiran):void 0,N=He(n.tgl_pertemuan),F=N?N.toLocaleDateString("en-US",{month:"short",day:"numeric"}):"";return e.jsxs("div",{className:"flex flex-col items-center gap-0.5 p-1.5 rounded border border-gray-200 hover:bg-gray-50 transition-colors cursor-help",title:`Week ${n.pertemuan_ke} - ${F}${n.topik?` - ${w(n.topik)}`:""}`,children:[e.jsxs("div",{className:"text-xs font-semibold text-gray-600",children:["W",n.pertemuan_ke]}),e.jsx("div",{className:"flex justify-center h-5",children:a?b(a):e.jsx(le,{className:"h-4 w-4 text-gray-300"})}),e.jsx("div",{className:"text-xs text-gray-500 text-center leading-tight max-w-12 break-words",children:F})]},n.id)})})]})})]},l.course.kelas_id))})},xs=({user:t,isOpen:o,onClose:i,currentSemester:c})=>{const[m,g]=d.useState("enrollments"),[k,x]=d.useState(!1),[j,f]=d.useState(null),[b,C]=d.useState(null),[l,n]=d.useState([]),[r,a]=d.useState({kode_mk:"",id_kelas:""}),[N,F]=d.useState([]),[u,T]=d.useState({kode_mk:"",id_kelas:"",sks_ajar:"",tatap_muka:""}),[_,h]=d.useState(!1),{data:P=[]}=Xe({semester:c,include_classes:!0}),E=d.useMemo(()=>{const s=[];return P.forEach(v=>{v.classes&&Array.isArray(v.classes)&&s.push(...v.classes)}),s},[P]),S=t?.roles?.find(s=>s.role==="student"),A=t?.roles?.find(s=>s.role==="lecturer"),{data:G}=Ye(A?.entity_id&&c?{id_dosen:A.entity_id,semester:c}:void 0);he.useEffect(()=>{G&&F(G)},[G]),he.useEffect(()=>{o&&S?.entity_id&&c&&$()},[o,S?.entity_id,c]);const $=async()=>{if(!(!S?.entity_id||!c)){x(!0),f(null);try{const s=await M.getEnrollments(S.entity_id,c);Array.isArray(s)?n(s.map(v=>({kode_mk:w(v.kode_mk)||"",id_kelas:ie(v.id_kelas)??void 0}))):n([])}catch(s){f(s instanceof Error?s.message:"Failed to load enrollments")}finally{x(!1)}}},I=()=>{if(!r.kode_mk){f("Please select a course");return}const s=r.id_kelas?Number(r.id_kelas):void 0;if(l.some(v=>v.kode_mk===r.kode_mk&&v.id_kelas===s)){f("Already enrolled in this class");return}n([...l,{kode_mk:r.kode_mk,id_kelas:s}]),a({kode_mk:"",id_kelas:""}),f(null)},K=s=>{n(l.filter((v,q)=>q!==s))},D=async()=>{if(!(!S?.entity_id||!c)){x(!0),f(null),C(null);try{const s=l.map(v=>({nim:S.entity_id,kode_mk:v.kode_mk,semester:c,id_kelas:v.id_kelas}));await M.updateEnrollments(S.entity_id,c,s),C("Enrollments saved successfully!"),setTimeout(()=>C(null),3e3)}catch(s){f(s instanceof Error?s.message:"Failed to save enrollments")}finally{x(!1)}}},Q=async()=>{if(!A?.entity_id||!u.kode_mk||!u.id_kelas||!c){f("Please fill in all required fields");return}x(!0),f(null);try{const s={id_dosen:A.entity_id,id_kelas:u.id_kelas,kode_mk:u.kode_mk,semester:c,sks_ajar:u.sks_ajar?parseInt(u.sks_ajar,10):void 0,tatap_muka:u.tatap_muka?parseInt(u.tatap_muka,10):void 0};if(await M.createLecturerAssignment(s),C("Teaching assignment created successfully"),T({kode_mk:"",id_kelas:"",sks_ajar:"",tatap_muka:""}),h(!1),A?.entity_id&&c){const v=await M.getLecturerAssignments({id_dosen:A.entity_id,semester:c});F(v)}}catch(s){f(s instanceof Error?s.message:"Failed to add teaching assignment")}finally{x(!1)}},U=async s=>{if(confirm("Are you sure you want to remove this teaching assignment?")){x(!0),f(null);try{await M.deleteLecturerAssignment(s),C("Teaching assignment removed successfully"),F(N.filter(v=>v.id!==s))}catch(v){f(v instanceof Error?v.message:"Failed to remove teaching assignment")}finally{x(!1)}}},X=d.useMemo(()=>{const s=new Map;return E.forEach(v=>{const q=w(v.kode_mk);q&&!s.has(q)&&s.set(q,q)}),Array.from(s.values())},[E]),Y=d.useMemo(()=>r.kode_mk?E.filter(s=>w(s.kode_mk)===r.kode_mk):[],[E,r.kode_mk]);if(!o||!t)return null;const R=!!S,z=!!A;return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/50 z-40",onClick:i}),e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-50 p-4 pointer-events-none",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl w-full max-w-6xl max-h-[90vh] overflow-y-auto pointer-events-auto",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-200 sticky top-0 bg-white z-10",children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-900",children:["Manage Assignments - ",w(t.name)||t.email]}),e.jsx("button",{onClick:i,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(Ne,{className:"w-5 h-5"})})]}),(R||z)&&e.jsx("div",{className:"px-6 pt-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex gap-4 overflow-x-auto",children:[R&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>g("enrollments"),className:`pb-2 px-1 border-b-2 font-medium text-sm transition-colors whitespace-nowrap ${m==="enrollments"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700"}`,children:[e.jsx(te,{className:"w-4 h-4 inline mr-2"}),"Enrollments"]}),e.jsxs("button",{onClick:()=>g("grades"),className:`pb-2 px-1 border-b-2 font-medium text-sm transition-colors whitespace-nowrap ${m==="grades"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700"}`,children:[e.jsx(oe,{className:"w-4 h-4 inline mr-2"}),"Grades"]}),e.jsxs("button",{onClick:()=>g("attendance"),className:`pb-2 px-1 border-b-2 font-medium text-sm transition-colors whitespace-nowrap ${m==="attendance"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700"}`,children:[e.jsx(Qe,{className:"w-4 h-4 inline mr-2"}),"Attendance"]})]}),z&&e.jsxs("button",{onClick:()=>g("teaching"),className:`pb-2 px-1 border-b-2 font-medium text-sm transition-colors whitespace-nowrap ${m==="teaching"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700"}`,children:[e.jsx(je,{className:"w-4 h-4 inline mr-2"}),"Teaching"]})]})}),e.jsxs("div",{className:"p-6 space-y-4",children:[j&&e.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm",children:j}),b&&e.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg text-green-600 text-sm",children:b}),m==="grades"&&R&&S?.entity_id&&c&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-900",children:"Student Grades (KHS)"}),e.jsxs("span",{className:"text-xs text-gray-500",children:["Semester: ",c]})]}),e.jsx(os,{studentId:S.entity_id,semester:c})]}),m==="attendance"&&R&&S?.entity_id&&c&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-900",children:"Student Attendance"}),e.jsxs("span",{className:"text-xs text-gray-500",children:["Semester: ",c]})]}),e.jsx(ms,{studentId:S.entity_id,semester:c})]}),m==="enrollments"&&R&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-900",children:"Student Enrollments"}),e.jsxs("span",{className:"text-xs text-gray-500",children:["Semester: ",c||"N/A"]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg p-4 space-y-3",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700",children:"Add Enrollment"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("select",{value:r.kode_mk,onChange:s=>a({...r,kode_mk:s.target.value,id_kelas:""}),className:"px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"Select Course"}),X.map(s=>e.jsx("option",{value:s,children:s},s))]}),e.jsxs("select",{value:r.id_kelas,onChange:s=>a({...r,id_kelas:s.target.value}),className:"px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500",disabled:!r.kode_mk,children:[e.jsx("option",{value:"",children:"Any Class"}),Y.map(s=>e.jsx("option",{value:s.id,children:w(s.nama_kelas)||`Class ${s.id}`},s.id))]}),e.jsxs("button",{onClick:I,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center justify-center gap-2",disabled:!r.kode_mk,children:[e.jsx(ae,{className:"w-4 h-4"}),"Add"]})]})]}),e.jsx("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:l.length===0?e.jsx("div",{className:"p-8 text-center text-gray-500 text-sm",children:"No enrollments yet. Add courses above."}):e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Course Code"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Class"}),e.jsx("th",{className:"px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase",children:"Action"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:l.map((s,v)=>{const q=E.find(ne=>ne.id===s.id_kelas);return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 font-medium text-gray-900",children:s.kode_mk}),e.jsx("td",{className:"px-4 py-3 text-gray-600",children:q?w(q.nama_kelas)||`Class ${q.id}`:"Any Class"}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsx("button",{onClick:()=>K(v),className:"p-1 text-red-600 hover:bg-red-50 rounded transition-colors",children:e.jsx(re,{className:"w-4 h-4"})})})]},v)})})]})}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:D,disabled:k,className:"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 disabled:opacity-50",children:k?e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"w-4 h-4 animate-spin"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"w-4 h-4"}),"Save Enrollments"]})})})]}),m==="teaching"&&z&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-900",children:"Teaching Assignments"}),e.jsxs("button",{onClick:()=>h(!_),disabled:k,className:"px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center gap-2 disabled:opacity-50",children:[e.jsx(ae,{className:"w-4 h-4"}),"Add Assignment"]})]}),_&&e.jsxs("div",{className:"p-4 bg-gray-50 border border-gray-200 rounded-lg space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Course ",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsxs("select",{value:u.kode_mk,onChange:s=>T({...u,kode_mk:s.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm",children:[e.jsx("option",{value:"",children:"Select course..."}),Array.from(new Set(E.map(s=>w(s.kode_mk)))).map(s=>e.jsx("option",{value:s||"",children:s},s))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Class ",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsxs("select",{value:u.id_kelas,onChange:s=>T({...u,id_kelas:s.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm",children:[e.jsx("option",{value:"",children:"Select class..."}),E.filter(s=>w(s.kode_mk)===u.kode_mk).map(s=>e.jsx("option",{value:s.id.toString(),children:w(s.nama_kelas)||`Class ${s.id}`},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"SKS Ajar"}),e.jsx("input",{type:"number",value:u.sks_ajar,onChange:s=>T({...u,sks_ajar:s.target.value}),min:"0",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tatap Muka"}),e.jsx("input",{type:"number",value:u.tatap_muka,onChange:s=>T({...u,tatap_muka:s.target.value}),min:"0",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm",placeholder:"0"})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>{h(!1),T({kode_mk:"",id_kelas:"",sks_ajar:"",tatap_muka:""})},disabled:k,className:"px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors text-sm disabled:opacity-50",children:"Cancel"}),e.jsx("button",{onClick:Q,disabled:k||!u.kode_mk||!u.id_kelas,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center gap-2 disabled:opacity-50",children:k?e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"w-4 h-4 animate-spin"}),"Creating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"w-4 h-4"}),"Create Assignment"]})})]})]}),e.jsx("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:N.length===0?e.jsx("div",{className:"p-8 text-center text-gray-500 text-sm",children:"No teaching assignments found."}):e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Course"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Class"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Semester"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"SKS"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Tatap Muka"}),e.jsx("th",{className:"px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase",children:"Action"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:N.map(s=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 font-medium text-gray-900",children:w(s.kode_mk)||"-"}),e.jsx("td",{className:"px-4 py-3 text-gray-600",children:w(s.id_kelas)||"-"}),e.jsx("td",{className:"px-4 py-3 text-gray-600",children:w(s.semester)||"-"}),e.jsx("td",{className:"px-4 py-3 text-gray-600",children:ie(s.sks_ajar)||"-"}),e.jsx("td",{className:"px-4 py-3 text-gray-600",children:ie(s.tatap_muka)||"-"}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsx("button",{onClick:()=>U(s.id),disabled:k,className:"p-1 text-red-600 hover:bg-red-50 rounded transition-colors disabled:opacity-50",children:e.jsx(re,{className:"w-4 h-4"})})})]},s.id))})]})})]}),!R&&!z&&e.jsxs("div",{className:"p-8 text-center text-gray-500",children:["This user doesn't have student or lecturer role.",e.jsx("br",{}),"Add appropriate roles first to manage assignments."]})]})]})})]})};function us(){const[t,o]=d.useState(1),[i,c]=d.useState(0),m=50,[g,k]=d.useState(""),[x,j]=d.useState("all"),[f,b]=d.useState(!1),[C,l]=d.useState(!1),[n,r]=d.useState(null),[a,N]=d.useState(fe),[F,u]=d.useState(null),[T,_]=d.useState(!1),[h,P]=d.useState([]),[E,S]=d.useState([]),{data:A,isLoading:G,error:$}=Ze(),{data:I,isLoading:K,error:D}=es(),Q=d.useMemo(()=>({q:g||void 0,limit:m,offset:(t-1)*m}),[m,t,g]),U=Je(Q,{enabled:!0}),X=ss(),Y=ts(),R=as();d.useEffect(()=>{A&&P(A)},[A]),d.useEffect(()=>{I&&S(I)},[I]),d.useEffect(()=>{U.data&&c(U.data.data.total)},[U.data]),d.useEffect(()=>{o(1)},[g,x]);const z=U.isLoading||G||K,s=U.error||$||D,v=d.useMemo(()=>{console.log("usersQuery.data:",U.data),console.log("usersQuery.data?.data:",U.data?.data),console.log("typeof usersQuery.data?.data:",typeof U.data?.data),console.log("Array.isArray(usersQuery.data?.data):",Array.isArray(U.data?.data));const y=U.data?.data?.data??[];return Array.isArray(y)?y.map(p=>{const L=p.roles||[],O=L.find(H=>H.role==="student"),B=L.find(H=>H.role==="lecturer"),Z={...p};return O?.entity_id&&A&&(Z.studentInfo=A.find(H=>H.nim===O.entity_id)),B?.entity_id&&I&&(Z.lecturerInfo=I.find(H=>H.id===B.entity_id)),Z}):(console.error("Expected array but got:",y),[])},[U.data,A,I]),q=d.useMemo(()=>v.filter(y=>{const p=y.roles?.map(L=>L.role)||[];return x==="all"||p.includes(x)}),[v,x]),ne=d.useMemo(()=>{const y=v.flatMap(p=>p.roles?.map(L=>L.role)||[]);return{total:i,students:y.filter(p=>p==="student").length,lecturers:y.filter(p=>p==="lecturer").length,admins:y.filter(p=>p==="admin").length,staff:y.filter(p=>p==="staff").length}},[v,i]),we=d.useCallback(()=>{u(null),N(fe),b(!0)},[]),_e=d.useCallback(()=>{b(!1)},[]),Ce=d.useCallback(y=>{u(null),r(y),N({email:y.email,name:V(y.name),password:"",roles:y.roles||[]}),l(!0)},[]),Ae=d.useCallback(()=>{l(!1),r(null)},[]),Se=d.useCallback(async y=>{if(y.preventDefault(),u(null),!a.email.trim()||!a.email.includes("@")){u("Email tidak valid");return}if(!a.password.trim()){u("Password wajib diisi jika tidak menggunakan Google OAuth");return}_(!0);try{const p={email:a.email.trim(),name:a.name.trim()||void 0,password:a.password.trim()||void 0,auth_provider:"local",roles:a.roles};await X.mutateAsync(p),b(!1)}catch(p){u(p.message||"Gagal menambahkan pengguna")}finally{_(!1)}},[a,X]),Ee=d.useCallback(async y=>{if(y.preventDefault(),!!n){if(u(null),!a.email.trim()||!a.email.includes("@")){u("Email tidak valid");return}_(!0);try{const p={email:a.email.trim(),name:a.name.trim()||void 0,roles:a.roles};a.password.trim()&&(p.password=a.password.trim()),await Y.mutateAsync({id:n.id,data:p}),l(!1)}catch(p){u(p.message||"Gagal mengupdate pengguna")}finally{_(!1)}}},[a,n,Y]),Me=d.useCallback(async y=>{const p=V(y.name)||y.email;if(confirm(`Apakah Anda yakin ingin menghapus pengguna "${p}"?`))try{await R.mutateAsync({id:y.id})}catch(L){alert(`Gagal menghapus pengguna: ${L.message}`)}},[R]),Ue=d.useCallback(y=>{if(a.roles.some(p=>p.role===y)){u("Role sudah ditambahkan");return}N(p=>({...p,roles:[...p.roles,{role:y}]}))},[a.roles]),Fe=d.useCallback(y=>{N(p=>({...p,roles:p.roles.filter((L,O)=>O!==y)}))},[]),Pe=d.useCallback((y,p,L)=>{N(O=>{const B=[...O.roles];if(L)B[y]={...B[y],entity_type:p,entity_id:L};else{const{entity_type:Z,entity_id:H,...Re}=B[y];B[y]=Re}return{...O,roles:B}})},[]);return{users:v,students:h,lecturers:E,userStats:ne,totalUsers:i,loading:z,loadError:s,actionLoading:T,currentPage:t,itemsPerPage:m,setCurrentPage:o,searchTerm:g,setSearchTerm:k,selectedRole:x,setSelectedRole:j,filteredUsers:q,formData:a,setFormData:N,formError:F,setFormError:u,isAddModalOpen:f,setIsAddModalOpen:b,isEditModalOpen:C,setIsEditModalOpen:l,editingUser:n,setEditingUser:r,handleAddUser:Se,handleEditUser:Ee,handleDeleteUser:Me,openAddModal:we,openEditModal:Ce,closeAddModal:_e,closeEditModal:Ae,addRole:Ue,removeRole:Fe,updateRoleEntity:Pe}}const Ns=()=>{const{currentSemester:t}=We(),{t:o}=Ve(),[i,c]=d.useState(null),{students:m,lecturers:g,userStats:k,totalUsers:x,loading:j,loadError:f,actionLoading:b,currentPage:C,itemsPerPage:l,setCurrentPage:n,searchTerm:r,setSearchTerm:a,selectedRole:N,setSelectedRole:F,filteredUsers:u,formData:T,setFormData:_,formError:h,isAddModalOpen:P,isEditModalOpen:E,handleAddUser:S,handleEditUser:A,handleDeleteUser:G,openAddModal:$,openEditModal:I,closeAddModal:K,closeEditModal:D,addRole:Q,removeRole:U,updateRoleEntity:X}=us(),Y=R=>{_(z=>({...z,...R}))};return e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6",children:[e.jsx(Le,{title:o("adminUsers.title"),subtitle:o("adminUsers.subtitle")}),e.jsx("div",{className:"flex gap-2 mt-4 sm:mt-0",children:e.jsxs("button",{onClick:$,className:"inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(ae,{className:"w-4 h-4"}),o("adminUsers.addUser")]})})]}),f&&e.jsxs("div",{className:"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-600",children:[o("adminUsers.loadError"),": ",f.message]}),e.jsx(rs,{stats:k}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 mb-6",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(Oe,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Cari berdasarkan nama atau email...",value:r,onChange:R=>a(R.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Be,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsxs("select",{value:N,onChange:R=>F(R.target.value),className:"pl-10 pr-8 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none bg-white",children:[e.jsx("option",{value:"all",children:"Semua Role"}),e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"lecturer",children:"Dosen"}),e.jsx("option",{value:"student",children:"Mahasiswa"}),e.jsx("option",{value:"staff",children:"Staff"}),e.jsx("option",{value:"alumni",children:"Alumni"}),e.jsx("option",{value:"student_applicant",children:"Pendaftar"})]})]})]}),e.jsx(is,{users:u,loading:j,currentPage:C,totalUsers:N==="all"?x:u.length,itemsPerPage:l,onManageAssignments:c,onPageChange:n,onEditUser:I,onDeleteUser:G}),e.jsx(be,{isOpen:P,isEdit:!1,formData:T,formError:h,actionLoading:b,students:m,lecturers:g,onClose:K,onSubmit:S,onFormChange:Y,onAddRole:Q,onRemoveRole:U,onUpdateRoleEntity:X}),e.jsx(be,{isOpen:E,isEdit:!0,formData:T,formError:h,actionLoading:b,students:m,lecturers:g,onClose:D,onSubmit:A,onFormChange:Y,onAddRole:Q,onRemoveRole:U,onUpdateRoleEntity:X}),e.jsx(xs,{user:i,isOpen:!!i,onClose:()=>c(null),currentSemester:t})]})};export{Ns as default};
//# sourceMappingURL=index-DL1IA3WZ.js.map
